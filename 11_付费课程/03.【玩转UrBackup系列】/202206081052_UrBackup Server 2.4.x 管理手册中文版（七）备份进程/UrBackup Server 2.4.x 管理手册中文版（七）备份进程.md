UrBackup Server 2.4.x 管理手册中文版（七）备份进程

副标题：备份进程~

英文：administration-manual-for-urbackup-server-7

关键字：administration,manual,urbackup,backup,server,client,architecture



 本节将详细说明如何执行备份。 



### `UrBackup` 的备份进程

##### 7.1 文件备份

服务器检测到最后一次增量备份的时间大于增量备份的时间间隔或最后一次完整备份的时间大于完整备份的时间间隔。

也可以根据客户端请求启动备份。



备份时服务器会创建一个新目录，它将用于保存备份。

此目录的架构是 `YYMMDD-HHMM` ，其中 `YY` 是两位数字格式的年份，`MM` 是当前月份，`DD` 是当天，以及 `HHMM` 表示当前的小时和分钟。

该目录被创建于 `备份路径`中名称与客户端名称相同的子目录中。



服务器向客户端请求文件列表构造。

客户端则构建文件列表并报告服务器已完成。



服务器从客户端下载 `urbackup/data/filelist.ub` 。

如果它是增量备份，服务器会将新的 `filelist.ub` 与来自客户端的最后一个进行比较并计算差异。



服务器开始传输并下载文件。

如果备份是增量备份，则只下载新的和更改的文件。

如果备份是完整的，则从客户端下载所有文件。



服务器将文件下载到临时文件中。

此临时文件默认位于备份存储目录中的 `urbackup_tmp_files` 文件夹中，亦或者，如果你在高级设置中启用了它，则位于系统临时文件夹中。

成功下载文件后，服务器会计算其哈希值并查看是否存在具有相同哈希值的另一个文件。

如果存在这样的文件，则假定它们是相同的，并保存为另一个文件的硬链接，同时删除临时文件。

如果不存在此类文件，则将文件移动到新的备份位置。

文件路径和哈希值会保存到服务器数据库中。



如果备份是增量备份并且文件未更改，则会创建指向先前备份中文件的硬链接。



如果备份是增量的，启用 `在增量文件备份期间使用符号链接` 并且包含 10 个以上文件或文件夹的目录未更改，则它将建立符号链接到上次备份中的同一文件夹。

因为最后一个备份可能会在当前备份之前被删除，所以首先将该文件夹移动到一个池目录（客户端文件夹中的 `.directory_pool` ），然后从两个位置都建立链接。

每次创建/删除指向该目录的另一个符号链接时，目录的引用计数都会增加/减少。



如果客户端在备份期间脱机并且备份是增量备份，则服务器会继续创建指向先前备份中文件的硬链接，但不会再次尝试下载文件。

无法下载的文件不会保存到服务器端文件列表中。

如果备份是完整的并且客户端离线，则备份过程将中断并保存部分文件列表，其中包括到目前为止下载的所有文件。



如果所有文件都已传输，则服务器会更新客户端备份存储位置中的 `当前` 符号链接以指向新备份。

仅当客户端在备份期间未脱机时才会发生这种情况。                    



##### 7.2 映像备份









与服务器位于同一局域网中的客户端会自动被服务端发现。

客户端发现的工作原理如下：

`UrBackup` 服务器每 `50` 秒在当前所有网络适配器上向该适配器的本地子网广播一条 `UDP` 消息。

（在 Linux 上，你可以配置 `UrBackup` 应该在哪些网络适配器上广播。）

在收到这样的广播消息时，客户端会使用其 `FQDB` （完全限定域名）进行回复。

因此，在客户端被识别为在线之前可能需要长达 `50` 秒的时间。

如果你要备份的客户端与服务器不在同一子网中，并且广播包因此而无法到达客户端，你可以通过单击状态页面上的  `添加新客户端` ，然后选择 `使用IP/客户端名检测新客户端` 。

然后，服务器将额外地向前面输入 `IP` 或主机名的客户端发送直达的 `UDP` 消息，从而允许交换机跨子网边界转发消息。

请注意，此时所有连接均是从服务器到客户端的。

如果服务器和客户端之间存在 `NAT` ，则应该使用 `Internet 客户端` （参见第 8 节）。

使用 `Internet 客户端` 则所有连接都是从客户端到服务器的。 



### 小结

本节阐述了 `UrBackup` 客户端的发现过程。

其基本原理是通过广播 `UDP` 来实现自动发现。

如果客户端与服务器位于同一子网，那么什么都不用干，它会自动连接到服务器。

如果客户端与服务器位于局域网中，但需要经过不同网关到达，那么需要我们提供客户端的 `IP` 地址或可以解析的主机名。

如果客户端与服务器不在一个网络中，数据包无法直达，那么就必须启用广域网模式。

最后需要注意发现连接的流量方面，这将有助于我们成功连接服务器与客户端。



**扫码关注@网管小贾，个人微信：sysadmcc**

网管小贾 / sysadm.cc

