UrBackup Server 2.4.x 管理手册中文版（十二）存储

副标题：存储~

英文：administration-manual-for-urbackup-server-11

关键字：administration,manual,urbackup,backup,server,client,architecture



 本节将向小伙伴们阐述 `UrBackup` 杂项的相关内容。 



#### 12. `UrBackup` 的存储

`UrBackup` 服务器存储系统的设计能够尽可能多地保存备份，从而尽可能多地占用存储分区上的空间。

有鉴于此，最佳做法是为备份存储使用单独的文件系统，或为 `urbackup` 用户设置配额。

如果某些文件系统几乎完全被占用（碎片化和性能差），则它们的性能会很差。

对于此类文件系统，你应该始终限制 `UrBackup` 最多可以使用全部可用空间的 `95%` 的配额。

你还可以在 `UrBackup` 中设置一个软配额（请参阅第 `9.1.14` 节），如果可能的话，该配额会导致 `UrBackup` 删除备份以保持在此配额内。



##### 12.1 每晚备份删除

`UrBackup` 在凌晨 `3` 点到 `5` 点之间自动删除旧文件备份和映像备份。

当客户端的 `增量/完整文件/映像` 备份数量超过配置的 `增量/完整文件/映像` 备份的最大数量时将删除备份。

备份将被删除直到备份数量再次回到限制范围内。

如果管理员已设定自动关机，则此清理过程会在服务器开机时启动（因为服务器很可能在夜间关闭）。

删除备份和后续更新统计信息会对系统性能产生巨大影响。

在夜间备份删除期间，`UrBackup` 还尝试强制执行全局和客户端特殊指定的软配额。

仅当客户端已拥有比配置的最小 `增量/完整文件/映像` 备份数量更多的备份时，它才能删除备份。



##### 12.2 紧急清理

如果服务器在备份期间用完存储空间，它会删除备份，直到有足够的空间再次可用。

映像优先于文件备份，最旧的备份首先被删除。

当拥有备份的客户端，其存储中配置了的最小数量的 `增量/完整文件/映像备份` 时，其备份仅被删除到其最小配置数量。

如果未找到符合被删除条件的备份而存储又用完了，则 `UrBackup` 将取消当前备份并出现致命错误。

如果发生此类错误，管理员应监控存储空间并添加存储或将 `增量/完整文件/映像备份` 的最小数量配置为较低水平。 

 

##### 12.3 清理具有大量备份文件的服务器

`UrBackup` 的数据库处于启用高并发的模式。

由于清理过程有时会受到数据库的限制，因此建议将数据库切换到允许较少并发但对于清理过程的某些操作来说速度较快的模式。

这在 `UrBackup` 运行时是不可能的，因此你应该调整备份窗口，以确保在某些时候没有运行备份。

然后你可以通过调用如下命令来停止服务器单独运行清理。

```
urbackupsrv cleanup --amount x
```

在 `GNU/Linux` 或 `Windows` 上：

```
cleanup.bat x
```

其中 `x` 是备份存储上要释放的空间百分比或字节/兆字节/千兆字节数，例如 `20G` 或 `10%` 。

如果想完全删除旧备份，请使用  `0%` 。



##### 12.4 清理具有 `UrBackup` 未知文件的存储文件夹

有时，通过使用数据库备份，存储目录中可能存在 `UrBackup` 并不知道的备份，即数据库中没有这些备份的条目。

或者数据库中有条目不在存储目录中（文件不再存在）。

在这些情况下，可运行如下命令清理。

```
urbackupsrv remove-unknown
```

在 `GNU/Linux` 或 `Windows` 上：

```
remove_unknown.bat
```

删除 `urbackup` 存储目录中不存在于 `UrBackup` 数据库中的文件和文件夹。

这也会遍历所有软硬链接并在必要时更正它们。



##### 12.5 归档

`UrBackup` 能够自动归档文件备份。

归档的文件备份不能通过夜间或紧急清理来删除 - 除非只有当它们不再是归档时。

你可以在 `设置` > `归档` 下为所有或特定客户端设置归档。

当归档到期且服务器当前处于归档窗口（参见 `12.5.1` ）时，所选类型的最后一个文件备份将在所选时间量内归档。

在那之后，它将不再自动归档。

你可以在 `Web` 页面的  `备份` 区域查看归档备份。

如果备份仅在有限的时间内归档，则复选标记旁边将显示一个时间符号。

将鼠标悬停在该时间符号上系统会告诉你该文件备份将保持归档多长时间。



###### 12.5.1 归档窗口

归档窗口允许你在特定的时间归档备份。

格式与 `crontab` 非常相似。

除了没有分钟之外，这些字段是相同的：

| Field/字段   | Allowed values/可用值 | Remark/备注               |
| ------------ | --------------------- | ------------------------- |
| Hour         | 0-23                  | 小时                      |
| Day of month | 1-31                  | 日期                      |
| Month        | 1-12                  | 月份，字母名称不可用      |
| Day of week  | 0-7                   | 周几，`0` 和 `7` 代表周日 |

 

要在每个月的第一个周五归档文件备份，我们会将 `归档间隔` 设置为 `27` 天。

输入我们希望归档备份的时间后，我们将添加如下代码

```
*;*;*;5
```

作为窗口（小时；月中的某天；月；周中的某天）。

要在每周五归档备份，我们会将 `存档间隔` 设置为大于 `1` 天但小于 `7` 天的值。

之所以可行，是因为必须满足两个条件：自上次备份归档以来的时间必须大于 `归档间隔` ，并且服务器当前必须位于归档窗口中。

其他例子更简单。

要在每个月的第一天归档备份，窗口将是

```
*;1;*;*
```

和 `归档每个` 大约 `2-27` 天。

可以通过逗号分隔它们来为每个字段添加多个值，像这样

```
*;*;*;3,5
```

 并且 `每天归档` 一天将在周三和周五存档备份。

`crontab` 中的其他高级功能不存在。 



##### 12.6 适合的文件系统





 











##### 11.1 手动更新 `UrBackup` 客户端

在客户端上使用 `UrBackup` 客户端之前，你应该先对其进行一些测试。

意思是有可能 `UrBackup` 不会自动从 `Internet` 下载最新的客户端版本并进行安装。

这就意味着在第 `9.1.8` 节中描述的自动更新被禁用了。

如果禁用了自动更新，你仍然可以从服务器集中更新客户端。

转至 `https://hndl.urbackup.org/Client/` 并将当前客户端更新文件夹中的所有文件下载到 `Linux` 上的  `/var/urbackup` 或 `Windows` 上（默认）的 `C:\Program Files\UrBackupServer\urbackup` 。

`UrBackup` 将在重新建立连接后推送新版本到客户端。

如果你启用了静默自动更新，则新版本将静默安装在客户端上，否则将弹出窗口要求用户安装新版本。 



##### 11.2 日志记录

`UrBackup` 通常将所有与备份相关的内容记录到几个日志工具中。

每条日志消息都具有相应的严重程度，即错误、警告、信息或调试。

每条日志输出都可以根据此严重程度过滤，例如只显示错误。

服务器和客户端都有单独的日志。

在备份过程中，`UrBackup` 服务器尝试将属于某个备份的所有内容记录在客户端特定的日志中，最后将该日志发送给客户端。

这些是你在客户端界面上看到的日志。

也可以通过 `Web` 界面的 `日志` 选项卡区域查看相同的日志。

如第 `9.2.2` 小节所述，你也可以通过邮件发送它们。



无法授权给特定客户端或会导致过多日志流量的所有内容都记录在通用日志文件中。 

服务器的日志文件默认在 `Linux` 上是 `/var/log/urbackup.log` ，在 `Windows` 上则是 `C:\Progam  files\UrBackupServer\urbackup.log` 。

而相应地客户端日志文件默认是 `/var/log/urbackup_client.log` 和 `C:\Progam files\UrBackup\debug.log`。

默认情况下，这些文件仅包含严重警告或更高级别的日志消息。

在 `Windows` 中，有一个 `args.txt` 文件与日志文件位于同一目录中。

将此文件的 `--loglevel` 的 `warn` 更改为 `debug` 、`info` 或 `error` 以获取一组不同级别的日志消息。

图a01



你需要重新启动服务器才能使此更改生效。

在 `Linux` 上，这取决于具体不同的发行版命令。

在 `Debian` 上，则要更改 `/etc/default/urbackupsrv` 中的设置。



##### 11.3 使用的网络端口

服务器绑定到以下默认端口：

| Port/端口 | Usage/用途                    | Incoming/Outgoing<br />进/出（方向） | Protocol/协议 |
| --------- | ----------------------------- | ------------------------------------ | ------------- |
| `55413`   | 为 `web` 接口服务的 `FastCGI` | Incoming/进                          | `TCP`         |
| `55414`   | `HTTP web` 管理接口           | Incoming/进                          | `TCP`         |
| `55415`   | `Internet` 客户端访问         | Incoming/进                          | `TCP`         |
| `35623`   | 用于发现的 `UDP` 广播端口     | Outgoing/出                          | `UDP`         |

 

客户端绑定到以下默认端口：

| Port/端口 | Usage/用途                   | Protocol/协议 |
| --------- | ---------------------------- | ------------- |
| `35621`   | 备份期间发送文件（文件服务） | `TCP`         |
| `35622`   | 用于发现的 `UDP` 广播端口    | `UDP`         |
| `35623`   | 发送指令或用于映像备份       | `TCP`         |



##### 11.4 在 `GNU/Linux` 上挂载（压缩的）`VHD` 文件

如果你使用 `fuse`（用户空间中的文件系统）支持编译 `UrBackup` 或安装了 `Debian/Ubuntu` 软件包，则 `UrBackup` 服务器可以直接挂载 `VHD(Z)` 文件。

你可以通过配置来编译带有 `fuse` 支持的 `UrBackup` ：

```
./configure --with-mountvhd
```

你可以通过如下方法挂载 `VHD(Z)` 文件。

```
urbackupsrv mount-vhd --file /media/backup/urbackup/testclient/\  
Image_C_140420-1956.vhdz --mountpoint /media/testclient_C
```

备份的 `C` 卷中的所有文件将在 `/media/testclient_C` 中有效可读。

卸载由 `UrBackup` 创建的挂载（参见 `mount` 的输出），以停止后台进程。 



##### 11.5 在 `Windows` 上将 `VHD` 挂载为卷

从 `Vista` 开始，`Windows` 可以直接挂载 `VHD` 文件。

如果 `VHD` 文件被压缩，则需要先对其进行解压缩（参见下一节 `11.6`）。

然后进入 `系统设置` > `管理` > `计算机管理` > `磁盘管理` > `其他操作` > `添加虚拟硬盘` ，以只读方式装载 `VHD` 文件。

该映像将在资源管理器中显示为另一个驱动器。

如果 `VHD` 文件位于网络驱动器上，它可能不起作用。



##### 11.6 解压 `VHD` 文件

考虑使用下一节 `11.7` 中描述的方法来解压 `VHD` 文件。

如果要在 `Windows` 上挂载 `VHD` 文件并且它们是压缩的（文件扩展名为 `VHDZ`），则需要先解压缩它们。

使用  `C:\Program Files\UrBackupServer\uncompress_image.bat`  正是为了这个原因。

调用不带参数的批处理文件将打开一个文件选择窗口，你可以在其中选择要解压缩的 `VHDZ` 文件。

解压缩完成后，会创建一个膨胀的临时副本并自动重命名。

如果映像是增量的，则父级 `VHD` 也会自动解压缩。

如果你想防止这种情况发生，请使用第 `11.7` 节中描述的方法来构建单独的未压缩映像。

所有映像文件仍将具有 `VHDZ` 扩展名，否则将不得不更改数据库条目，但文件将不再被压缩。

在 `Linux` 上，可以使用 `urbackupsrv decompress-file -f [filename]` 完成相同的操作。



##### 11.7 将多个 `VHD` 卷映像整合成一个 `VHD` 磁盘映像

`UrBackup` 分别存储每个卷的映像备份。

如果你想在不使用还原 `CD` 的情况下启动加载映像备份，那么作为一台虚拟机你必须将多个卷重新整合到一个磁盘 `VHD` 映像中。

在 `Windows` 上，可以通过运行 `C:\Program Files\UrBackupServer\assemble_disk_image.bat` 来完成。

在第一步中，它将要求整合 `VHD` 映像，例如选择 `Image_C_XXXXX.vhd` 和 `Image_SYSVOL_XXXXX.vhd` 。

源映像也可以是增量或压缩的。

然后它会询问输出的 `VHD` 磁盘映像应该保存在哪里。

之后，它会将 `Image_C_XXXXX.vhd.mbr` 的主引导记录和卷内容写入输出磁盘映像中的适当偏移量。

 在 `Linux` 上，同样的事情可以用

```
urbackupsrv -a /full/path/Image_C_XXXXX.vhdz -a /full/path/Image_SYSVOL_XXXXX.vhdz\  
-o full_disk.vhd
```

 通过选择单个 `VHD` 文件作为输入，此工具还可用于在不解压其父级的情况下解压缩映像。



##### 11.8 迁移非 `btrfs` 备份存储

`UrBackup` 具有内置迁移功能，可让你以最少的停机时间将备份存储迁移到不同的设备。

这仅适用于普通备份存储，也就是说，它不适用于第 `12.7.2` 节中描述的特殊 `btrfs` 模式或第 `12.7.1` 节中描述的写时复制映像。

迁移功能仅适用于迁移，不适用于镜像备份等。

与使用例如 `rsync` 相比，内置迁移有一些优点：

* 它可以以备份级别恢复迁移
* 它会自动禁用所有清理，以最大限度地减少迁移期间必要的更改量
* `UrBackup` 继续备份当前未迁移的客户端并自动迁移新备份
* `UrBackup` 可正确处理硬链接



在 `/var/urbackup` 或 `C:\Program Files\UrBackupServer\urbackup`  中创建一个名为 `migrate_storage_to` 的文件，其唯一内容是要将备份迁移至目的地的路径。

然后重新启动 `UrBackup` 服务器并开始迁移。

你可以在活动页面查看迁移进度。

迁移完成后，将设置中的备份存储路径更改为新位置或将新的备份存储挂载到旧位置。

然后运行第 12.4 节中描述的 `删除未知` 。 





### 小结

本节内容比较杂，包括手动更新客户端、日志记录、通讯端口以及 `VHD` 文件的挂载等等。

关于 `VHD` 挂载涉及的存储相关内容，将在下一小节阐述，敬请期待！



**扫码关注@网管小贾，个人微信：sysadmcc**

网管小贾 / sysadm.cc

