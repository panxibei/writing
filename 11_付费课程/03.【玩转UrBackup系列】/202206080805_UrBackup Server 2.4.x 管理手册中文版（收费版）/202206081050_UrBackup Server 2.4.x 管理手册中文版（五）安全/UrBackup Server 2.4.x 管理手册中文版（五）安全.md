UrBackup Server 2.4.x 管理手册中文版（五）安全

副标题：安全~

英文：administration-manual-for-urbackup-server-5

关键字：administration,manual,urbackup,backup,server,client,architecture



本篇内容讲述了 `UrBackup` 安全方面的内容。

通过本节内容的学习，我们可以更好地掌握不同客户端（用户）的权限管理，以及对 `UrBackup` 是如何实现安全备份可以有一个初步的了解。



### 5 `UrBackup` 的安全

任何系统都必须充分注重安全方面的问题，`UrBackup` 作为一款基于网络服务的备份解决方案，其安全问题自然也不容忽视。

基于此，我们可以从以下几个方面来说明 `UrBackup` 是如何应对和保障系统安全运行的。



##### 5.1 服务端 `Web` 界面的权限管理

`UrBackup` 服务端的 `Web` 管理页面系统拥有一套非常标准的用户系统，你可以按实际需求创建、管理或删除帐户。 

这些帐户仅通过权限的管理松散地与客户端相关联，意思是说，一个帐户对应着一个客户端，同时它可以视情况而拥有不同的权限。

请小心，在首次安装 `UrBackup` 服务端后，`Web` 管理页面并没有设置管理员密码，因此任何人都可以登录到 `Web` 管理页面并且可以随意查看所有的备份文件！

如果你想做到限制用户访问，那么你应该立即找到设置中的用户管理，创建管理员帐户并为其设置密码。

图01



管理员帐户可以做任何事情，包括浏览查看所有客户端的文件备份。

而在 `Web` 管理页面中则允许我们创建一个 `受限` 的普通帐户，并且该帐户只能在某个指定的客户端一侧浏览备份和查看统计信息。

更复杂一些的权限设定可以允许一个帐户访问多个客户端或者限制到某些特定权限。

例如，你可以设置一个帐户，该帐户可以执行除浏览备份之外的所有操作。

你可以限制或扩展帐户的权限，目前我们可以参考使用如下域：

（在 `UrBackup` 中，我们可以将这个 `域` 理解为通常用户权限中的角色概念，因此为了更好理解，在以下内容中我将之称为 `角色域` 。）



| Domain/角色域     | Description/描述                                             |
| ----------------- | ------------------------------------------------------------ |
| browse_backups    | 浏览和下载文件备份                                           |
| lastacts          | 查看服务器执行的最后操作（文件或映像备份）（包括备份大小和持续时间） |
| progress          | 查看当前运行的文件或映像备份的进度                           |
| settings          | 允许更改设置                                                 |
| client_settings   | 允许更改客户端特定设置                                       |
| status            | 允许查看当前状态（上次查看、上次文件备份和最后的映像备份）   |
| logs              | 查看备份期间创建的日志                                       |
| manual_archive    | 手动归档文件备份                                             |
| stop_backup       | 停止服务器上客户端的备份                                     |
| piegraph*         | 查看统计信息                                                 |
| users*            | 获取客户端名称                                               |
| general_settings* | 更改常规设置（如备份存储路径）                               |
| mail_settings     | 更改邮件服务器设置                                           |
| usermod*          | 创建、更改和删除用户                                         |
| remove_client*    | 删除客户端并删除其所有备份                                   |
| start_backup*     | 为服务器上的客户端启动备份                                   |
| download_image    | 通过恢复 `CD` 从服务器下载卷映像                             |

图02



从图示中，我们可以看到，截图表格左侧即为角色域，而中间所谓的权限列则是指用户的ID（第一个用户就是 `1` ，以此类推）。



你可以将前表格中未标有星号 ( `*` ) 的角色域依次赋予一个或多个客户端的用户ID（用 `,` 分隔），或者直接赋予所有用户ID `all` ，意为该帐户可以访问所有客户端。

带有星号（ `*` ）的角色域必须是属于 `all`  或 `none` ，要么是 `all` ，要么是 `none` ，是固定的，不可单独被赋予给某个客户端帐户。

因此为了能够查看统计信息，你需要将 `piegraph` 和 `users` 这两个角色域同时都赋予给 `all` 。



有一个特殊的角色域 `all` ，它是所有角色域的通配符。

这意味着如果将角色域 `all` 赋予给了所有用户ID `all` ，则该帐户就拥有了执行一切的至高无上的权限！

请注意区分，这个角色域 `all` 是和前面表格中所列一样的角色域之一，并不是用来指代所有用户ID的 `all` ，一个是角色域，一个是用户ID，虽说它俩名字是一模一样，都叫 `all` 。

好了，到目前为止，我们应该了解了，用户至少需要一个 `status` 角色域才能够使用户成功登录 `Web` 页面系统。



##### 5.2 让 `Web` 管理页面支持 `SSL` 访问

服务器 `Web` 管理页面可以通过 `FastCGI` （ `TCP` 端口 `55413` ）访问。

通过这种方式，你可以使用几乎所有现代 `Web` 服务来连接 `UrBackup` 使用，因此可以通过以下方式访问支持 `SSL` 的 `Web` 管理页面。

本节将描述如何使用 `Apache` 和 `Lighttp` 执行此操作。



###### 5.2.1 `Apache` 配置

在 `Apache` 设置中为 `UrBackup` 的 `www` 目录创建软链接，或是为其定义一个别名 `alias` 。

针对创建软链接的方法，你需要切换到你的 `SSL` 的 `Web` 根目录 `webroot` ，然后执行类似于如下操作。

```
ln -s /usr/share/urbackup/www urbackup
```



请确保你在 `Apache` 上创建软链接的配置项中设置了 `Option +FollowSymLinks` 。

然后启用 `Apache 2.x` 的模块插件 `mod_proxy_fcgi` 。

例如在 `Debian/Ubuntu` 上可以这样。

```
a2enmod proxy_fcgi
```

 

然后将其中的 `x` （某些）文件代理到本地（或远程）运行的 `UrBackup` `FastCGI` 服务器（默认端口 `55413` ）。

例如，将以下内容添加到您的 `SSL` 虚拟主机配置中。

```
ProxyPass "/urbackup/x" "fcgi://127.0.0.1:55413"
```



路径 `/urbackup/x` 取决于 `UrBackup` 的 `Web` 根目录（ `index.htm` 文件应该位于相同目录）以及你希望 `Web` 管理页面所在的位置。

好了，现在 `UrBackup` 应该可以通过 `Apache` 来访问了。



###### 5.2.2 `Lighttp` 配置

如 `Apache` 配置中所述，将 `urbackup/www` 目录链接到 `webroot` 。

添加以下代码到你的 `lighttp.conf` 文件中。

```
include “conf.d/fastcgi.conf” 
```



然后再添加以下代码到 `fastcgi.conf` 文件中。

```
fastcgi.server = ( 
	"/urbackup/x" => 
	((	“host”=>“127.0.0.1”， 
		“port”=> 55413 
	))  
) 
```



##### 5.3 客户端安全

`UrBackup` 客户端仅在服务器或接口进程为其提供凭据时才应答指令。

服务器凭据保存在 `/var/lib/urbackup/server_ident.key` 中。

如果这个文件不存在，那么服务器会在第一次启动时随机生成。



服务器身份标识也由 `私钥/公钥` 形式的密钥认证系统来确认。

如果这种密钥认证不存在，服务器将生成一套私有和公有的 `ECDSA` 密钥，分别是 `server_ident_ecdsa409k1.priv` 和 `server_ident_ecdsa409k1.pub` 。



客户端接口凭据也以相同的方式生成，并且驻留在客户端一侧 `UrBackup` 目录的 `pw.txt` 以及  `pw_change.txt` 两个文件中。

要提供客户端核心进程接口命令，你需要的 `pw.txt` 或 `pw_change.txt` 这两个文件的内容，其内容具体取决于如下某些命令。



`pw.txt`

- `Getting the current status` - 获取当前状态
- `Get the paths which are backed up during file backups` - 获取文件备份时备份的路径
- `Get the incremental file backup interval ` - 获取增量文件备份间隔
- `Start backups` - 开始备份
- `Pause backups` - 暂停备份



`pw_change.txt`

- `Change the paths which are backed up during file backups` - 更改文件备份期间备份的路径
- `Get all settings` - 获取所有设置
- `Change all settings`  - 更改所有设置
- `Get log entries/logs` - 获取日志条目/日志
- `Accept a new server` - 接受新服务器

 

默认情况下，只有特权用户可以访问 `pw_change.txt` 。

在 Windows 上，这会导致访问 `pw_change.txt` 内容会提示需要提升到管理员权限。

如果你不想让让提升权限的窗口老跳出来，请禁用 `UAC` 或更改 `pw_change.txt` 的访问权限以允许非特权用户读取访问。

客户端核心进程从它接受了指令并允许通过 `server_idents.txt` 中所描述的下载文件后就保存了服务器凭据。

 `server_idents.txt` 文件中每行一个凭据，同时服务器的公钥也保存在其中。



如果想要手动将服务器添加到 `server_idents.txt` 中，则需要删除 `server_ident.key` 文件末尾前置的  `#I`  和 `#` 。

`UrBackup` 在安装完成时 `server_idents.txt` 并不存在，之后客户端核心进程才接受（并添加）它看到的第一台服务器（使用服务器的公钥）。

在此之后，客户端不会接受具有不同凭据的其他服务器，并且一旦客户端检测到新服务器，则需要手动添加它们的凭据，或者通过单击弹出窗口来操作。

这可以防止其他人访问你想在公共场所备份的文件。

如果你想让多台服务器能够对一台客户端进行备份，那么你可以有两种选择。

要么，你手动向客户端提供服务器凭据（通过将凭据复制到 `server_idents.txt` 中），要么，通过复制相同的 `server_ident.key` 、 `server_ident_ecdsa409k1.priv` 和 `server_ident_ecdsa409k1.pub` 这三个文件为所有服务器提供相同的凭据。 



##### 5.4 传输安全

从客户端到服务器的数据传输在本地网络上是未加密的，允许窃听攻击恢复备份数据的内容。

考虑到这一点，你应该只在受信任的本地网络中使用 `UrBackup` 。

请注意，如果没有采取任何措施来防止这种情况，那么在本地网络中流量被重定向则非常容易。 



##### 5.5 广域网模式安全

广域网模式使用增强身份验证和加密。

三次握手通过使用一个共享密钥以及基于 `SHA512` 的迭代次数为  `20000` 的 `PBKDF2-HMAC` 加密算法完成。

数据使用 `AES-GCM` 加密和验证。

此外，通过服务器身份密钥和 `ECDSA` 私钥/公钥身份验证来完成本地网络服务器的身份验证。 



### 小结

本节内容主要向小伙伴们展示了关于使用 `UrBackup` 安全方面的内容。

其中涉及到了服务端与客户端是如何建立连接并安全传输数据，以达到完成设置及正常备份的目的。

此外本节还涉及了 `Web` 管理权限的问题，以及使用 `SSL` 来加密访问 `Web` 管理页面的问题。

虽然本节只讲了一些理论知识，没有特别的测试实践过程，但是在手册之外我还写有其他具体实操的文章，其中就包含了大量的真实的关于安全方面的管理内容。

因此除了本管理手册外，我建议大家可以参考其他更多的具体实战文章，这样更接进实际使用，更能使大家深刻理解学习关于 `UrBackup` 方面的知识。

好了，本小节就先到这儿吧，祝各位学习进步！



**扫码关注@网管小贾，个人微信：sysadmcc**

网管小贾 / sysadm.cc

