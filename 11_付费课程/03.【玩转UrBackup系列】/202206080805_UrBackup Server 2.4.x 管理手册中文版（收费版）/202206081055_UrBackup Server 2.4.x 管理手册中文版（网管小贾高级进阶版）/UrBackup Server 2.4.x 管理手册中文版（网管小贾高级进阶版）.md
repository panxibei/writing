























## `UrBackup Server 2.4.x` 管理手册中文版（网管小贾高级进阶版）

### Administration Manual for UrBackup Server 2.4.x (Advanced Chinese Version)

![网管小贾 / sysadm.cc](.\qrcode.png)

**作者：Martin Raiber (February 19, 2018)**

**译者：网管小贾 / sysadm.cc (2022年6月20日)**





















## 0 参考目录

* 1 开篇介绍
* 2 服务器安装
  * 2.1 `Windows` 上的服务器安装
  * 2.2 `Ubuntu` 上的服务器安装
  * 2.3 `Debian` 上的服务器安装
  * 2.4 在其他 `GNU/Linux` 发行版或 `FreeBSD` 上安装服务器
  * 2.5 `GNU/Linux` 服务器安装提示
  * 2.6 操作系统独立服务器安装步骤

* 3 客户端安装
  * 3.1 `Windows` 客户端安装
  * 3.2 自动部署到多台 `Windows` 计算机
  * 3.3 `Linux` 客户端安装
  * 3.4 `Mac OS X` 客户端安装（追加内容，官网手册无此内容）

* 4 架构
  * 4.1 服务器架构
  * 4.2 客户端架构

* 5 安全

  * 5.1 服务端 `Web` 界面的权限管理
  * 5.2 让 `Web` 页面可通过 `SSL` 访问
    * 5.2.1 `Apache` 配置
    * 5.2.2 `Lighttp` 配置

  * 5.3 客户端安全
  * 5.4 传输安全
  * 5.5 广域网模式安全

* 6 局域网中的客户端发现

* 7 备份过程
  * 7.1 文件备份
  * 7.2 映像备份
  * 7.3 数据冲突概率
    * 7.3.1 文件备份冲突概率
    * 7.3.2 映像备份冲突概率
  * 7.4 客户端和服务器上的备份前后脚本
    * 7.4.1 客户端备份前后脚本
    * 7.4.2 服务器后备脚本

* 8 广域网客户端
  * 8.1 自动推送服务器配置到客户端
  * 8.2 下载预配置的客户端安装程序
  * 8.3 手动添加和配置客户端
  * 8.4 通过 `Internet` 传输文件

* 9 服务器设置

  * 9.1 全局服务器设置
    * 9.1.1 备份存储路径
    * 9.1.2 服务器网址
    * 9.1.3 禁止磁盘镜像备份
    * 9.1.4 禁止文件备份
    * 9.1.5 自动关闭服务器
    * 9.1.6 从更新服务器下载客户端
    * 9.1.7 当新有服务器版本可用时通知我
    * 9.1.8 自动更新客户端
    * 9.1.9 最大同时备份数
    * 9.1.10 最近活动客户端的最大数量
    * 9.1.11 清理时间窗口
    * 9.1.12 自动备份 `UrBackup` 数据库
    * 9.1.13 本地网络的总体最大备份速度
    * 9.1.14 全局软文件系统配额
  * 9.2 邮件设置
    * 9.2.1 邮件服务器设置
    * 9.2.2 配置报告

  * 9.3 客户端特定设置

    * 9.3.1 备份窗口
    * 9.3.2 高级备份间隔
    * 9.3.3 排除文件
    * 9.3.4 要备份的默认目录
    * 9.3.5 虚拟子客户端名称

  * 9.4 广域网设置

    * 9.4.1 数据使用限额预估

  * 9.5 高级设置

    * 9.5.1 启用临时文件缓冲区

    * 9.5.2 传输模式
    * 9.5.3 增量映像备份样式
    * 9.5.4 完整映像备份样式
    * 9.5.5 批处理期间的数据库缓存大小

  * 9.6 在增量文件备份期间使用符号链接

  * 9.7 调试：所有文件备份的端到端验证

  * 9.8 调试：使用客户端哈希验证文件备份

  * 9.9 定期将 `Internet` 客户端的文件条目读入数据库

  * 9.10 文件备份后为客户端上的每个用户创建符号链接视图

  * 9.11 每个客户端同时作业的最大数量

  * 9.12 映像备份期间要分组快照的卷

  * 9.13 文件备份期间要分组快照的卷
  * 9.14 `Windows` 组件备份配置

* 10 恢复备份
  * 10.1 恢复镜像备份
  * 10.2 恢复文件备份

* 11 杂项

  * 11.1 手动更新 UrBackup 客户端

  * 11.2 日志记录
  * 11.3 使用的网络端口
  * 11.4 在 GNU/Linux 上挂载（压缩）VHD 文件
  * 11.5 在 Windows 上将 VHD 挂载为卷

  * 11.6 解压 VHD 文件

  * 11.7 将多个卷 VHD 映像组装到一个磁盘 VHD 映像中

  * 11.8 迁移非 `btrfs` 备份存储

* 12 存储

  * 12.1 每晚备份删除
  * 12.2 紧急清理
  * 12.3 清理具有大量备份文件的服务器
  * 12.4 清理具有 `UrBackup` 未知文件的存储文件夹
  * 12.5 归档
    * 12.5.1 归档窗口
  * 12.6 合适的文件系统
    * 12.6.1 `Ext4/XFS`
    * 12.6.2 `NTFS`
    * 12.6.3 `btrfs`
    * 12.6.4 `ZFS`

  * 12.7 存储设置建议
    * 12.7.1 `ZFS`
    * 12.7.2 `Btrfs`









































## 1 开篇介绍

我从去年（2020年）开始就写过与开源备份软件 `UrBackup` 的相关文章。

只不过这些文章都是针对具体的业务实现而随之展开的操作方法。

可就在整个写作和测试的过程中，我发现或多或少的总有一些问题会跳出来给我一些难堪。

其次有不少小伙伴看了我的文章，在他们实践中也遇到了这样那样的奇葩问题，因此也来和我一起探讨。

由于我的基础也仅限于安装使用这种应用层面的水平，所以自然对于有些问题也是一知半解，甚至无法完美解答。

为了避免尴尬，同时也是为了更好地为小伙伴们服务，我决定将 `UrBackup` 的管理手册重新再翻出来过一遍。

当然了，这一次可不是照本宣科，我想做的是，在搬运的同时加入我自己实践并理解的东西，翻译、测试一个也不能少，尽力让大家能学习看懂并有效避坑。



据官网上的介绍，目前为止全球已经有超过 `21000` 多的 `UrBackup` 运行实例，其中主要集中在欧美地区。

相对而言，我国使用的数量显得少之又少，不过近几年随着应用日益广泛，使用它的用户也与日俱增。

![](..\202206080806_UrBackup Server 2.4.x 管理手册中文版（一）开篇介绍\02.JPG)



国人对于开源软件，特别是免费开源软件那热情绝对不减反增，开源软件就是香！

当然了，开源软件的一个众所周知的小问题，就是什么都得自己搞定，似乎对于新手小白来说有点小麻烦哈！

因此自然而然，有更多的人也更加迫切地需要学习和了解 `UrBackup` 。

那么正好，我学一遍正好大家也一起学一遍，独乐乐不如众乐乐！



这里友情提示一下，官网的管理手册应以网页版为准，似乎 `PDF` 版本的最后更新时间要早于网页版本，因此请各位小伙伴们务必注意了！

> 官方管理手册（英文）链接：https://www.urbackup.org/administration_manual.html



好了，我们就此开篇介绍。



什么是 `UrBackup` ？

我猜应该是 `Ur` + `Backup` 的组合，哈哈这不是废话嘛！

`Backup` 不用多说，自然是备份的意思，那么 `Ur` 是啥意思呢？

官网上我没有找到具体的含义，不过我个人猜测，应该是英文 `Your` 的简写，意为 `你的` 。

那么 `UrBackup` 的意思就是 `你的备份（软件）` ，即 `Your Backup` 。

好了，胡诌适可而止，让我们来看看 `UrBackup` 的官方特色介绍。



`UrBackup` 是一款易用的开源的 `C/S` 构架的备份系统，它通过映像和文件备份组合的方式来实现数据的安全保障并且可快速地做到备份和恢复数据。

`UrBackup` 具有以下几个特点。

1、采用 `C/S` 构架，这意味着它是一个服务器软件和 N 个客户端软件这样的结构。

2、当然服务器也可以是多个，这取决于是否有多个不同的网段。

3、客户端软件可以在 `Windows` 、`Linux` 和 `Mac OS X` 上跑，但只有 `Windows` 客户端能够执行映像备份。

4、服务端软件可以在 `Windows` 、`LInux` 和 `FreeBSD` 上跑。

5、`UrBackup` 已经被设计得非常智能，所以通常只要使用默认设置即可正常运行，因此你要做的仅仅是在服务端定义备份路径，在客户端说明应该备份哪些目录即可。（更多设置请参阅第 `9` 章）

6、一旦设定完毕，服务器将自动发现客户端，备份将随时进行，不影响其他程序进程的正常运行。

7、当客户端移动到另一个网络中时，服务器也会自动发现它进而开始备份，此时安全性部分显得尤为重要。（请参阅第 `5` 章）

8、持续监视备份文件夹，快速寻找差异，快速实现增量备份。注意，`UrBackup` 的增量备份是指一个完整备份的基础上再叠加增量部分，而非只有增量部分，所以增量备份的大小并不一定比完整备份小，这也是初次接触 `UrBackup` 时容易被误解的地方之一。

9、备份可通过 `Web` 界面、客户端、 `Windows` 资源管理器或 `CD` 、`USB` 引导等等多种方式进行恢复。



除了以上这些特点外，管理手册中还有涉及到诸多实际操作方面的说明，比如安全性、备份的具体过程、服务器的详细设置、邮件报告、客户端特定设置、互联网备份、备份恢复等等。

本文开篇介绍，旨在为给大家呈现一个完整的 `UrBackup` 中文管理手册而抛砖引玉。

本文还未涉及任何实际的操作，所以仅仅给小伙伴们提供了一些理论和概念性的东西，先做入门之用。

在下一篇中，我们将继续介绍 `UrBackup` 在不同平台上的安装实操，包括服务端和客户端。





## 2 服务端的安装

通常我们学习一套软件，总会先尝试安装它，然后再通过熟悉它的界面以及配置操作来掌握使用它。

`UrBackup` 既然是 `C/S` 构架的，那么它肯定是分为服务端和客户端。

OK，那我们先来了解 `UrBackup` 的服务端是如何安装的。

在这里我们要知道，`UrBackup` 是支持多平台操作系统的，所以下面我们会针对不同的平台分别说明。

当前演示版本为 **`UrBackup Server 2.4.13`** 。



##### 2.1 在 Windows上安装服务器

**演示操作系统版本：Windows Server 2016**



###### 2.1.1 直接安装

直接到官方首页即可下载到 `exe` 格式的安装软件包。

或者在下载页面找到 `msi` 这种 Windows 平台特有的安装文件，只不过 `msi` 只支持 `Vista/2008` 及其以后版本的 64 位系统。

理所当然，我选择并下载了 `exe` 格式的安装包，它在哪个版本上都能安装，注意，同时它也支持 32 位系统。



安装过程极其简单，下一步搞定一切。

![](..\202206080934_UrBackup Server 2.4.x 管理手册中文版（二）安装服务端\01.JPG)

![图02](..\202206080934_UrBackup Server 2.4.x 管理手册中文版（二）安装服务端\02.JPG)

![](..\202206080934_UrBackup Server 2.4.x 管理手册中文版（二）安装服务端\03.JPG)

![](..\202206080934_UrBackup Server 2.4.x 管理手册中文版（二）安装服务端\03.JPG)



安装完毕后，打开服务器上的浏览器，再打开网址 `http://localhost:55414` 即可访问管理配置页面。

如果要在其他电脑上访问服务器，那么别忘记开放服务器上防火墙的 `TCP` `55414` 端口。

打开配置页面，首先要做的就是设置 `UrBackup` 的备份目标文件夹（备份存储路径），也就是设置将来备份放在哪儿。



注意啦！这个备份文件夹可不是随便选的，它必须满足以下条件。

1. 它应该放在 `NTFS` 格式的分区（卷）上，而不能是 `ReFS` 或 `FAT` 等其他格式的分区。

2. 要保证它有足够的可用空间来容纳备份。

3. 最好它是专门放备份的，而不要兼作他用。

4. 它应该在 `UrBackup` 服务实例运行时一直处于在线状态，`UrBackup` 并不支持不同的备份卷或驱动器。

5. 虽然它可以被迁移，但过程漫长且异常困难，所以最好提前做好规划。

6. 如果你使用 `Windows` 动态卷或硬件 `raid` ，那么你就可以轻松扩展备份存储卷的大小。

   如果你使用的是普通卷，若想将来备份文件夹有扩展性，请在首次备份之前将其更改为动态卷。

   具体可以参考我写的《Windows 运用 UrBackup 备份服务的最佳实践》一文。

7. 为 `UrBackup` 备份文件夹打开压缩（资源管理器中：右键单击选择属性）。

   如果服务器不是很旧的话，它可以节省空间而不用降低备份速度。

   不过有可能会有例外情况：

   如果你想要备份超过 50GB 的容量大小时，那么你不应该开启压缩，因为 `NTFS` 无法压缩超过 50GB 的文件。

8. 作为压缩的替代方案，你还可以使用 `Windows Server 2012` 中的脱机重复数据删除和压缩构建。

9. 请在分区或卷上禁用 `8.3 名称生成`。

   有关如何执行此操作，请参阅 `https://support.microsoft.com/en-us/kb/121007` 。

   `8.3 名称生成` 在极少数情况下会导致错误，降低性能，并且 `8.3 名称` 仅在极少数情况下使用。

   

   输入以下命令后重启系统来禁用 `8.3 名称生成` ：

   ```
   fsutil behavior set disable8dot3 1
   ```

   

10. 如果你使用的是 `Windows Server 2008(R2)`（或等效桌面版本），可能会有 `NTFS` 卷碎片化严重而导致复制文件失败的系统问题，则应考虑应用修补程序 `https://support.microsoft.com/en-us/kb/967351`，然后使用以下命令格式化备份存储卷。

    ```powershell
    Format <Drive:> /FS:NTFS /L
    ```

    这可以防止这些操作系统上的大文件操作出现潜在问题。

    由于 `Windows Server 2008(R2)` 或 `Vista` 之类系统的生命同期已经结束，因此微软官网相关的更新补丁也不再提供，基于此建议大家尽量使用较新的 `Windows` 版本系统以避免出现大文件读写失败问题。



###### 2.1.2 用巧克力来安装

`Windows` 下居然还有其他安装方式，是不是挺新鲜？

慢着，这巧克力是啥？

它就是 `Chocolatey` ，好嘛，等于没说！

其实它类似于 `Linux` 下的包管理软件，只是它专门服务于 `Windows` 。

没用过 `Linux` 的小伙伴可能会懵，听我给你解释。

我们平时在 `Windows` 上安装软件都是先双击后下一步，这种方式本身好像没啥毛病，但是软件一多你就会发现，没办法好好管理了，进而导致软件混乱不堪。

这时我们急需一个统一下载管理的办法，所以仿照 `Linux` ， `Chocolatey` 也就应运而生了。

有了 `Chocolatey` ，所有的被它支持的软件我们只要通过它就可以统一安装管理了，不再需要一个一个地自己手动费心费力了。



如何安装 `Chocolatey` ：

> https://chocolatey.org/install#individual

```powershell
# 请在 PowerShell 中执行
# 开放安全限制
Set-ExecutionPolicy Bypass -Scope Process

# 安装 Chocolatey
Set-ExecutionPolicy Bypass -Scope Process -Force; [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))
```



用 `Chocolatey` 安装 `Urbackup` 。

```
choco install urbackup-server
```



接下来可以跳转至 `2.6` 节继续操作系统的后续安装步骤了。



##### 2.2 在 Ubuntu 上安装服务器

**演示操作系统版本：Ubuntu 20.04.2 LTS**



使用以下命令安装 `UrBackup` 服务端。

```
# 获取指向 UrBackup 的更新源
sudo add-apt-repository ppa:uroni/urbackup

# 更新系统源
sudo apt-get update
sudo apt-get install urbackup-server
```



获取 `UrBackup` 更新源时，需要回车确认一下。

![](..\202206080934_UrBackup Server 2.4.x 管理手册中文版（二）安装服务端\05.JPG)



开始安装后，首先提示设定保存路径，比如这里指定为 `/BACKUP` 。

![](..\202206080934_UrBackup Server 2.4.x 管理手册中文版（二）安装服务端\06.JPG)



之后再耐心等待一会儿就完成安装了。

这时就可以打开 `http://serverip:55414` 来访问 `Web` 管理界面了。



##### 2.3 在 Debian 上安装服务器

**演示操作系统版本：Debian 10.10**



输入以下命令开始安装 `UrBackup` 。

```
# 命令中可依据实际具体的版本号修改
sudo apt-get update
wget https://hndl.urbackup.org/Server/2.4.13/urbackup-server_2.4.13_amd64.deb
sudo dpkg -i urbackup-server_2.4.13_amd64.deb
sudo apt-get -f install 
```



下载当前最新稳定版本 `urbackup-server_2.4.13_amd64.deb` 。

![](..\202206080934_UrBackup Server 2.4.x 管理手册中文版（二）安装服务端\07.JPG)



可能需要你安装一些依赖，比如 `sqlite3` 和 `libcurl3-nss` 。

![](..\202206080934_UrBackup Server 2.4.x 管理手册中文版（二）安装服务端\08.JPG)



安装完成。

![](..\202206080934_UrBackup Server 2.4.x 管理手册中文版（二）安装服务端\09.JPG)



##### 2.4 在 FreeBSD 上安装服务器

**演示操作系统版本：FreeBSD-13.0-RELEASE-amd64**



`FreeBSD` 是一种 `Unix` 系统，它的应用也十分广泛，所以官网上仅有 `FreeNAS` 上安装 `UrBackup` 的介绍。

虽然如此，但只要是 `FreeBSD` 平台的系统都是差不多的安装方法。

类似详细的安装方法可以参考我以前的文章。

> 《XigmaNas+UrBackup打造个人整机备份方案》



简单地说，由两大步骤完成。

第一步，执行安装命令。

```
pkg update
pkg install urbackup-server
sysrc urbackup_server_enable=YES
```

![](..\202206080934_UrBackup Server 2.4.x 管理手册中文版（二）安装服务端\10.JPG)

![](..\202206080934_UrBackup Server 2.4.x 管理手册中文版（二）安装服务端\11.JPG)



第二步，如果你使用 `root` 用户来安装并运行 `UrBackup` ，则需要修改配置文件，将用户改为 `root` 。

```
# 修改配置文件 /usr/local/etc/urbackup/urbackupsrv.conf
# 将 USER="urbackup" 修改为 USER="root"
USER="root"
```

![](..\202206080934_UrBackup Server 2.4.x 管理手册中文版（二）安装服务端\12.JPG)



以上两个步骤可以在默认系统上安装，也可以创建 `jail` 虚拟机后在 `jail` 上安装。

要注意管理用户和备份存储目录的权限。

```
# 创建备份目录
mkdir -p /mnt/backup/backups

# 修正备份目录的用户所属，比如你的用户是 urbackup ，则修改成 urbackup
chown urbackup:urbackup /mnt/backups/backups
```



此外，可以通过重复操作以上步骤来更新到新版本的 `UrBackup` 。



##### 2.5 在其他 GNU/Linux 发行版上安装服务器

`UrBackup` 项目已经托管到了 `OpenSUSE` 网站上，通过点击不同的图标来显示具体的安装步骤。

> 参考链接：https://software.opensuse.org/download.html?project=home%3Auroni&package=urbackup-server

![](..\202206080934_UrBackup Server 2.4.x 管理手册中文版（二）安装服务端\13.JPG)



###### 2.5.1 在其他 GNU/Linux 发行版上以源码方式安装服务器

在 `http://urbackup.org/download.html` 页面上有相关详细信息，通常我们需要手动编译源码来安装服务器。

* 下载 `UrBackup` 服务端 `tarball` 源码并解压缩。
* 安装依赖项，比如 `gcc` 、 `g++` 、`make`  、 `libcrypto++` 以及 `libcurl` （就如开发版本中包含的那样）。
* 通过 `./Configure` 、`make` 和 `make install` 编译并安装服务端。
* 使用 `urbackupsrv run` 来运行服务器
* 将 `/usr/bin/urbackupsrv run -daemon` 添加到你的 `/etc/rc.local` 或其他系统启动配置文件中，以便在服务器启动时可以自动启动 `UrBackup` 服务器。



有关 `GNU/Linux` 系统的更多安装提示，请参阅第 `2.5.2` 节，有关独立于操作系统的安装步骤，请参阅第 `2.6` 节。



###### 2.5.2 关于 GNU/Linux 服务器安装的小提示

进入网页管理界面 `http://localhost:55414` ，在设置中配置备份存储路径。

关于备份存储路径的小提示：

* 它应该很容易扩展，这可以通过使用硬件 `raid`、卷管理器 `LVM` 或下一代文件系统 `btrfs` 和 `ZFS` 来实现。

* 你应该压缩文件备份。这可以通过使用 `ZFS` （`http://zfsonlinux.org/`）或 `btrf` 来实现。

* 推荐 `btrfs` ，因为 `UrBackup` 可以将每个文件备份放入单独的子卷中，并且能够在增量文件备份中执行基于块的廉价重复数据删除。

  有关如何设置 `btrfs` 备份存储，请参阅第 `12.7.2` 节。

  如果使用 `btrfs` ，你应该设置一个非常低的软文件系统配额（请参阅第 `9.1.14` 节），因为 `btrfs`  目前在空间不足的情况下仍然存在问题，可能需要手动干预。



##### 2.6 操作系统独立服务器安装步骤

安装 `UrBackup` 服务器后，你应该执行以下步骤：

* 转到用户设置并添加管理员帐户。如果你不这样做，每个可以访问服务器的人都将能够看到所有备份！

  ![](..\202206080934_UrBackup Server 2.4.x 管理手册中文版（二）安装服务端\14.JPG)

  

* 通过输入指定的邮件服务器设置来设定邮件服务器（请参阅第 `9.2.1` 节）。

* 如果你希望客户端能够通过 `Internet/广域网` 而不仅仅是通过本地局域网进行备份，请在 `Internet/广域网` 设置中配置服务器的公共服务器名称或 `IP`（参见第 `9.4` 节）。

* 如果你希望**客户端能够通过浏览器访问其备份**并可以通过右键单击指定备份来恢复/访问备份，那么请务必在设置中输入服务器的 `URL` 。

  例如你可以这样输入 `http://backups.company.com:55414/` ，但请确保你的 `DNS` 配置解析正常，如果从内部网络访问，`backups.company.com` 应当指向备份服务器的内部 `IP` ，否则应该解析为外部 `IP` 地址。

* 你应该在 `UrBackup` 前面放置一个真实的 `Web` 服务器并设置 `SSL`（请参阅第 `5.2` 节 ）。

* 如果你想查看备份失败的日志，请转到日志界面并为你的电子邮件地址配置报告。

* 根据你的使用场景修改任何其他设置。有关所有可用设置的说明，请参阅第 `9` 节。

* 安装客户端（请参阅第 `3` 节）。



#### 小结

本节为小伙伴们演示说明了各个服务器平台上安装 `UrBackup` 的要领方法。

作为开始了解 `UrBackup` 的重要一环，服务端安装有很多讲究，而且还包含了使用前的一些准备设定工作，比如备份路径、服务器 `IP` 地址等，需要我们认真仔细地阅读前面所述内容。

好，在下一节我们为大家介绍客户端的安装和注意事项。

如果对本节还不太熟悉，请大家转发分享后再来看看吧！





















































## 3 客户端的安装

前一篇我们介绍了 `UrBackup` 服务端的安装，与之相对我们今天要介绍的客户端安装就要简单得多了。

如果你是在 `Windows` 下安装 `UrBackup` 客户端，那基本不需要了解什么操作知识就可以直接上手了。

不过，由于 `UrBackup` 是开源支持多平台的特性，所以也有必要介绍一下在除 `Windows` 平台下的安装方法。

此外，还有在面对批量用户的情况下，应该考虑批量自动的处理方法。

OK，我们一起来学习一下！



##### 3.1 Windows 客户端安装

如果你打算在与服务端相同子网的网络中使用客户端，或者客户端在设置期间位于本地网络中，那么可以这样来安装客户端。

- 从 `http://www.urbackup.org` 下载客户端程序。
- 运行安装程序。
- 保留备份项目的默认值，手动选择备份路径或从服务器配置客户端（参见第 `9.3.4` 节）。
- 服务器会自动发现客户端并开始备份。



如果客户端只能通过 `Internet` 或 `NAT` 等非本地网络的方式访问，那么可以这样安装客户端。

- 打开 `Web` 管理界面，在状态页面上添加一个新的 `Internet` 客户端。

  ![](..\202206081018_UrBackup Server 2.4.x 管理手册中文版（三）安装客户端\01.JPG)

  

  ![](..\202206081018_UrBackup Server 2.4.x 管理手册中文版（三）安装客户端\02.JPG)

  

- 从网上下载到客户端上并安装。

  或者，为新客户端创建一个帐户（在 `Web` 界面的 `设置` > `用户` 中）并将 `用户名/密码` 发送给客户端的用户（注意，用户名大小写敏感）。

  然后，用户就可以从服务端状态页面上下载客户端安装程序并进行安装。

  **注意，经过测试，从服务端状态页面并不能找到可下载的客户端程序。**

  

- 在客户端上选择所需备份路径或在服务器上配置适当的默认备份路径（参见第 `9.3.4` 节）。

- 一旦与客户端建立连接，服务器将自动开始备份。

这是最简单的添加 `Internet` 客户端的方法，添加 `Internet` 客户端的其他方法详见第 `8` 节。



##### 3.2 自动部署到多台 `Windows` 计算机

首先，如果你想选择不同于安装后默认设置的备份路径，可以自行配置一般默认备份路径，统一为每个客户端默认备份相应的文件夹（请参阅第 `9.3.4` 节），然后再使用以下方法之一安装客户端。



* 本地网络客户端

将 `MSI` 客户端安装程序通过组策略添加到域控制器。

或者，你可以使用带有开关 `/S` 的 `NSIS (.exe)` 安装程序进行静默安装，并使用 `psexec` 之类的东西。

服务器将自动寻找并备份新客户端。



* 广域网客户端

从以下链接中获取 `Python` 脚本，并将脚本放在服务端可被客户端访问的 `URL` 链接中。

> https://urbackup.atlassian.net/wiki/display/US/Download+custom+client+installer+via+Python 



该脚本在客户端上访问并执行，可自动在服务器上创建客户端，执行环境为 `Python 3`，当前支持 `UrBackup 2.x` 。

你还可以在执行脚本时添加静默安装开关 `/S`，这样它就无需用户干预了。



**批量部署UrBackup客户端脚本.py.7z**

下载链接：https://pan.baidu.com/s/1IWkkh0zH1CZCRUb7iI3MkA

提取码：<关注网管小贾微信公众号，发送000855>



**脚本中只需修改前面的 `server_url` 之类的变量。**

```python
import http.client as http
import json
from urllib.parse import urlparse
from urllib.parse import urlencode
from base64 import b64encode
import hashlib
import socket
import shutil
import os
import binascii
  
#############################
# Settings. Please edit.
#############################
  
#Your server URL. Do not forget the 'x' at the end
server_url = 'http://example.com:55414/x'
  
  
#If you have basic authentication via .htpasswd
server_basic_username = ''
server_basic_password = ''
  
  
# Login user needs following rights
#   "status": "some"
#   "add_client": "all"
# Optionally, to be able to
# install existing clients:
#   "settings": "all"
server_username='adduser'
server_password='foo'
  
  
#############################
# Global script variables.
# Please do not modify.
# Only modify something after this line
# if you know what you are doing
#############################
  
session=""
  
def get_response(action, params, method):
    global server_url;
    global server_basic_username;
    global server_basic_password;
    global session;
      
    headers = {
        'Accept': 'application/json',
        'Content-Type': 'application/json; charset=UTF-8'
    }
      
    if('server_basic_username' in globals() and len(server_basic_username)>0):
        userAndPass = b64encode(str.encode(server_basic_username+":"+server_basic_password)).decode("ascii")
        headers['Authorization'] = 'Basic %s' %  userAndPass
      
    curr_server_url=server_url+"?"+urlencode({"a": action});
      
    if(len(session)>0):
        params["ses"]=session
      
    if method=='GET':
        curr_server_url+="&"+urlencode(params);
      
    target = urlparse(curr_server_url)
     
    if not method:
        method = 'GET'
         
    if method=='POST':
        body = urlencode(params)
    else:
        body = ''
      
    if(target.scheme=='http'):
        h = http.HTTPConnection(target.hostname, target.port)
    elif(target.scheme=='https'):
        h = http.HTTPSConnection(target.hostname, target.port)
    else:
        print('Unkown scheme: '+target.scheme)
        raise Exception("Unkown scheme: "+target.scheme)
      
    h.request(
            method,
            target.path+"?"+target.query,
            body,
            headers)
      
    return h.getresponse();
  
def get_json(action, params = {}):
      
    response = get_response(action, params, "POST")
      
    if(response.status != 200):
        return ""
      
    data = response.read();
      
    response.close()
          
    return json.loads(data.decode("utf-8"))
  
def download_file(action, outputfn, params):
      
    response = get_response(action, params, "GET");
      
    if(response.status!=200):
        return False
      
    with open(outputfn, 'wb') as outputf:
        shutil.copyfileobj(response, outputf)
     
    if os.path.getsize(outputfn)<10*1024:
        return False
     
    return True      
  
def md5(s):
    return hashlib.md5(s.encode()).hexdigest()
  
  
print("Logging in...")
  
salt = get_json("salt", {"username": server_username})
  
if( not ('ses' in salt) ):
    print('Username does not exist')
    exit(1)
      
session = salt["ses"];
      
if( 'salt' in salt ):
    password_md5_bin = hashlib.md5((salt["salt"]+server_password).encode()).digest()
    password_md5 = binascii.hexlify(password_md5_bin).decode()
     
    if "pbkdf2_rounds" in salt:
        pbkdf2_rounds = int(salt["pbkdf2_rounds"])
        if pbkdf2_rounds>0:
            password_md5 = binascii.hexlify(hashlib.pbkdf2_hmac('sha256', password_md5_bin,
                                               salt["salt"].encode(), pbkdf2_rounds)).decode()
     
    password_md5 = md5(salt["rnd"]+password_md5)
      
    login = get_json("login", { "username": server_username,
                                "password": password_md5 })
      
    if('success' not in login or not login['success']):
        print('Error during login. Password wrong?')
        exit(1)
         
    clientname = socket.gethostname()
          
    print("Creating client "+clientname+"...")
          
    new_client = get_json("add_client", { "clientname": clientname})
     
    if "already_exists" in new_client:
        print("Client already exists")
         
        status = get_json("status")
         
        if "client_downloads" in status:
            for client in status["client_downloads"]:        
                if (client["name"] == clientname):
                    print("Downloading Installer...")
                     
                    if not download_file("download_client", "Client Installer.exe",
                                 {"clientid": client["id"] }):
                        print("Downloading client failed")
                        exit(1)
        else:       
            print("Client already exists and login user has probably no right to access existing clients")
            exit(2)
    else:
        if not "new_authkey" in new_client:
            print("Error creating new client")
            exit(3)
             
        print("Downloading Installer...")
                  
        if not download_file("download_client", "Client Installer.exe",
                             {"clientid": new_client["new_clientid"],
                              "authkey": new_client["new_authkey"]
                              }):
              
            print("Downloading client failed")
            exit(1)
          
    print("Sucessfully downloaded client")
    os.startfile("Client Installer.exe")
    exit(0)
```



通过 `Python` 脚本实现批量部署，由于需要每个客户端都具备 `Python` 环境，所以个人感觉比较麻烦，大家可以视实际情况而行。



##### 3.3 `Linux` 上的客户端安装

如果你打算在与服务端相同子网的网络中使用客户端，或者客户端在设置期间位于本地网络中，那么可以这样来安装客户端。

- 从 `http://www.urbackup.org` 下载便携式二进制 `Linux` 客户端安装程序。

- 运行安装程序。

- 选择一种可用的快照机制。

  如果没有可用的快照机制，请考虑在 `LVM` 或 `btrfs` 上安装 `Linux` ，否则你将不得不在备份期间停止所有正在运行的应用程序，因为备份脚本会在备份周期内改动文件，从而对应用程序的执行造成影响。

- 服务器会自动找到客户端并开始备份。



如果客户端只能通过 `Internet` 或 `NAT` 方式访问，那么可以这样安装客户端。

- 在状态页面上添加一个新的 `Internet` 客户端。

- 下载 `Internet` 客户端的客户端安装程序并将其发送到新客户端。

- 从网上下载到客户端上并安装。

  或者，为新客户端创建一个帐户（在 `Web` 界面的 `设置` > `用户` 中）并将 `用户名/密码` 发送给客户端的用户（注意，用户名大小写敏感）。

  然后，用户就可以从服务端状态页面上下载客户端安装程序并进行安装。

  **注意，经过测试，从服务端状态页面并不能找到可下载的客户端程序。**

  

- 通过命令行选择要在客户端备份的备份路径。

  ````
  urbackupclientctl add-backupdir –path /
  ````

  或在服务器上配置合适的默认备份目录（参见第 `9.3.4` 节）。

- 一旦客户端连接，服务器将自动开始备份。



##### 3.4 `Mac OS X` 客户端安装（追加内容，官网手册没有此内容）

由于官网对于 `Mac OS X` 系统的支持好像仅限于论坛讨论，所以官网主页上未见实际安装步骤。

经过我一个星期的测试，终于不负众望找到了可以使用的安装程序包。

在此强调一下，如果你找的是 `2.4` 或 `2.5` 的安装包，多半是不能直接使用的。



测试系统环境：

* `UrBackup Server 2.4.13 (Windows)`
* `Mac OS X 10.9.3 Mavericks`
* `UrBackup Client 2.0.29`（后面会提供下载）



1、双击 `UrBackup Client 2.0.29` 安装包，点击继续。

![](..\202206081018_UrBackup Server 2.4.x 管理手册中文版（三）安装客户端\03.JPG)



2、选择安装位置。

![](..\202206081018_UrBackup Server 2.4.x 管理手册中文版（三）安装客户端\04.JPG)



3、确定安装位置并开始安装。

![](..\202206081018_UrBackup Server 2.4.x 管理手册中文版（三）安装客户端\05.JPG)



4、输入密码以便开始安装。

![](..\202206081018_UrBackup Server 2.4.x 管理手册中文版（三）安装客户端\06.JPG)



5、程序开始验证并安装。

![](..\202206081018_UrBackup Server 2.4.x 管理手册中文版（三）安装客户端\07.JPG)



6、很快安装即可完成。

![](..\202206081018_UrBackup Server 2.4.x 管理手册中文版（三）安装客户端\08.JPG)



7、在应用程序中可以看到 `UrBackup Client` 。

![](..\202206081018_UrBackup Server 2.4.x 管理手册中文版（三）安装客户端\09.JPG)



8、手动运行 `UrBackup Client` 或重启让它自己启动也可以。

点击图标，选择 `Status` 查看当前状态，正常情况下需要几分钟时候服务端即可自动发现并添加到客户端列表中。

![](..\202206081018_UrBackup Server 2.4.x 管理手册中文版（三）安装客户端\10.JPG)



9、点击图标，选择 `Infos` 查看版本等信息。

![](..\202206081018_UrBackup Server 2.4.x 管理手册中文版（三）安装客户端\11.JPG)



10、点击图标，选择 `Add/Remove backup paths` 添加修改需要备份的路径。

![](..\202206081018_UrBackup Server 2.4.x 管理手册中文版（三）安装客户端\12.JPG)



11、点击图标，选择 `Do full file backup` 或 `do incremental file backup` 可以开始执行完全备份和增量备份，当然在服务端也可以执行同样的操作。

![](..\202206081018_UrBackup Server 2.4.x 管理手册中文版（三）安装客户端\13.JPG)



我测试的 `Mac OS X` 版本是 `10.9` ，同样在其他更高版上测试也是没问题的。

但请小伙伴们注意，`UrBackup Client` 的 `2.4` 或是 `2.5` 我都没有测试成功，要小心如果失败尽早放弃。



**UrBackup Client 2.0.29.pgk.7z (5.05M)**

下载链接：https://pan.baidu.com/s/1GhT3s7f65W5QOi6KPL4k3g

提取码：<关注网管小贾微信公众号，发送000855>



#### 小结

本节向小伙伴们介绍分享了 `UrBackup` 客户端的安装方法，虽然相对服务端的安装来说比较简单，但在实际的安装实践中也可以有多种灵活的方法，大家可以按实际情况定制安装。

由于开源多平台的特质，所以具体的客户端安装方法可以参考官方下载页面，每个不同的平台有相应不同的具体安装方法。

今天分享就到这里，之后会继续介绍 `UrBackup` 的其他特性，敬请期待！















## 4 架构

`UrBackup` 分为服务端和客户端两大部分（ `C/S` 架构）。

服务端负责发现和备份客户端，在存储空间耗尽或存在太多备份时删除备份，同时还可以生成统计信息和管理客户端设置。

客户端则侦听服务端指令，比如告诉它应该构建一个文件列表，或者服务端想要传输下载哪个文件。

此外服务端还会开启一个通道，客户端可以在该通道上请求服务端开始备份，或者更新客户端的特定设置。



基于我自己的学习理解，制作了一张纯手绘架构图，供大家参考学习。

![](..\202206081045_UrBackup Server 2.4.x 管理手册中文版（四）架构\01.JPG)



OK，基于这张手绘架构图，我们再来阅读下面的内容会更好理解。



##### 4.1 服务端架构

服务端分为**核心**和**接口**两个部分。



目前服务端接口只支持 `Web` 界面的管理方式。

`Web` 界面可通过 `FastCGI`（端口 `55413`）和 `HTTP`（端口 `55414`）访问。

你可以利用 `FastCGI` 端口使 `Web` 界面通过 `SSL` 来访问（例如使用 `apache` ）。

有关详细信息，请参阅第 `5.2` 节。



服务端核心部分由多个不同任务的线程组成。

一个线程发现新客户端，另一个线程则检查客户端是否需要备份，而其他线程向客户端发送 `ping` 包以检查它们是否在线，或者向它们发送当前的备份状态。

还有一个线程则用于更新文件统计信息或删除旧备份。

正是因为 `UrBackup` 服务端由多线程任务组成，所以使用现代多核 `CPU` 会更加高效（核数越多越好！）。



##### 4.2 客户端架构

客户端分为**核心进程**和**接口进程**。



接口进程用于显示托盘图标和对话窗口，同时向核心进程发送设置和命令。

客户端核心进程在 `UDP` 端口 `35622` 上侦听来自服务端的广播消息，并在收到消息后将带有其名称的消息返回给服务端，名称使用的是 `Windows` 计算机名称。

它在 `TCP` 端口 `35623` 上侦听来自客户端接口进程和服务端的命令，并在 `TCP` 端口 `35621` 上侦听来自服务端的文件请求。

服务端在其命令端口上与每个客户端建立永久连接，客户端可以使用该连接请求备份或更改其设置。

客户端核心进程负责构建要备份的目录中所有文件的列表。

此列表在 `UrBackup` 客户端目录中创建为 `urbackup/data/filelist.ub` 。

为了加速目录列表的创建，要备份的目录会通过 `Windows` 变更日志被不断监视，`Windows` 变更日志只能用于整个分区。

因此，当某个卷的目录被第一次添加时，`UrBackup` 客户端核心进程就会将这个卷上的所有目录条目读取到 `urbackup/backup_client.db` 的客户端数据库文件中。

当卷被成功创建了索引之后，此数据库就会不断更新以便时刻与文件系统同步。

因此，如果卷发生了较大变化，数据库更新就会变得比通常更为频繁。

这不会带来很大的性能损失，因为仅仅是目录列表保存在数据库中。

更新每 10 秒发生一次，或者在请求文件列表时进行。

服务端从客户端获取文件列表，并通过客户端内置的文件服务下载变更的或新增的文件来开始备份。

映像备份仅可使用命令端口完成。



#### 小结

本节内容灰常简短，主要是根据管理员手册中的理论部分向大家展示。

了解了 `UrBackup` 的基本架构，对于我们更深入地了解它的工作机制和原理是很有帮助的。

在接下来的篇章中，很多程序工作的方式也是基于本篇所述的架构原理。

本节只涉及理论内容，故没有特别的测试实践过程，在之后的篇章中就会有大量的动手过程。

如果你有什么不明白的地方，也可以随时回过头来再反复研究一下。

OK，今天就先到这儿吧，今晚不加班庆祝一下，打工人不再 996 了！









## 5 安全

任何系统都必须充分注重安全方面的问题，`UrBackup` 作为一款基于网络服务的备份解决方案，其安全问题自然也不容忽视。

基于此，我们可以从以下几个方面来说明 `UrBackup` 是如何应对和保障系统安全运行的。



##### 5.1 服务端 `Web` 界面的权限管理

`UrBackup` 服务端的 `Web` 管理页面系统拥有一套非常标准的用户系统，你可以按实际需求创建、管理或删除帐户。 

这些帐户仅通过权限的管理松散地与客户端相关联，意思是说，一个帐户对应着一个客户端，同时它可以视情况而拥有不同的权限。

请小心，在首次安装 `UrBackup` 服务端后，`Web` 管理页面并没有设置管理员密码，因此任何人都可以登录到 `Web` 管理页面并且可以随意查看所有的备份文件！

如果你想做到限制用户访问，那么你应该立即找到设置中的用户管理，创建管理员帐户并为其设置密码。

![](..\202206081050_UrBackup Server 2.4.x 管理手册中文版（五）安全\01.JPG)



管理员帐户可以做任何事情，包括浏览查看所有客户端的文件备份。

而在 `Web` 管理页面中则允许我们创建一个 `受限` 的普通帐户，并且该帐户只能在某个指定的客户端一侧浏览备份和查看统计信息。

更复杂一些的权限设定可以允许一个帐户访问多个客户端或者限制到某些特定权限。

例如，你可以设置一个帐户，该帐户可以执行除浏览备份之外的所有操作。

你可以限制或扩展帐户的权限，目前我们可以参考使用如下域：

（在 `UrBackup` 中，我们可以将这个 `域` 理解为通常用户权限中的角色概念，因此为了更好理解，在以下内容中我将之称为 `角色域` 。）



| Domain/角色域     | Description/描述                                             |
| ----------------- | ------------------------------------------------------------ |
| browse_backups    | 浏览和下载文件备份                                           |
| lastacts          | 查看服务器执行的最后操作（文件或映像备份）（包括备份大小和持续时间） |
| progress          | 查看当前运行的文件或映像备份的进度                           |
| settings          | 允许更改设置                                                 |
| client_settings   | 允许更改客户端特定设置                                       |
| status            | 允许查看当前状态（上次查看、上次文件备份和最后的映像备份）   |
| logs              | 查看备份期间创建的日志                                       |
| manual_archive    | 手动归档文件备份                                             |
| stop_backup       | 停止服务器上客户端的备份                                     |
| piegraph*         | 查看统计信息                                                 |
| users*            | 获取客户端名称                                               |
| general_settings* | 更改常规设置（如备份存储路径）                               |
| mail_settings     | 更改邮件服务器设置                                           |
| usermod*          | 创建、更改和删除用户                                         |
| remove_client*    | 删除客户端并删除其所有备份                                   |
| start_backup*     | 为服务器上的客户端启动备份                                   |
| download_image    | 通过恢复 `CD` 从服务器下载卷映像                             |

![](..\202206081050_UrBackup Server 2.4.x 管理手册中文版（五）安全\02.JPG)



从图示中，我们可以看到，截图表格左侧即为角色域，而中间所谓的权限列则是指用户的ID（第一个用户就是 `1` ，以此类推）。



你可以将前表格中未标有星号 ( `*` ) 的角色域依次赋予一个或多个客户端的用户ID（用 `,` 分隔），或者直接赋予所有用户ID `all` ，意为该帐户可以访问所有客户端。

带有星号（ `*` ）的角色域必须是属于 `all`  或 `none` ，要么是 `all` ，要么是 `none` ，是固定的，不可单独被赋予给某个客户端帐户。

因此为了能够查看统计信息，你需要将 `piegraph` 和 `users` 这两个角色域同时都赋予给 `all` 。



有一个特殊的角色域 `all` ，它是所有角色域的通配符。

这意味着如果将角色域 `all` 赋予给了所有用户ID `all` ，则该帐户就拥有了执行一切的至高无上的权限！

请注意区分，这个角色域 `all` 是和前面表格中所列一样的角色域之一，并不是用来指代所有用户ID的 `all` ，一个是角色域，一个是用户ID，虽说它俩名字是一模一样，都叫 `all` 。

好了，到目前为止，我们应该了解了，用户至少需要一个 `status` 角色域才能够使用户成功登录 `Web` 页面系统。



##### 5.2 让 `Web` 管理页面支持 `SSL` 访问

服务器 `Web` 管理页面可以通过 `FastCGI` （ `TCP` 端口 `55413` ）访问。

通过这种方式，你可以使用几乎所有现代 `Web` 服务来连接使用 `UrBackup` ，因此可以通过以下方式访问支持 `SSL` 的 `Web` 管理页面。

本节将描述如何使用 `Apache` 和 `Lighttp` 执行此操作。



###### 5.2.1 `Apache` 配置

在 `Apache` 设置中为 `UrBackup` 的 `www` 目录创建软链接，或是为其定义一个别名（ `alias` ）。

针对创建软链接的方法，你需要切换到想要支持 `SSL` 的 `UrBackup` 的 `Web` 根目录，然后执行类似于如下操作。

```
ln -s /usr/share/urbackup/www urbackup
```



请确保你在 `Apache` 上创建软链接的配置项中设置了 `Options +FollowSymLinks` 。

![](..\202206081050_UrBackup Server 2.4.x 管理手册中文版（五）安全\03.JPG)



然后启用 `Apache 2.x` 的模块插件 `mod_proxy_fcgi` 。

![](..\202206081050_UrBackup Server 2.4.x 管理手册中文版（五）安全\04.JPG)

例如，在 `Debian/Ubuntu` 上可以这样。

```
a2enmod proxy_fcgi
```

 

然后将其中的 `x` （某些）文件代理转发到本地（或远程）运行的 `UrBackup` `FastCGI` 服务器（默认端口 `55413` ）。

例如，将以下内容添加到你的 `SSL` 虚拟主机配置中。

```
ProxyPass "/urbackup/x" "fcgi://127.0.0.1:55413"
```



路径 `/urbackup/x` 取决于 `UrBackup` 的 `Web` 根目录（ `index.htm` 文件应该位于相同目录）以及你希望 `Web` 管理页面所在的位置。

好了，现在 `UrBackup` 应该可以通过 `Apache` 来访问了。



###### 5.2.2 `Lighttp` 配置

如 `Apache` 配置中所述，将 `urbackup/www` 目录链接到 `Lighttp` 的 `webroot` 。

添加以下代码到你的 `lighttp.conf` 文件中。

```
include “conf.d/fastcgi.conf” 
```



然后再添加以下代码到 `fastcgi.conf` 文件中。

```
fastcgi.server = ( 
	"/urbackup/x" => 
	((	"host"=>"127.0.0.1"， 
		"port"=> 55413 
	))  
) 
```



##### 5.3 客户端安全

`UrBackup` 客户端仅在服务器或接口进程为其提供凭据时才应答指令。

服务器凭据保存在 `/var/lib/urbackup/server_ident.key` 中。

如果这个文件不存在，那么服务器会在第一次启动时随机生成。

在 `Windows` 中这个文件通常在如下目录中。

```
C:\Program Files\UrBackupServer\urbackup
```

![](..\202206081050_UrBackup Server 2.4.x 管理手册中文版（五）安全\05.JPG)



服务器身份标识也由 `私钥/公钥` 形式的密钥认证系统来确认。

如果这种密钥认证不存在，服务器将生成一套私有和公有的 `ECDSA` 密钥，分别是 `server_ident_ecdsa409k1.priv` 和 `server_ident_ecdsa409k1.pub` 。

![](..\202206081050_UrBackup Server 2.4.x 管理手册中文版（五）安全\06.JPG)



客户端接口凭据也以相同的方式生成，并且驻留在客户端一侧 `UrBackup` 目录的 `pw.txt` 以及  `pw_change.txt` 两个文件中。

```
C:\Program Files\UrBackup\pw.txt
C:\Program Files\UrBackup\pw_change.txt
```

![](..\202206081050_UrBackup Server 2.4.x 管理手册中文版（五）安全\07.JPG)



要提供客户端核心进程接口命令，你需要知道 `pw.txt` 或 `pw_change.txt` 这两个文件的内容，其内容具体取决于如下某些命令。



`pw.txt`

- `Getting the current status` - 获取当前状态
- `Get the paths which are backed up during file backups` - 获取文件备份时的备份路径
- `Get the incremental file backup interval ` - 获取增量文件备份的时间间隔
- `Start backups` - 开始备份
- `Pause backups` - 暂停备份



`pw_change.txt`

- `Change the paths which are backed up during file backups` - 更改文件备份期间的备份路径
- `Get all settings` - 获取所有设置
- `Change all settings`  - 更改所有设置
- `Get log entries/logs` - 获取日志条目/日志
- `Accept a new server` - 接受新服务器

 

默认情况下，只有特权用户可以访问 `pw_change.txt` 。

在 `Windows` 上，这将导致访问 `pw_change.txt` 内容时系统会提示需要提升到管理员权限。

如果你不想让提升权限的窗口老跳出来，请禁用 `UAC` 或更改 `pw_change.txt` 的访问权限以允许非特权用户读取访问。

客户端核心进程从它接受了指令并允许通过 `server_idents.txt` 中所描述的下载文件后就保存了服务器凭据。

`server_idents.txt` 文件中一行一个凭据，同时服务器的公钥也保存在其中。

![](..\202206081050_UrBackup Server 2.4.x 管理手册中文版（五）安全\08.JPG)



如果想要手动将服务器添加到 `server_idents.txt` 中，则需要删除 `server_ident.key` 文件中字符串前置的  `#I` 和末尾的 `#` 。

`UrBackup` 在刚安装完成时 `server_idents.txt` 并不存在，之后客户端核心进程才接受（并添加）它看到的第一台服务器（通过服务器的公钥连接）。

在此之后，客户端不会接受具有不同凭据的其他服务器，并且一旦客户端检测到新服务器，则需要手动添加它们的凭据，或者通过单击弹出窗口来操作。

这样可以防止其他人访问你想在公共场所存放的备份文件。

如果你想让多台服务器能够对一台客户端进行备份，那么你可以有两种选择。

要么，你手动向客户端提供服务器凭据（通过将凭据复制到 `server_idents.txt` 中），要么，通过复制所有服务器上的位于相同服务器上的 `server_ident.key` 、 `server_ident_ecdsa409k1.priv` 和 `server_ident_ecdsa409k1.pub` 这三个文件，来作为客户端访问它们的凭据。 



##### 5.4 传输安全

从客户端到服务器的数据传输在本地网络上是未加密的，允许窃听攻击来恢复备份数据内容。

考虑到这一点，你应该只在受信任的本地网络中使用 `UrBackup` 。

请注意，如果没有采取任何措施来防止这种情况，那么在本地网络中数据流量被重定向则是非常容易的。 



##### 5.5 广域网模式安全

广域网模式使用增强身份验证和加密。

三次握手通过使用一个共享密钥以及基于 `SHA512` 的迭代次数为  `20000` 的 `PBKDF2-HMAC` 加密算法完成。

数据使用 `AES-GCM` 加密和验证。

此外，通过服务器身份密钥和 `ECDSA` 私钥/公钥身份验证来完成本地网络服务器的身份验证。 



### 小结

本节内容主要向小伙伴们展示了关于 `UrBackup` 使用安全方面的内容。

其中涉及到了服务端与客户端是如何建立连接并安全传输数据，以达到完成设置及正常备份的目的。

此外本节还涉及了 `Web` 管理权限的问题，以及使用 `SSL` 来加密访问 `Web` 管理页面的问题。

虽然本节只讲了一些理论知识，没有特别的测试实践过程，但是在手册之外我还写有其他具体实操的文章，其中就包含了大量的真实的关于安全方面的管理内容。

因此除了本管理手册外，我建议大家可以参考其他更多的具体实战文章，这样更接进实际使用，更能使大家深刻理解学习关于 `UrBackup` 方面的知识。

好了，本小节就先到这儿吧，祝各位学习进步！











## 6 局域网中的客户端发现

与服务器位于同一局域网中的客户端会自动被服务端发现。

客户端发现的工作原理如下：

`UrBackup` 服务器每 `50` 秒在当前所有网络适配器（网卡）上向该适配器所处的本地子网广播一条 `UDP` 消息。

（在 `Linux` 上，你可以配置 `UrBackup` 应该在哪些网络适配器上广播。）

在收到这样的广播消息时，客户端会使用其 `FQDN` （完全限定域名）进行回复。

因此，在客户端被识别为在线之前可能需要长达 `50` 秒的时间。



如果你要备份的客户端与服务器不在同一子网中，并且广播包因此而无法到达客户端，那么你可以通过单击 `Web` 管理界面的 `状态` 页面上的  `添加新客户端` ，然后选择 `使用IP/客户端名检测新客户端` 。

![](..\202206081051_UrBackup Server 2.4.x 管理手册中文版（六）客户端发现\01.JPG)



![](..\202206081051_UrBackup Server 2.4.x 管理手册中文版（六）客户端发现\02.JPG)



然后，服务器将额外地向前面输入 `IP` 或主机名的客户端发送直达的 `UDP` 消息，从而允许交换机跨子网边界转发消息。

请注意，此时所有连接均是从服务器到客户端的。

如果服务器和客户端之间存在 `NAT` ，则应该使用 `Internet/广域网 客户端` （参见第 `8` 节）。

使用 `Internet/广域网 客户端` 则所有连接都是从客户端到服务器的。 

![](..\202206081051_UrBackup Server 2.4.x 管理手册中文版（六）客户端发现\03.JPG)



#### 小结

本节阐述了 `UrBackup` 客户端的发现过程。

其基本原理是通过广播 `UDP` 来实现自动发现。

如果客户端与服务器位于同一子网，那么什么都不用干，它会自动连接到服务器。

如果客户端与服务器位于局域网中，但需要经过不同网关到达，那么需要我们提供客户端的 `IP` 地址或可以解析的主机名。

如果客户端与服务器不在一个网络中，数据包无法直达，那么就必须启用广域网模式。

最后需要注意发现连接的流量方面，这将有助于我们成功连接服务器与客户端。

















## 7 备份进程

 本节将详细说明如何执行备份。 



##### 7.1 文件备份

服务器检测到当前时间距离最近一次增量备份的时间大于增量备份的时间间隔，或当前时间距离最近一次完整备份的时间大于完整备份的时间间隔，即开始启动备份。

* 当前时间 - 最近一次增量备份时间 > 增量备份时间间隔
* 当前时间 - 最近一次完整备份时间 > 完整备份时间间隔

也可以根据客户端请求主动启动备份。



备份时服务器会创建一个新目录，它将用于保存备份。

此目录以 `YYMMDD-HHMM` 这样的格式构成，其中 `YY` 是十位数格式的年份，`MM` 是当前月份，`DD` 是当天日期，以及 `HHMM` 表示当前的小时和分钟。

该目录被创建于 `备份存储路径`中名称与客户端名称相同的子目录中。

例如，主机名称为 `DESKTOP-2OQEQDF` 的客户端，它的备份被依次存放在服务器备份存储路径 `D:\Backup` 的如下路径中。

```
D:\Backup\DESKTOP-2OQEQDF
```

则每个备份按日期时间不同存放在前者目录的子目录中。

```
D:\Backup\DESKTOP-2OQEQDF\YYMMDD-HHMM
```

![](..\202206081052_UrBackup Server 2.4.x 管理手册中文版（七）备份进程\01.JPG)



服务器向客户端请求文件列表结构。

客户端则构建文件列表并回复报告服务器已完成。



服务器从客户端下载 `urbackup/data/filelist.ub` 。

如果是增量备份，服务器会将新的 `filelist.ub` 与来自客户端的最后（前）一个文件列表进行比较并计算差异。



服务器开始传输并下载文件。

如果是增量备份，则只下载较新的以及更改过的文件。

如果是完整备份，则从客户端下载所有文件。



服务器将文件下载到临时文件中。

此临时文件默认位于备份存储目录中的 `urbackup_tmp_files` 文件夹中，亦或者，如果你在高级设置中启用了它，则位于系统临时文件夹中。

![](..\202206081052_UrBackup Server 2.4.x 管理手册中文版（七）备份进程\02.JPG)



成功下载文件后，服务器会计算其哈希值并查看是否存在具有相同哈希值的另一个文件。

如果存在这样的文件，则假定它们是相同的，并保存为另一个文件的硬链接，同时删除临时文件。

如果不存在此类文件，则再将文件移动到新的备份位置。

文件路径和哈希值会保存到服务器数据库中。



如果当前备份是增量备份并且文件未更改，则会创建指向先前备份中文件的硬链接。



如果当前备份是增量备份，同时启用了 `在增量备份中使用符号链接` ，并且相应目录所含文件或文件夹有超过 `10` 个以上未更改的，则它将建立符号链接到上次备份中的同一文件夹。

![](..\202206081052_UrBackup Server 2.4.x 管理手册中文版（七）备份进程\03.JPG)



因为最近一次备份可能会在当前备份之前被删除，所以该文件夹会被事先移动到一个池目录（客户端文件夹中的 `.directory_pool` ）中，然后均从两处位置建立链接。

每次创建/删除指向该目录的另一个符号链接时，目录的引用计数都会相应增加/减少。



如果客户端在备份期间脱机并且备份是增量备份，则服务器会继续创建指向先前备份中文件的硬链接，但不会再次尝试下载文件。

无法下载的文件不会保存到服务器端文件列表中。

如果备份是完整备份并且客户端离线，则备份进程将中断并保存部分文件列表，其中包括到进程中断前为止下载的所有文件。



如果所有文件都已传输，则服务器会更新客户端备份存储位置中的 `当前` 符号链接以指向新备份。

仅当客户端在备份期间未脱机时才会产生这种情况。                    



##### 7.2 映像备份

服务器检测到当前时间距离最近一次完整备份的时间大于完整备份的时间间隔，当前时间距离最近一次增量备份的时间大于增量备份的时间间隔，或客户端主动请求进行映像备份，即开始启动备份。

* 当前时间 - 最近一次增量备份时间 > 增量备份时间间隔
* 当前时间 - 最近一次完整备份时间 > 完整备份时间间隔
* 客户端主动请求备份



然后，服务器打开客户端服务命令关于卷映像的请求连接。

客户端通过发送错误码或发送映像来应答。

映像是逐个扇区发送的，每个扇区前面都有其在硬盘上的所在位置描述。

客户端只发送文件系统使用的扇区。

如果备份是增量的，客户端会计算以 `512 kbyte` 为单位的块的哈希值，并将其与之前的映像备份进行比较。

如果块的哈希值没有改变，它不会将该块传输到服务器，否则它会将其传输到服务器。

默认情况下，服务器将映像数据直接写入一个 `VHD` 文件。

如果在高级配置中启用了临时文件设定，服务器会先将映像数据写入临时文件。

![](..\202206081052_UrBackup Server 2.4.x 管理手册中文版（七）备份进程\04.JPG)



这个临时文件的最大大小为 `1GB` 。

超过此大小后，服务器继续另行启用新的临时文件。

映像数据并行写入 `VHD` 文件，并位于备份存储位置的客户端目录中。

![](..\202206081052_UrBackup Server 2.4.x 管理手册中文版（七）备份进程\05.JPG)



`VHD` 文件的名称是 `Image_<Volume>_<YYMMDD_HHMM>.vhd` 这个样子。

`<Volume>` 为备份分区（卷）的盘符，`YY` 为当年，`MM` 为当月，`DD` 为当日，`HHMM` 则表示开始映像备份的小时和分钟。

例如下图，是 `C` 盘的映像备份，只不过它采用了压缩 `VHD` 的格式，因此文件后缀是 `vhdz` 。

![](..\202206081052_UrBackup Server 2.4.x 管理手册中文版（七）备份进程\06.JPG)



从 `UrBackup Server 1.4` 版本开始，`VHD` 文件默认是被压缩的（即以 `vhdz` 格式保存），当然这可以在映像备份设置中禁用。

映像备份容量通常都比较大，因此为了保证备份效率建议保持默认的 `压缩VHD` 的设定。

![](..\202206081052_UrBackup Server 2.4.x 管理手册中文版（七）备份进程\07.JPG)



在 `Windows` 上，没有工具可以直接挂载压缩格式的 `VHD` 文件。

（事实上现在较新版本的 `Windows` 上已经可以直接挂载了。）

有关在 `Linux` 上如何挂载 `VHD` 文件，请参见第 `11.4` 节。

想要解压缩映像文件以便它们可以挂载到 `Windows` 上，请参见 `11.7` 节。

压缩的 `VHD` 文件具有扩展名 `.vhdz` 。

`VHD` 文件使用正常压缩级别的 `GZIP` 压缩程序并以 `2MB` 一个区块的形式压缩。



##### 7.3 数据冲突概率

在本节中，我们将研究 `UrBackup` 备份系统认为数据相同的概率问题，即使这些数据有所不同。

这可能是由哈希冲突引起的（即使数据不同，数据也可能具有相同的哈希值）。

如果发生了冲突，可能会导致文件链接错误或映像备份中的块未传输。



###### 7.3.1 文件备份冲突概率

`UrBackup` 在文件重复数据删除之前使用 `SHA512` 对文件进行哈希处理。

相比之下，`ZFS` 使用 `SHA256` 进行块重复数据删除。

选择 `SHA512` 更安全，维基百科关于  `生日攻击` 的页面有一个 `SHA512` 的概率表。

根据这张表，需要 `1.6 * 10(68次方)` 个不同的文件（大小相同）才能达到 `10(-18次方）`的冲突概率。

它还指出，`10(-18次方)` 是常规硬盘的不可纠正误码率的最佳情况。

要拥有 `1.6 * 10(68次方)` 个 `1KB` 的不同文件，你需要 `1.4551915 * 1056 EB` 的硬盘空间。

因此，硬盘返回错误数据或数据在 `RAM` 中损坏的可能性更大，而不是 `UrBackup` 将错误的文件相互链接。



###### 7.3.2 映像备份冲突概率

对于映像备份中的块也是使用 `SHA256` ，它们的大小为 `512 kbyte` 。

对于两个散列，与 `SHA256` 发生哈希冲突的几率为 `1:(2(256次方)) (p = 21256)` 。

在最糟糕的情况下，增量映像备份中有 `2TB∕512kbyte = 4194304` 个不同的块。

在任何  `4194304` 个块中发生冲突的机会（最糟的情况）是 `1 - (1 -21256)(4194304次方) ≈ 3.6 * 10(-71次方)` 。

与例如 `10(-18次方)` 个常规硬盘具有不可纠正位错误的概率相比，这又是低得离谱。



##### 7.4 客户端和服务器上的备份前后脚本

`UrBackup` 在备份的前期和后期都会在服务器和客户端上调用脚本。

本节将列出调用的脚本和脚本参数。



###### 7.4.1 客户端的备份前后脚本

在 `Linux` 上，会在 `/etc/urbackup/` 或 `/usr/local/etc/urbackup/` （取决于 `urbackup` 的安装位置）中搜索客户端备份前脚本和备份后脚本。

在 `Windows` 上，默认情况下会在 `C:\Program Files\UrBackup` 中使用 `.bat` 文件扩展名搜索它们。

![](..\202206081052_UrBackup Server 2.4.x 管理手册中文版（七）备份进程\08.JPG)



除 `Windows` 上的 `prefilebackup.bat` （默认就有）之外，你必须先创建这些脚本才能使它生效。

| Script/脚本     | Description/描述                      | Parameters/参数                                              | On  failure  (return code not zero) /失败(返回非0代码) |
| --------------- | ------------------------------------- | ------------------------------------------------------------ | ------------------------------------------------------ |
| prefilebackup   | 文件备份前调用（早于快照/副本的创建） | 1: `0` 表示完全备份，`1` 表示增量备份<br />2: 服务器令牌<br />3: 文件备份组 | 索引失败且未启动备份                                   |
| postfilebackup  | 文件备份成功完成后调用                | 无参数                                                       | 可忽略                                                 |
| preimagebackup  | 映像备份前调用（早于快照/副本的创建） | 1: `0` 表示完全备份，`1` 表示增量备份<br />2: 服务器令牌     | 映像备份失败                                           |
| postimagebackup | 映像备份成功完成后调用                | 无参数                                                       | 可忽略                                                 |



###### 7.4.2 服务器的备份后脚本

在 `Linux` 上，在 `/var/urbackup` 或 `/usr/local/var/urbackup` 中搜索备份后脚本（取决于 `urbackup` 的安装位置）。

在 `Windows` 上，默认情况下在 `C:\Program Files\UrBackupServer\urbackup` 中搜索它们，文件扩展名为 `.bat` 。

最初这些脚本并不存在，我们必须先创建这些脚本才能使用它们。

| Script/脚本           | Description/描述         | Parameters/参数                                              | On failure  (return code not zero)/失败(返回非0代码) |
| --------------------- | ------------------------ | ------------------------------------------------------------ | ---------------------------------------------------- |
| post_full_filebackup  | 在完整文件备份完成后执行 | 1: 文件备份路径<br />2: 成功为 `1` ，否则为 `0` <br />3: 文件备份组 | 备份失败                                             |
| post_incr_filebackup  | 在增量文件备份完成后执行 | 1: 文件备份路径<br />2: 成功为 `1` ，否则为 `0` <br />3: 文件备份组 | 备份失败                                             |
| post_full_imagebackup | 在完整映像备份完成后执行 | 1: 镜像备份文件的路径<br />2: 映像盘符<br />3: 成功为 `1` ，否则为 `0` | 备份失败                                             |
| post_incr_imagebackup | 在增量映像备份完成后执行 | 1: 镜像备份文件的路径<br />2: 映像盘符<br />3: 成功为 `1` ，否则为 `0` | 备份失败                                             |



### 小结

本节阐述了 `UrBackup` 是如何备份的，给大家简单地呈现了 `UrBackup` 的备份方式和过程。

其中我们可以很清楚地看到 `UrBackup` 是如何校验增量数据，以及作者告诉我们它的可靠性。

另外，我们还可以利用备份前后的自动化脚本来实现一些辅助功能。

这一节的内容非常有利于我们理解 `UrBackup` 的备份流程，消化理解后我们便可以更好地操控备份的制作和管理。















## 8 广域网客户端

`UrBackup` 官方称之为 `Internet` 客户端，叫作互联网客户端也行，不过个人感觉广域网客户端更加契合。

`UrBackup` 能够通过 `Internet` 备份客户端，支持 `LAN` 和 `Internet` 混合备份。

例如，对于并非一直在 `LAN` 中使用但连接到 `Internet` 的移动设备，这可能很有用。

由于它会对备份文件系统造成额外的压力，因此默认情况下此功能是被禁用的。

你需要在设置中手动启用和配置它并重新启动服务器才能使用它。

![](..\202206081053_UrBackup Server 2.4.x 管理手册中文版（八）广域网客户端\01.JPG)



你必须设定的最小配置是指定备份服务器在 `Internet` 上可被访问的域名或 `IP` 地址。

由于可能在备份服务器和 `Internet` 之间存在防火墙或路由器，因此你还需要在这些设备上配置将 `UrBackup` 端口（默认值：`55415` ）映射转发到备份服务器。

以下分三个部分来说明三种配置客户端的方法。



##### 8.1 自动推送服务器配置给客户端

如果客户端是一个移动设备，它将是最容易让服务器推动其名称和设置的，推送将自动发生。

服务器也会自动生成针对每个客户端的密钥并且将其推送至对应的客户端。

假设当前的局域网是一个安全通道。

如果客户端已经被入侵，你仍然可以更新服务器和客户端上的密钥。



##### 8.2 下载预配置的客户端安装程序

如果你在服务器设置中启用 `从更新服务器下载客户端` ，或者手动下载客户端更新并将其放在相应的文件夹中（参见第 `11.1` 节），用户可以在 `状态` 页面从服务器下载预配置的客户端安装程序。

（注意，我在测试过程中并没有发现预配置客户端安装程序。可能对于工作得非常好的自动发现功能来说，这个并不是十分重要。）

![](..\202206081053_UrBackup Server 2.4.x 管理手册中文版（八）广域网客户端\02.JPG)



安装程序包括服务器 `IP` /域名、它正在侦听的端口、客户端名称和身份验证密钥。

这允许已安装的客户端自动连接到下载安装程序的服务器。



##### 8.3 手动添加和配置客户端

`UrBackup` 还允许手动添加客户端和手动配置共享密钥。

要添加这样的客户端，需要执行以下步骤：

1. 以管理员身份进入 `状态` 页面。

2. 单击 `添加新客户端` 并在 `添加广域网客户端名/NAT后端的客户端名` 下输入您要添加的电脑名称。

   ![](..\202206081053_UrBackup Server 2.4.x 管理手册中文版（八）广域网客户端\03.JPG)

   

3. `UrBackup` 将为该客户端生成并显示一个身份验证密钥。

   ![](..\202206081053_UrBackup Server 2.4.x 管理手册中文版（八）广域网客户端\04.JPG)

   

4. 在客户端上，打开设置并在 `广域网` 选项卡中输入相同的密钥，并在 `客户端` 选项卡中输入你为客户端提供的电脑名称。

   还要输入备份服务器的公共 `IP` 或域名以及可访问的端口。

   ![](..\202206081053_UrBackup Server 2.4.x 管理手册中文版（八）广域网客户端\05.JPG)

   

5. 服务器和客户端现在应该可以相互连接了，如果它不起作用，客户端会在 `状态` 窗口中提示出了什么问题。



##### 8.4 通过 `Internet` 传输文件

如果客户端通过 `Internet` 连接，`UrBackup` 会自动使用节省带宽的文件传输模式。

此模式仅传输已更改的文件块，因此会节省消耗未完全更改文件的带宽，例如数据库文件、虚拟磁盘等。

不过这也是有代价的，`UrBackup` 必须保存每个文件的哈希检验值。

如果文件的哈希值不存在，例如由于 `Internet` 模式刚刚启用，则这些哈希值是在备份期间根据文件创建的，因此可能会减慢备份进程。



### 小结

本节阐述了 `UrBackup` 的广域网客户端的相关内容。

当我们要实现异地备份，或是不在同一局域网的远程备份等情况的话，`UrBackup` 的广域网模式就可以发挥它的作用了！

虽然广域网模式非常有用，但是它也有相对不足之处，比如限于带宽网速等等的制约因素。

因此基于各种因素，我们应该根据实际情况做出合理有效的备份解决方案。







## 9 服务器配置

`UrBackup` 服务器允许管理员更改多项设置。

有一些只影响服务器的全局设置，而有一些则影响客户端和服务器两方面的设置。

对于这些设置，管理员可以设置为默认值或覆盖客户端侧的设置。



##### 9.1 全局服务器设置

全局服务器设置仅影响服务器，任何具有 `general_settings` 权限的用户都可以更改。



###### 9.1.1 备份存储路径

备份存储路径是保存所有备份数据的地方。

为了正常运行，所有这些目录的内容必须位于同一个文件系统上（否则无法创建硬链接）。

此文件系统上有多少空间可用于 `UrBackup` ，部分决定了可以进行多少备份以及 `UrBackup`何时开始删除旧备份。  默认值： ””。（默认是空，就是没有设定，需要我们主动设定。）

![](..\202206081053_UrBackup Server 2.4.x 管理手册中文版（九）服务器配置\01.JPG)



 ###### 9.1.2 服务器网址

在客户端一侧的菜单中，如果用户选择了 `访问/恢复备份` ，客户端将浏览到的 `URL` 。

这个 `URL` 通常是服务器的访问网址，例如 `http://backups.company.com:55414/`。

默认值：“”（默认是空，如果为空 `访问/恢复备份` 将在客户端上不可用。） 

译者按：这个 `URL` 值需要我们手动指定，域名需要确保 `DNS` 可解析访问。

![](..\202206081053_UrBackup Server 2.4.x 管理手册中文版（九）服务器配置\02.JPG)



###### 9.1.3 禁止磁盘映像备份

如果选中，服务器将不进行映像备份。  默认值：未勾选。

![](..\202206081053_UrBackup Server 2.4.x 管理手册中文版（九）服务器配置\03.JPG)



###### 9.1.4 禁止文件备份

   如果选中，服务器将不进行文件备份。  默认值：未勾选。

![](..\202206081053_UrBackup Server 2.4.x 管理手册中文版（九）服务器配置\04.JPG)



###### 9.1.5 自动关闭服务器

如果选中此 `UrBackup` 将在服务器空闲一段时间后尝试关闭服务器。

这也会导致在启动 `UrBackup` 时就删除太旧的备份而不是在夜间作业中删除这些旧备份。

在 `Windows` 服务器版本中，这无需额外工作即可工作，因为 `UrBackup` 服务器进程以可以关闭机器的 `SYSTEM` 用户身份运行。

在 `Linux` 上，`UrBackup` 服务器作为受限用户运行，通常无权关闭机器。

`UrBackup` 会创建文件 `/var/urbackup/shutdown_now` ，您可以在 `cron` 脚本中检查该文件是否存在，例如：

```
if test -e /var/urbackup/shutdown_now then  
	shutdown -h +10  
fi 
```

默认值：未勾选。

![](..\202206081053_UrBackup Server 2.4.x 管理手册中文版（九）服务器配置\05.JPG)



###### 9.1.6 从更新服务器下载客户端

如果选中此项，服务器将自动查找新的 `UrBackup` 客户端版本。

如果有新版本，它将从 `Internet` 下载。

下载受数字签名保护。

默认值：已勾选。

![](..\202206081053_UrBackup Server 2.4.x 管理手册中文版（九）服务器配置\06.JPG)



###### 9.1.7 当新的服务器版本可用时通知我

如果选中此项，如果有可用的新服务器版本，服务器将显示在状态页面上（仅限管理员）。

默认值：已勾选。

![](..\202206081053_UrBackup Server 2.4.x 管理手册中文版（九）服务器配置\07.JPG)



 ###### 9.1.8 自动更新客户端

如果选中此项，服务器将自动向其客户端发送新版本。

`UrBackup` 客户端界面将要求用户安装新的客户端版本。

如果您选中静默自动更新（参见第 `9.1.8` 节），它将在后台更新。

安装程序受数字签名保护。

默认值：已勾选。

![](..\202206081053_UrBackup Server 2.4.x 管理手册中文版（九）服务器配置\08.JPG)



###### 9.1.9 最大同时备份数

此选项限制服务器将同时启动的文件和映像备份的数量。

你可以减少或增加此数字以平衡服务器负载。

大量同时备份可能会增加备份所需的时间。

可能的同时备份数量几乎是无限的。

默认值：`10` 。（实际可能是 `100` ）

![](..\202206081053_UrBackup Server 2.4.x 管理手册中文版（九）服务器配置\09.JPG)



###### 9.1.10 最近活动客户端的最大数量

此选项限制服务器接受的客户端数量。

活动客户端是服务器在过去两个月中看到的客户端。

如果网络中有多个服务器，则可以使用此选项来平衡它们的负载和存储使用。

默认值：100。（实际可能是 `10000` ）

![](..\202206081053_UrBackup Server 2.4.x 管理手册中文版（九）服务器配置\10.JPG)



###### 9.1.11 清理时间窗口

`UrBackup` 将在此期间进行清理。

这是删除旧备份和客户端的时间。

你可以将工作日和小时指定为间隔，语法与备份窗口相同。

因此，有关如何指定此类时间窗口的详细信息，请参阅第 `9.3.1` 节。

默认值为 `1-7/3-4` ，这意味着清理将在每天（ `1` -周一 -  `7` -周日）凌晨 `3` 点到 `4` 点之间开始。

![](..\202206081053_UrBackup Server 2.4.x 管理手册中文版（九）服务器配置\11.JPG)



###### 9.1.12 自动备份 `UrBackup` 数据库

如果选中，`UrBackup` 会将其内部数据库的备份保存在备份存储路径中名为 `urbackup` 的子目录中。

此备份每天在清理时间窗口内完成。

默认值：已勾选。

如果你备份了大量文件并且数据库变得很大，请考虑禁用此功能并通过另一种方法执行数据库备份，例如通过在服务器上安装  `UrBackup` 客户端。

因此这种情况下你应该备份 `/var/urbackup` 或 `C:\Program files\UrBackupServer\urbackup` 。 

![](..\202206081053_UrBackup Server 2.4.x 管理手册中文版（九）服务器配置\12.JPG)



###### 9.1.13 本地网络总体最大传输备份速度

你可以使用此设置限制本地网络中服务器的总带宽使用量。

然后限制服务器和客户端之间的所有连接以保持在配置的速度限制之下。

如果你不希望备份服务器使你的本地网络饱和，这将很有用。

对于不同的时间窗口，所有速度设置都可以有不同的值。  请先参见第 `9.3.1` 节如何指定时间窗口。

你可以通过将速度设置与时间窗口相结合，在不同的时间设置不同的速度，以 `@` 分隔。

如果您希望在工作时间（周一至周五，上午 `8` 点至下午 `6` 点）的默认速度限制为 `60 MBit/s` 和 `10 MBit/s`：

```
60;10@Mon-Fri/8-18
```



将使用最具体的速度限制，因此无论顺序如何，添加一个 `80 MBit/s` 的额外规则（上午 `12` 点到下午 `1` 点）都可以正常工作：

```
60;10@Mon-Fri/8-18;80@1-7/12-13
```



你还可以将速度限制指定为最大速度的百分比，例如 `50%` 。

这可以再次与以 `@` 分隔的窗口组合。

如果指定了百分比值，`UrBackup` 将按一定的时间间隔全速运行，直到速度稳定到最大值。

当它不再测试最大速度时，它将降低为指定的最大速度百分比。

![](..\202206081053_UrBackup Server 2.4.x 管理手册中文版（九）服务器配置\13.JPG)



###### 9.1.14 全局文件系统配额

在清理期间，`UrBackup` 将查看备份文件夹所在文件系统的已用空间。

如果使用空间高于全局文件系统配额，`UrBackup` 将尽可能删除旧备份，直到使用空间低于配额。

请注意，不仅 `UrBackup` 的文件被计入配额，其他文件也被计入配额。

你可以通过总空间的百分比或大小来指定配额。

例如让备份设备的大小为 `1 Tera-byte` 。

如果将全局文件系统配额设置为 `90%` ，`UrBackup` 将在使用超过大约 `900 GB` 的可用空间时删除旧备份。

你也可以通过将配额设置为  `900G` 来直接将配额设置为 `900 GB` 。

使用其他单位是可行的，例如 `900000M` 或 `1T` 。

![](..\202206081053_UrBackup Server 2.4.x 管理手册中文版（九）服务器配置\14.JPG)



##### 9.2 邮件配置

###### 9.2.1 邮件服务器配置

如果你希望 `UrBackup` 服务器发送邮件报告，则应在 `邮件` 设置页面中配置邮件服务器。

![](..\202206081053_UrBackup Server 2.4.x 管理手册中文版（九）服务器配置\15.JPG)



具体设置及其说明如下：



| Settings/配置                | Description/描述                                             | Example/举例         |
| ---------------------------- | ------------------------------------------------------------ | -------------------- |
| Mail server name             | 邮件服务器的域名或IP地址                                     | mail.example.com     |
| Mail server port             | `SMTP` 服务的端口，通常为  `25` 或 `587`                     | 587                  |
| Mail server username         | 用户名（如果 SMTP 服务器需要一个）                           | test@example.com     |
| Mail server password         | 用户密码（如果 SMTP 服务器需要一个）                         | password1            |
| Sender E-Mail Address        | `UrBackup` 的邮件报告将来自哪个电子邮件地址                  | urbackup@example.com |
| Send mails only with SSL/TLS | 仅在可以建立与邮件服务器的安全连接时才发送邮件（保护密码）   |                      |
| Check SSL/TLS certificate    | 检查服务器证书是否有效，如果有效则仅发送邮件                 |                      |
| Server admin mail address    | 发生致命错误时使用的备用地址（例如，紧急清理失败或发生其他致命错误） |                      |

 要测试输入的设置是否有效，可以指定一个电子邮件地址，然后让 `UrBackup` 将向该地址发送测试邮件。 



###### 9.2.2 配置报告

要指定应该通过邮件发送哪些错误的活动，你必须转到 `日志` 页面。

在页面底部有一个名为 `报告` 的区域。

![](..\202206081053_UrBackup Server 2.4.x 管理手册中文版（九）服务器配置\16.JPG)



在那里，你可以说明报告应该发送到哪些电子邮件地址（例如  `user1@example.com；user2@example.com` ），以及  `UrBackup` 是否应该只发送有关备份 `失败/成功` 并包含特定级别日志消息的报告。

如果你选择日志级别 `信息` 和 `全部` ，则会发送有关每个备份的报告，因为每个备份都会导致至少一个信息级别的日志消息。

如果你选择 `警告` 或 `错误` ，则不会向你发送没有事件的消息。

每个 `Web` 界面用户都可以以不同的方式配置这些值。

如果用户拥有特定客户端的  `日志` 权限，`UrBackup` 只会将客户端备份报告发送到用户提供的地址。

因此，如果你想将有关某个客户的报告发送到特定的电子邮件地址，你必须为此客户创建一个用户，以该用户身份登录并为该用户配置报告。

用户 `admin` 可以访问所有客户端的日志，因此也可以获取有关所有客户端的报告。

#####  9.3 客户端特定设置

| Settings/设置                                                | Description/描述                                             | Default value/缺省值     |
| ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------ |
| Interval for incremental file backups                        | 服务器将在这样的时间间隔内启动增量文件备份                   | 5 小时                   |
| Interval for full file backups                               | 服务器将以此类间隔启动完整文件备份                           | 30 天                    |
| Interval            for incremental   image backups          | 服务器将以此类间隔启动增量映像备份                           | 7 天                     |
| Interval    for    full image backups                        | 服务器将以此类间隔启动完整映像备份                           | 30 天                    |
| Maximal number of incremental      file backups              | 此客户端的最大增量文件备份数。如果增量文件备份的数量超过此数量，服务器将开始删除旧的增量文件备份。 | 100                      |
| Minimal number of incremental      file backups              | 此客户端的最小增量文件备份数。如果服务器用完了备份存储空间，则服务器可以删除增量文件备份，直到达到这个最小数量。  如果删除备份会导致增量文件备份的数量低于此数量，则会中止并显示错误消息。 | 40                       |
| Maximal number of full file backups                          | 此客户端的最大完整文件备份数。如果完整文件备份的数量超过此数量，服务器将开始删除旧的完整文件备份。 | 10                       |
| Minimal number of full file backups                          | 此客户端的完整文件备份的最少数量。如果服务器用完备份存储空间，则服务器可以删除完整文件备份，直到达到此最小数量。如果删除备份会导致完整文件备份的数量低于此数量，则会中止并显示错误消息。 | 2                        |
| Maximal number of incremental   image backups                | 此客户端的最大增量映像备份数。如果增量映像备份的数量超过此数量，服务器将开始删除旧的增量映像备份。 | 30                       |
| Minimal number of incremental   image backups                | 此客户端的最小增量映像备份数。如果服务器用完备份存储空间，则服务器可以删除增量映像备份，直到达到此最小数量。  如果删除备份会导致增量映像备份的数量低于此数量，则会中止并显示错误消息。 | 4                        |
| Maximal number of full image backups                         | 此客户端的最大完整映像备份数。如果完整映像备份的数量超过此数量，服务器将开始删除旧的完整映像备份。 | 5                        |
| Minimal number of full image backups                         | 此客户端的完整映像备份的最少数量。如果服务器用完备份存储空间，则服务器可以删除完整映像备份，直到达到此最小数量。如果删除备份会导致完整映像备份的数量低于此数量，则会中止并显示错误消息。 | 2                        |
| Delay after system start up                                  | 服务器将在发现新客户端后等待此分钟数，然后再开始备份。       | 0 分钟                   |
| Backup window                                                | 服务器只会在此窗口内开始备份客户端。有关详细信息，请参阅第 `9.3.1` 节。 | 1-7/0-24                 |
| Max  backup  speed for local network                         | 服务器将限制与客户端的连接以保持在此速度范围内（请参阅 `9.1.13` 以使用窗口设置速度）。 | -                        |
| Perform auto-updates silently                                | 如果选择此选项，将在客户端上执行自动更新而不询问用户。       | 未勾选                   |
| Soft client quota                                            | 在每晚清理期间，如果在达到此配额之前备份数量超过文件/映像备份的最小数量，`UrBackup` 将删除此客户端的备份。配额可以是百分比（例如 `20%` ）或绝对值（例如 `1500G` 、`2000M` ） | ""                       |
| Excluded files                                               | 允许你定义应从备份中排除哪些文件。详见 `9.3.3` 节            | ""                       |
| Default  directories to backup                               | 备份的默认目录。 详见 `9.3.4` 节                             | ""                       |
| Directories         to backup are optional by default        | 如果选中，如果配置为在文件备份期间备份的目录丢失，客户端将不会失败备份。 | 未勾选                   |
| Volumes to backup                                            | 指定完成映像备份的卷。用分号或逗号分隔不同的驱动器号。例如 `C;D` 。  使用特殊设置 `ALL` 备份所有卷，使用 `ALL_NONUSB` 备份除通过 `USB` 连接的卷以外的所有卷。 | C                        |
| Image  backup  file format                                   | 标准 `VHD`（虚拟硬盘）、压缩 `VHD (VHDZ)` 或备份存储在 `btrfs` 文件系统 `写时原始复制文件` 上。 | VHD btrfs: Raw  cow file |
| Allow client-side changing of the directories to backup      | 允许客户端更改完成文件备份的目录。                           | 已勾选                   |
| Allow client-side  starting of  incremental/full file backups | 允许客户端启动文件备份。                                     | 已勾选                   |
| Allow client-side  starting of  incremental/full image backups | 允许客户端启动映像备份。                                     | 已勾选                   |
| Allow     client-side viewing  of  backup logs               | 允许客户端查看日志。                                         | 已勾选                   |
| Allow     client-side pausing of backups                     | 允许客户端暂停备份。                                         | 已勾选                   |
| Allow client-side changing of settings                       | 如果选中此选项，则客户端可以通过客户端界面更改其客户端特定设置。如果您不选中此项，服务器设置将始终覆盖客户端的设置。 | 已勾选                   |
| Allow    clients    to quit the tray icon                    | 允许客户端退出托盘图标。如果托盘图标退出当前和将来的备份将暂停。 | 已勾选                   |



###### 9.3.1 备份窗口

服务器只会在备份窗口内开始备份客户端。

客户端始终可以自行启动备份，即使在备份窗口之外。

![](..\202206081053_UrBackup Server 2.4.x 管理手册中文版（九）服务器配置\17.JPG)



如果启动备份，它会一直运行直到完成，如果备份过程未在备份窗口内完成，它不会停止。

备份窗口的几个示例：

*  `1-7/0-24` ：允许在每周的每一天每小时进行备份。
*  `Mon-Sun/0-24` ：上述的等价符号
*  `Mon-Fri/8:00-9:00,19:30-20:30;Sat,Sun/0-24` ：平日 8 点至 9 点和 19:30 至 20:30  之间备份。在周六和周日的整个时间。



正如我们所看到的，一个数字可以表示一周中的一天（ 1-Monday, 2-Tuesday, 3-Wednesday, 4-Thursday, 5-Friday, 6-Saturday, 7-Sunday ）。

你还可以使用日期的缩写（ Mon, Tues, Wed, Thurs, Fri, Sat, Sun ）。

时间可以仅包含完整的小时数或小时数和分钟数，小时是 24 小时制。

你可以为每个窗口定义设置多个日期和时间，以 `,` 分隔。

如果使用 `-` 指定间隔，则间隔中包括开始日和结束日。

你还可以设置多个窗口定义，用 `;` 分隔它们。



###### 9.3.2 高级备份间隔

与备用速度限制（参见第 `9.1.13` 节）类似，可以通过将备用间隔与由 `@` 分隔的备用窗口（参见前面的第 `9.3.1` 节）组合来为不同的时间间隔指定备用间隔，然后将使用最具体的备份间隔。

例如，默认备份间隔应该是一小时，而在晚上（晚上 8 点到早上 6 点）应该是 4 小时：

```
1;4@1-7/20-6
```

 如果另外在周末备份间隔应该是 6 小时： 

```
1;4@1-5/18-6;6@6,7/0-24
```



###### 9.3.3 排除文件

你可以排除具有通配符匹配的文件。

![](..\202206081053_UrBackup Server 2.4.x 管理手册中文版（九）服务器配置\18.JPG)



例如，如果你想排除所有 `MP3` 和电影文件，请输入如下内容： 

```
*.mp3;*.avi;*.mkv;*.mp4;*.mpg;*.mpeg
```

 如果你想排除一个目录，例如 `Temp` 你可以这样做： 

```
*/Temp/*
```

你还可以提供完整的本地路径名称：

```
C:\Users\User\AppData\Local\Temp\*
```

或者给出该位置的名称，例如：

```
C_\Users\User\AppData\Local\Temp
```

规则用分号 ( `;` ) 分隔 。



###### 9.3.4 要备份的默认目录

输入用分号 ( `;` ) 分隔的不同位置，例如：

```
C:\Users;C:\Program Files
```

如果你想给备份位置一个不同的名字，你可以用管道符号（ `|` ）添加一个，例如：

```
C:\Users|User files;C:\Program Files|Programs

```

将 `Users` 目录命名为 `User files`，将 `Program Files` 目录命名为 `Programs` 。

![](..\202206081053_UrBackup Server 2.4.x 管理手册中文版（九）服务器配置\19.JPG)



这些位置只是默认位置。

即使你选中 `此客户端的单独设置` 并禁用 `允许客户端更改设置` ，一旦客户端修改了路径，客户端将不再使用此字段中的更改。

**目录标志** 每个要备份的目录都有一组标志。

如果你不指定任何标志，则将使用默认标志。

否则，仅使用你指定的标志。

通过在备份位置名称（用 `/` 分隔）后面附加标志来指定标志。

标志本身由  `,` 分隔。 

| Flag/标志         | Description/描述                                             | Default/默认 |
| ----------------- | ------------------------------------------------------------ | ------------ |
| optional          | 如果目录不可用，备份不会失败。                               | 非默认       |
| follow_symlinks   | 将遵循指向指定目录之外的符号链接。                           | 默认         |
| symlinks_optional | 如果无法遵循符号链接，备份不会失败。                         | 默认         |
| one_filesystem    | 如果无法创建该位置的快照/卷影副本，则备份失败。              | 非默认       |
| require_snapshot  | 如果无法创建该位置的快照/卷影副本，则备份失败。              | 非默认       |
| share_hashes      | 在不同的虚拟客户端之间共享文件哈希。                         | 默认         |
| keep              | 在增量备份期间保留已删除的文件和目录。                       | 非默认       |
| required          | 如果设置“默认情况下要备份的目录是可选的”仅目录，则此标志将在备份不可用时失败。 | 非默认       |

 如果要设置可选标志：

```
C:\Users|User files/follow_symlinks,symlinks_optional,share_hashes,optional
```

 （前三个是默认标志）



###### 9.3.5 虚拟子客户端名称

虚拟子客户端允许你使用一个客户端拥有不同的文件备份集。

指定虚拟子客户端后，将出现多个客户端，名称为 `clientname[subclientname]` 。

你可以更改该客户端的所有文件备份特定选项，例如要备份的默认目录、增量文件备份间隔、增量文件备份的最大数量……

主客户端（“客户端名称”）在线则虚拟子客户端将始终在线。

通过 `|` 分隔虚拟子客户端名称。例如：

```
system-files|user-files
```



#####  9.4 广域网设置

| Settings/配置                                                | Description/描述                                             | Default value/默认值 |
| ------------------------------------------------------------ | ------------------------------------------------------------ | -------------------- |
| Internet server name/IP                                      | 客户端可以通过 Internet 访问服务器的 IP 或名称。             | ""                   |
| Internet server port                                         | 服务器将侦听新客户端的端口。                                 | 55415                |
| Do  image  backups over internet                             | 如果选中，服务器将允许此客户端/客户端的映像备份。            | 未勾选               |
| Do full file backups over internet                           | 如果选中，服务器将允许此客户端/客户端的完整文件备份。        | 未勾选               |
| Max  backup  speed for            internet connection        | Internet 客户端的最大备份速度。正确设置此项有助于避免客户端的 Internet 连接饱和（请参阅 `9.1.13` 设置窗口速度） | -                    |
| Total  max  backup speed  for  internet connection           | 所有 Internet 客户端的总累积备份速度。  这可以帮助避免使服务器的 Internet 连接饱和（参见 `9.1.13` 使用窗口设置速度） | -                    |
| Encrypted transfer                                           | 如果选中，则服务器和客户端之间的所有数据都已加密。           | 已勾选               |
| Compressed transfer                                          | 如果选中，则服务器和客户端之间的所有数据都已压缩。           | 已勾选               |
| Calculate file-hashes  on  the client                        | 如果选中，则客户端在备份之前计算每个文件的哈希值（仅计算更改文件的哈希值）。  如果另一个客户端已经传输了相同的文件，则不必传输该文件 | 未勾选               |
| Connect to Internet backup   server   if connected  to  local backup server | 如果选中，客户端将连接到配置的 Internet 服务器，即使它连接到本地网络上的备份服务器。 | 未勾选               |
| Do  not  start  file backups if current estimated data usage limit per month   is   smaller than | 如果客户端可以通过其当前 Internet 连接传输的估计数据量小于指定值，则 UrBackup 服务器将不会安排文件备份。  有关如何估算数据使用限制，请参见 `9.4.1` 。 | 5000 MB              |
| Do not start image backups if current estimated data usage limit per month   is   smaller than | 如果客户端可以通过其当前 Internet 连接传输的估计数据量小于指定值，则 UrBackup 服务器将不会安排映像备份。  有关如何估算数据使用限制，请参见 `9.4.1` 。 | 20000 MB             |

![](..\202206081053_UrBackup Server 2.4.x 管理手册中文版（九）服务器配置\20.JPG)



 ###### 9.4.1 数据流量限额预估

目前有两种机制可以估计客户端在其当前 Internet 连接下每月可以传输多少数据。

如果客户端在 Windows 10 上运行，客户端通过 wifi 连接且 wifi 连接设置为按流量计费，则数据使用限制估计为每月 1GB。

否则，`https://github.com/uroni/dataplan_db` 上的数据计划数据库用于通过客户端主机名估计数据使用限制。

你可以在 `http://ipinfo.io/` 上查看您的 Internet 连接的主机名。

如果数据库中缺少它，请为数据计划数据库提供帮助。

数据计划数据库包含估计有使用限制的主机名（例如移动电话连接、飞机等）和估计无限制的主机名。

如果主机名估计为无限制，则 UrBackup  将始终启动备份而忽略设置。

如果数据库中没有有关主机名的信息，则每月的数据使用限制估计为 1TB。

因此，如果你将其中一项设置设置为 1TB 以上，则只有在数据计划数据库中将主机名指定为无限制时才会开始备份。

如果主机名在数据库中有限制，则仅当此限制大于客户端的相应设置时才会开始备份。





##### 9.5 高级设置

在本节中，你将找到全局服务器设置，你只需针对繁重或自定义工作负载进行更改。

大多数设置需要重新启动服务器才能生效。



######  9.5.1 启用临时文件缓冲区

早期版本的 UrBackup  总是首先将来自客户端的传入数据保存到临时文件，然后将其复制到最终目的地（如果数据是新的）——理由是，最终目的地可能很慢，并且您希望从客户尽快。

在 UrBackup 1.1 中，此默认行为已更改为直接将数据复制到最终备份存储。

这两个设置允许您重新启用旧的行为，例如，因为您的备份存储很慢，因为它被删除了重复数据。

如果重新启用它，请确保每个客户端至少有 1GB  空间，并且至少与要备份的最大文件一样多的空间乘以客户端数量或同时备份的最大数量（以较低者为准） , 在你的临时存储上。

你可以通过  `GNU/Linux` 上的环境变量 `TMPDIR` 和 `Windows` 上的服务器设置来更改临时存储目录。

![](..\202206081053_UrBackup Server 2.4.x 管理手册中文版（九）服务器配置\21.JPG)



###### 9.5.2 传输模式

`UrBackup` 有不同的文件和图像传输模式。如以下：

* 原始。尽可能“原始”地传输数据。  这是最快的传输模式，并且在服务器和客户端上使用最少的 CPU 周期。

* 散列。  通过在传输过程中对数据进行哈希处理，保护传输的数据免受位错误。

  这会使用客户端和服务器上的 CPU 周期。

  `UrBackup` 使用 TCP/IP 传输图像和文件。

  `TCP/IP` 实现了自己的误码检测机制 (CRC32)。

  然而，如果网络引起大量误码并且如果传输大量数据（>2TB），则TCP/IP的误码检测机制不足以检测所有发生的错误。

  `散列` 传输模式增加了额外的保护层，以降低位错误的可能性。

  如果你通过启用加密的 Internet  模式连接进行备份，则不需要使用散列传输模式，因为加密层已经保护了传输数据的完整性。

* 块差异 - 散列。仅可用于文件备份（因为它会自动为映像完成）。

  传输文件的块使用 CRC32 和 MD5 哈希函数进行比较。

  只有发生变化的块才会通过网络发送。

  在文件只有某些块发生变化的情况下，这会减少传输的数据量。

  它还会导致在服务器和客户端之间发送更多消息并使用 CPU 周期，这就是默认情况下仅对 Internet 客户端启用它的原因。

![](..\202206081053_UrBackup Server 2.4.x 管理手册中文版（九）服务器配置\22.JPG)



###### 9.5.3 增量映像备份样式

你可以选择增量映像备份应基于的备份。

在上一次完整或增量映像备份或上一次完整备份（有时称为差异）上。

请记住，仅当映像备份所基于的所有映像备份也被删除时，才能删除映像备份。

此选项对 `btrfs` 文件系统和原始映像文件格式无效。

因此，映像备份始终基于上次的完整或增量映像备份。



###### 9.5.4 完整映像备份样式

你可以选择完整映像是否应传输所有数据或仅传输从上次增量或完整映像备份（合成完整映像备份）更改的数据。

合成完整备份将仅传输更改的块并将所有块存储在 `VHD/VHDZ` 文件中。

此选项对 `btrfs` 文件系统和原始映像文件格式无效，因为在那里将自动禁用完整映像。



 ###### 9.5.5 批量处理进程期间的数据库缓存大小

批量处理进程期间用于数据库缓存的内存量。 



##### 9.6 在增量文件备份期间使用符号链接

如果启用 `UrBackup` 将使用符号链接将未更改的目录链接到超过 `10` 个目录/文件。

如果只更改很少的目录，这将大大提高增量文件备份的速度，因为在某些文件系统（例如 `NTFS` 和机械旋转磁盘）上必须创建更少的硬链接并且硬链接操作是昂贵的。

其不足之处是：

* `UrBackup` 需要跟踪目录的使用次数。对于硬链接，操作系统会这样做。`UrBackup` 这样做可能会更慢且更不可靠。

* 如果备份存储文件夹被移动，所有符号链接都将失效。

  要恢复符号链接，请在服务器未运行时，

  在 `Windows` 上运行：

  ```
  C:\Program Files\UrBackupServer\remove_unkown.bat
  ```

   在 Linux 上运行： 

  ```
  urbackupsrv remove-unknown
  ```



 默认使用符号链接。如果使用 `btrfs` 模式，则此选项无效。 

 

##### 9.7 调试：所有文件备份的端到端验证

这是用于调试目的的偏好设置。

如果启用端到端验证，`UrBackup` 客户端将为每个文件创建文件哈希，以读取每个要备份的文件。

在备份过程结束时，将存储在服务器上的文件的哈希值与客户端计算的哈希值进行比较。

如果哈希值不同，则备份失败，并向服务器管理员发送一封电子邮件。



##### 9.8 调试：使用客户端哈希验证文件备份

在文件备份结束时，服务器将检查备份中的所有文件，并将文件哈希与客户端哈希进行比较。

![](..\202206081053_UrBackup Server 2.4.x 管理手册中文版（九）服务器配置\23.JPG)



#####  9.9 定期将 `Internet` 客户端的文件条目读入数据库

如果选中，`UrBackup` 将定期刷新其数据库中的哈希值，以便备份删除不会导致 UrBackup 重新下载备份存储中已经存在的文件。



#####  9.10 文件备份后为客户端上的每个用户创建符号链接视图

文件备份成功后，`UrBackup` 将为备份服务器上客户端计算机上使用的每个创建符号链接视图。

然后可以访问这些视图，例如通过 `samba` 文件共享。



##### 9.11 每个客户端同时作业的最大数量

每个客户端及其所有虚拟子客户端的最大同时作业数。

如果你希望它同时执行映像和文件备份，请增大此值。

![](..\202206081053_UrBackup Server 2.4.x 管理手册中文版（九）服务器配置\24.JPG)



##### 9.12 映像备份期间一块儿做快照的卷组

指定在进行映像备份时 `UrBackup` 应该一起快照哪些卷。

当快照在一起时，卷彼此一致。

例如，如果一个卷包含数据库而另一个包含数据库日志文件，则应将卷一起创建快照以获得有效备份。

可以是 `all` 以同时对所有卷进行快照，可以是由逗号分隔的卷列表（例如 `C,D` ）或由管道符号分隔的列表列表（例如 `C,D|E,F` ）。

![](..\202206081053_UrBackup Server 2.4.x 管理手册中文版（九）服务器配置\25.JPG)



##### 9.13 文件备份期间一块做快照的卷组

指定在进行文件备份时 `UrBackup` 应该一起快照哪些卷。

目前仅通过 `Windows` 客户端支持。

当快照在一起时，卷彼此一致。

例如，如果一个卷包含数据库而另一个包含数据库日志文件，则应将卷一起创建快照以获得有效备份。

可以是 `all` 以同时对所有卷进行快照，可以是由逗号分隔的卷列表（例如 `C,D` ）或由管道符号分隔的列表列表（例如 `C,D|E,F` ）。

![](..\202206081053_UrBackup Server 2.4.x 管理手册中文版（九）服务器配置\26.JPG)



##### 9.14 Windows 组件备份配置

通过 `Windows` 备份 `API` 配置 `Windows` 组件备份。

目前，最好在客户端上通过 `GUI`（可从托盘图标访问或通过运行  `UrBackupClient.exe` 选择 `Windows 组件` 访问）进行配置，或者从通过 `GUI` 配置的客户端来复制和粘贴。

`default = 1`（默认值）设置将自动备份 `Microsoft Exchange` 、`Microsoft SQL Server` 和  `Microsoft Hyper-V` 。

`default = 0` 设置将禁用 `Windows` 组件备份。

![](..\202206081053_UrBackup Server 2.4.x 管理手册中文版（九）服务器配置\27.JPG)



在客户端一侧也可以手动选择需要备份的 `Windows` 组件。

![](..\202206081053_UrBackup Server 2.4.x 管理手册中文版（九）服务器配置\28.JPG)



#### 小结

本节内容非常多，主要阐述了 `UrBackup` 服务器配置的相关内容。

服务器配置不单单涉及服务端的配置，而且还涉及到众多其他一些高级设定，甚至是客户端需要配合的配置。

因此我们需要仔细研究、熟练掌握其中的细节，以便我们可以精准地调试或设定我们想要的最终备份效果。

本节篇幅较长，需要小伙伴们花一些时间来阅读整理，为了更好地消化这些内容，建议在阅读过程中结合一些实际程序的操作，这样效果更好。















## 10 恢复备份

`UrBackup` 通过创建灾难恢复映像备份来保护整机，以及创建文件备份来保护用户或服务器文件。

因为文件备份的大小通常可以根据机器上的重要数据来筛选精简，所以它们通常可以比映像备份运行得更加频繁。

交替使用映像和文件备份是有意义的，与通过文件备份来备份重要文件相比，备份整个机器的频率相对更低。 



##### 10.1 恢复镜像备份

可以使用基于 `Debian GNU/Linux` 的可引导的 `CD` 或 `U` 盘来恢复映像备份。

![](..\202206081053_UrBackup Server 2.4.x 管理手册中文版（十）恢复备份\01.JPG)



在此映像恢复期间，要恢复的机器必须为无需从服务器进行网络地址转换即可访问（或者你将第 `11.3` 节中的客户端端口转发到恢复客户端）。

虽然 `Linux` 支持许多主板、磁盘控制器等，但你应该始终验证恢复 `CD` 是否适用于你的特定硬件，尤其是在你使用不同的新硬件时。

包括一些无线设备的驱动和固件以及一些需要配置的程序，不过通过有线网络连接进行恢复会更省事、更快，应当作为首选方案。

如此这样恢复就很容易实现。

启动后，它将寻找备份服务器。

![](..\202206081053_UrBackup Server 2.4.x 管理手册中文版（十）恢复备份\02.JPG)



如果找不到，你可以输入备份服务器的 `IP/主机名` 并更改你的网络设置。

![](..\202206081053_UrBackup Server 2.4.x 管理手册中文版（十）恢复备份\03.JPG)



找到备份服务器后，它会要求输入用户名和密码。

例如，使用你的管理员帐户访问所有客户端及其映像备份。

然后你可以选择一个镜像备份，选择你要恢复到的磁盘，然后它就会恢复。

目标磁盘必须至少与映像备份的磁盘一样大。

某些硬件更改可能会导致  `Windows` 在恢复之后在系统启动时出现蓝屏故障。

如果启动修复失败，你可能必须使用 `Windows` 恢复盘进行修复安装。

如果你计划将  `Windows` 还原到不同的硬件，则应事先测试不同的硬件组合。



##### 10.2 恢复文件备份

在执行文件备份时，`UrBackup` 会创建一个与当时客户端文件系统相同的文件系统快照。

因此，你可以通过任何文件共享协议或应用程序（例如  `Windows` 文件共享（或 `samba` ）、 `FTP/SFTP` 、 `WebDAV`……）简单地将这些文件系统快照提供给客户端。



你还可以为客户端创建一个用户，允许用户通过 `UrBackup` 的 `Web` 界面浏览客户端的所有备份，并以 `ZIP` 格式下载单个文件或整个目录（限制为最大 `4GB` ）。



从 `UrBackup 2.0.x` 开始，如果配置了服务器 `URL` ，用户可以直接从客户端访问 `Web` 界面。

用户可以右键单击  `UrBackup`  托盘图标，然后单击打开浏览器的 `访问/恢复备份` ，或者他们可以右键单击备份路径中的文件/目录，然后单击 `访问/恢复备份` 以访问所有文件/目录的备份（仅在带有 `Windows Explorer` 的 `Windows` 上）。

![](..\202206081053_UrBackup Server 2.4.x 管理手册中文版（十）恢复备份\04.JPG)



![](..\202206081053_UrBackup Server 2.4.x 管理手册中文版（十）恢复备份\05.JPG)



浏览备份时，如果客户端在线，`Web` 界面将显示一个恢复按钮。

恢复将要求用户确认。

![](..\202206081053_UrBackup Server 2.4.x 管理手册中文版（十）恢复备份\06.JPG)



如果客户端包含 `GUI` 组件（托盘图标），则将弹出用户确认以供客户端上的所有活动用户恢复。

如果未及时确认（超时）或拒绝，则还原将失败。

你可以在客户端的  `C:\Program files\UrBackup\args.txt` 中更改此行为，方法是在 `Windows`  上将 `--allow_restore` 的值由 `default` 更改为 `server-confirms` ，或者在 `Linux` 上更改 `/etc/default/urbackupclient` 或  `/etc/sysconfig/urbackupclient` 中的恢复设置。

![](..\202206081053_UrBackup Server 2.4.x 管理手册中文版（十）恢复备份\07.JPG)



![](..\202206081053_UrBackup Server 2.4.x 管理手册中文版（十）恢复备份\08.JPG)



若想管控好备份恢复， `UrBackup` 可按照这样的设置，由于理论上的数据丢失场景是攻击者控制了你的备份服务器，删除了所有备份，然后通过还原来删除客户端上的所有文件。

在 `Linux`（和其他操作系统）上，你还可以在客户端通过命令行 `urbackupclientctl browse` 和 `urbackupclientctl restore-start` 进行恢复。



#### 小结

本节内容不多，主要阐述了 `UrBackup` 恢复备份的相关内容。

虽然内容不多，但还建议各位小伙伴重视起来，毕竟如果备份恢复失败等同于没有备份一样。

因此与如何备份同样重要的恢复备份方法，也需要我们认真阅读学习。

恢复备份的方法有很多种，不同的方法适合不同的场景，而相同的场景又可能有不止一种的恢复方法。

所以说，我们应该在实际操作中来熟悉如何恢复备份，这样也可以很好地为今后在实战中打下基础。























































## 11 `UrBackup` 的杂项

##### 11.1 手动更新 `UrBackup` 客户端

我们在使用 `UrBackup` 客户端程序之前，应该先对其进行一些测试。

意思是有可能 `UrBackup` 并不会自动地从 `Internet` 下载最新的客户端版本并进行安装。

这就意味着在第 `9.1.8` 节中描述的自动更新被禁用了。

如果禁用了自动更新，你仍然可以从服务器集中更新客户端。

转至网址：

> https://hndl.urbackup.org/Client/

并将当前系统平台对应的客户端程序在 `update` 文件夹中的所有文件下载到：

`Linux` 上的

```
/var/urbackup
```

或 `Windows` 上（默认）的

```
C:\Program Files\UrBackupServer\urbackup
```

这些目录中。

![](..\202206081053_UrBackup Server 2.4.x 管理手册中文版（十一）杂项\01.JPG)



接着 `UrBackup` 将在它们重新建立连接后推送新版本到客户端。

如果你启用了静默自动更新，则新版本将静默安装在客户端上，否则将弹出窗口询问用户是否要安装新版本。 



##### 11.2 日志记录

`UrBackup` 通常将所有与备份相关的内容记录到几个日志工具中。

每条日志消息都具有相应的严重级别，即 `error` 错误、`warning` 警告、`info` 信息或 `debug` 调试。

每条日志输出都可以根据此严重级别过滤，例如只显示错误。

服务器和客户端都有单独的日志。

在备份过程中，`UrBackup` 服务器尝试将属于某个备份的所有内容记录在客户端特定的日志中，最后将该日志发送给客户端。

这些就是你在客户端界面上看到的日志。

也可以通过 `Web` 界面的 `日志` 选项卡区域查看相同的日志。

如第 `9.2.2` 小节所述，你也可以通过邮件发送它们。



如果没有特别指定某个客户端对应某些日志的话可能会导致产生过多日志流量，因为所有内容将都记录在通用日志文件中。 

服务器的日志文件默认在 `Linux` 上是 `/var/log/urbackup.log` ，在 `Windows` 上则是 `C:\Progam  files\UrBackupServer\urbackup.log` 。

而相应地客户端日志文件默认是 `/var/log/urbackup_client.log` 和 `C:\Progam files\UrBackup\debug.log`。

![](..\202206081053_UrBackup Server 2.4.x 管理手册中文版（十一）杂项\02.JPG)



默认情况下，这些文件仅包含严重警告或更高级别的日志消息。

在 `Windows` 中，有一个 `args.txt` 文件与日志文件位于同一目录中。

将此文件的 `--loglevel` 的 `warn` 更改为 `debug` 、`info` 或 `error` 以获取一组不同级别的日志消息。

![](..\202206081053_UrBackup Server 2.4.x 管理手册中文版（十一）杂项\03.JPG)



你需要重新启动服务器才能使此更改生效。

在 `Linux` 上，这取决于具体不同的发行版命令。

在 `Debian` 上，则要更改 `/etc/default/urbackupsrv` 中的设置。



##### 11.3 使用的网络端口

服务器绑定到以下默认端口：

| Port/端口 | Usage/用途                    | Incoming/Outgoing<br />进/出（方向） | Protocol/协议 |
| --------- | ----------------------------- | ------------------------------------ | ------------- |
| `55413`   | 为 `web` 接口服务的 `FastCGI` | Incoming/进                          | `TCP`         |
| `55414`   | `HTTP web` 管理接口           | Incoming/进                          | `TCP`         |
| `55415`   | `Internet` 客户端访问         | Incoming/进                          | `TCP`         |
| `35623`   | 用于发现的 `UDP` 广播端口     | Outgoing/出                          | `UDP`         |

 

客户端绑定到以下默认端口：

| Port/端口 | Usage/用途                   | Protocol/协议 |
| --------- | ---------------------------- | ------------- |
| `35621`   | 备份期间发送文件（文件服务） | `TCP`         |
| `35622`   | 用于发现的 `UDP` 广播端口    | `UDP`         |
| `35623`   | 发送指令或用于映像备份       | `TCP`         |



##### 11.4 在 `GNU/Linux` 上挂载（压缩的）`VHD` 文件

如果你使用 `fuse`（用户态文件系统）支持编译 `UrBackup` 或安装了 `Debian/Ubuntu` 软件包，则 `UrBackup` 服务器可以直接挂载 `VHD(Z)` 文件。

你可以通过配置来编译带有 `fuse` 支持的 `UrBackup` ：

```
./configure --with-mountvhd
```

你可以通过如下方法挂载 `VHD(Z)` 文件。

```
urbackupsrv mount-vhd --file /media/backup/urbackup/testclient/\  
Image_C_140420-1956.vhdz --mountpoint /media/testclient_C
```

之后 `C` 卷备份中的所有文件将在 `/media/testclient_C` 中有效可读。

`unmount` 卸载由 `UrBackup` 创建的挂载（参见 `mount` 输出），来停止后台进程。 



##### 11.5 在 `Windows` 上将 `VHD` 挂载为卷

从 `Vista` 开始，`Windows` 可以直接挂载 `VHD` 文件。

如果 `VHD` 文件被压缩，则需要先对其进行解压缩（参见下一节 `11.6`）。

然后进入 `系统设置` > `管理` > `计算机管理` > `磁盘管理` > `其他操作` > `添加虚拟硬盘` ，以只读方式装载 `VHD` 文件。

该映像将在资源管理器中显示为另一个驱动器。

如果 `VHD` 文件位于网络驱动器上，它可能不起作用。



##### 11.6 解压 `VHD` 文件

可以考虑使用下一节 `11.7` 中描述的方法来解压缩 `VHD` 文件。

如果要在 `Windows` 上挂载 `VHD` 文件而它们是压缩格式的（文件扩展名为 `VHDZ`），则需要先解压缩它们。

使用  `C:\Program Files\UrBackupServer\uncompress_image.bat`  正是为了这个原因。

![](..\202206081053_UrBackup Server 2.4.x 管理手册中文版（十一）杂项\04.JPG)



调用不带参数的批处理文件将打开一个文件选择窗口，你可以在其中选择要解压缩的 `VHDZ` 文件。

![](..\202206081053_UrBackup Server 2.4.x 管理手册中文版（十一）杂项\05.JPG)



解压缩完成后，会创建一个比原先更大的临时副本并自动重命名。

如果映像是增量的，则父级 `VHD` 也会自动解压缩。

如果你想防止这种情况发生，请使用第 `11.7` 节中描述的方法来构建单独的未压缩映像。

所有映像文件仍将具有 `VHDZ` 扩展名（也就是说是压缩形式的），否则将不得不更改数据库条目，只是文件将不再被压缩。

在 `Linux` 上，可以使用 `urbackupsrv decompress-file -f [filename]` 完成相同的操作。



笔者补充说明：

和前面官方描述的部分内容有一些出入，特此说明。

在 `Windows` 上如果你直接双击打开的 `uncompress_image.bat` ，那么它会将 `vhdz` 文件直接解压缩并覆盖原文件。

此时需要已经解压缩完成，但文件的扩展名不会变，需要我们手动修正为 `vhd` 。

这样我们就可以利用 `Windows` 自带的镜像挂载功能，直接挂载使用镜像了。

![](..\202206081053_UrBackup Server 2.4.x 管理手册中文版（十一）杂项\06.JPG)



##### 11.7 将多个 `VHD` 卷映像整合成一个 `VHD` 磁盘映像

`UrBackup` 是分别单独存储每个卷的映像备份的。

如果你想在不使用还原 `CD` 的情况下启动加载映像备份，那么作为一台完整的虚拟机你必须将多个卷重新整合到一个磁盘 `VHD` 映像中。

在 `Windows` 上，可以通过运行 `C:\Program Files\UrBackupServer\assemble_disk_image.bat` 来完成。

![](..\202206081053_UrBackup Server 2.4.x 管理手册中文版（十一）杂项\07.JPG)



在第一步中，它将询问你需要整合哪些 `VHD` 映像（可多选），例如选择 `Image_C_XXXXX.vhd` 和 `Image_SYSVOL_XXXXX.vhd` 。

![](..\202206081053_UrBackup Server 2.4.x 管理手册中文版（十一）杂项\08.JPG)



选择的源映像文件也可以是增量或压缩的。

然后它会询问输出的 `VHD` 磁盘映像应该保存在哪里。

![](..\202206081053_UrBackup Server 2.4.x 管理手册中文版（十一）杂项\09.JPG)



之后，它会将 `Image_C_XXXXX.vhd.mbr` 的主引导记录和卷内容写入输出磁盘映像中的适当偏移量。

 在 `Linux` 上，同样的事情可以用

```
urbackupsrv -a /full/path/Image_C_XXXXX.vhdz -a /full/path/Image_SYSVOL_XXXXX.vhdz\  
-o full_disk.vhd
```

 通过选择单个 `VHD` 文件作为输入，此工具还可用于在不解压其父级 `VHD` 的情况下解压缩映像。



##### 11.8 迁移非 `btrfs` 备份存储

`UrBackup` 具有内置迁移功能，可让你以最少的停机时间将备份存储迁移到不同的设备。

这仅适用于普通备份存储，也就是说，它不适用于第 `12.7.2` 节中描述的特殊 `btrfs` 模式或第 `12.7.1` 节中描述的写入时复制 `copy-on-write`  映像 。

迁移功能仅适用于迁移，不适用于比如镜像备份等场景。

与使用诸如 `rsync` 相比，内置迁移有一些优点：

* 它可以以备份级别恢复迁移
* 它会自动禁用所有清理，以最大限度地减少迁移期间必要的更改量
* `UrBackup` 会继续备份当前未迁移的客户端并自动迁移新备份
* `UrBackup` 会很好地处理硬链接



在 `/var/urbackup` 或 `C:\Program Files\UrBackupServer\urbackup`  中创建一个名为 `migrate_storage_to` 的文件，其唯一内容是要将备份迁移至哪里的目标路径。

![](..\202206081053_UrBackup Server 2.4.x 管理手册中文版（十一）杂项\10.JPG)



然后重新启动 `UrBackup` 服务器，迁移进程将会自动开始（需要耐心等一会儿）。

你可以在 `Web` 管理界面的 `活动` 页面查看迁移进度。

一旦迁移完成，在 `migrate_storage_to` 文件相同所在目录中生成一个 `migrate_storage_to.done` 文件以示迁移任务完成。

在下一次迁移开始之前，建议将此文件事先删除。

![](..\202206081053_UrBackup Server 2.4.x 管理手册中文版（十一）杂项\11.JPG)



![](..\202206081053_UrBackup Server 2.4.x 管理手册中文版（十一）杂项\12.JPG)



迁移完成后，将设置中的 `备份存储路径` 更改为新位置，或将新的备份存储挂载到老位置。

（后半句可以理解为原备份路径不改变的情况下，备份路径依然保持老位置。）

然后运行第 `12.4` 节中描述的 `删除未知` 。 

![](..\202206081053_UrBackup Server 2.4.x 管理手册中文版（十一）杂项\13.JPG)



#### 小结

本节内容比较杂，包括手动更新客户端、日志记录、通讯端口以及 `VHD` 文件的挂载等等。

关于 `VHD` 挂载涉及的存储相关内容，将在下一小节阐述，敬请期待！























## 12 存储

`UrBackup` 服务器存储系统被设计为能够尽可能多地保存备份，从而尽可能高效地利用存储分区上的空间。

有鉴于此，最佳做法是为备份存储使用可分开独立的文件系统，或为 `urbackup` 用户设置配额。

如果某些文件系统几乎完全被占用（碎片化和低性能），则它们的性能会表现得很差。

对于此类文件系统，你应该始终限制 `UrBackup` 最多可以使用全部可用空间的 `95%` 的配额设定。

你还可以在 `UrBackup` 中设置一个软配额（请参阅第 `9.1.14` 节），如果是这样设定的，那么要注意该配额设定会导致 `UrBackup` 删除旧备份以保持可用空间占用率在此配额限定内。



##### 12.1 每晚备份删除

`UrBackup` 在凌晨 `3` 点到 `5` 点之间自动删除旧文件备份和映像备份。

当客户端的 `增量/完整的文件/映像` 备份数量超过配置的 `增量/完整的文件/映像` 备份的最大数量时将删除备份。

备份将被删除直到备份数量再次回到限制范围内。

如果管理员已设定自动关机，则此清理过程会在服务器开机时启动（因为服务器很可能在夜间关闭）。

删除备份和后续更新统计信息会对系统性能产生巨大影响。



在夜间备份删除期间，`UrBackup` 还将尝试强制执行全局的或客户端特殊指定的软配额。

仅当客户端已拥有比配置的最小 `增量/完整的文件/映像` 备份数量更多的备份时，它才能删除备份。



##### 12.2 紧急清理

如果服务器在备份期间用完存储空间，它会删除备份，直到有足够的空间再次可用。

映像备份优先于文件备份，最旧的备份首先被删除。

当拥有备份的客户端，其存储中配置了的最小数量的 `增量/完整的文件/映像备份` 时，其备份仅被删除到其最小配置数量。

如果未找到符合被删除条件的备份而存储又用完了，则 `UrBackup` 将取消当前备份并报告出现致命错误。

如果发生此类错误，管理员应监控存储空间并添加存储，或将 `增量/完整的文件/映像备份` 的最小数量配置为较低水平。 

 

##### 12.3 清理具有大量备份文件的服务器

`UrBackup` 的数据库处于启用高并发的模式。

由于清理过程有时会受到数据库的限制，因此建议将数据库切换到允许较少并发但对于清理过程的某些操作来说速度较快的模式。

这在 `UrBackup` 运行时是不可能的，因此你应该调整备份窗口，以确保在某些时候没有运行备份。

然后你可以通过调用如下命令来停止服务器单独运行清理。

```
urbackupsrv cleanup --amount x
```

在 `GNU/Linux` 或 `Windows` 上：

```
cleanup.bat x
```

其中 `x` 是备份存储上要释放的空间百分比或字节/兆字节/千兆字节数，例如 `20G` 或 `10%` 。

如果想完全删除旧备份，请使用  `0%` 。



##### 12.4 清理具有 `UrBackup` 未知文件的存储文件夹

有时，通过使用数据库备份，存储目录中可能存在 `UrBackup` 并不知道的备份，即数据库中没有这些备份的条目。

或者数据库中有记录条目但文件却不在存储目录中（文件不再存在）。

在这些情况下，可运行如下命令清理。

在 `GNU/Linux` 上：

```
urbackupsrv remove-unknown
```

或在 `Windows` 上：

```
remove_unknown.bat
```

![](..\202206081054_UrBackup Server 2.4.x 管理手册中文版（十二）存储\01.JPG)



删除 `urbackup` 存储目录中不存在于 `UrBackup` 数据库中的文件和文件夹。

这也会遍历所有软硬链接并在必要时更正它们。



##### 12.5 归档

`UrBackup` 能够自动归档文件备份。

所谓归档就是你不想让系统自动删除而想暂时保留的备份项，因此可以理解被归档的备份可能会超出备份周期时间窗口而保留下来。

归档的文件备份不会通过夜间或紧急清理等形式被删除，除非只有当它们不再是归档时。

你可以在 `设置` > `归档` 下为所有或特定客户端设置归档。

当归档到期且服务器当前处于归档窗口（参见 `12.5.1` ）时，所选类型的最后一个文件备份将在所选时间量内归档。

在那之后，它将不再自动归档。

你可以在 `Web` 页面的 `备份` 区域查看归档备份。

![](..\202206081054_UrBackup Server 2.4.x 管理手册中文版（十二）存储\02.JPG)



如果备份仅在有限的时间内归档，则复选标记旁边将显示一个时间符号。

将鼠标悬停在该时间符号上系统会告诉你该文件备份将保持归档多长时间。



###### 12.5.1 归档窗口

归档窗口允许你在特定的时间归档备份。

![](..\202206081054_UrBackup Server 2.4.x 管理手册中文版（十二）存储\03.JPG)



格式与 `crontab` 非常相似。

除了没有分钟之外，以下这些字段都与 `crontab` 是相同的：

| Field/字段   | Allowed values/可用值 | Remark/备注               |
| ------------ | --------------------- | ------------------------- |
| Hour         | 0-23                  | 小时                      |
| Day of month | 1-31                  | 日期                      |
| Month        | 1-12                  | 月份，字母名称不可用      |
| Day of week  | 0-7                   | 周几，`0` 和 `7` 代表周日 |

 

要在每个月的第一个周五归档文件备份，我们可以将 `每归档间隔` 设置为比如 `27` 天。

输入我们希望归档备份的时间后，我们将添加如下代码：

```
*;*;*;5
```

作为窗口（小时；月中的某天；月；周中的某天）。

要在每周五归档备份，我们会将 `每归档间隔` 设置为大于 `1` 天但小于 `7` 天的值。

之所以可行，是因为必须满足两个条件：自上次备份归档以来的时间必须大于 `每归档间隔` ，并且服务器当前必须位于归档窗口中。

其他例子更简单。

要在每个月的第一天归档备份，窗口将是：

```
*;1;*;*
```

和 `每归档间隔` 比如大约 `2-27` 天。

可以通过逗号分隔它们来为每个字段添加多个值，像这样：

```
*;*;*;3,5
```

 并且 `每归档间隔` 一天将在周三和周五存档备份。

`crontab` 中的其他高级功能不存在。 



##### 12.6 适合的文件系统

因为 `UrBackup` 可以选择先将所有传入的数据保存到临时文件（参见第 `9.5.1`  节），然后将它们复制到并行备份的最终位置，即使备份存储空间很慢，性能仍然会很好。

这意味着你可以使用具有压缩和重复数据删除功能的全功能文件系统，而不会造成太大的性能损失。

在最坏的情况下，服务器会在晚上写完一个映像备份（白天已经将映像的内容保存到临时文件中）。

本节将显示哪些文件系统适合 `UrBackup` 。 



###### 12.6.1 `Ext4/XFS`

`Ext4` 和 `XFS` 都在 `Linux` 中可用，并且可以处理存储映像备份所需的大文件。

但是，它们没有压缩或重复数据删除功能。

可以通过在它们之上使用 `fuse` 用户态文件系统（例如 `fusecompress` ）来实现压缩。

还有一些块级重复数据删除 `fuse` 层，但我建议不要使用它们，因为它们看起来不太稳定。

你必须使用内核 `用户/组` 级别配额支持来限制 `UrBackup` 的存储使用。



###### 12.6.2 `NTFS`

如果你在 `Windows` 下运行 `UrBackup` 服务器，`NTFS` 几乎是你唯一的选择。

它支持大文件和压缩以及硬链接，因此比标准 `Linux` 文件系统的 `XFS` 和 `Ext4` 更适合 `UrBackup` 。



###### 12.6.3 `btrfs`

`Btrfs` 是与 `ZFS` 相媲美的下一代 `Linux` 文件系统。

它支持压缩和离线块级重复数据删除。

`UrBackup`  有一个特殊的快照备份模式，使用 `btrfs` 可以更快地进行增量备份和删除文件备份。

使用 `btrfs` `UrBackup` 还可以对增量文件备份进行廉价的（就 `CPU` 和内存要求而言）块级重复数据删除。详见 `12.7.2` 。

`UrBackup` 还有一种特殊的写时复制原始映像备份格式，它允许 `持续增量备份` 风格的映像备份。



###### 12.6.4 ZFS

`ZFS` 是源自 `Solaris` 的文件系统。

它可用作 `Linux` 的 `fuse` 模块 ( `zfs-fuse` ) 和内核模块  ( `ZFSOnLinux` )。

存在一个阻碍 `ZFS` 直接与 `Linux` 集成的许可问题。

如果你想要最高的性能和稳定性，其中一个选择是使用  `FreeBSD`（例如 `FreeNAS` ）。

`ZFS` 具有一些简洁的功能，例如压缩、块级重复数据删除、快照和内置的 `RAID`  支持，使其非常适合备份存储。

`12.7.1` 节详细介绍了如何使用 `ZFS` 构建 `UrBackup` 服务器。

`UrBackup`  还有一种特殊的写时复制原始映像备份格式，它允许在 `ZFS` 上工作的 `持续增量备份` 风格的映像备份。第 `12.7.1` 节描述了如何设置它。



##### 12.7 存储设置建议

在本节中，展示了使用 `ZFS` 的示例存储设置，它允许通过 `Internet` 或通过磁带进行异地备份，例如手动异地存储和使用 `Linux` 文件系统 `btrfs` 的存储设置，使用 `btrfs` 快照机制来加速文件备份的创建和销毁并更有效地保存文件备份。



###### 12.7.1 `ZFS`

注意：假设 `UrBackup` 在支持 `ZFS` 的 `Linux` 或 `BSD` 等类 `UNIX` 的系统上运行。

我们将使用所有 `ZFS` 功能，例如压缩、重复数据删除和快照。

假设服务器有两个专用于备份的硬盘驱动器 ( `sdb` , `sdc` ) 和一个热插拔硬盘驱动器插槽 ( `sdd` )。

假设在 `/dev/sde` 中也有一个缓存设备来加速重复数据删除。

即使是快速的 `U` 盘也可以加快重复数据删除速度，因为它比普通硬盘具有更好的随机访问性能。

使用 `SSD` 以获得最佳性能。



首先设置服务器，使临时目录 ( `/tmp` ) 位于足够强大的高性能文件系统上。

如果你有一个 `raid` 设置，你可以将 `/tmp` 设置在条带设备上。

我们现在将在 `/media/BACKUP` 中创建一个备份存储文件系统。

利用两个硬盘驱动器创建一个 `ZFS-pool` 备份，两个硬盘驱动器是镜像的。

将相同大小的硬盘放入热插拔硬盘插槽。

我们也将镜像它： 

```
zpool create backup mirror /dev/sdb /dev/sdc /dev/sdd cache /dev/sde -m /media/BACKUP
```

启用重复数据删除和压缩。

你不需要设置配额，因为重复数据删除会分割整理所有内容（这就是我们需要缓存设备的原因）。

```
zfs set dedup=on backup  
zfs set compression=on backup
```

现在我们想实现一个祖父、父亲、儿子或类似的备份方案，这样我们就可以将硬盘放在防火保险箱中。

因此，每次我们想要进行异地备份时，我们都会移除热插拔设备并插入一个新设备。

然后我们要么运行 

```
zpool replace backup /dev/sdd /dev/sdd
```

要么运行

```
zpool scrub
```

你可以使用 `zpool status` 查看 ` re-silvering/scrub ` （重新自检同步/修复） 的进度。

一旦完成后，你就可以将另一个硬盘放在某个地方。



现在我们想将备份保存在另一个位置的服务器上。

首先，我们在这个其他位置创建 `ZFS` 备份池。

然后我们传输完整的文件系统（ `otherserver` 是对方服务器的主机名）：

```
zfs snapshot backup@last  
zfs send backup@last | ssh -l root otherserver zfs recv backup@last
```

 完成此操作后，我们可以增量同步两个文件系统： 

```
zfs snapshot backup@now  
ssh -l root otherserver zfs rollback -r backup@last  
zfs send -i backup@last backup@now | ssh -l root otherserver zfs recv backup@now  
zfs destroy backup@last  
zfs rename backup@last backup@now  
ssh -l root otherserver zfs destory backup@last  
ssh -l root otherserver zfs rename backup@last backup@now
```

你还可以将这些完整和增量 `zfs` 流保存到其他服务器上的文件中，而不是直接保存到 `ZFS` 文件系统中。



**`ZFS` 的写时复制原始映像备份**

自 `UrBackup 2.1.x` 起使用  `ZFS` 存储还允许使用写时复制原始映像备份格式。

这种格式没有大小限制，并允许 `持续增量备份` 风格的映像备份。

`UrBackup` 将每个映像备份放入单独的数据集中，并将映像存储为单个大文件。

压缩和未使用区域管理由 `ZFS` 完成。

为了创建和删除 `ZFS` 快照，`UrBackup` 安装了一个 `setuid` 可执行文件 `urbackup_snapshot_helper` 。

但是，当前 `ZFSOnLinux` 会依次调用 `mount` ，当 `urbackup_snapshot_helper` 以非特权用户身份运行时会失败。

因此，你必须以 `root` 用户身份运行 `UrBackup` 服务器（ `urbackupsrv run -u root` ）。

你应该创建一个单独的 `ZFS` 数据集，其中将存储映像备份，例如 `tank/images` 。

`UrBackup` 服务器将从 `/etc/urbackup/dataset` 读取此数据集，并从 `/etc/urbackup/backupfolder` 读取备份存储路径。

比如按如下示例设置： 

```
mkdir -p /etc/urbackup  
echo "tank/images" > /etc/urbackup/dataset  
echo "/mnt/BACKUP/urbackup" > /etc/urbackup/backupfolder
```

 然后以 root 身份运行测试一切是否正常：

```
urbackup_snapshot_helper test
```

然后，你应该能够享受更快的增量文件备份，这些备份使用更少的存储空间和 `持续增量备份` 风格的映像备份。

其他注意事项：`UrBackup` 使用 `file hole punching` （文件打孔）在增量备份后从映像文件中删除未使用的区域。

`FreeBSD` 当前不支持此功能，因此在  `FreeBSD` 上进行增量映像备份后，它将无法删除那些未使用的区域。

但是取而代之的是，它将这些未使用区域设置为零，因此如果启用 `ZFS`  压缩，未使用的区域将不会占用太多空间。



**`ZFS` 的写时复制文件备份**

同样，`UrBackup` 支持使用 `ZFS` 进行写时复制文件备份。

方法与下一节中 `btrfs` 的方法相同，但前提是不能像在 `btrfs` 中那样在 `ZFS` 数据集之间重新链接相同的文件，因为 `ZFS` 缺少 `reflink` 功能。

相反，文件将被复制，也就是说，如果文件已经有副本，`UrBackup` 将不会加载两次，但如果未启用 `ZFS` 重复数据删除，则可能会存储两次。

使用 `ZFS` 进行写时复制文件备份需要使用 `ZFS` 进行写时复制映像备份的先前设置，另外设置要存储文件备份的数据集，例如 

```
echo "tank/files" > /etc/urbackup/dataset_file
```



###### 12.7.2 `Btrfs`

`Btrfs` 是用于 `Linux` 的高级文件系统，能够创建子卷的写时副本快照。

要使 `UrBackup` 能够使用快照机制，`Linux` 内核版本必须至少为 `3.6` 。



如果 `UrBackup` 检测到 `btrfs` 文件系统，它会使用特殊的快照文件备份模式。

它将每个客户端的每个文件备份保存在单独的 `btrfs` 子卷中。

创建增量文件备份时，`UrBackup` 会创建最后一个文件备份的快照，并仅删除、添加和更改更新快照所需的文件。

这比普通方法快得多，其中 `UrBackup` 将新增量文件备份中的每个文件链接（硬链接）到最后一个文件中的文件。

它还使用较少的元数据（有关文件的信息，即目录条目）。

如果检测到新的/更改的文件与另一个客户端的文件相同或与另一个备份中的文件相同，则 `UrBackup` 使用跨设备引用链接在文件系统上仅将该文件中的数据保存一次。

使用 `btrfs` 还允许 `UrBackup` 以仅存储文件中更改的数据的方式备份在增量备份之间更改的文件。

这大大减少了备份所需的存储量，尤其是对于大型数据库文件（例如 `Outlook`  存档文件）。

上一节 ( `12.7.1` ) 中的 `ZFS` 重复数据删除节省了更多存储空间，但代价是读写性能大幅下降以及 `CPU` 和内存要求高。



使用 `btrfs` `UrBackup` 还可以使用特殊的原始映像文件格式。

这种格式没有大小限制，并允许 `持续增量备份` 风格的映像备份。

`UrBackup` 将每个映像备份放入单独的子卷中，并将映像存储为单个大文件。

压缩和未使用区域管理由 `btrfs` 完成。



为了创建和删除 `btrfs` 快照，`UrBackup` 安装了一个 `setuid` 可执行文件 `urbackup_snapshot_helper` 。

`UrBackup` 还使用此工具来测试是否可以进行跨设备重新链接。

只有当 `UrBackup` 可以创建跨设备 `reflink` 并且能够创建和销毁 `btrfs` 快照时，才启用 `btrfs` 模式。

`urbackup_snapshot_helper` 需要单独告知  `UrBackup` 备份文件夹在哪里。

此路径从 `/etc/urbackup/backupfolder` 中读取。

因此，如果 `/media/backup/urbackup` 是 `UrBackup` 保存路径的文件夹，则以下命令将正确创建此文件： 

```
mkdir /etc/urbackup  
echo "/media/backup/urbackup" > /etc/urbackup/backupfolder
```

 然后，你可以通过运行测试 `UrBackup` 是否会启用 `btrfs` 功能。

```
urbackup_snapshot_helper test
```

如果测试失败，你需要检查内核是否足够新，以及备份文件夹是否位于 `btrfs` 卷上。

然后，你应该能够享受更快的增量文件备份，这些备份使用更少的存储空间和 `持续增量备份` 风格的映像备份。 



### 小结

本节集中阐述存储相关内容，包括存储的使用、归档以及文件系统等等。

`Windows` 的 `NTFS` 非常适合作为 `UrBackup` 的存储文件系统，这也是新手们通常使用的途径，具有支持压缩以及大文件等属性，易于我们初级者使用。

除了 `Windows` 下的 `NTFS` 之外，其他文件系统也常被用于各种存储系统中，比如 `NAS` 等，则应该按照手册中所述做出相应调整，以便达到 `UrBackup` 的最佳使用效果。



![](.\donate.png)

**来杯冰阔落，扫码捐赠网管小贾~**



![](.\qrcode.png)

**扫码关注微信公众号@网管小贾，个人微信：sysadmcc**

网管小贾 / sysadm.cc