UrBackup Server 2.4.x 管理手册中文版（七）备份进程

副标题：备份进程~

英文：administration-manual-for-urbackup-server-7

关键字：administration,manual,urbackup,backup,server,client,architecture



 

### 7 备份进程

 本节将详细说明如何执行备份。 



##### 7.1 文件备份

服务器检测到当前时间距离最近一次增量备份的时间大于增量备份的时间间隔，或当前时间距离最近一次完整备份的时间大于完整备份的时间间隔，即开始启动备份。

* 当前时间 - 最近一次增量备份时间 > 增量备份时间间隔
* 当前时间 - 最近一次完整备份时间 > 完整备份时间间隔

也可以根据客户端请求主动启动备份。



备份时服务器会创建一个新目录，它将用于保存备份。

此目录以 `YYMMDD-HHMM` 这样的格式构成，其中 `YY` 是十位数格式的年份，`MM` 是当前月份，`DD` 是当天日期，以及 `HHMM` 表示当前的小时和分钟。

该目录被创建于 `备份存储路径`中名称与客户端名称相同的子目录中。

例如，主机名称为 `DESKTOP-2OQEQDF` 的客户端，它的备份被依次存放在服务器备份存储路径 `D:\Backup` 的如下路径中。

```
D:\Backup\DESKTOP-2OQEQDF
```

则每个备份按日期时间不同存放在前者目录的子目录中。

```
D:\Backup\DESKTOP-2OQEQDF\YYMMDD-HHMM
```

图01



服务器向客户端请求文件列表结构。

客户端则构建文件列表并回复报告服务器已完成。



服务器从客户端下载 `urbackup/data/filelist.ub` 。

如果是增量备份，服务器会将新的 `filelist.ub` 与来自客户端的最后（前）一个文件列表进行比较并计算差异。



服务器开始传输并下载文件。

如果是增量备份，则只下载较新的以及更改过的文件。

如果是完整备份，则从客户端下载所有文件。



服务器将文件下载到临时文件中。

此临时文件默认位于备份存储目录中的 `urbackup_tmp_files` 文件夹中，亦或者，如果你在高级设置中启用了它，则位于系统临时文件夹中。

图02



成功下载文件后，服务器会计算其哈希值并查看是否存在具有相同哈希值的另一个文件。

如果存在这样的文件，则假定它们是相同的，并保存为另一个文件的硬链接，同时删除临时文件。

如果不存在此类文件，则再将文件移动到新的备份位置。

文件路径和哈希值会保存到服务器数据库中。



如果当前备份是增量备份并且文件未更改，则会创建指向先前备份中文件的硬链接。



如果当前备份是增量备份，同时启用了 `在增量备份中使用符号链接` ，并且相应目录所含文件或文件夹有超过 `10` 个以上未更改的，则它将建立符号链接到上次备份中的同一文件夹。

图03



因为最近一次备份可能会在当前备份之前被删除，所以该文件夹会被事先移动到一个池目录（客户端文件夹中的 `.directory_pool` ）中，然后均从两处位置建立链接。

每次创建/删除指向该目录的另一个符号链接时，目录的引用计数都会相应增加/减少。



如果客户端在备份期间脱机并且备份是增量备份，则服务器会继续创建指向先前备份中文件的硬链接，但不会再次尝试下载文件。

无法下载的文件不会保存到服务器端文件列表中。

如果备份是完整备份并且客户端离线，则备份进程将中断并保存部分文件列表，其中包括到进程中断前为止下载的所有文件。



如果所有文件都已传输，则服务器会更新客户端备份存储位置中的 `当前` 符号链接以指向新备份。

仅当客户端在备份期间未脱机时才会产生这种情况。                    



##### 7.2 映像备份

服务器检测到当前时间距离最近一次完整备份的时间大于完整备份的时间间隔，当前时间距离最近一次增量备份的时间大于增量备份的时间间隔，或客户端主动请求进行映像备份，即开始启动备份。

* 当前时间 - 最近一次增量备份时间 > 增量备份时间间隔
* 当前时间 - 最近一次完整备份时间 > 完整备份时间间隔
* 客户端主动请求备份



然后，服务器打开客户端服务命令关于卷映像的请求连接。

客户端通过发送错误码或发送映像来应答。

映像是逐个扇区发送的，每个扇区前面都有其在硬盘上的所在位置描述。

客户端只发送文件系统使用的扇区。

如果备份是增量的，客户端会计算以 `512 kbyte` 为单位的块的哈希值，并将其与之前的映像备份进行比较。

如果块的哈希值没有改变，它不会将该块传输到服务器，否则它会将其传输到服务器。

默认情况下，服务器将映像数据直接写入一个 `VHD` 文件。

如果在高级配置中启用了临时文件设定，服务器会先将映像数据写入临时文件。

图04



这个临时文件的最大大小为 `1GB` 。

超过此大小后，服务器继续另行启用新的临时文件。

映像数据并行写入 `VHD` 文件，并位于备份存储位置的客户端目录中。

图05



`VHD` 文件的名称是 `Image_<Volume>_<YYMMDD_HHMM>.vhd` 这个样子。

`<Volume>` 为备份分区（卷）的盘符，`YY` 为当年，`MM` 为当月，`DD` 为当日，`HHMM` 则表示开始映像备份的小时和分钟。

例如下图，是 `C` 盘的映像备份，只不过它采用了压缩 `VHD` 的格式，因此文件后缀是 `vhdz` 。

图06



从 `UrBackup Server 1.4` 版本开始，`VHD` 文件默认是被压缩的（即以 `vhdz` 格式保存），当然这可以在映像备份设置中禁用。

映像备份容量通常都比较大，因此为了保证备份效率建议保持默认的 `压缩VHD` 的设定。

图07



在 `Windows` 上，没有工具可以直接挂载压缩格式的 `VHD` 文件。

（事实上现在较新版本的 `Windows` 上已经可以直接挂载了。）

有关在 `Linux` 上如何挂载 `VHD` 文件，请参见第 `11.4` 节。

想要解压缩映像文件以便它们可以挂载到 `Windows` 上，请参见 `11.7` 节。

压缩的 `VHD` 文件具有扩展名 `.vhdz` 。

`VHD` 文件使用正常压缩级别的 `GZIP` 压缩程序并以 `2MB` 一个区块的形式压缩。



##### 7.3 数据冲突概率

在本节中，我们将研究 `UrBackup` 备份系统认为数据相同的概率问题，即使这些数据有所不同。

这可能是由哈希冲突引起的（即使数据不同，数据也可能具有相同的哈希值）。

如果发生了冲突，可能会导致文件链接错误或映像备份中的块未传输。



###### 7.3.1 文件备份冲突概率

`UrBackup` 在文件重复数据删除之前使用 `SHA512` 对文件进行哈希处理。

相比之下，`ZFS` 使用 `SHA256` 进行块重复数据删除。

选择 `SHA512` 更安全，维基百科关于  `生日攻击` 的页面有一个 `SHA512` 的概率表。

根据这张表，需要 `1.6 * 10(68次方)` 个不同的文件（大小相同）才能达到 `10(-18次方）`的冲突概率。

它还指出，`10(-18次方)` 是常规硬盘的不可纠正误码率的最佳情况。

要拥有 `1.6 * 10(68次方)` 个 `1KB` 的不同文件，你需要 `1.4551915 * 1056 EB` 的硬盘空间。

因此，硬盘返回错误数据或数据在 `RAM` 中损坏的可能性更大，而不是 `UrBackup` 将错误的文件相互链接。



###### 7.3.2 映像备份冲突概率

对于映像备份中的块也是使用 `SHA256` ，它们的大小为 `512 kbyte` 。

对于两个散列，与 `SHA256` 发生哈希冲突的几率为 `1:(2(256次方)) (p = 21256)` 。

在最糟糕的情况下，增量映像备份中有 `2TB∕512kbyte = 4194304` 个不同的块。

在任何  `4194304` 个块中发生冲突的机会（最糟的情况）是 `1 - (1 -21256)(4194304次方) ≈ 3.6 * 10(-71次方)` 。

与例如 `10(-18次方)` 个常规硬盘具有不可纠正位错误的概率相比，这又是低得离谱。



##### 7.4 客户端和服务器上的备份前后脚本

`UrBackup` 在备份的前期和后期都会在服务器和客户端上调用脚本。

本节将列出调用的脚本和脚本参数。



###### 7.4.1 客户端的备份前后脚本

在 `Linux` 上，会在 `/etc/urbackup/` 或 `/usr/local/etc/urbackup/` （取决于 `urbackup` 的安装位置）中搜索客户端备份前脚本和备份后脚本。

在 `Windows` 上，默认情况下会在 `C:\Program Files\UrBackup` 中使用 `.bat` 文件扩展名搜索它们。

图08



除 `Windows` 上的 `prefilebackup.bat` （默认就有）之外，你必须先创建这些脚本才能使它生效。

| Script/脚本     | Description/描述                      | Parameters/参数                                              | On  failure  (return code not zero) /失败(返回非0代码) |
| --------------- | ------------------------------------- | ------------------------------------------------------------ | ------------------------------------------------------ |
| prefilebackup   | 文件备份前调用（早于快照/副本的创建） | 1: `0` 表示完全备份，`1` 表示增量备份<br />2: 服务器令牌<br />3: 文件备份组 | 索引失败且未启动备份                                   |
| postfilebackup  | 文件备份成功完成后调用                | 无参数                                                       | 可忽略                                                 |
| preimagebackup  | 映像备份前调用（早于快照/副本的创建） | 1: `0` 表示完全备份，`1` 表示增量备份<br />2: 服务器令牌     | 映像备份失败                                           |
| postimagebackup | 映像备份成功完成后调用                | 无参数                                                       | 可忽略                                                 |



###### 7.4.2 服务器的备份后脚本

在 `Linux` 上，在 `/var/urbackup` 或 `/usr/local/var/urbackup` 中搜索备份后脚本（取决于 `urbackup` 的安装位置）。

在 `Windows` 上，默认情况下在 `C:\Program Files\UrBackupServer\urbackup` 中搜索它们，文件扩展名为 `.bat` 。

最初这些脚本并不存在，我们必须先创建这些脚本才能使用它们。

| Script/脚本           | Description/描述         | Parameters/参数                                              | On failure  (return code not zero)/失败(返回非0代码) |
| --------------------- | ------------------------ | ------------------------------------------------------------ | ---------------------------------------------------- |
| post_full_filebackup  | 在完整文件备份完成后执行 | 1: 文件备份路径<br />2: 成功为 `1` ，否则为 `0` <br />3: 文件备份组 | 备份失败                                             |
| post_incr_filebackup  | 在增量文件备份完成后执行 | 1: 文件备份路径<br />2: 成功为 `1` ，否则为 `0` <br />3: 文件备份组 | 备份失败                                             |
| post_full_imagebackup | 在完整映像备份完成后执行 | 1: 镜像备份文件的路径<br />2: 映像盘符<br />3: 成功为 `1` ，否则为 `0` | 备份失败                                             |
| post_incr_imagebackup | 在增量映像备份完成后执行 | 1: 镜像备份文件的路径<br />2: 映像盘符<br />3: 成功为 `1` ，否则为 `0` | 备份失败                                             |



### 小结

本节阐述了 `UrBackup` 是如何备份的，给大家简单地呈现了 `UrBackup` 的备份方式和过程。

其中我们可以很清楚地看到 `UrBackup` 是如何校验增量数据，以及作者告诉我们它的可靠性。

另外，我们还可以利用备份前后的自动化脚本来实现一些辅助功能。

这一节的内容非常有利于我们理解 `UrBackup` 的备份流程，消化理解后我们便可以更好地操控备份的制作和管理。



**扫码关注@网管小贾，个人微信：sysadmcc**

网管小贾 / sysadm.cc

