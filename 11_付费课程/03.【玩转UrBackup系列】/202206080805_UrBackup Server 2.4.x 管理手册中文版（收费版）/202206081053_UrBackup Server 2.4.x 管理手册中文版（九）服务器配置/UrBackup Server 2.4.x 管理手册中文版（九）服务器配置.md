UrBackup Server 2.4.x 管理手册中文版（九）服务器配置

副标题：服务器配置~

英文：administration-manual-for-urbackup-server-9

关键字：administration,manual,urbackup,backup,server,client,architecture



 本节将向小伙伴们阐述 `UrBackup` 服务器是如何配置的相关内容。 



#### `UrBackup` 的服务器配置

`UrBackup` 服务器允许管理员更改多项设置。

有一些只影响服务器的全局设置，而有一些则影响客户端和服务器两方面的设置。

对于这些设置，管理员可以设置为默认值或覆盖客户端侧的设置。



##### 9.1 全局服务器设置

全局服务器设置仅影响服务器，任何具有 `general_settings` 权限的用户都可以更改。



###### 9.1.1 备份存储路径

备份存储路径是保存所有备份数据的地方。

为了正常运行，所有这些目录的内容必须位于同一个文件系统上（否则无法创建硬链接）。

此文件系统上有多少空间可用于 `UrBackup` ，部分决定了可以进行多少备份以及 `UrBackup`何时开始删除旧备份。  默认： ””。（默认是空，就是没有设定，需要我们主动设定。）



 ###### 9.1.2 服务器网址

在客户端一侧的菜单中，如果用户选择了 `访问/恢复备份` ，客户端将浏览到的 `URL` 。

这个 `URL` 通常是服务器的访问网址，例如 `http://backups.company.com:55414/`。

默认值：“”（默认是空，如果为空 `访问/恢复备份` 将在客户端上不可用。） 

译者按：这个 `URL` 值需要我们手动指定。



###### 9.1.3 禁止磁盘映像备份

如果选中，服务器将不进行映像备份。  默认值：未选中。



###### 9.1.4 禁止文件备份

   如果选中，服务器将不进行文件备份。  默认值：未选中。



###### 9.1.5 自动关闭服务器

如果选中此 `UrBackup` 将在服务器空闲一段时间后尝试关闭服务器。

这也会导致在启动 `UrBackup` 时就删除太旧的备份而不是在夜间作业中删除这些旧备份。

在 `Windows` 服务器版本中，这无需额外工作即可工作，因为 `UrBackup` 服务器进程以可以关闭机器的 `SYSTEM` 用户身份运行。

在 `Linux` 上，`UrBackup` 服务器作为受限用户运行，通常无权关闭机器。

`UrBackup` 会创建文件 `/var/urbackup/shutdown_now` ，您可以在 `cron` 脚本中检查该文件是否存在，例如：

```
if test -e /var/urbackup/shutdown_now then  
	shutdown -h +10  
fi 
```

默认：不检查。



###### 9.1.6 从更新服务器下载客户端

如果选中此项，服务器将自动查找新的 `UrBackup` 客户端版本。

如果有新版本，它将从 `Internet` 下载。

下载受数字签名保护。

默认值：选中。



###### 9.1.7 当新的服务器版本可用时通知我

如果选中此项，如果有可用的新服务器版本，服务器将显示在状态页面上（仅限管理员）。

默认值：选中。



 ###### 9.1.8 自动更新客户端

如果选中此项，服务器将自动向其客户端发送新版本。

`UrBackup` 客户端界面将要求用户安装新的客户端版本。

如果您选中静默自动更新（参见第 `9.1.8` 节），它将在后台更新。

安装程序受数字签名保护。

默认值：选中。



###### 9.1.9 最大同时备份数

此选项限制服务器将同时启动的文件和映像备份的数量。

你可以减少或增加此数字以平衡服务器负载。

大量同时备份可能会增加备份所需的时间。

可能的同时备份数量几乎是无限的。

默认值：10。 



###### 9.1.10 最近活动客户端的最大数量

此选项限制服务器接受的客户端数量。

活动客户端是服务器在过去两个月中看到的客户端。

如果网络中有多个服务器，则可以使用此选项来平衡它们的负载和存储使用。

默认值：100。



###### 9.1.11 清理时间窗口

`UrBackup` 将在此期间进行清理。

这是删除旧备份和客户端的时间。

你可以将工作日和小时指定为间隔，语法与备份窗口相同。

因此，有关如何指定此类时间窗口的详细信息，请参阅第 `9.3.1` 节。

默认值为 `1-7/3-4` ，这意味着清理将在每天（ `1` -周一 -  `7` -周日）凌晨 `3` 点到 `4` 点之间开始。



###### 9.1.12 自动备份 `UrBackup` 数据库

如果选中，`UrBackup` 会将其内部数据库的备份保存在备份存储路径中名为 `urbackup` 的子目录中。

此备份每天在清理时间窗口内完成。

默认值：选中。

如果你备份了大量文件并且数据库变得很大，请考虑禁用此功能并通过另一种方法执行数据库备份，例如通过在服务器上安装  `UrBackup` 客户端。

因此这种情况下你应该备份 `/var/urbackup` 或 `C:\Program files\UrBackupServer\urbackup` 。 



###### 9.1.13 局域网总体最大传输备份速度

你可以使用此设置限制本地网络中服务器的总带宽使用量。

然后限制服务器和客户端之间的所有连接以保持在配置的速度限制之下。

如果你不希望备份服务器使你的本地网络饱和，这将很有用。

对于不同的时间窗口，所有速度设置都可以有不同的值。  请先参见第 `9.3.1` 节如何指定时间窗口。

你可以通过将速度设置与时间窗口相结合，在不同的时间设置不同的速度，以 `@` 分隔。

如果您希望在工作时间（周一至周五，上午 `8` 点至下午 `6` 点）的默认速度限制为 `60 MBit/s` 和 `10 MBit/s`：

```
60;10@Mon-Fri/8-18
```



将使用最具体的速度限制，因此无论顺序如何，添加一个 `80 MBit/s` 的额外规则（上午 `12` 点到下午 `1` 点）都可以正常工作：

```
60;10@Mon-Fri/8-18;80@1-7/12-13
```



你还可以将速度限制指定为最大速度的百分比，例如 `50%` 。

这可以再次与以 `@` 分隔的窗口组合。

如果指定了百分比值，`UrBackup` 将按一定的时间间隔全速运行，直到速度稳定到最大值。

当它不再测试最大速度时，它将降低为指定的最大速度百分比。



###### 9.1.14 全局文件系统配额

在清理期间，`UrBackup` 将查看备份文件夹所在文件系统的已用空间。

如果使用空间高于全局文件系统配额，`UrBackup` 将尽可能删除旧备份，直到使用空间低于配额。

请注意，不仅 `UrBackup` 的文件被计入配额，其他文件也被计入配额。

你可以通过总空间的百分比或大小来指定配额。

例如让备份设备的大小为 `1 Tera-byte` 。

如果将全局文件系统配额设置为 `90%` ，`UrBackup` 将在使用超过大约 `900 GB` 的可用空间时删除旧备份。

你也可以通过将配额设置为  `900G` 来直接将配额设置为 `900 GB` 。

使用其他单位是可行的，例如 `900000M` 或 `1T` 。



##### 9.2 邮件配置

###### 9.2.1 邮件服务器配置

如果你希望 `UrBackup` 服务器发送邮件报告，则应在 `邮件` 设置页面中配置邮件服务器。

具体设置及其说明如下：



| Settings/配置                | Description/描述                                             | Example/举例         |
| ---------------------------- | ------------------------------------------------------------ | -------------------- |
| Mail server name             | 邮件服务器的域名或IP地址                                     | mail.example.com     |
| Mail server port             | `SMTP` 服务的端口，通常为  `25` 或 `587`                     | 587                  |
| Mail server username         | 用户名（如果 SMTP 服务器需要一个）                           | test@example.com     |
| Mail server password         | 用户密码（如果 SMTP 服务器需要一个）                         | password1            |
| Sender E-Mail Address        | `UrBackup` 的邮件报告将来自哪个电子邮件地址                  | urbackup@example.com |
| Send mails only with SSL/TLS | 仅在可以建立与邮件服务器的安全连接时才发送邮件（保护密码）   |                      |
| Check SSL/TLS certificate    | 检查服务器证书是否有效，如果有效则仅发送邮件                 |                      |
| Server admin mail address    | 发生致命错误时使用的备用地址（例如，紧急清理失败或发生其他致命错误） |                      |

 要测试输入的设置是否有效，可以指定一个电子邮件地址，然后让 `UrBackup` 将向该地址发送测试邮件。 



###### 9.2.2 配置报告

要指定应该通过邮件发送哪些错误的活动，你必须转到 `日志` 页面。

在页面底部有一个名为 `报告` 的区域。

在那里，你可以说明报告应该发送到哪些电子邮件地址（例如  `user1@example.com；user2@example.com` ），以及  `UrBackup` 是否应该只发送有关备份 `失败/成功` 并包含特定级别日志消息的报告。

如果你选择日志级别 `信息` 和 `全部` ，则会发送有关每个备份的报告，因为每个备份都会导致至少一个信息级别的日志消息。

如果你选择 `警告` 或 `错误` ，则不会向你发送没有事件的消息。

每个 `Web` 界面用户都可以以不同的方式配置这些值。

如果用户拥有特定客户端的  `日志` 权限，`UrBackup` 只会将客户端备份报告发送到用户提供的地址。

因此，如果你想将有关某个客户的报告发送到特定的电子邮件地址，你必须为此客户创建一个用户，以该用户身份登录并为该用户配置报告。

用户 `admin` 可以访问所有客户端的日志，因此也可以获取有关所有客户端的报告。



#####  9.3 客户端特定设置

| Settings/设置                                                | Description/描述                                             | Default value/缺省值     |
| ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------ |
| Interval for incremental file backups                        | 服务器将在这样的时间间隔内启动增量文件备份                   | 5 小时                   |
| Interval for full file backups                               | 服务器将以此类间隔启动完整文件备份                           | 30 天                    |
| Interval            for incremental   image backups          | 服务器将以此类间隔启动增量映像备份                           | 7 天                     |
| Interval    for    full image backups                        | 服务器将以此类间隔启动完整映像备份                           | 30 天                    |
| Maximal number of incremental      file backups              | 此客户端的最大增量文件备份数。如果增量文件备份的数量超过此数量，服务器将开始删除旧的增量文件备份。 | 100                      |
| Minimal number of incremental      file backups              | 此客户端的最小增量文件备份数。如果服务器用完了备份存储空间，则服务器可以删除增量文件备份，直到达到这个最小数量。  如果删除备份会导致增量文件备份的数量低于此数量，则会中止并显示错误消息。 | 40                       |
| Maximal number of full file backups                          | 此客户端的最大完整文件备份数。如果完整文件备份的数量超过此数量，服务器将开始删除旧的完整文件备份。 | 10                       |
| Minimal number of full file backups                          | 此客户端的完整文件备份的最少数量。如果服务器用完备份存储空间，则服务器可以删除完整文件备份，直到达到此最小数量。如果删除备份会导致完整文件备份的数量低于此数量，则会中止并显示错误消息。 | 2                        |
| Maximal number of incremental   image backups                | 此客户端的最大增量映像备份数。如果增量映像备份的数量超过此数量，服务器将开始删除旧的增量映像备份。 | 30                       |
| Minimal number of incremental   image backups                | 此客户端的最小增量映像备份数。如果服务器用完备份存储空间，则服务器可以删除增量映像备份，直到达到此最小数量。  如果删除备份会导致增量映像备份的数量低于此数量，则会中止并显示错误消息。 | 4                        |
| Maximal number of full image backups                         | 此客户端的最大完整映像备份数。如果完整映像备份的数量超过此数量，服务器将开始删除旧的完整映像备份。 | 5                        |
| Minimal number of full image backups                         | 此客户端的完整映像备份的最少数量。如果服务器用完备份存储空间，则服务器可以删除完整映像备份，直到达到此最小数量。如果删除备份会导致完整映像备份的数量低于此数量，则会中止并显示错误消息。 | 2                        |
| Delay after system start up                                  | 服务器将在发现新客户端后等待此分钟数，然后再开始备份。       | 0 分钟                   |
| Backup window                                                | 服务器只会在此窗口内开始备份客户端。有关详细信息，请参阅第 `9.3.1` 节。 | 1-7/0-24                 |
| Max  backup  speed for local network                         | 服务器将限制与客户端的连接以保持在此速度范围内（请参阅 `9.1.13` 以使用窗口设置速度）。 | -                        |
| Perform auto-updates silently                                | 如果选择此选项，将在客户端上执行自动更新而不询问用户。       | 未勾选                   |
| Soft client quota                                            | 在每晚清理期间，如果在达到此配额之前备份数量超过文件/映像备份的最小数量，`UrBackup` 将删除此客户端的备份。配额可以是百分比（例如 `20%` ）或绝对值（例如 `1500G` 、`2000M` ） | ""                       |
| Excluded files                                               | 允许你定义应从备份中排除哪些文件。详见 `9.3.3` 节            | ""                       |
| Default  directories to backup                               | 备份的默认目录。 详见 `9.3.4` 节                             | ""                       |
| Directories         to backup are optional by default        | 如果选中，如果配置为在文件备份期间备份的目录丢失，客户端将不会失败备份。 | 未勾选                   |
| Volumes to backup                                            | 指定完成映像备份的卷。用分号或逗号分隔不同的驱动器号。例如 `C;D` 。  使用特殊设置 `ALL` 备份所有卷，使用 `ALL_NONUSB` 备份除通过 `USB` 连接的卷以外的所有卷。 | C                        |
| Image  backup  file format                                   | 标准 `VHD`（虚拟硬盘）、压缩 `VHD (VHDZ)` 或备份存储在 `btrfs` 文件系统 `写时原始复制文件` 上。 | VHD btrfs: Raw  cow file |
| Allow client-side changing of the directories to backup      | 允许客户端更改完成文件备份的目录。                           | 已勾选                   |
| Allow client-side  starting of  incremental/full file backups | 允许客户端启动文件备份。                                     | 已勾选                   |
| Allow client-side  starting of  incremental/full image backups | 允许客户端启动映像备份。                                     | 已勾选                   |
| Allow     client-side viewing  of  backup logs               | 允许客户端查看日志。                                         | 已勾选                   |
| Allow     client-side pausing of backups                     | 允许客户端暂停备份。                                         | 已勾选                   |
| Allow client-side changing of settings                       | 如果选中此选项，则客户端可以通过客户端界面更改其客户端特定设置。如果您不选中此项，服务器设置将始终覆盖客户端的设置。 | 已勾选                   |
| Allow    clients    to quit the tray icon                    | 允许客户端退出托盘图标。如果托盘图标退出当前和将来的备份将暂停。 | 已勾选                   |



###### 9.3.1 备份窗口

服务器只会在备份窗口内开始备份客户端。

客户端始终可以自行启动备份，即使在备份窗口之外。

如果启动备份，它会一直运行直到完成，如果备份过程未在备份窗口内完成，它不会停止。

备份窗口的几个示例：

*  `1-7/0-24` ：允许在每周的每一天每小时进行备份。
* `Mon-Sun/0-24` ：上述的等价符号
* `Mon-Fri/8:00-9:00,19:30-20:30;Sat,Sun/0-24` ：平日 8 点至 9 点和 19:30 至 20:30  之间备份。在周六和周日的整个时间。



正如我们所看到的，一个数字可以表示一周中的一天（ 1-Monday, 2-Tuesday, 3-Wednesday, 4-Thursday, 5-Friday, 6-Saturday, 7-Sunday ）。

你还可以使用日期的缩写（ Mon, Tues, Wed, Thurs, Fri, Sat, Sun ）。

时间可以仅包含完整的小时数或小时数和分钟数，小时是 24 小时制。

你可以为每个窗口定义设置多个日期和时间，以 `,` 分隔。

如果使用 `-` 指定间隔，则间隔中包括开始日和结束日。

你还可以设置多个窗口定义，用 `;` 分隔它们。



###### 9.3.2 高级备份间隔

与备用速度限制（参见第 `9.1.13` 节）类似，可以通过将备用间隔与由 `@` 分隔的备用窗口（参见前面的第 `9.3.1` 节）组合来为不同的时间间隔指定备用间隔，然后将使用最具体的备份间隔。

例如，默认备份间隔应该是一小时，而在晚上（晚上 8 点到早上 6 点）应该是 4 小时：

```
1;4@1-7/20-6
```

 如果另外在周末备份间隔应该是 6 小时： 

```
1;4@1-5/18-6;6@6,7/0-24
```



###### 9.3.3 排除文件

你可以排除具有通配符匹配的文件。

例如，如果你想排除所有 `MP3` 和电影文件，请输入如下内容： 

```
*.mp3;*.avi;*.mkv;*.mp4;*.mpg;*.mpeg
```

 如果你想排除一个目录，例如 `Temp` 你可以这样做： 

```
*/Temp/*
```

你还可以提供完整的本地路径名称：

```
C:\Users\User\AppData\Local\Temp\*
```

或者给出该位置的名称，例如：

```
C_\Users\User\AppData\Local\Temp
```

规则用分号 ( `;` ) 分隔 。



###### 9.3.4 要备份的默认目录

输入用分号 ( `;` ) 分隔的不同位置，例如：

```
C:\Users;C:\Program Files
```

如果你想给备份位置一个不同的名字，你可以用管道符号（ `|` ）添加一个，例如：

```
C:\Users|User files;C:\Program Files|Programs
```

将 `Users` 目录命名为 `User files`，将 `Program Files` 目录命名为 `Programs` 。



这些位置只是默认位置。

即使你选中 `此客户端的单独设置` 并禁用 `允许客户端更改设置` ，一旦客户端修改了路径，客户端将不再使用此字段中的更改。

**目录标志** 每个要备份的目录都有一组标志。

如果你不指定任何标志，则将使用默认标志。

否则，仅使用你指定的标志。

通过在备份位置名称（用 `/` 分隔）后面附加标志来指定标志。

标志本身由  `,` 分隔。 

| Flag/标志         | Description/描述                                             | Default/默认 |
| ----------------- | ------------------------------------------------------------ | ------------ |
| optional          | 如果目录不可用，备份不会失败。                               | 非默认       |
| follow_symlinks   | 将遵循指向指定目录之外的符号链接。                           | 默认         |
| symlinks_optional | 如果无法遵循符号链接，备份不会失败。                         | 默认         |
| one_filesystem    | 如果无法创建该位置的快照/卷影副本，则备份失败。              | 非默认       |
| require_snapshot  | 如果无法创建该位置的快照/卷影副本，则备份失败。              | 非默认       |
| share_hashes      | 在不同的虚拟客户端之间共享文件哈希。                         | 默认         |
| keep              | 在增量备份期间保留已删除的文件和目录。                       | 非默认       |
| required          | 如果设置“默认情况下要备份的目录是可选的”仅目录，则此标志将在备份不可用时失败。 | 非默认       |

 如果要设置可选标志：

```
C:\Users|User files/follow_symlinks,symlinks_optional,share_hashes,optional
```

 （前三个是默认标志）



###### 9.3.5 虚拟子客户端名称

虚拟子客户端允许你使用一个客户端拥有不同的文件备份集。

指定虚拟子客户端后，将出现多个客户端，名称为 `clientname[subclientname]` 。

你可以更改该客户端的所有文件备份特定选项，例如要备份的默认目录、增量文件备份间隔、增量文件备份的最大数量……

主客户端（“客户端名称”）在线则虚拟子客户端将始终在线。

通过 `|` 分隔虚拟子客户端名称。例如：

```
system-files|user-files
```



#####  9.4 广域网设置

| Settings/配置                                                | Description/描述                                             | Default value/默认值 |
| ------------------------------------------------------------ | ------------------------------------------------------------ | -------------------- |
| Internet server name/IP                                      | 客户端可以通过 Internet 访问服务器的 IP 或名称。             | ""                   |
| Internet server port                                         | 服务器将侦听新客户端的端口。                                 | 55415                |
| Do  image  backups over internet                             | 如果选中，服务器将允许此客户端/客户端的映像备份。            | 未勾选               |
| Do full file backups over internet                           | 如果选中，服务器将允许此客户端/客户端的完整文件备份。        | 未勾选               |
| Max  backup  speed for            internet connection        | Internet 客户端的最大备份速度。正确设置此项有助于避免客户端的 Internet 连接饱和（请参阅 `9.1.13` 设置窗口速度） | -                    |
| Total  max  backup speed  for  internet connection           | 所有 Internet 客户端的总累积备份速度。  这可以帮助避免使服务器的 Internet 连接饱和（参见 `9.1.13` 使用窗口设置速度） | -                    |
| Encrypted transfer                                           | 如果选中，则服务器和客户端之间的所有数据都已加密。           | 已勾选               |
| Compressed transfer                                          | 如果选中，则服务器和客户端之间的所有数据都已压缩。           | 已勾选               |
| Calculate file-hashes  on  the client                        | 如果选中，则客户端在备份之前计算每个文件的哈希值（仅计算更改文件的哈希值）。  如果另一个客户端已经传输了相同的文件，则不必传输该文件 | 未勾选               |
| Connect to Internet backup   server   if connected  to  local backup server | 如果选中，客户端将连接到配置的 Internet 服务器，即使它连接到本地网络上的备份服务器。 | 未勾选               |
| Do  not  start  file backups if current estimated data usage limit per month   is   smaller than | 如果客户端可以通过其当前 Internet 连接传输的估计数据量小于指定值，则 UrBackup 服务器将不会安排文件备份。  有关如何估算数据使用限制，请参见 `9.4.1` 。 | 5000 MB              |
| Do not start image backups if current estimated data usage limit per month   is   smaller than | 如果客户端可以通过其当前 Internet 连接传输的估计数据量小于指定值，则 UrBackup 服务器将不会安排映像备份。  有关如何估算数据使用限制，请参见 `9.4.1` 。 | 20000 MB             |





 ###### 9.4.1 数据流量限额预估

目前有两种机制可以估计客户端在其当前 Internet 连接下每月可以传输多少数据。

如果客户端在 Windows 10 上运行，客户端通过 wifi 连接且 wifi 连接设置为按流量计费，则数据使用限制估计为每月 1GB。

否则，`https://github.com/uroni/dataplan_db` 上的数据计划数据库用于通过客户端主机名估计数据使用限制。

你可以在 `http://ipinfo.io/` 上查看您的 Internet 连接的主机名。

如果数据库中缺少它，请为数据计划数据库提供帮助。

数据计划数据库包含估计有使用限制的主机名（例如移动电话连接、飞机等）和估计无限制的主机名。

如果主机名估计为无限制，则 UrBackup  将始终启动备份而忽略设置。

如果数据库中没有有关主机名的信息，则每月的数据使用限制估计为 1TB。

因此，如果你将其中一项设置设置为 1TB 以上，则只有在数据计划数据库中将主机名指定为无限制时才会开始备份。

如果主机名在数据库中有限制，则仅当此限制大于客户端的相应设置时才会开始备份。





##### 9.5 高级设置

在本节中，你将找到全局服务器设置，你只需针对繁重或自定义工作负载进行更改。

大多数设置需要重新启动服务器才能生效。



######  9.5.1 启用临时文件缓冲区

早期版本的 UrBackup  总是首先将来自客户端的传入数据保存到临时文件，然后将其复制到最终目的地（如果数据是新的）——理由是，最终目的地可能很慢，并且您希望从客户尽快。

在 UrBackup 1.1 中，此默认行为已更改为直接将数据复制到最终备份存储。

这两个设置允许您重新启用旧的行为，例如，因为您的备份存储很慢，因为它被删除了重复数据。

如果重新启用它，请确保每个客户端至少有 1GB  空间，并且至少与要备份的最大文件一样多的空间乘以客户端数量或同时备份的最大数量（以较低者为准） , 在你的临时存储上。

你可以通过  `GNU/Linux` 上的环境变量 `TMPDIR` 和 `Windows` 上的服务器设置来更改临时存储目录。



###### 9.5.2 传输模式

`UrBackup` 有不同的文件和图像传输模式。如以下：

* 原始。尽可能“原始”地传输数据。  这是最快的传输模式，并且在服务器和客户端上使用最少的 CPU 周期。

* 散列。  通过在传输过程中对数据进行哈希处理，保护传输的数据免受位错误。

  这会使用客户端和服务器上的 CPU 周期。

  `UrBackup` 使用 TCP/IP 传输图像和文件。

  `TCP/IP` 实现了自己的误码检测机制 (CRC32)。

  然而，如果网络引起大量误码并且如果传输大量数据（>2TB），则TCP/IP的误码检测机制不足以检测所有发生的错误。

  `散列` 传输模式增加了额外的保护层，以降低位错误的可能性。

  如果你通过启用加密的 Internet  模式连接进行备份，则不需要使用散列传输模式，因为加密层已经保护了传输数据的完整性。

* 块差异 - 散列。仅可用于文件备份（因为它会自动为映像完成）。

  传输文件的块使用 CRC32 和 MD5 哈希函数进行比较。

  只有发生变化的块才会通过网络发送。

  在文件只有某些块发生变化的情况下，这会减少传输的数据量。

  它还会导致在服务器和客户端之间发送更多消息并使用 CPU 周期，这就是默认情况下仅对 Internet 客户端启用它的原因。



###### 9.5.3 增量映像备份样式

你可以选择增量映像备份应基于的备份。

在上一次完整或增量映像备份或上一次完整备份（有时称为差异）上。

请记住，仅当映像备份所基于的所有映像备份也被删除时，才能删除映像备份。

此选项对 btrfs 文件系统和原始图像文件格式无效。

因此，映像备份始终基于上次的完整或增量映像备份。



###### 9.5.4 完整图像备份样式

你可以选择完整映像是否应传输所有数据或仅传输从上次增量或完整映像备份（合成完整映像备份）更改的数据。

合成完整备份将仅传输更改的块并将所有块存储在 VHD/VHDZ 文件中。

此选项对 btrfs 文件系统和原始图像文件格式无效，因为在那里将自动禁用完整图像。



 ###### 9.5.5 批处理期间的数据库缓存大小

批处理期间用于数据库缓存的内存量。 



##### 9.6 在增量文件备份期间使用符号链接

如果启用 UrBackup 将使用符号链接将未更改的目录链接到超过 10 个目录/文件。

如果只更改很少的目录，这将大大提高增量文件备份的速度，因为在某些文件系统（例如 NTFS 和旋转磁盘）上必须创建更少的硬链接并且硬链接操作是昂贵的。

不足之处是：

* UrBackup 需要跟踪目录的使用次数。对于硬链接，操作系统会这样做。UrBackup 这样做可能会更慢且更不可靠。

* 如果备份存储文件夹被移动，所有符号链接都将失效。要恢复符号链接，请在 Windows 上运行。

  ```
  C:\Program Files\UrBackupServer\remove_unkown.bat
  ```

   在服务器未运行时在 Linux 上： 

  ```
  urbackupsrv remove-unknown
  ```



 默认使用符号链接。如果使用 `btrfs` 模式，则此选项无效。 

 

##### 9.7 调试：所有文件备份的端到端验证

这是用于调试目的或偏执狂的设置。

如果启用端到端验证，UrBackup 客户端将为每个文件创建文件哈希，以读取每个要备份的文件。

在备份过程结束时，将存储在服务器上的文件的哈希值与客户端计算的哈希值进行比较。

如果哈希值不同，则备份失败，并向服务器管理员发送一封电子邮件。



##### 9.8 调试：使用客户端哈希验证文件备份

在文件备份结束时，服务器将检查备份中的所有文件，并将文件哈希与客户端哈希进行比较。



#####  9.9 定期将 Internet 客户端的文件条目读入数据库

如果选中，UrBackup 将定期刷新其数据库中的哈希值，以便备份删除不会导致 UrBackup 重新下载备份存储中已经存在的文件。



#####  9.10 文件备份后为客户端上的每个用户创建符号链接视图

文件备份成功后，UrBackup 将为备份服务器上客户端计算机上使用的每个创建符号链接视图。

然后可以访问这些视图，例如通过 samba  文件共享。



##### 9.11 每个客户端同时作业的最大数量

每个客户端及其所有虚拟子客户端的最大同时作业数。

如果您希望它同时执行图像和文件备份，请增加此值。



##### 9.12 映像备份期间要分组快照的卷

指定在进行映像备份时 UrBackup 应该一起快照哪些卷。

当快照在一起时，卷彼此一致。

例如，如果一个卷包含数据库而另一个包含数据库日志文件，则应将卷一起创建快照以获得有效备份。

可以是 `all` 以同时对所有卷进行快照，可以是由逗号分隔的卷列表（例如 `C,D` ）或由管道符号分隔的列表列表（例如 `C,D|E,F` ）。



##### 9.13 文件备份期间分组快照的卷

指定在进行文件备份时 UrBackup 应该一起快照哪些卷。

目前仅通过 Windows 客户端支持。

当快照在一起时，卷彼此一致。

例如，如果一个卷包含数据库而另一个包含数据库日志文件，则应将卷一起创建快照以获得有效备份。

可以是 `all` 以同时对所有卷进行快照，可以是由逗号分隔的卷列表（例如 `C,D` ）或由管道符号分隔的列表列表（例如 `C,D|E,F` ）。



##### 9.14 Windows 组件备份配置

通过 `Windows` 备份 `API` 配置 `Windows` 组件备份。

目前，最好通过 `GUI`（可从托盘图标访问或通过运行  `UrBackupClient.exe` 选择 `Windows 组件` 访问）在客户端上进行配置，或者从通过 `GUI` 配置的客户端来复制和粘贴。

`default = 1`（默认值）设置将自动备份 `Microsoft Exchange` 、`Microsoft SQL Server` 和  `Microsoft Hyper-V` 。

`default = 0` 设置将禁用 Windows 组件备份。



### 小结

本节内容非常多，主要阐述了 `UrBackup` 服务器配置的相关内容。

服务器配置不单单涉及服务端的配置，而且还涉及到众多其他一些高级设定，甚至是客户端需要配合的配置。

因此我们需要仔细研究、熟练掌握其中的细节，以便我们可以精准地调试或设定我们想要的最终备份效果。

本节篇幅较长，需要小伙伴们花一些时间来阅读整理，为了更好地消化这些内容，建议在阅读过程中结合一些实际程序的操作，这样效果更好。



**扫码关注@网管小贾，个人微信：sysadmcc**

网管小贾 / sysadm.cc

