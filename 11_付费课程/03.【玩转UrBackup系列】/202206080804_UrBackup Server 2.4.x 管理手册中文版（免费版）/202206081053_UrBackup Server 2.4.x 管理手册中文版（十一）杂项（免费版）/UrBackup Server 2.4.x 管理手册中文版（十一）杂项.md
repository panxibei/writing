UrBackup Server 2.4.x 管理手册中文版（十一）杂项

副标题：杂项~

英文：administration-manual-for-urbackup-server-11

关键字：administration,manual,urbackup,backup,server,client,architecture



---

**推荐 `PDF` 版本：《UrBackup Server 2.4.x 管理手册中文版（网管小贾高级进阶版）》**

此次翻译整理，并不是照本宣科，原文照搬，而是通过我大量的测试实操再结合手册中的内容做的一次大调整、大改写。

我做了以下这些事情：

1. 修正了大量官网英文版中不通顺的语句（每个单词都认识，放一起愣不知道啥意思），使之更便于阅读、更易于理解。
2. 根据实际场景操作添加了大量配图插画强化说明，有了图片理解起来就会很OK啊！
3. 根据实际场景操作调整修正了部分说明内容（有部分官网内容由于版本更新问题，实际上并不准确甚至存在错误和误导）。
4. 根据实际场景操作添加了大量官网手册中没有详细说明，甚至是压根就没提到的其他实用内容。

---



***参考目录***

* *1 开篇介绍*
* *2 服务器安装*
  * *2.1 `Windows` 上的服务器安装*
  * *2.2 `Ubuntu` 上的服务器安装*
  * *2.3 `Debian` 上的服务器安装*
  * *2.4 在其他 `GNU/Linux` 发行版或 `FreeBSD` 上安装服务器*
  * *2.5 `GNU/Linux` 服务器安装提示*
  * *2.6 操作系统独立服务器安装步骤*

* *3 客户端安装*
  * *3.1 `Windows` 客户端安装*
  * *3.2 自动部署到多台 `Windows` 计算机*
  * *3.3 `Linux` 客户端安装*
  * *3.4 `Mac OS X` 客户端安装（追加内容，官网手册无此内容）*

* *4 架构*
  * *4.1 服务器架构*
  * *4.2 客户端架构*

* *5 安全*

  * *5.1 服务端 `Web` 界面的权限管理*
  * *5.2 让 `Web` 页面可通过 `SSL` 访问*
    * *5.2.1 `Apache` 配置*
    * *5.2.2 `Lighttp` 配置*

  * *5.3 客户端安全*
  * *5.4 传输安全*
  * *5.5 广域网模式安全*

* *6 局域网中的客户端发现*

* *7 备份过程*
  * *7.1 文件备份*
  * *7.2 映像备份*
  * *7.3 数据冲突概率*
    * *7.3.1 文件备份冲突概率*
    * *7.3.2 映像备份冲突概率*
  * *7.4 客户端和服务器上的备份前后脚本*
    * *7.4.1 客户端备份前后脚本*
    * *7.4.2 服务器后备脚本*

* *8 广域网客户端*
  * *8.1 自动推送服务器配置到客户端*
  * *8.2 下载预配置的客户端安装程序*
  * *8.3 手动添加和配置客户端*
  * *8.4 通过 `Internet` 传输文件*

* *9 服务器设置*

  * *9.1 全局服务器设置*
    * *9.1.1 备份存储路径*
    * *9.1.2 服务器网址*
    * *9.1.3 禁止磁盘镜像备份*
    * *9.1.4 禁止文件备份*
    * *9.1.5 自动关闭服务器*
    * *9.1.6 从更新服务器下载客户端*
    * *9.1.7 当新有服务器版本可用时通知我*
    * *9.1.8 自动更新客户端*
    * *9.1.9 最大同时备份数*
    * *9.1.10 最近活动客户端的最大数量*
    * *9.1.11 清理时间窗口*
    * *9.1.12 自动备份 `UrBackup` 数据库*
    * *9.1.13 本地网络的总体最大备份速度*
    * *9.1.14 全局软文件系统配额*
  * *9.2 邮件设置*
    * *9.2.1 邮件服务器设置*
    * *9.2.2 配置报告*

  * *9.3 客户端特定设置*

    * *9.3.1 备份窗口*
    * *9.3.2 高级备份间隔*
    * *9.3.3 排除文件*
    * *9.3.4 要备份的默认目录*
    * *9.3.5 虚拟子客户端名称*

  * *9.4 广域网设置*

    * *9.4.1 数据使用限额预估*

  * *9.5 高级设置*

    * *9.5.1 启用临时文件缓冲区*

    * *9.5.2 传输模式*
    * *9.5.3 增量映像备份样式*
    * *9.5.4 完整映像备份样式*
    * *9.5.5 批处理期间的数据库缓存大小*

  * *9.6 在增量文件备份期间使用符号链接*

  * *9.7 调试：所有文件备份的端到端验证*

  * *9.8 调试：使用客户端哈希验证文件备份*

  * *9.9 定期将 `Internet` 客户端的文件条目读入数据库*

  * *9.10 文件备份后为客户端上的每个用户创建符号链接视图*

  * *9.11 每个客户端同时作业的最大数量*

  * *9.12 映像备份期间要分组快照的卷*

  * *9.13 文件备份期间要分组快照的卷*
  * *9.14 `Windows` 组件备份配置*

* *10 恢复备份*
  * *10.1 恢复镜像备份*
  * *10.2 恢复文件备份*

* ***11 杂项***
* ***11.1 手动更新 `UrBackup` 客户端***
  
* ***11.2 日志记录***
  * ***11.3 使用的网络端口***
  * ***11.4 在 `GNU/Linux` 上挂载（压缩）`VHD` 文件***
  * ***11.5 在 `Windows` 上将 `VHD` 挂载为卷***
  
* ***11.6 解压 `VHD` 文件***
  
* ***11.7 将多个卷 `VHD` 映像组装到一个磁盘 `VHD` 映像中***
  
* ***11.8 迁移非 `btrfs` 备份存储***
  
* *12 存储*

  * *12.1 每晚备份删除*
  * *12.2 紧急清理*
  * *12.3 清理具有大量备份文件的服务器*
  * *12.4 清理具有 `UrBackup` 未知文件的存储文件夹*
  * *12.5 归档*
    * *12.5.1 归档窗口*
  * *12.6 合适的文件系统*
    * *12.6.1 `Ext4/XFS`*
    * *12.6.2 `NTFS`*
    * *12.6.3 `btrfs`*
    * *12.6.4 `ZFS`*

  * *12.7 存储设置建议*
    * *12.7.1 `ZFS`*
    * *12.7.2 `Btrfs`*



### 11. `UrBackup` 的杂项

##### 11.1 手动更新 `UrBackup` 客户端

在客户端上使用 `UrBackup` 客户端之前，你应该先对其进行一些测试。

意思是有可能 `UrBackup` 不会自动从 `Internet` 下载最新的客户端版本并进行安装。

这就意味着在第 `9.1.8` 节中描述的自动更新被禁用了。

如果禁用了自动更新，你仍然可以从服务器集中更新客户端。

转至 `https://hndl.urbackup.org/Client/` 并将当前客户端更新文件夹中的所有文件下载到 `Linux` 上的  `/var/urbackup` 或 `Windows` 上（默认）的 `C:\Program Files\UrBackupServer\urbackup` 。

`UrBackup` 将在重新建立连接后推送新版本到客户端。

如果你启用了静默自动更新，则新版本将静默安装在客户端上，否则将弹出窗口要求用户安装新版本。 



##### 11.2 日志记录

`UrBackup` 通常将所有与备份相关的内容记录到几个日志工具中。

每条日志消息都具有相应的严重程度，即错误、警告、信息或调试。

每条日志输出都可以根据此严重程度过滤，例如只显示错误。

服务器和客户端都有单独的日志。

在备份过程中，`UrBackup` 服务器尝试将属于某个备份的所有内容记录在客户端特定的日志中，最后将该日志发送给客户端。

这些是你在客户端界面上看到的日志。

也可以通过 `Web` 界面的 `日志` 选项卡区域查看相同的日志。

如第 `9.2.2` 小节所述，你也可以通过邮件发送它们。



无法授权给特定客户端或会导致过多日志流量的所有内容都记录在通用日志文件中。 

服务器的日志文件默认在 `Linux` 上是 `/var/log/urbackup.log` ，在 `Windows` 上则是 `C:\Progam  files\UrBackupServer\urbackup.log` 。

而相应地客户端日志文件默认是 `/var/log/urbackup_client.log` 和 `C:\Progam files\UrBackup\debug.log`。

默认情况下，这些文件仅包含严重警告或更高级别的日志消息。

在 `Windows` 中，有一个 `args.txt` 文件与日志文件位于同一目录中。

将此文件的 `--loglevel` 的 `warn` 更改为 `debug` 、`info` 或 `error` 以获取一组不同级别的日志消息。

你需要重新启动服务器才能使此更改生效。

在 `Linux` 上，这取决于具体不同的发行版命令。

在 `Debian` 上，则要更改 `/etc/default/urbackupsrv` 中的设置。



##### 11.3 使用的网络端口

服务器绑定到以下默认端口：

| Port/端口 | Usage/用途                    | Incoming/Outgoing<br />进/出（方向） | Protocol/协议 |
| --------- | ----------------------------- | ------------------------------------ | ------------- |
| `55413`   | 为 `web` 接口服务的 `FastCGI` | Incoming/进                          | `TCP`         |
| `55414`   | `HTTP web` 管理接口           | Incoming/进                          | `TCP`         |
| `55415`   | `Internet` 客户端访问         | Incoming/进                          | `TCP`         |
| `35623`   | 用于发现的 `UDP` 广播端口     | Outgoing/出                          | `UDP`         |

 

客户端绑定到以下默认端口：

| Port/端口 | Usage/用途                   | Protocol/协议 |
| --------- | ---------------------------- | ------------- |
| `35621`   | 备份期间发送文件（文件服务） | `TCP`         |
| `35622`   | 用于发现的 `UDP` 广播端口    | `UDP`         |
| `35623`   | 发送指令或用于映像备份       | `TCP`         |



##### 11.4 在 `GNU/Linux` 上挂载（压缩的）`VHD` 文件

如果你使用 `fuse`（用户空间中的文件系统）支持编译 `UrBackup` 或安装了 `Debian/Ubuntu` 软件包，则 `UrBackup` 服务器可以直接挂载 `VHD(Z)` 文件。

你可以通过配置来编译带有 `fuse` 支持的 `UrBackup` ：

```
./configure --with-mountvhd
```

你可以通过如下方法挂载 `VHD(Z)` 文件。

```
urbackupsrv mount-vhd --file /media/backup/urbackup/testclient/\  
Image_C_140420-1956.vhdz --mountpoint /media/testclient_C
```

备份的 `C` 卷中的所有文件将在 `/media/testclient_C` 中有效可读。

卸载由 `UrBackup` 创建的挂载（参见 `mount` 的输出），以停止后台进程。 



##### 11.5 在 `Windows` 上将 `VHD` 挂载为卷

从 `Vista` 开始，`Windows` 可以直接挂载 `VHD` 文件。

如果 `VHD` 文件被压缩，则需要先对其进行解压缩（参见下一节 `11.6`）。

然后进入 `系统设置` > `管理` > `计算机管理` > `磁盘管理` > `其他操作` > `添加虚拟硬盘` ，以只读方式装载 `VHD` 文件。

该映像将在资源管理器中显示为另一个驱动器。

如果 `VHD` 文件位于网络驱动器上，它可能不起作用。



##### 11.6 解压 `VHD` 文件

考虑使用下一节 `11.7` 中描述的方法来解压 `VHD` 文件。

如果要在 `Windows` 上挂载 `VHD` 文件并且它们是压缩的（文件扩展名为 `VHDZ`），则需要先解压缩它们。

使用  `C:\Program Files\UrBackupServer\uncompress_image.bat`  正是为了这个原因。

调用不带参数的批处理文件将打开一个文件选择窗口，你可以在其中选择要解压缩的 `VHDZ` 文件。

解压缩完成后，会创建一个膨胀的临时副本并自动重命名。

如果映像是增量的，则父级 `VHD` 也会自动解压缩。

如果你想防止这种情况发生，请使用第 `11.7` 节中描述的方法来构建单独的未压缩映像。

所有映像文件仍将具有 `VHDZ` 扩展名，否则将不得不更改数据库条目，但文件将不再被压缩。

在 `Linux` 上，可以使用 `urbackupsrv decompress-file -f [filename]` 完成相同的操作。



##### 11.7 将多个 `VHD` 卷映像整合成一个 `VHD` 磁盘映像

`UrBackup` 分别存储每个卷的映像备份。

如果你想在不使用还原 `CD` 的情况下启动加载映像备份，那么作为一台虚拟机你必须将多个卷重新整合到一个磁盘 `VHD` 映像中。

在 `Windows` 上，可以通过运行 `C:\Program Files\UrBackupServer\assemble_disk_image.bat` 来完成。

在第一步中，它将要求整合 `VHD` 映像，例如选择 `Image_C_XXXXX.vhd` 和 `Image_SYSVOL_XXXXX.vhd` 。

源映像也可以是增量或压缩的。

然后它会询问输出的 `VHD` 磁盘映像应该保存在哪里。

之后，它会将 `Image_C_XXXXX.vhd.mbr` 的主引导记录和卷内容写入输出磁盘映像中的适当偏移量。

 在 `Linux` 上，同样的事情可以用

```
urbackupsrv -a /full/path/Image_C_XXXXX.vhdz -a /full/path/Image_SYSVOL_XXXXX.vhdz\  
-o full_disk.vhd
```

 通过选择单个 `VHD` 文件作为输入，此工具还可用于在不解压其父级的情况下解压缩映像。



##### 11.8 迁移非 `btrfs` 备份存储

`UrBackup` 具有内置迁移功能，可让你以最少的停机时间将备份存储迁移到不同的设备。

这仅适用于普通备份存储，也就是说，它不适用于第 `12.7.2` 节中描述的特殊 `btrfs` 模式或第 `12.7.1` 节中描述的写时复制映像。

迁移功能仅适用于迁移，不适用于镜像备份等。

与使用例如 `rsync` 相比，内置迁移有一些优点：

* 它可以以备份级别恢复迁移
* 它会自动禁用所有清理，以最大限度地减少迁移期间必要的更改量
* `UrBackup` 继续备份当前未迁移的客户端并自动迁移新备份
* `UrBackup` 可正确处理硬链接



在 `/var/urbackup` 或 `C:\Program Files\UrBackupServer\urbackup`  中创建一个名为 `migrate_storage_to` 的文件，其唯一内容是要将备份迁移至目的地的路径。

然后重新启动 `UrBackup` 服务器并开始迁移。

你可以在活动页面查看迁移进度。

迁移完成后，将设置中的备份存储路径更改为新位置或将新的备份存储挂载到旧位置。

然后运行第 12.4 节中描述的 `删除未知` 。 







**扫码关注@网管小贾，个人微信：sysadmcc**

网管小贾 / sysadm.cc

