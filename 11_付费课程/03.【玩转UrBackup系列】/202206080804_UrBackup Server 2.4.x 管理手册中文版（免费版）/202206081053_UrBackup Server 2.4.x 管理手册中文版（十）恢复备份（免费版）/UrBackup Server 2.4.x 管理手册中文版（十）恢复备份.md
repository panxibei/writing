UrBackup Server 2.4.x 管理手册中文版（十） 恢复备份 

副标题：恢复备份~

英文：administration-manual-for-urbackup-server-10

关键字：administration,manual,urbackup,backup,server,client,architecture



---

**推荐 `PDF` 版本：《UrBackup Server 2.4.x 管理手册中文版（网管小贾高级进阶版）》**

此次翻译整理，并不是照本宣科，原文照搬，而是通过我大量的测试实操再结合手册中的内容做的一次大调整、大改写。

我做了以下这些事情：

1. 修正了大量官网英文版中不通顺的语句（每个单词都认识，放一起愣不知道啥意思），使之更便于阅读、更易于理解。
2. 根据实际场景操作添加了大量配图插画强化说明，有了图片理解起来就会很OK啊！
3. 根据实际场景操作调整修正了部分说明内容（有部分官网内容由于版本更新问题，实际上并不准确甚至存在错误和误导）。
4. 根据实际场景操作添加了大量官网手册中没有详细说明，甚至是压根就没提到的其他实用内容。

---



***参考目录***

* *1 开篇介绍*
* *2 服务器安装*
  * *2.1 `Windows` 上的服务器安装*
  * *2.2 `Ubuntu` 上的服务器安装*
  * *2.3 `Debian` 上的服务器安装*
  * *2.4 在其他 `GNU/Linux` 发行版或 `FreeBSD` 上安装服务器*
  * *2.5 `GNU/Linux` 服务器安装提示*
  * *2.6 操作系统独立服务器安装步骤*

* *3 客户端安装*
  * *3.1 `Windows` 客户端安装*
  * *3.2 自动部署到多台 `Windows` 计算机*
  * *3.3 `Linux` 客户端安装*
  * *3.4 `Mac OS X` 客户端安装（追加内容，官网手册无此内容）*

* *4 架构*
  * *4.1 服务器架构*
  * *4.2 客户端架构*

* *5 安全*

  * *5.1 服务端 `Web` 界面的权限管理*
  * *5.2 让 `Web` 页面可通过 `SSL` 访问*
    * *5.2.1 `Apache` 配置*
    * *5.2.2 `Lighttp` 配置*

  * *5.3 客户端安全*
  * *5.4 传输安全*
  * *5.5 广域网模式安全*

* *6 局域网中的客户端发现*

* *7 备份过程*
  * *7.1 文件备份*
  * *7.2 映像备份*
  * *7.3 数据冲突概率*
    * *7.3.1 文件备份冲突概率*
    * *7.3.2 映像备份冲突概率*
  * *7.4 客户端和服务器上的备份前后脚本*
    * *7.4.1 客户端备份前后脚本*
    * *7.4.2 服务器后备脚本*

* *8 广域网客户端*
  * *8.1 自动推送服务器配置到客户端*
  * *8.2 下载预配置的客户端安装程序*
  * *8.3 手动添加和配置客户端*
  * *8.4 通过 `Internet` 传输文件*

* *9 服务器设置*

  * *9.1 全局服务器设置*
    * *9.1.1 备份存储路径*
    * *9.1.2 服务器网址*
    * *9.1.3 禁止磁盘镜像备份*
    * *9.1.4 禁止文件备份*
    * *9.1.5 自动关闭服务器*
    * *9.1.6 从更新服务器下载客户端*
    * *9.1.7 当新有服务器版本可用时通知我*
    * *9.1.8 自动更新客户端*
    * *9.1.9 最大同时备份数*
    * *9.1.10 最近活动客户端的最大数量*
    * *9.1.11 清理时间窗口*
    * *9.1.12 自动备份 `UrBackup` 数据库*
    * *9.1.13 本地网络的总体最大备份速度*
    * *9.1.14 全局软文件系统配额*
  * *9.2 邮件设置*
    * *9.2.1 邮件服务器设置*
    * *9.2.2 配置报告*

  * *9.3 客户端特定设置*

    * *9.3.1 备份窗口*
    * *9.3.2 高级备份间隔*
    * *9.3.3 排除文件*
    * *9.3.4 要备份的默认目录*
    * *9.3.5 虚拟子客户端名称*

  * *9.4 广域网设置*

    * *9.4.1 数据使用限额预估*

  * *9.5 高级设置*

    * *9.5.1 启用临时文件缓冲区*

    * *9.5.2 传输模式*
    * *9.5.3 增量映像备份样式*
    * *9.5.4 完整映像备份样式*
    * *9.5.5 批处理期间的数据库缓存大小*

  * *9.6 在增量文件备份期间使用符号链接*

  * *9.7 调试：所有文件备份的端到端验证*

  * *9.8 调试：使用客户端哈希验证文件备份*

  * *9.9 定期将 `Internet` 客户端的文件条目读入数据库*

  * *9.10 文件备份后为客户端上的每个用户创建符号链接视图*

  * *9.11 每个客户端同时作业的最大数量*

  * *9.12 映像备份期间要分组快照的卷*

  * *9.13 文件备份期间要分组快照的卷*
  * *9.14 `Windows` 组件备份配置*

* ***10 恢复备份***
  * ***10.1 恢复镜像备份***
  * ***10.2 恢复文件备份***

* *11 杂项*

  * *11.1 手动更新 `UrBackup` 客户端*

  * *11.2 日志记录*
  * *11.3 使用的网络端口*
  * *11.4 在 `GNU/Linux` 上挂载（压缩）`VHD` 文件*
  * *11.5 在 `Windows` 上将 `VHD` 挂载为卷*

  * *11.6 解压 `VHD` 文件*

  * *11.7 将多个卷 `VHD` 映像组装到一个磁盘 `VHD` 映像中*

  * *11.8 迁移非 `btrfs` 备份存储*

* *12 存储*

  * *12.1 每晚备份删除*
  * *12.2 紧急清理*
  * *12.3 清理具有大量备份文件的服务器*
  * *12.4 清理具有 `UrBackup` 未知文件的存储文件夹*
  * *12.5 归档*
    * *12.5.1 归档窗口*
  * *12.6 合适的文件系统*
    * *12.6.1 `Ext4/XFS`*
    * *12.6.2 `NTFS`*
    * *12.6.3 `btrfs`*
    * *12.6.4 `ZFS`*

  * *12.7 存储设置建议*
    * *12.7.1 `ZFS`*
    * *12.7.2 `Btrfs`*



### 10 `UrBackup` 的恢复备份

`UrBackup` 通过创建灾难恢复映像备份来保护整机，以及创建文件备份来保护用户或服务器文件。

因为文件备份的大小通常可以根据机器上的重要数据来筛选精简，所以它们通常可以比映像备份运行得更频繁。

串联使用映像和文件备份是有意义的，与通过文件备份来备份重要文件相比，备份整个机器的频率更低。 



##### 10.1 恢复镜像备份

可以使用基于 `Debian GNU/Linux` 的可引导的 `CD` 或 `U` 盘来恢复映像备份。

在此映像恢复期间，要恢复的机器必须为可访问，而无需从服务器进行网络地址转换（或者你将第 `11.3` 节中的客户端端口转发到恢复客户端）。

虽然 `Linux`支持许多主板、磁盘控制器等，但你应该始终验证恢复 `CD` 是否适用于你的特定硬件，尤其是在你使用新硬件或新硬件时。

包括一些无线设备的驱动程序和固件以及要配置的程序，但通过有线网络连接进行恢复会更省事、更快，应该是首选。

这样恢复就很容易做到。

启动后，它将寻找备份服务器。

如果找不到，你可以输入备份服务器的 `IP/主机名` 并更改你的网络设置。

找到备份服务器后，它会要求输入用户名和密码。

例如，使用你的管理员帐户访问所有客户端及其映像备份。

然后你可以选择一个镜像备份，选择你要恢复到的磁盘，然后它就会恢复。

目标磁盘必须至少与映像备份的磁盘一样大。

某些硬件更改可能会导致  `Windows` 在恢复之后在系统启动时出现蓝屏。

如果启动修复失败，你可能必须使用 `Windows` 磁盘进行修复安装。

如果你计划将  `Windows` 还原到不同的硬件，则应事先测试不同的硬件组合。



##### 10.2 恢复文件备份

在执行文件备份时，`UrBackup` 会创建一个与当时客户端文件系统相同的文件系统快照。

因此，你可以通过任何文件共享协议或应用程序（例如  `Windows` 文件共享（或 `samba` ）、 `FTP/SFTP` 、 `WebDAV`……）简单地将这些文件系统快照提供给客户端。



你还可以为客户端创建一个用户，允许用户通过 `UrBackup` 的 `Web` 界面浏览客户端的所有备份，并以 `ZIP` 格式下载单个文件或整个目录（限制为最大 `4GB` ）。



从 `UrBackup 2.0.x` 开始，如果配置了服务器 `URL` ，用户可以直接从客户端访问 `Web` 界面。

他们可以右键单击  `UrBackup`  托盘图标，然后单击打开浏览器的 `访问/恢复备份` ，或者他们可以右键单击备份路径中的文件/目录，然后单击 `访问/恢复备份` 以访问所有文件/目录的备份（仅在带有 `Windows Explorer` 的 `Windows` 上）。



浏览备份时，如果客户端在线，`Web` 界面将显示一个恢复按钮。

恢复将要求用户确认。

如果客户端包含 `GUI` 组件（托盘图标），则将弹出用户确认以供客户端上的所有活动用户恢复。

如果未及时确认（超时）或拒绝，则还原将失败。

你可以在  `C:\Program files\UrBackup\args.txt` 中更改此行为，方法是在 `Windows`  上将 `default` 更改为 `server-confirms` ，或者在 `Linux` 上更改 `/etc/default/urbackupclient` 或  `/etc/sysconfig/urbackupclient` 中的恢复设置。

`UrBackup` 就是这样设置的，因为理论上的数据丢失场景是攻击者控制了你的备份服务器，删除了所有备份，然后通过还原来删除客户端上的所有文件。

在 `Linux`（和其他操作系统）上，你还可以在客户端通过命令行 `urbackupclientctl browse` 和 `urbackupclientctl restore-start` 进行恢复。







**扫码关注@网管小贾，个人微信：sysadmcc**

网管小贾 / sysadm.cc

