UrBackup Server 2.4.x 管理手册中文版（五）安全

副标题：安全~

英文：administration-manual-for-urbackup-server-5

关键字：administration,manual,urbackup,backup,server,client,architecture



本篇内容比较简单，简述 `UrBackup` 的基本架构。

我们想要更好地学习 `UrBackup` ，那么对它的基本架构一定要有个直观的了解。



### `UrBackup` 的安全

任何系统都必须充分注重安全方面的问题，`UrBackup` 作为一款基于网络服务的备份解决方案，其安全问题自然也不容忽视。

基于此，我们可以从以下几个方面来说明 `UrBackup` 是如何应对和保障系统安全运行的。





##### 5.1 服务端 `Web` 界面的权限管理

`UrBackup` 服务端的 `Web` 管理页面系统拥有一套非常标准的用户系统，你可以按实际需求创建、管理或删除帐户。 

这些帐户仅通过权限的管理松散地与客户端相关联，意思是说，一个帐户对应着一个客户端，同时它可以视情况而拥有不同的权限。

请小心，在首次安装 `UrBackup` 服务端后，`Web` 管理页面并没有设置管理员密码，因此任何人都可以登录到 `Web` 管理页面并且可以随意查看所有备份的文件！

如果你想做到限制用户访问，那么你应该立即找到设置中的帐户管理，创建管理员帐户并为其设置密码。

管理员帐户可以做任何事情，包括浏览查看所有客户端的文件备份。

而在 `Web` 管理页面中则允许我们创建一个“受限”帐户，并且该帐户只能在某个指定的客户端一侧浏览备份和查看统计信息。

更复杂一些的权限设定可以允许一个帐户访问多个客户端或者限制某些特定权限。

例如，你可以设置一个帐户，该帐户可以执行除浏览备份之外的所有操作。

你可以限制或扩展帐户的权限，目前我们可以参考使用的以下域：

（在 `UrBackup` 中，角色被称为 `域` 。）



| Domain/角色域     | Description/描述                                             |
| ----------------- | ------------------------------------------------------------ |
| browse_backups    | 浏览和下载文件备份                                           |
| lastacts          | 查看服务器执行的最后操作（文件或映像备份）（包括备份大小和持续时间） |
| progress          | 查看当前运行的文件或映像备份的进度                           |
| settings          | 允许更改设置                                                 |
| client_settings   | 允许更改客户端特定设置                                       |
| status            | 允许查看当前状态（上次查看、上次文件备份和最后的映像备份）   |
| logs              | 查看备份期间创建的日志                                       |
| manual_archive    | 手动归档文件备份                                             |
| stop_backup       | 停止服务器上客户端的备份                                     |
| piegraph*         | 查看统计信息                                                 |
| users*            | 获取客户端名称                                               |
| general_settings* | 更改常规设置（如备份存储路径）                               |
| mail_settings     | 更改邮件服务器设置                                           |
| usermod*          | 创建、更改和删除用户                                         |
| remove_client*    | 删除客户端并删除其所有备份                                   |
| start_backup*     | 为服务器上的客户端启动备份                                   |
| download_image    | 通过恢复 `CD` 从服务器下载卷映像                             |



你可以将未标有星号 ( `*` ) 的角色域依次赋予一个或多个客户端的用户ID（用 `,` 分隔），或者直接赋予所有用户ID `all` ，意为该帐户可以访问所有客户端。

带有星号（ `*` ）的角色域必须是属于 `all`  或 `none` ，要么是 `all` ，要么是 `none` ，是固定的，不可被赋予给客户端帐户。

因此为了能够查看统计信息，你需要将 `piegraph` 和 `users` 这两个角色域同时都赋予给 `all` 。

有一个特殊的角色域 `all` ，它是所有角色域的通配符。

这意味着如果将角色域 `all` 赋予给了所有用户ID `all` ，则该帐户就拥有了执行一切的至高无上的权限！

请注意区分，这个 `all` 是和前面表格中的所列一样的角色域，并不是用来指代所有用户ID的 `all` ，虽说它俩名字是一模一样。

好了，到目前为止，我们应该了解了，用户至少需要一个 `status` 角色域才能够使用户成功登录 `Web` 页面系统。



##### 5.2 让 `Web` 管理页面支持 `SSL` 访问

服务器 `Web` 管理页面可以通过 `FastCGI` （ `TCP` 端口 `55413` ）访问。

通过这种方式，你可以使用几乎所有现代 `Web` 服务来连接 `UrBackup` 使用，因此可以通过以下方式访问支持 `SSL` 的 `Web` 管理页面。

本节将描述如何使用 `Apache` 和 `Lighttp` 执行此操作。



###### 5.2.1 `Apache` 配置

在 `Apache` 设置中为 `UrBackup` 的 `www` 目录创建软链接，或是为其定义一个别名 `alias` 。

针对创建软链接的方法，你需要切换到你的 `SSL` 的 `Web` 根目录 `webroot` ，然后执行类似于如下操作。

```
ln -s /usr/share/urbackup/www urbackup
```



请确保你在 `Apache` 上创建软链接的配置项中设置了 `Option +FollowSymLinks` 。

然后启用 `Apache 2.x` 的模块插件 `mod_proxy_fcgi` 。

例如在 `Debian/Ubuntu` 上可以这样。

```
a2enmod proxy_fcgi
```

 

然后将其中的 `x` （某些）文件代理到本地（或远程）运行的 `UrBackup` `FastCGI` 服务器（默认端口 `55413` ）。

例如，将以下内容添加到您的 `SSL` 虚拟主机配置中。

```
ProxyPass "/urbackup/x" "fcgi://127.0.0.1:55413"
```



路径 `/urbackup/x` 取决于 `UrBackup` 的 `Web` 根目录（ `index.htm` 文件应该位于相同目录）以及你希望 `Web` 管理页面所在的位置。

好了，现在 `UrBackup` 应该可以通过 `Apache` 来访问了。



###### 5.2.2 `Lighttp` 配置

如 `Apache` 配置中所述，将 `urbackup/www` 目录链接到 `webroot` 。

添加以下代码到你的 `lighttp.conf` 文件中。

```
include “conf.d/fastcgi.conf” 
```



然后再添加以下代码到 `fastcgi.conf` 文件中。

```
fastcgi.server = ( 
	"/urbackup/x" => 
	((	“host”=>“127.0.0.1”， 
		“port”=> 55413 
	))  
) 
```



##### 5.3 客户端安全

`UrBackup` 客户端仅在服务器或接口进程为其提供凭据时才应答指令。

服务器凭据保存在 `/var/lib/urbackup/server_ident.key` 中。

如果这个文件不存在，那么服务器会在第一次启动时随机生成。



服务器身份标识也由 `私钥/公钥` 形式的密钥认证系统来确认。

如果这种密钥认证不存在，服务器将生成一套私有和公有的 `ECDSA` 密钥，分别是 `server_ident_ecdsa409k1.priv` 和 `server_ident_ecdsa409k1.pub` 。



客户端接口凭据也以相同的方式生成，并且驻留在客户端一侧 `UrBackup` 目录的 `pw.txt` 以及  `pw_change.txt` 两个文件中。

要提供客户端核心进程接口命令，你需要的 `pw.txt` 或 `pw_change.txt` 这两个文件的内容，其内容具体取决于如下某些命令。



`pw.txt`

- `Getting the current status` - 获取当前状态
- `Get the paths which are backed up during file backups` - 获取文件备份时备份的路径
- `Get the incremental file backup interval ` - 获取增量文件备份间隔
- `Start backups` - 开始备份
- `Pause backups` - 暂停备份



`pw_change.txt`

- `Change the paths which are backed up during file backups` - 更改文件备份期间备份的路径
- `Get all settings` - 获取所有设置
- `Change all settings`  - 更改所有设置
- `Get log entries/logs` - 获取日志条目/日志
- `Accept a new server` - 接受新服务器

 

默认情况下，只有特权用户可以访问 `pw_change.txt` 。

在 Windows 上，这会导致访问 `pw_change.txt` 内容会提示需要提升到管理员权限。

如果你不想让让提升权限的窗口老跳出来，请禁用 `UAC` 或更改 `pw_change.txt` 的访问权限以允许非特权用户读取访问。

客户端核心进程从它接受了指令并允许通过 `server_idents.txt` 中所描述的下载文件后就保存了服务器凭据。

 `server_idents.txt` 文件中每行一个凭据，同时服务器的公钥也保存在其中。



如果想要手动将服务器添加到 `server_idents.txt` 中，则需要删除 `server_ident.key` 文件末尾前置的  `#I`  和 `#` 。

`UrBackup` 在安装完成时 `server_idents.txt` 并不存在，之后客户端核心进程才接受（并添加）它看到的第一台服务器（使用服务器的公钥）。

在此之后，客户端不会接受具有不同凭据的其他服务器，并且一旦客户端检测到新服务器，则需要手动添加它们的凭据，或者通过单击弹出窗口来操作。

这可以防止其他人访问你想在公共场所备份的文件。

如果你想让多台服务器能够对一台客户端进行备份，那么你可以有两种选择。

要么，你手动向客户端提供服务器凭据（通过将凭据复制到 `server_idents.txt` 中），要么，通过复制相同的 `server_ident.key` 、 `server_ident_ecdsa409k1.priv` 和 `server_ident_ecdsa409k1.pub` 这三个文件为所有服务器提供相同的凭据。 



































服务端分为**核心**和**接口**两个部分。



目前服务端接口只支持 Web 界面的管理方式。

Web 界面可通过 `FastCGI`（端口 `55413`）和 `HTTP`（端口 `55414`）访问。

你可以利用 `FastCGI` 端口使 Web 界面通过 `SSL` 来访问（例如使用 `apache` ）。

有关详细信息，请参阅第 4.2 节。



服务端核心部分由多个不同任务的线程组成。

一个线程发现新客户端，另一个则检查客户端是否需要备份，而其他线程向客户端发送 ping 包以检查它们是否在线，或者向它们发送当前的备份状态。

还有一个线程则用于更新文件统计信息或删除旧备份。

正是因为 `UrBackup` 服务端由多线程任务组成，所以使用现代多核 CPU 会更高效（核数越多越好！）。



##### 3.2 客户端架构

客户端分为**核心进程**和**接口进程**。



接口进程用于显示托盘图标和对话窗口，同时向核心进程发送设置和命令。

客户端核心进程在 `UDP` 端口 `35622` 上侦听来自服务端的广播消息，并在收到消息后将带有其名称的消息返回给服务端，名称使用的是 Windows 计算机名称。

它在 `TCP` 端口 `35623` 上侦听来自客户端接口进程和服务端的命令，并在 `TCP` 端口 `35621` 上侦听来自服务端的文件请求。

服务端在其命令端口上与每个客户端建立永久连接，客户端可以使用该连接请求备份或更改其设置。

客户端核心进程负责构建要备份的目录中所有文件的列表。

此列表在 `UrBackup` 客户端目录中创建为 `urbackup/data/filelist.ub` 。

为了加速目录列表的创建，要备份的目录会通过 Windows 变更日志被不断监视，Windows 变更日志只能用于整个分区。

因此，当某个卷的目录被第一次添加时，`UrBackup` 客户端核心进程就会将这个卷上的所有目录条目读取到 `urbackup/backup_client.db` 的客户端数据库文件中。

当卷被成功创建了索引之后，此数据库就会不断更新以便时刻与文件系统同步。

因此，如果卷发生了较大变化，数据库更新就会变得比通常更为频繁。

这不会带来很大的性能损失，因为仅仅是目录列表保存在数据库中。

更新每 10 秒发生一次，或者在请求文件列表时进行。

服务端从客户端获取文件列表，并通过客户端内置的文件服务下载变更的或新增的文件来开始备份。

映像备份仅可使用命令端口完成。



### 小结

本节内容灰常简短，主要是根据管理员手册中的理论部分向大家展示。

了解了 `UrBackup` 的基本架构，对于我们更深入地了解它的工作机制和原理是很有帮助的。

在接下来的篇章中，很多程序工作的方式也是基于本篇所述的架构原理。

本节只涉及理论内容，故没有特别的测试实践过程，在之后的篇章中就会有大量的动手过程。

如果你有什么不明白的地方，也可以随时回过头来再反复研究一下。

OK，今天就先到这儿吧，今晚不加班庆祝一下，打工人不再 996 了！



**扫码关注@网管小贾，阅读更多**

网管小贾的博客 / www.sysadm.cc

