UrBackup Server 2.4.x 管理手册中文版（九）服务器配置

副标题：服务器配置~

英文：administration-manual-for-urbackup-server-8

关键字：administration,manual,urbackup,backup,server,client,architecture



 本节将向小伙伴们阐述 `UrBackup` 服务器是如何配置的相关内容。 



#### `UrBackup` 的服务器配置

`UrBackup` 服务器允许管理员更改多项设置。

有一些只影响服务器的全局设置，而有一些则影响客户端和服务器两方面的设置。

对于这些设置，管理员可以设置为默认值或覆盖客户端侧的设置。



##### 9.1 全局服务器设置

全局服务器设置仅影响服务器，任何具有 `general_settings` 权限的用户都可以更改。



###### 9.1.1 备份存储路径

备份存储路径是保存所有备份数据的地方。

为了正常运行，所有这些目录的内容必须位于同一个文件系统上（否则无法创建硬链接）。

此文件系统上有多少空间可用于 `UrBackup` ，部分决定了可以进行多少备份以及 `UrBackup`何时开始删除旧备份。  默认： ””。（默认是空，就是没有设定，需要我们主动设定。）



 ###### 9.1.2 服务器网址

在客户端一侧的菜单中，如果用户选择了 `访问/恢复备份` ，客户端将浏览到的 `URL` 。

这个 `URL` 通常是服务器的访问网址，例如 `http://backups.company.com:55414/`。

默认值：“”（默认是空，如果为空 `访问/恢复备份` 将在客户端上不可用。） 

译者按：这个 `URL` 值需要我们手动指定。



###### 9.1.3 禁止磁盘映像备份

如果选中，服务器将不进行映像备份。  默认值：未选中。



###### 9.1.4 禁止文件备份

   如果选中，服务器将不进行文件备份。  默认值：未选中。



###### 9.1.5 自动关闭服务器

如果选中此 `UrBackup` 将在服务器空闲一段时间后尝试关闭服务器。

这也会导致在启动 `UrBackup` 时就删除太旧的备份而不是在夜间作业中删除这些旧备份。

在 `Windows` 服务器版本中，这无需额外工作即可工作，因为 `UrBackup` 服务器进程以可以关闭机器的 `SYSTEM` 用户身份运行。

在 `Linux` 上，`UrBackup` 服务器作为受限用户运行，通常无权关闭机器。

`UrBackup` 会创建文件 `/var/urbackup/shutdown_now` ，您可以在 `cron` 脚本中检查该文件是否存在，例如：

```
if test -e /var/urbackup/shutdown_now then  
	shutdown -h +10  
fi 
```

默认：不检查。



###### 9.1.6 从更新服务器下载客户端

如果选中此项，服务器将自动查找新的 `UrBackup` 客户端版本。

如果有新版本，它将从 `Internet` 下载。

下载受数字签名保护。

默认值：选中。



###### 9.1.7 当新的服务器版本可用时通知我

如果选中此项，如果有可用的新服务器版本，服务器将显示在状态页面上（仅限管理员）。

默认值：选中。



 ###### 9.1.8 自动更新客户端

如果选中此项，服务器将自动向其客户端发送新版本。

`UrBackup` 客户端界面将要求用户安装新的客户端版本。

如果您选中静默自动更新（参见第 `9.1.8` 节），它将在后台更新。

安装程序受数字签名保护。

默认值：选中。



###### 9.1.9 最大同时备份数

此选项限制服务器将同时启动的文件和映像备份的数量。

你可以减少或增加此数字以平衡服务器负载。

大量同时备份可能会增加备份所需的时间。

可能的同时备份数量几乎是无限的。

默认值：10。 



###### 9.1.10 最近活动客户端的最大数量

此选项限制服务器接受的客户端数量。

活动客户端是服务器在过去两个月中看到的客户端。

如果网络中有多个服务器，则可以使用此选项来平衡它们的负载和存储使用。

默认值：100。



###### 9.1.11 清理时间窗口

`UrBackup` 将在此期间进行清理。

这是删除旧备份和客户端的时间。

你可以将工作日和小时指定为间隔，语法与备份窗口相同。

因此，有关如何指定此类时间窗口的详细信息，请参阅第 `9.3.1` 节。

默认值为 `1-7/3-4` ，这意味着清理将在每天（ `1` -周一 -  `7` -周日）凌晨 `3` 点到 `4` 点之间开始。



###### 9.1.12 自动备份 `UrBackup` 数据库

如果选中，`UrBackup` 会将其内部数据库的备份保存在备份存储路径中名为 `urbackup` 的子目录中。

此备份每天在清理时间窗口内完成。

默认值：选中。

如果你备份了大量文件并且数据库变得很大，请考虑禁用此功能并通过另一种方法执行数据库备份，例如通过在服务器上安装  `UrBackup` 客户端。

因此这种情况下你应该备份 `/var/urbackup` 或 `C:\Program files\UrBackupServer\urbackup` 。 



###### 9.1.13 局域网总体最大传输备份速度

你可以使用此设置限制本地网络中服务器的总带宽使用量。

然后限制服务器和客户端之间的所有连接以保持在配置的速度限制之下。

如果你不希望备份服务器使你的本地网络饱和，这将很有用。

对于不同的时间窗口，所有速度设置都可以有不同的值。  请先参见第 `9.3.1` 节如何指定时间窗口。

你可以通过将速度设置与时间窗口相结合，在不同的时间设置不同的速度，以 `@` 分隔。

如果您希望在工作时间（周一至周五，上午 `8` 点至下午 `6` 点）的默认速度限制为 `60 MBit/s` 和 `10 MBit/s`：

```
60;10@Mon-Fri/8-18
```



将使用最具体的速度限制，因此无论顺序如何，添加一个 `80 MBit/s` 的额外规则（上午 `12` 点到下午 `1` 点）都可以正常工作：

```
60;10@Mon-Fri/8-18;80@1-7/12-13
```



你还可以将速度限制指定为最大速度的百分比，例如 `50%` 。

这可以再次与以 `@` 分隔的窗口组合。

如果指定了百分比值，`UrBackup` 将按一定的时间间隔全速运行，直到速度稳定到最大值。

当它不再测试最大速度时，它将降低为指定的最大速度百分比。



###### 9.1.14 全局文件系统配额

在清理期间，`UrBackup` 将查看备份文件夹所在文件系统的已用空间。

如果使用空间高于全局文件系统配额，`UrBackup` 将尽可能删除旧备份，直到使用空间低于配额。

请注意，不仅 `UrBackup` 的文件被计入配额，其他文件也被计入配额。

你可以通过总空间的百分比或大小来指定配额。

例如让备份设备的大小为 `1 Tera-byte` 。

如果将全局文件系统配额设置为 `90%` ，`UrBackup` 将在使用超过大约 `900 GB` 的可用空间时删除旧备份。

你也可以通过将配额设置为  `900G` 来直接将配额设置为 `900 GB` 。

使用其他单位是可行的，例如 `900000M` 或 `1T` 。



















`UrBackup` 官方称之为 `Internet` 客户端，叫作互联网客户端也行，不过个人感觉广域网客户端更加契合。

`UrBackup` 能够通过 `Internet` 备份客户端，支持 `LAN` 和 `Internet` 混合备份。

例如，对于并非一直在 `LAN` 中使用但连接到 `Internet` 的移动设备，这可能很有用。

由于它会对备份文件系统造成额外的压力，因此默认情况下此功能是被禁用的。

你需要在设置中启用和配置它并重新启动服务器才能使用它。

你必须设定的最小配置是指定备份服务器在 `Internet` 上可访问的服务器域名或 `IP` 地址。

由于可能在备份服务器和 `Internet` 之间存在防火墙或路由器，因此你还需要在这些设备上配置将 `UrBackup` 端口（默认值：`55415` ）转发到备份服务器。

以下分三个部分来说明三种配置客户端的方法。



##### 8.1 自动推送服务器配置给客户端

如果客户端是一个移动设备，它将是最容易让服务器推动其名称和设置的，推送将自动发生。

服务器也会自动生成针对每个客户端的密钥并且推送以对应客户端。

这假设当前的局域网是一个安全通道。

如果客户端已经被入侵，你仍然可以更新服务器和客户端上的密钥。



##### 8.2 下载预配置的客户端安装程序

如果你在服务器设置中启用 `从更新服务器下载客户端` ，或者手动下载客户端更新并将其放在相应的文件夹中（参见第 `11.1` 节），用户可以在 `状态` 页面从服务器下载预配置的客户端安装程序。

安装程序包括服务器 IP/域名、它正在侦听的端口、客户端名称和身份验证密钥。

这允许已安装的客户端自动连接到下载安装程序的服务器。



##### 8.3 手动添加和配置客户端

`UrBackup` 还允许手动添加客户端和手动配置共享密钥。

要添加这样的客户端，需要执行以下步骤：

1. 以管理员身份进入 `状态` 页面。

2. 单击 `添加新客户端` 并在 `添加广域网客户端名/NAT后端的客户端名` 下输入您要添加的电脑名称。

3.  `UrBackup` 将为该客户端生成并显示一个身份验证密钥。

4. 在客户端上，打开设置并在 `广域网` 选项卡中输入相同的密钥，并在 `客户端` 选项卡中输入你为客户端提供的电脑名称。

   还要输入备份服务器的公共 `IP` 或域名以及可访问的端口。

5. 服务器和客户端现在应该可以相互连接了，如果它不起作用，客户端会在 `状态` 窗口中显示出了什么问题。



##### 8.4 通过 `Internet` 传输文件

如果客户端通过 `Internet` 连接，`UrBackup` 会自动使用节省带宽的文件传输模式。

此模式仅传输已更改的文件块，因此应节省未完全更改的文件的带宽，例如数据库文件、虚拟磁盘等。

这是有代价的：`UrBackup` 必须保存每个文件的哈希值。

如果文件的哈希值不存在，例如因为 `Internet` 模式刚刚启用，则它们是在备份期间根据文件创建的，因此可能会减慢备份过程。



### 小结

本节阐述了 `UrBackup` 的广域网客户端的相关内容。

当我们要实现异地备份，或是不在同一局域网的远程备份等情况的话，`UrBackup` 的广域网模式就可以发挥它的作用了！

虽然广域网模式非常有用，但是它也有相对不足之处，比如限于带宽网速等等的制约因素。

因此基于各种因素，我们应该根据实际情况做出合理有效的备份解决方案。



**扫码关注@网管小贾，个人微信：sysadmcc**

网管小贾 / sysadm.cc

