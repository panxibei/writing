VB6添加资源文件总是内存溢出？最终我还是治好了这胎里病！

副标题：VB6添加资源文件总是内存溢出？最终我还是治好了这胎里病！

英文：vb-is-always-out-of-memory-when-adding-resource-files-finally-i-managed-to-resolve-the-big-problem

关键字：vb,resource,资源文件,资源,memory,overflow,内存溢出







使用过 `VB6` 的小伙伴们应该对资源编辑器和资源文件不陌生吧。

通过添加资源文件的方式，可以将一些想要用到的辅助文件给绑定到 `EXE` 文件中。

比如，我们的程序会用到一些 `DLL` 动态链接库文件，那么就可以通过这样的方式把它嵌入到程序中。

要用的时候再随时将文件释放出来，最终也只需要做成一个 `EXE` 文件，既方便又干净。



至于如何添加资源文件，以及如何释放利用资源文件，这些问题在网上都有很多介绍，内容都挺详细的，在这里就不多啰嗦了。

既然这么方便好用，我当然也不能放过了，于是我就经常这么用来着。

可是有那么一天，我突然发现这玩意出了问题。

要么无法再添加新的文件，要么重新打开工程时就会报错，整得我一脸懵啊！

图x01



内存溢出是什么鬼？

起初我怀疑是我的程序哪里坏了，后来对比了我修改的代码部分，发现并不是哪里写坏了，而是资源文件引起的。

这就有点搞笑了，难道添加个资源文件也会导致内存溢出吗？

然而事实证明这是真的！

经过我不厌其烦多次测试，发现只要添加文件后生成的 `RES` 资源文件本身大小超过 `350` 多兆就会崩溃。

你没看错，就区区 `350` 多兆就玩完了！

反正上不了 `400` 多兆吧，具体上限我没有找到官方的说法。

这么好用的东西，就因为其本身古老陈旧带来的限制而导致成了个半废物，说实话，我有点不太能接受啊！

在查资料的时候，有 `VB6` 生成的 `EXE` 有 `2G` 上限的说法，那么这个资源文件好歹也来个 `2G` 上限也行啊，结果却是那么的悲哀，才这么点大小！

好了，就因为这点问题让我放弃 `VB6` ，我做不到。

擦干眼泪，继续前行，谁麻烦递个手巾板！



既然卡此路不通，那我就另辟蹊径呗，活人还能让尿给憋死？

前一阵正好要做个程序，需要绑定较大资源文件到程序中，大小在数百兆左右，就拿这个来测试吧！

可常规方式行不通，有什么好办法呢？

找了很多资料，思来想去，只有一个简单得不能再简单，但又有点麻烦的做法：手动将资源文件绑定到 `EXE` 文件尾部。

什么？什么？你把话说清楚！



首先，我们先制作一个不带任何资源文件的 `EXE` 程序文件，它具有除了资源文件之外所有你希望要实现的功能。

其次，将需要的资源文件像嫁接手术一样把它们接到 `EXE` 文件后面，有一个接一个，有两个就接两个，一个挨着一个按顺序放到 `EXE` 文件尾部，然后生成一个新的更大的 `EXE` 文件。

最后，当需要释放或使用资源文件时，再正常执行程序将其从尾部读取即可。



说到这儿可能有经验的小伙伴会说，这不是病毒原理嘛！

没错，早期的病毒就是这么干的，在正常程序屁股后边加一段代码。

当被感染的程序执行到最后时，它并没有结束，而是继续执行后面的病毒代码。

因此早期杀毒基本上总是要先判断正常文件大小是否有变化，如果变大了，那么大概率就是中毒了。

尾部接上一些令人迷惑的东西并不会导致 `EXE` 文件无法执行，因此这是可行的，并且目前看并没有文件大小的限制，总之原理就是这么个原理。



好，原理大概知道了，具体怎么做呢？

我自己做了一个简单的演示示例程序，分为两个部分。

* `XJAddResToEXE` - 将资源文件绑定到原始 `EXE` 文件的尾部
* `XJExampleEXE` - 原始示例 `EXE` 文件（绑定资源之前）



**网管小贾的自定义输出资源文件演示程序.7z**

下载链接：



我来说一下这个示例程序怎么用。



首先，准备好一个未绑定资源文件前的 `EXE` 文件，示例中我们就用 `XJExampleEXE` 吧。

注意这个 `EXE` 中是提前写有释放资源文件代码的。



其次，打开 `XJAddResToEXE` ，指定好你想要绑定的资源文件，本示例只演示添加一个资源文件的情况。

导出文件则写上 `XJExampleEXE` 的同名文件，即生成新的 `EXE` 文件也是一样名字的。

如果你想生成不同名称的新的 `EXE` 文件，那么需要修改代码（源代码提供付费下载）。

图a01

图b04



我们可以对比一下绑定资源前后的两个 `EXE` 文件，明显后者比较胖一点哈，容量差不多增加的就是资源文件的大小！

图b01



最后，打开新生成的 `XJExampleEXE` 文件，指定好释放路径和文件名，点击按钮即可看到导出的资源文件。

图a02

图b02



如果你不放心，完全可以将释放出来的资源文件拿过来对比一下，别光看大小，要看一看哈希值，基本上就不会错了。

图b03



大家可以通过演示程序来体验手动绑定资源文件的感觉。目前只支持绑定一个文件。

其实严格来说应该是演示程序只支持释放一个资源文件，因此只能给它绑定一个而不是多个。

不过如果你想要批量绑定多个文件，而且还能做到正常释放，那么就请参考源代码吧！





**网管小贾的自定义输出资源文件源代码.7z**

下载链接：







**将技术融入生活，打造有趣之故事**

网管小贾 / sysadm.cc