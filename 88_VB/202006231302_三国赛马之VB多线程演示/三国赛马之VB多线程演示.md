三国赛马之VB多线程演示

副标题：纯API实现VB多线程技术



话说自从刘备封了五人为五虎上将，关羽就对此有些许不满。

他对黄老将军也能被封为五虎之一颇有意见，早已不念战长沙时与黄老将军（黄忠）两人惺惺相惜之情，如今着实地看不起这年逾七旬的老者。

而黄老将军也不服老，总是想证明自己宝刀未老，还能上阵杀敌。

两个人就这么你不服我不忿，一来一回总是明里争暗里斗。

这不前几日这老二位不知哪里来的兴致，突然又要打赌比赛、一决高下。

如今见着了赵云，怕别人看出各自的小心眼儿，硬是也要拉上他一起赌赛。

这次不比武，换作赛马了，并约在三日之后579.7高地，以谁先到山顶为胜。



说到这儿，我不禁思考起来，在VB中如何实现多线程功能，当然不涉及 `Timer` 控件。

之前拜读过某几位大神关于VB6多线程技术超详细示例（纯API）的文章。

具体网址已不可考，但应该尚存于VB贴吧中，有心可以去找找看。

VB6被很多人诟病，其一便是无法实现多线程功能，其实是一种误解，它强大得很呢！



经过一番初步的学习了解，我整理总结如下一些知识内容，请诸君参考：

1、大神提供了一个VB6多线程模板程序，所有实现多线程功能均依照这个模板来扩展实现。



2、使用VB6多线程的必备知识储备

1. 熟练VB6的基本语法
2. 能熟练的使用API
3. 熟知BYVAL和BYREF的区别
4. 大致了解消息循环
5. 最好能懂一点点指针和各种数据在内存中的存在方式
6. 大致了解线程与进程的关系和区别，了解多线程的特点和意义



3、使用VB6多线程，保证其稳定性的注意事项

1. VB6多线程程序在IDE下的稳定性和子类化相当，编译为EXE后才具有完整的稳定性
2. VB6多线程程序必须以SUB MAIN作为启动对象(在在工程——属性——启动对象中自行设置)
3. 由于是用的是ACTIVEXEXE的初始化流程（但是工程类型必须选择标准EXE！），所以必须在SUBMAIN中处理重入问题（模版中已经写好了）
4. VB6主线程（就传统的拖控件，在事件里面写代码的那个线程）不要先于子线程退出，否则容易发生难以预料的情况
5. 不要在子线程中直接定义定长数组（例如dim arr(100) as long），否则将导致程序崩溃。如果一定要在子线程中直接定义定长数组，请用REDIM（例如Redim arr(100) as Long）代替
6. 多个线程在程序逻辑上有可能会同时操作同一块内存时（新手可以理解为同时操作同一变量或HDC之类的东东时），要特别注意加锁。（原子操作不必加锁，详情请百度）即使用临界区排队处理，否则易导致数据混乱甚至程序崩溃。但是DOEVENTS不能进入临界区，否则易造成相关的线程锁死。



4、本套VB6多线程方法有如下特点

1. 稳定：采用的是微软官方藏起来的，对VB6 ACTIVEXEXE多线程环境进行初始化的一套流程。
2. 高效：可以编译为本机代码运行，而不是龟速PCODE。优化选项可以随意勾选，保证了执行效率。
3. 方便快捷：限制较少，所有的工作都可以在一个工程内全部完成。对API的声明既可以用TLB也可以用VB6最传统的Declare XXX。生成的EXE在自带有VB6运行库的任何WINDOWS系统上都可运行，就多线程技术本身而言无需额外注册其它组件，且生成的程序可以被加壳。
4. 参考资料易得：由于是系统API创建的多线程，绝大部分的技术原理和C系列语言的多线程是相通的。完全可以参考C的相关技术和代码。这对以后想学C系列语言的爱好者们来说是个很好的适应性“热身运动”。
5. 实用，学习成本低：这是以上四个特点的综合。有一定编程功力的爱好者能很快上手，学习成本远低于另外再学一门语言，而且很多内容都是所有的多线程技术本来就都要学习的。并且该套方法继承了VB6快速开发的初衷和特点，具有很强的实用性。



