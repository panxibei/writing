玩一玩VBRichClient的WebServer

副标题：

英文：

关键字：





`HTML` 测试代码。

```html
<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>网管小贾 / sysadm.cc</title>
</head>
<body>
	Hello, World!!
	<br>
	你好！网管小贾！！
</body>
</html>
```





在成功显示的页面中，我们按下 `F12` 调出浏览器的编辑调试模式。

找到发送请求的消息头信息，我们可以看到 `ServerName` 是 `RichClient-WebServer` 。

也就是说，我们的确是向 `VBRichClient` 的 `WebServer` 发送了请求并得到了响应。

图a01





看似一切OK，不过我这人吧总不闲着，我就发现这个 `cWebServer` 中还有一个事件 `connRemoved` 。

图a03



从字面上看意思是移除连接，这个事件网上怎么也找不到介绍说明，看来只好自己动手了。





在启动 `Web` 服务之前，我们先确认在 `8888` 这个端口上并没有任何其他服务在跑。

图b01



OK，确认过后我们就可以放心大胆地开启 `Web` 服务了，点击 `Start` 。

图b02



从图中可以看到，`Web` 服务已经成功开启，服务正跑在 `8888` 端口上。

当然现在是没有任何连接的，只是服务在侦听。

好，我们尝试连接一下看看。

在浏览器的地址栏上输入以下网址并回车。

```
http://127.0.0.1:8888/
```





有反应了，我们可以看到有两个客户端请求过来了。

并且可以查看到有两个 `TCP` 连接已经被建立起来。

图b03



只是，呃...为啥浏览器上无法显示页面呢？

其实是由于服务端没有正确返回我们想要的结果。

什么意思呢？

简单地说，就是服务端并把某些页面内容发送给我们，究其原由，是由于我们并没有告诉服务端指定哪些内容来发送。

那我们怎么指定呢？

非常简单，我们就拿 `index.html` 这种常见的文档来做测试吧！

在 `Web` 根目录下，我们准备好一个文本文件，名字就叫 `index.html` 。

其中内容我们写得简单一些，比如像下面这样的 `HTML` 测试代码。

```html
<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>网管小贾 / sysadm.cc</title>
</head>
<body>
	Hello, World!!
	<br>
	你好！网管小贾！！
</body>
</html>
```



OK，我们接着测试，在浏览器地址栏上指定访问 `index.html` ，输入以下网址并回车。

```
http://127.0.0.1:8888/index.html
```

乃斯！网页内容完美呈现！

图b04



此外我们从查看 `TCP` 的结果中也可以了解到，每次访问实际上都要建立一次或多次连接。

为什么要提到这个 `TCP` 连接呢，因为 `HTTP` 就是在 `TCP` 上跑的呀！

不过话不能说得太满，严格一点儿说呢，`HTTP` 的 `1.x` 和 `2.0` 是在 `TCP` 上跑的，而 `HTTP 3.0` 则是改成了 `UDP` 了。

即使如此，深入学习一下 `TCP` 也是非常有利于搞懂 `HTTP` 的，建议小伙伴们注意了解一下这个知识点。



每次访问网站 `HTTP` 都会建立连接，这个我们都懂没问题，但是好像网页加载完或数据传输完后，连接就会在一定的时间之后自动断开。

具体的情况我才疏学浅不甚了解，但的确除此之外当你主动关闭浏览器窗口时，原来的连接就会断开。

那我就突发奇想，能不能主动断开连接呢？



经过我的研究，`VBRichClient` 中 `WebServer` 的事件 `ConnRemoved` 似乎存在 `Bug` ，它老提示我过程声明不匹配，明明我就是照抄它的。

我发了一封邮件给作者，不知道会不会石沉大海。

在得到消息之前，我尝试看能不能通过网址访问来断开连接。

比如，我发送带有 `reset` 字样的网址。

```
http://127.0.0.1:8888/reset
```



显然服务端在接收到请求后肯定会分析网址的，通过比对网址字段我就可以在代码中加上断开连接的功能了。

图b05



主要是通过匹配列表框中的连接记录来断开删除之，目前这个功能做得不够完善，就不放上来献丑了。

其实最好的办法就是利用 `ConnRemoved` 事件自动触发，奈何这个事件不好使，有待以后研究。





### 下载文件

和访问 `html` 文件是差不多的，只不过在返回请求的时候要换一换，换成返回文件的方法。

```
SetResponseFileNameAbs
```



因此事情就变成挺简单了，只要我们判断客户端的请求，如果是访问某些特殊文件的，比如 `xlsx` 或是 `pdf` 等文档，那么我们就认为浏览器想下载这些文件。

接下来就不要响应 `html` 页面元素了，而是返回文件即可。

比如下载 `xlsx` 文件。

图b06



亦或是 `pdf` 文档。

图b07



只是让我感动奇怪的是，`xlsx` 的下载时后缀名为何变成了 `zip` ？

虽说 `xlsx` 其实就是个 `zip` 文件，但是下载下来还要手动修改一下有点麻烦哈！

不知道是我哪儿没搞好，还是 `VBRichClient` 的 `Bug` 。





