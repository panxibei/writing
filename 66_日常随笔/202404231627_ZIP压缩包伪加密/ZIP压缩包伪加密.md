ZIP压缩包伪加密

副标题：

英文：

关键字：



“太公……太……”

高员外一个转身，差点和家仆高才撞个满怀。

员外怒斥道：“你这小厮，慌里慌张，成何体统！”

高才喘着粗气笑脸道：“恭……恭喜……太……太公……法……法师找到了！”



趁着这几天空闲，我四处游玩，不期遇见高才。

这小厮路上没几个人，拽着我就走。

光天化日之下，你竟敢强抢民男，是何道理？

见我执意不走，便说我就是他要找的法师。

我问他我哪里看着像法师了？

他看我眉分八彩、目若朗星，相貌甚伟、仪表堂堂，不是法师，难道是和尚？

高才允若，要是帮忙得力，员外爷必有重谢！

我没得辩驳，只得随他走了。

因此才有了开头一幕。



员外将我让进厅中，两行热泪、口打唉声，诉说前情。

从员外口中，我才知道，原来这户人家家中无子，只有一个女儿。

本想着家中颇有些财产，想着上门招赘，也好将女儿留在身边。

就在半年前，来一男子，口称二十里外的福崚村人，愿意招赘。

可后来时间一久，人品性格就暴露了出来，平日里好吃懒做打骂下人，吃了些酒就爱撒酒疯，连员外老夫妇俩都要打骂。

近日他居然将女儿单独关在后院，更过分的是还将后院上锁。



后来从女儿口中得知，这锁的密码就放在了家里电脑的一个压缩文件里。

可当我们好不容易找到了这个文件时，却发现它需要输入密码才能打开。

然而我们不知道密码是多少，无论试了多少次都不行。

之前也请过几个法师来看过，听说连暴力破解都用上了，就是不行。



虽然对你不抱什么太大的希望，不过也只能是试一试罢了。

说完，太公挥了挥手，让小厮们退下，将电脑从隐秘的柜子中取出。



















一个 `ZIP` 文件通常由三大部分组成：

* 压缩源文件**数据区**，以 `50 4B 03 04` 开头。
* 压缩源文件**目录区**，以 `50 4B 01 02` 开头。
* 压缩源文件**目录结束标志**，以 `50 4B 05 06` 开头。



这里我截了三幅图，各位可以对照着参看。



压缩源文件数据区，注意哈，这个不仅仅是在文件开头，只要有多个文件，那么其他地方也存在对应的文件数据区。

图c01



压缩文件目录区，可以简单地理解为存放的是压缩文件的索引记录。

图c02



压缩文件目录结束标志，与前者压缩文件目录区对应，形成一个文件的完美闭环。

图c03



光这么说，各位肯定得糊涂，还是画图为妙。

```
数据区1
数据区2
数据区N
……
目录区1
目录区结束标志1
目录区2
目录区结束标志2
目录区N
目录区结束标志N
……
```



对于压缩文件1，在 `ZIP` 文件里就是先放数据区1，再放目录区1和目录区结束标志1。

剩下的以此类推，好理解了吧？



接下来揭秘。

我们只要知道这么两个神秘的地方。



第一个，数据区加密位置，偏移量为6，也就是在数据区开头后面的第7位（开头都是从0开始的）。

这个偏移为6的位置，叫做全局方式位标记。

来，上图，光靠想象不行，还得看图。

看到没，从数据区 `50 4B 03 04` 标记往后边数（从 `50` 开始数），第7个就是全局方式位标记。

先记住它，后面要用。

图a01



接下来第二个，目录区加密位置，偏移量为8，也就是目录区开头后面的第9位（开头都是从0开始的）。

这个偏移为8的位置，也叫做全局方式位标记，只是它是目录区的。

接着上图，看到没，从数据区 `50 4B 01 02` 标记往后边数（从 `50` 开始数），第9个就是全局方式位标记。

图a02



其他的这个那个不用管，就这么两个地方，就是我们变戏法的关键所在！

原因很简单，因为看一个 `ZIP` 文件是否加密，主要就是看压缩源文件（数据区）的全局方式位标记和压缩源文件（目录区）的全局方式位标记。

那么这两个地方怎么看，有什么讲究呢？

好，重点来了！

答案可能简单得让你吃惊，关键就在这两个标记数值的奇偶上，而和其他因素没有关系，并且不影响加密属性。

简单一句话，标记为偶数（如：`00` 、`02` 、`04` 等）则表示无加密，标记为奇数（如：`01` 、 `03` 、 `07` 等）则表示有加密。

当然了，数据区标记和目录区标记要相互配合，不能单蹦。



能行吗？

是骡子是马拉出来溜溜呗！

我们随便拿个 `ZIP` 文件来试试不就知道了？



找一个未加密的 `ZIP` 文件，用 `WinHex` 或是其他16进制编辑软件打开它。

先找到数据区标志 `50 4B 03 04` ，然后将第 `7` 位改成任意奇数。

图d01



接着找到目录区标志 `50 4B 01 02` ，然后将第 `9` 位改成任意奇数。

图d02



好了，保存，打完收工！

收什么工，还没测试呢！

测试很简单，打开刚才修改过的 `ZIP` 文件，你会发现神奇的一幕，原来不要密码的，现在它居然……居然要密码了！

不管是系统自带的解压软件，还是第三方的解压工具，都会提示需要输入密码。

图b01

图b02



如果想要恢复成原来不需要输入密码的状态，那么只需要将修改的标记位再改为偶数即可。

是不是简单又魔幻？

这就是传说中的 `ZIP` 伪加密。

的确挺有趣的对不对，为此我之前就自己做了一个小工具，方便伪加密和伪解密。

图e01



**网管小贾的ZIP伪加密演示程序**

下载链接：





经过一番折腾，压缩文件中的密码文件总算是给解出来了！









**将技术融入生活，打造有趣之故事**

网管小贾 / sysadm.cc
