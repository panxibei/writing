重置开机密码不算本事，就问你能猜出来吗？

副标题：重置开机密码不算本事，就问你能猜出来吗？

英文：resetting-the-startup-password-of-windows-is-not-particularly-powerful-how-do-you-guess-it

关键字：windows,password,mimikatz,破解,密码,猜测,minesweeper,扫雷,作弊





夜深人静，小鸡小鸭小猫小狗都睡了，房间里只听得到闹钟“咔咔咔”的声响。

月光透过窗户照在了闹钟上，指针刚刚走过12点，忽然一前一后两个黑影窜进了屋内！

不一会儿，电脑屏幕突然诡异地亮了起来，一个低沉的声音打破了方才的寂静……



“哎，大军哥，咱不是来找那个毒地环评报告的嘛，你摸电脑干啥？”

“嘘……小点声，怕别人听不见啊！”

“你个猪脑袋，我特么当然是在找电脑里的资料！你这硕士是怎么考上的，充话费送的啊？！”



说话的两人正是刘大军和丁小伟，他们都是在校的研究生。

不过大半夜黑灯瞎火的，他们跑这房间里究竟要做什么呢？



“哥，你咋这么肯定这报告材料就在冯教授的办公室里？”

“哎，这电脑咋没关呢，这冯教授也太不懂得节约用电了吧！”

刘大军一皱眉，回头狠狠瞪了一眼这位猪队友：“你知道啥，我早打听过了，冯教授就没有关机的习惯，材料肯定在他的工作电脑里，这不正好，省得我们破解密码了！原先我还准备实在不行就重置密码，这下不用那么麻烦了！”

“你赶紧去那边书柜里找找，还有旁边的抽屉里，都看看有没有其他材料合同！”，刘大军指示丁小伟分头行动。

可这位丁小伟却不知从哪摸着一个摆件，自顾自在一旁摆弄了起来……



没过几分钟，刘大军低声招呼丁小伟，他似乎找到了疑似目标文件夹，上面写着某某项目相关资料。

可是怎么点都进不去，提示需要输入密码。

丁小伟一看他反倒先急了，“哥啊，这肯定是我们要找的资料啊，这咋还要密码呢？”

刘大军没理他，尝试了几次密码始终没能成功。

他摸了摸下巴，低头思忖喃喃自语道：“冯教授年事已高，记不住那么多密码，恐怕用的就是开机密码……看来不能轻易重置密码，还是要破解密码啊……”

丁小伟一旁听了，干脆一拍大腿，好么，还得靠猜，这上哪儿猜去！



说是迟那时快，只见刘大军不知从哪儿掏出个一寸来长带钛合金镶边儿的U盘状物体，刹那间屋内烁烁放光、寒气逼人。

丁小伟倒吸了一口冷气：“哥哎，你在哪儿请的灵宝法器，可闪瞎我的狗眼了……”

刘大军并不搭话，只见他口中念念有词，对着这块物体轻轻吹了口气，然后径直插进电脑。

随着噼里啪啦一顿猛操作，屏幕上出现了这样的画面。

图01



丁小伟瞪大了两只小咪咪眼，咧开大嘴道：“我说哥，这上面……难道是密码？”

“你这脑袋总算好使一回！还好这台电脑的系统不算太新……”说着刘大军随手将 `NTLM` 那一行给复制了下来。

紧接着他又打开了某个在线解密网站，将那串看不懂的密钥粘贴了上去。

他只简单地点击了解密查询，页面上便神奇地出现了明文密码！

图02



看到这儿，丁小伟暗暗吃惊，立马将手中摆件轻轻放下，疑惑道：“这是啥秘密武器啊！还带这么玩的，还能显示登录密码？”

“你说你一天天的，就知道刷手机玩游戏，没个正形，你好歹多少也学点有用的啊！”

眼前的猪队友实在是太拉胯，帮忙是根本指望不上了，刘大军也只希望这位别给自己拖后腿就已经阿弥陀佛了。

没办法，人家里有矿，就是来这儿混个文凭，刘大军哀其不幸怒其不争，只能强压怒火，耐着性子给他解释……





> https://github.com/gentilkiwi/mimikatz/wiki/module-~-sekurlsa



刚才用的是一款开源软件 `mimikatz` （文末统一下载），专门用来翻看电脑密码的。

它是以命令行形式运行，通过输入一系列指令来操作。

这款工具软件开发的初衷，是为了找回遗忘的密码，不过由于它的原理是通过访问系统内存数据（比如 `lsass` 进程），因此其往往会被杀毒软件视为病毒。



通常使用 `mimikatz` 查看密码需要管理员权限才行。

> When working with `lsass` process, `mimikatz` needs some rights, choice:
>
> - Administrator, to get `debug` privilege via [`privilege::debug`](https://github.com/gentilkiwi/mimikatz/wiki/module-~-privilege#debug) 
> - `SYSTEM` account, via post exploitation tools, scheduled tasks, `psexec -s ...` - in this case `debug` privilege is not needed.
>
> Without rights to access `lsass` process, all commands will fail with an error like this: `ERROR kuhl_m_sekurlsa_acquireLSA ; Handle on memory (0x00000005)` *(except when working with a minidump)*.



想要以管理员权限来运行 `mimitatz` 可以有两种方式，一种是使用它自身提供的 `privilege::debug` 命令，还有一种是使用其他方法提升为 `SYSTEM` 账户权限，然后再运行它。

如果没能获得管理员权限，那么会收到像 `ERROR kuhl_m_sekurlsa_acquireLSA; Handle on memory (0x00000005)` 这样失败的错误提示。



想要让 `mimikatz` 正常工作，其前提条件稍显苛刻。

有时默认情况下密码并不存在于内存中，这是出于安全机制考虑的。

密码不在内存中，`mimikatz` 便成了巧妇难为无米之炊了。

然而想要让密码出现在内存中，那么需要做些小动作才行。

比如：当域名服务不可达时，`kerberos` 会将密码暂存在内存中。

又比如：注册表中，`HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest` 项下， `UseLogonCredential` (DWORD) 的值设定为 `1` ，那么 `wdigest` 会将密码暂存在内存中。

还比如：当  `HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa\Credssp\PolicyDefaults` ，或 `HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft\Windows\CredentialsDelegation` 中存在以 `Allow*` 开头的注册项时，`tspkgs/CredSSP`  会保持密码。

当然，这些前提是当前系统并没有使用 `Credential Guard` 安全防护。

> Starting with Windows 8.x and 10, **by default**, there is no password in memory.
>
> *Exceptions:*
>
> - When DC is/are unreachable, the `kerberos` provider keeps passwords for future negocation ;
> - When `HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest`, `UseLogonCredential` (DWORD) is set to `1`, the `wdigest` provider keeps passwords ;
> - When values in `Allow*` in `HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa\Credssp\PolicyDefaults` or `HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft\Windows\CredentialsDelegation`, the `tspkgs` / CredSSP provider keeps passwords.
>
> Of course, not when using *Credential Guard*.



实际操作一下就可以了解它的简单用法。



运行 `mimikatz.exe` ，进入命令提示符状态。

图03



输入命令 `privilege::debug` ，前文有说过，目的是为了提升管理员权限。

```
mimikatz # privilege::debug
Privilege '20' OK
```



当然，如果要记录日志，还可以再来一条命令。

```
mimikatz # log sekurlsa.log
Using 'sekurlsa.log' for logfile : OK
```



但是有时 `privilege::debug` 命令好像执行失败了。

图04



原来 `cmd` 窗口也必须要以管理员权限运行才行。

重新打开命令窗口，再试一次，OK！

图05



有了权限，就可以进一步查看密码了。

输入命令 `sekurlsa::logonpasswords` ，回车！

乖乖，都出来了！

图01



不过密码有可能不是明文的，而是像 `NTLM` 、`SHA1` 等加密形式。

复制 `NTLM` 密钥，找个在线解密网站，如果密码比较简单，那么它就无处遁行了。

图02



接着再看，还能看到电脑里保存的访问共享而暂存的远程用户名和密码。

图06



总之 `mimikatz` 功能强大，在忘记密码却又需要找回来的时候就显得非常有用。

不过这个 `mimikatz` 也存在一些问题，比如在较新的 `Windows` 系统上，由于安全强化致使其可能并不十分有效，同时也可能会被当作病毒而被查杀。

建议在较低版本的系统上（比如 `Win7` 或旧版 `Win10` ）并关闭杀毒软件尝试。



刘大军正说得兴奋，这才发现这小子居然玩起了游戏，也不知道丁小伟什么时候摆弄起了电脑，可把他给气坏了！

他正要发作，丁小伟却嬉皮笑脸说道：“嘿嘿……冯教授电脑上还有扫雷，我电脑上咋没有呢，哥，正好你也来玩两把……”

“玩你个脑袋玩！”，刘大军一把夺过鼠标，直想给这不争气的来一脚。

“我说你个榆木脑袋就知道玩游戏啊！正事还干不干了！”

刘大军一边说，一边打开了 `mimikatz` ，随手输入了以下命令。

```
mimikatz # minesweeper::infos
```



神奇的一幕出现了，命令结果居然显示的是扫雷的隐藏信息，哪埋着雷是一目了然！

图07



丁小伟看傻了眼，不禁发感叹，这玩意除了破解密码，还能玩扫雷哈！

刘大军蔑视道：“瞧你那没见过世面的德性！这叫知识改变命运！回头哥再教你几招！”

丁小伟乐得屁颠屁颠，不住地点头。

正当他俩扯闲篇呢，门外走廊忽然响起了急匆匆的脚步声！

“不好，快……快躲起来！”顾不上关电脑，俩人一溜烟钻到了桌子的下面。

随着门锁从外面被打开，房间里亮起了灯……





**mimikatz.7z(3.73M)含可执行文件及源代码**

下载链接：https://pan.baidu.com/s/1JtywmDvMfxQ6B7DHgw240A

提取码：x2no







**将技术融入生活，打造有趣之故事**

网管小贾 / sysadm.cc

