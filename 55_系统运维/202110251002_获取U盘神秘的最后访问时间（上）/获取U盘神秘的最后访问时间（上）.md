获取U盘神秘的最后访问时间（上）

副标题：

英文：getting-the-last-mysterious-attach-timestamps-of-usb-flash-disk-1

关键字：usb,attach,timestamps,udisk,utc,time,插拨,时间,U盘





叮铃......“据最新消息，从11月1日起，《中华人民共和国个人信息保护法》正式实施......”。

叮、叮铃.......“据本台记者最新报道，我市公安局近期成功打掉一伙非法倒卖公民个人信息的犯罪团伙......”。

桌上的手机屏幕连续蹦出了几条新闻信息，可是简睿丝毫没有将目光从案件卷宗上移开的意思。

正在他若有所思的时候，蔡学飞从外面推门进来。



“师傅，您怎么还在这儿呢？“，蔡学飞风风火火地走近简睿，将一盒点心放在了简睿的面前。

蔡学飞一边打开盒子，一边埋怨道，”我就猜您还在办公室。您要是不回去休息可就会累垮的！”

正在思考中的简睿被蔡学飞打断了思路，倒也没生气，他看了一眼盒子里的东西，正是他喜欢吃的桃酥饼。

正好，肚子有点饿了，简睿也不客气，拿起一块桃酥饼吃了起来。

蔡学飞一瞅老师的吃相，扑哧乐了，“味道怎么样？这可是我珍藏了一个星期的高档点心，我爸都没舍得给他吃呢！”

简睿正想说话，没想到被桃酥噎呛得说不出话来，蔡学飞吓了一跳，立马递上水杯。

“您倒是慢点啊！您要是有个三长两短的，秦队可要拿我开刀了啊！”

“我三长两短，秦队干吗拿你开刀？”简睿喝了几口水，舒服多了。

“那我不是得把您的手艺学会学精嘛！我现在就一小菜鸟，啥也不会啊！”

“你还啥都不会啊，你不是正规警官学校毕业的？”简睿白了他一眼，拿起了第二块桃酥。

“嘿嘿，师傅见笑啦！我那点本事师傅还不知道嘛！”

“就拿最近那个个人信息倒卖案来说，要不是师傅，我们也不可能拿到指认胡莉莉的关键证据啊！”

蔡学飞嘻笑着凑近简睿耳边，“师傅，嘿嘿，其实我就想跟您请教来着，您是怎么从牛老二电脑里把胡莉莉的U盘使用时间记录给查出来的？”

简睿吞下最后一口桃酥，拍了拍手，“哦？你小子真想学？”

“那是那是，师傅本事多，徒弟我学个一两样的就能保我穿衣吃饭了。”

蔡学飞一脸认真，以恳求的语气说道：“师父，您就教我两招吧！别看了，就当休息休息，和我聊聊天放松放松！”

简睿扶了扶眼镜盯着徒弟，“好吧，我就和你唠唠，说完你就回家，别妨碍我工作哦！”

“太好了！您就给我讲讲那个U盘历史记录是咋给整出来的吧！”

“这就要从头说起了......”



案件快速回顾

就在几天前，当地公安局破获一起倒卖个人信息案。

根据有关线索，犯罪嫌疑人胡某莉（外号“莉姐”）曾与从事快递行业的牛某（外号“牛二”）勾结，大量非法获取并倒卖公民个人信息。

关键的证物已由警方查获，但由于最关键的电脑U盘使用时间问题，犯罪嫌疑人始终百般抵赖、拒不认罪。

考虑到案情重大，又在《个人信息保护法》出台实施之际，专案组秦队找到了简睿，希望他能起到关键作用，帮上这个忙。



秦壮：“简睿，你是信息安全方面的专家，现在案情重大，领导非常重视，你给看看，帮个忙吧！”

简睿：“这个案子大概的情况我了解了，不过需要我怎么帮呢？”

秦壮：“哦，是这样，我们已经查获了“牛二”的个人电脑，他的电脑里有大量的用于快递联系的个人信息。而这个“莉姐”，就是倒卖信息的犯罪嫌疑人，她在前天下午的一点到三点之间曾经使用过“牛二”的电脑。在她住处我们也查获了她的U盘，现在我们需要确认在“牛二”的电脑上是否使用过“莉姐”的U盘，并且最好在刚才说的时间段内。这样我们就可以充分掌握了证据。”

简睿：“明白了！秦队请放心，我立刻展开调查！”



声明：本故事纯属虚构，如有雷同，不用多想，就是那么巧！

本文系统在 `Windows 10` 平台上展开测试。



### 使用工具软件

简睿：“当我们想要查看U盘的使用记录时，自然而然地会先想到各种工具软件。

比如，`UsbVewer` 、`USBDeview` 之类的，的确很方便易用，但是它们并不完美，也并不完全能给我们带来帮助。”

蔡学飞：“师父，这些工具软件上不是可以查出某项U盘的使用时间吗？”

简睿：“你仔细看看，上面只写着创建日期和最后的插拔日期。而后者并不能有效地反映出使用U盘的具体时间段。到底什么时候插入，什么时候拨出，这些并不明确。”

图01



蔡学飞：“哦，我懂了！那要怎么才能查出具体的插拔时间呢？”

简睿：“嗯，单纯依靠手头现有的工具软件已经不能满足我们的调查需求了，所以我们要另辟蹊径，自己去调查获取。不过在此之前，我们先要搞懂原理。”

蔡学飞：“师父，您快讲讲原理！”



### 原理

根据相关资料，U盘的使用历史记录均被系统存放在了注册表中。

那么具体这些记录信息被存放到了哪些地方呢？

我们可以通过手工方式来一探究竟。



实际上所有的U盘信息都会被记录到以下注册表项的子项中。

```
HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Enum\USBSTOR
```

图02



而在 `USBSTOR` 展开的子项中，我们就可以清楚地看到之前我们使用U盘的记录了。

图03



接着我们展开每一行记录项时，还有可以看到一串为了标识U盘系统所生成的数字编码。

点击这个数字编码，在右侧的窗口中有一项名字为 `FriendlyName` 的字符串键即是我们所看到的U盘的友好名称。

比如本例中U盘的名称为 `SanDisk Cruzer Blade USB Device` 。

图04



其他的一些有关于这个U盘的基本信息都可以很容易地获取到，只是我们想要的接入时间却并不在这里。

“在哪儿啊？”

“实际上它们被隐藏在了属性 `Properties` 子键中。”

“那我们点击展开 `Properties` 查看不就行了？”

“你太天真了，为啥我要说是被隐藏的，就是因为这个 `Properties` 是无法直接打开的，你瞧！”

 图a01



如果你直接点击 `Properties` 这一项时，就会收到一个打开错误的提示。

上面写得很清楚，无法打开，拒绝访问，即便是管理员权限也会被拒之门外。





“哎？为啥到这里就打不开了呢？”

我不知道原因，可能里面有一些秘密，它并不想让我们普通的用户知道吧。

那我就是想看看里面应该怎么办呢？

其实也是有办法的，需要设置权限，而这个权限就是我们普通用户通常情况下用不到的 `SYSTEM` 权限。

“这也就是我们即便使用管理员权限也无法打开的缘故。”

“ `SYSTEM` 权限似乎更高级一些吧？”

好了，我们来看看如何撬开这把需要 `SYSTEM` 权限的锁。



右键点击 `Properties` ，在菜单中选择 `权限(P)...` 。

图a04



来了个警告，没关系，只是警告而已，告诉你没有权限，但可以更改权限。

这不废话嘛，我就冲着修改权限来的，吓唬别人还行，我可不怕哈，点击确定忽略之。

图a05



打开的 `Properties` 权限窗口一片空白，别事，我们点击 `高级(V)` 按钮。

图a06



在 `Properties` 的高级安全设置中，窗口最上面的那个所有者一项，点击 `更改(C)` 。

图a07



在对象名称框中输入 `administrators` ，点击确定。

图a08



`Properties` 所有者更改为 `administrators` ，点击确定直到退出。

注意，不要勾选 `替换子容器和对象的所有者` ，可能会报错。

图a09



OK，这时由于所有者变更为管理员了，所以我们就允许任意添加权限了。

右键 `Properties` 项，选择 `权限(P)...` 后，在权限窗口中添加管理员为完全控制权限。

图a10



再来展开一下 `Properties` 项，你会发现可以看到里面的内容啦。

如果没有展开，可以按 `F5` 刷新一下。

图a11





随后按以下子项即可查询相应时间。

```
名称				属性路径

第一次安装时间		{83da6326-97a6-4088-9453-a1923f573b29}\0065
最后一次连接时间	{83da6326-97a6-4088-9453-a1923f573b29}\0066
最后一次拨出时间	{83da6326-97a6-4088-9453-a1923f573b29}\0067
```

图a12



“哎，不对啊师父，右边的键值怎么好像是个十六进制的数据啊？”

“你猜对了，这就是十六进制格式的时间数据，叫作 `FILETIME` 。

不过这个比较复杂，牵扯到数据存放的方式（大小尾端）等，所以你有空可以看看以前我写的参考文章。

看过之后就可以了解如何将这个十六进制的数字转换成我们能看得懂的正常可读的时间格式了。”



>参考前文：《十六进制的时间格式到底是个什么鬼？》
>
>链接：https://www.sysadm.cc/index.php/vbbiancheng/798-what-the-hell-is-hexadecimal-datetime-format



“原来如此，那我想要查找指定的U盘，只要按前面说的方法找到十六进制的时间数据，然后再将其转换就可以了吧？”

“没错！不过这里会有一个小问题。”

“什么问题？”

“如果你只查一个U盘的时间记录，那么当然没什么难度。

可要是批量地查询多个U盘呢，难道还要一个一个地去修改注册表项的访问权限吗？”

“还真是哈，这也太麻烦了啊！”

“所以说，我们应该换个思路。

这个查询 `Properties` 注册项问题的本质其实就是要获得 `SYSTEM` 权限，因此我们可以通过某种方法让 `Regedit` 以 `SYSTEM` 权限运行就可以了。”

“怎么整？`SYSTEM` 权限可不是一般用户可以获取的，而且我好像记得 `SYSTEM` 没有密码啊，可怎么输入呢？”

“你说得不错，这个 `SYSTEM` 是高级系统权限，普通用户无法正常以它的身份运行程序，所以我们可以借助第三方程序来达到目的。

比如微软官方提供的工具软件  `PsExec` ，它被打包在了工具集 `PsTools` 中。 ”



**`PsExec` 下载**

官方链接：https://docs.microsoft.com/zh-cn/sysinternals/downloads/psexec

本地下载链接：



“用法比较简单，将 `PsExec` 从 `PsTools` 压缩包中提取出，然后按以下命令行形式执行程序即可。”

```
# -i 程序可交互，-s 以SYSTEM帐户权限运行
psexec -i -s C:\Windows\regedit.exe
```



“此外，还有其他优秀的第三方软件也可以实现这样的效果，比如 `NirCmd` 。”

下载链接：https://www.nirsoft.net/utils/nircmd.html



“需要注意的是，`PsExec` 作为远程工具，它有一个小缺点，那就是必须要保证程序所在的系统开放了默认共享（`C$` 、`Admin$` ），否则会导致程序启动失败。”

图d05



“经过以 `SYSTEM` 权限运行 `regedit.exe` 后，我们就可以打开任意 `Properties` 子项了。”

图a03



"太好了！这样就方便多了！"

“呵呵，可是这样也顶多不用挨个改权限，还算不上方便啊！”

“哦，也是啊，如果U盘记录非常多，那还是要手动一个一个地去对照查找，还是费时费力啊！”

“是的，一针见血！你小子有进步啊！”

“嘿嘿！那师父，这种情况还有啥更好的绝招没？”

“有啊，在我们掌握了原理后，如果某些操作或工具软件不能达到或实现我们目的的时候，我们就可以自己通过编程来达到预期效果。”

简睿接着说：“我们可以通过代码来遍历读取我们需要的注册表项，然后通过 `FILETIME` 格式转换成我们可读的时间格式。

我花了几个晚上的时间，自己动手制作了一款小工具 `XJUsbViewer` ，USB时间记录查看器。”

图a13



"我利用了第三方的 `NirCmd` 程序，在程序启动时自动切换为以 `SYSTEM` 权限运行。

然后再点击查看USB时间记录按钮，系统中的所有USB时间记录就都显示出来了。

除了区分为三个部分（第一次安装时间、最后一次连接时间以及最后一次拔出时间）外，还有十六进制与正常时间格式的对照。"

"嘿，这个好啊！怪不得您效率这么高啊！我又学到一招了！"



**`XJUsbViewer` (xxxK)**

本地下载：



“由于时间比较紧，目前我也就做了这么一个简单的查询功能。

至于清除记录的功能，等到以后有空再研究研究吧！”

“这个太好用了啊！我得从头好好学学，谢谢师父啊！”

“好了，时候不早了，你赶快回去吧！”

“好吧，师父您也早点休息哈！明天我再来向您请教！”

简睿冲蔡学飞点了点头，目送着他走出了办公室。

他揉了揉太阳穴又伸了个懒腰，抖擞了精神坐回了自己的座位，将刚才的那份桌子上的案件资料又拿在手上继续看了起来......





**扫码关注@网管小贾，阅读更多**

网管小贾的博客 / www.sysadm.cc

