wlc9800

副标题：

英文：

关键字：



下班倒计时30秒，老板出现了。

刹那间办公室所有人都像机器一样，仍然保持着疯狂地运转。

唯独我一人对于身后的老板毫无察觉，哼着小调正愉快地收拾着背包……



“你……来一下！”

冷不丁这背后传来的声音差点让我当场跪了。

一回头，只见老板的背景正渐渐远去。

我的天，脑袋嗡嗡作响，赶紧扔下背包，直奔老板办公室……



“老板，您找我有……有什么吩咐？”我一路小跑到门口，差点没刹住。

老板背对着我欣赏着墙上书有硕大标语的锦旗，上写八大金字“加班加点，拼搏腾飞”。

“你来几年了？”

“回您的话，我也不知道来这儿几年了。呃，只记得在食堂饱饱吃了七次蛋炒饭。”

“嗯……七年了，你也该给公司做点实事了！”老板一边用手巾擦着聪明绝顶，一边意味深长的说道。



老板看我有点蒙逼，连忙转身打开了电脑：“最近新增加了好多无线设备，花了不少的钱，我希望能监测到这些设备的实时运行情况。”

“啊，比如最起码我想要知道，每个无线AP上实时连接有多少客户端，以及整个公司总的连接的客户端数量。”

“这样，你想个办法，先简单点吧，把这些数量变化转换成实时动态图表，这样看着也直观方便。”

老板每说一句，就是对我心脏的一次重击。

最后老板问我能搞定不，我将脑袋摇得跟波浪鼓似的。



老板一皱眉，厉声说道：“去帮我找支笔来，要马良牌的！”

“哎……啊？这神笔马良让我上哪儿找去啊，再说您要那玩意干吗？”

“你给我找来，我好给你画饼啊！你小子不是早就吵吵要加工资吗？”

老板一瞪那对小圆眼，嘿，可算看清楚里面还有眼珠子呢！

我皮笑肉不笑的光咧个嘴，没敢接话茬。



“行了！甭废话，这次给你小子这个任务，做好了甭说加工资，给你升职都可以考虑！”

好么，我心说话，这不就是在给我画饼嘛，当我三岁大学刚毕业啊！

“这可太好了！我尽管按您的吩咐办就是了！”我只能假装感激，接下这一大坑。











这个 `WLC9800` 据说是新款，有着各种先进功能，并且管理设置也与以往的网络控制器有很大的区别。

可是，这丫居然没有支持客户端数量和加入的AP数量的 `OID` 。

官方也堂而皇之地贴出来声明，说是目前有 `BUG` ，就是不支持。

> https://www.cisco.com/c/zh_cn/support/docs/wireless/catalyst-9800-series-wireless-controllers/217460-monitor-catalyst-9800-wlc-via-snmp-with.html#anc17

图a03



嘿，什么特么地破玩意，以前都支持，现在新的反而不支持了，这很难吗？

网上一搜，好么，有不少人都有这个需求，愣是没有好的解决办法。

发牢骚是没有用的，得，找找还有没有其他办法吧！

后来摸了半天，寻思着这个控制器本身应该是有这方面的数据的。



于是我看到了这个，当前 `AP` 的 `5G` 信号上连接了 `16` 个客户端。

图c01



有门哈，那其他的 `AP` 我怎么看呢，难道要一个一个点开吗？

很明显，这样做不行，不过至少控制器是肯定有相应统计数据的。

于是乎我就去查了一下获取相关数据的命令，结果还真有。



通过 `SSH` （当然 `Telnet` 也行）登录获取数据信息。

```
WLC9800> show ap wlan summary
```

多啰嗦一句，这条命令可能和其他控制器有所出入，有的命令是写成 `show client` 这样的。

然后我就看到了下面这样一堆数据。

图b07



好家伙，够乱的，不过好像有点规律，似乎是排版问题，挺费眼的！

好了，多少能看出点名堂了吧？

比如左边圈出来的是 `2.4G/5G` 信号，右边圈出来的就是当前分别连接的客户端数量了。

看懂了就好办了，接下来就是对这些信息如何加工提取的问题了。



这么乱的数据，怎么加工提取呢？

哎，我们把它放一放，先来添加监控项，后会具体说。

什么监控项呢？

比如某个时刻一共有几个AP在线，一共有多少客户端连在上面，等等。

我们先来整个简单的，就是某个 `AP` 上连有多少个客户端。



登录到 `Zabbix` ，在左侧菜单中找到 `数据采集` > `主机` ，然后在右侧找到控制器，点击相应的监控项。

图b01



点击界面右上角的 `创建监控项` 。

图b02



在所需填写的栏目内写上相应的参数信息。

* 名称：起个好听好看的名字
* 类型：`SSH` 客户端
* 键值：`ssh.run[<unique short description>,<ip>,<port>,<encoding>,<ssh options>]`
* 主机接口：无
* 认证方法：密码
* 用户名称：登录 `SSH` 用户名
* 密码：登录 `SSH` 密码
* 已执行的脚本：`show ap wlan summary`



其中这个键值怎么写呢？

```
ssh.run[<unique short description>,<ip>,<port>,<encoding>,<ssh options>]
```



可以简单地写成这样：

```
ssh.run[AP Client Count,192.168.123.123,22]
```

其中描述 `<unique short description>` 是一段文字，可以随便写，但不能与其他已有监控项的描述相同。

比如我给写的是：`AP Client Count` 。

然后就是 `IP` 地址，外加端口号，默认 `22` 其实可以不写。



好，这是监控项参数的填写方法，很简单。

接下来主要重点是从输出命令结果中提取对我们有用的数据，因此我们需要添加预定步骤。

这个所谓的预定步骤，就是用来进一步加工获取信息的。

比如本例中的 `show ap wlan summary` 命令，出来一大堆内容，可我只想要某个 `AP` 当前连接的客户端数，很显然我是要去筛选这些数据的。



怎么筛选？

我们先在监控项设定界面中点击 `预处理` ，然后添加一项。

图b04



 `Zabbix` 默认提供了不少预定步骤方法，不过对于这么一堆杂乱无章的内容，简单预设的步骤恐难胜任，因此还是需要用到编程。

`Zabbix` 可以用 `JavaScript` 作为筛选数据的编程工具。

图b05



在选定预定步骤的名称为 `JavaScript` 后，我们需要在后面的 `参数` 部分中写上代码。

图b06



代码就不展示了，文末有下载，我说说实现的主要原理。

首先，将 `show ap wlan summary` 命令输出的内容分为标题和数据两大部分，只取数据部分。

其次，定位根据 `AP` 名称、`SSID` 以及物理信号分类（ `2.4G/5G` ）等过滤筛选出指定 `AP` 所连接的客户端数量。

这里多说一句，如果你想计算所有的 `AP` 一共连了多少客户端，那就是将前面筛选相加后的总和。



最后写好了代码肯定是要测试一下的，要不怎么知道它转不转得起来呢？

好，点击右侧的 `测试` 。

图b08



在打开的界面中，先要勾选 `从主机获取值` ，要是不这么做，那么就没有测试用的数据，结果自然就会失败。

接着直接点击 `获取值并进行测试` 等待测试结果就行了。

图b09



我这边得到的测试结果是数字 `2` ，表示当前 `AP` 上连接有两个客户端。

图b10



如何出错了，那么就根据提示好好看看代码哪里写错了吧！



最终效果，显示当前连接的AP数量，以及 `2.4G` 和 `5G` 各自连接的客户端总数量。

图a01



每个AP连接的客户端数量。

图a02





下载链接：













**将技术融入生活，打造有趣之故事**

网管小贾 / sysadm.cc