虚拟机平台 CentOS 迁移网卡故障一例

副标题：网络不通，这事儿不小~



近期有计划需要将一台虚拟机迁移到新服务器中。

这台虚拟机是 `CentOS 7` 操作系统，所在平台是 `VirtualBox` ，而新平台是 `Esxi` 的。



> 操作系统：CentOS 7
>
> 虚拟平台：VirtualBox → Esxi



虽然 `Esxi` 无法识别 `vdi` 格式的磁盘文件，但是还好 `VirtualBox` 提供了虚拟磁盘转换功能，可以将 `vdi` 格式转换为 `vmdk` 格式的磁盘镜像文件。

通过点击 `VirtualBox` 左上角菜单的 `管理` > `虚拟介质管理` ，然后选中虚拟硬盘后点击复制即可。

图1

图2



磁盘镜像文件不算大，很快就转换好了。

然后在新平台下新建一台虚拟机，并添加上了转换后的磁盘镜像文件。

开机很顺利，登录也很正常，只是怎么好像网络不通啊！

简单地查看了一下，发现原先的固定IP地址不知怎么就变成了自动分配。

图3



自动分配的IP地址与原来固定IP不同，而且时刻都在变动，并不能确保可以正常使用，所以还是得改回来。

于是赶紧查看网卡配置，发现配置文件根本就没有变动过，还是老样子。

```
cat /etc/sysconfig/network-scripts/ifcfg-enp0s3
```



这就很搞笑了，配置没动，怎么就变成其他IP了？

是不是网络服务有问题呢？

查看一下网络服务状态。

```
systemctl status network
```

嗯？有一个错误？难怪网络不对劲啊！

```
Failed to start LSB: Bring up/down networking.
```

图4



这是啥意思，`LSB` 无法启动，怎么还骂人呢？

好吧，不明白，还是祭出搜索大法！



一番苦苦寻找，大概了解到好像是配置上的问题，可以你也看见了，配置文件我根本就没去动过啊！

怎么办呢，还是根据日志定位具体是什么原因吧，于是翻出日志。

```
less /var/log/messages
```

按 `Shift+g` 移动到日志末尾，看到了这么一行文字，说是“此连接没有发现配套的设备”。

图5



它的意思是指我没有网卡？

明明有网卡嘛，只是自动分配了IP地址......

然后再仔细反复地查看日志内容，并与之前列出的IP设定对比，我猛然发现了一个惊人的秘密！

这特么前后的网卡设备名不一样啊！

* 原始网卡名称：`enp0s3`
* 现在网卡名称：`ens192`



不信你可以回过头去看看那几张图片。

原因找到了，解决起来也就容易多了。

由于我的系统是整个照搬到新平台上的，所以大体的不用动什么，只要修改两处地方即可。

一处是网卡配置文件名称，另一处是网卡配置文件里面的设备名称。



具体如下：

**1、将网卡配置文件名称修改成与现有设备名称一致。**

```
cd /etc/sysconfig/network-scripts
mv ifcfg-enp0s3 ifcfg-ens192
```

**2、同时将 `ifcfg-ens192` 文件中的网卡名称修改成 `ens192` 。**

```
DEVICE=ens192
```



修改完毕后，再次重启网络服务。

```
systemctl restart network
```

图6



网络服务似乎没有问题了，那网卡设定怎么样了呢？

再次查看网卡设定，OK，固定IP终于回来了！

图7



经过不断的折腾，最终还是把系统给折腾回来了，省去了再重新安装调试的麻烦。

不过我隐约记得以前好像也碰到过类似的问题，虚拟机平台迁移以后可能会变成日常操作，所以此类问题可能会越来越多。

遇到此类问题，有的小伙伴可能会像我一样先尝试各种各样的办法去解决，比如修改虚拟网卡之类，其实都是在走弯路，只是没想到设备名称会变动。

那么就本文给出的案例，希望能给小伙伴们一点点参考。

如有帮助，还请各位及时关注分享，谢谢！



**关注@网管小贾，阅读更多**
网管小贾的博客 | www.sysadm.cc