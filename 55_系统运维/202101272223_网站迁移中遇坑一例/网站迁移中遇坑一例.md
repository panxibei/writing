网站迁移中遇坑一例

副标题：挪个窝~



早些年前搞了一个阿里的云主机，当时因为促销便宜，为了学习和测试也就入手了。

只是平时我在地面上忙工作，主机在云上闲置着没空打理，也就荒废了许久。

好不容易挤出了时间，也下定了决心要好好利用一番，结果大限将至。

有一首歌唱得好，“等我有了钱的时候我却没时间...“，而我是有了时间却没有钱。

其实我就是个屌斯，没钱时间也是硬挤出来的，呜呼悲哉！

于是摸着口袋上网找主机，居然被我发现了 `SugarHosts` 出了两款迷你主机。

为了规避广告嫌疑，我就不上图了，小伙伴们有兴趣可自行搜索。

一番权衡之下，我选择了 `Tiny G2` 这一款，这一款空间容量更大、带宽更多。



好了，铺垫这么多，还是来说说在迁移过程中遇到的坑吧。

当然首先我要声明这和主机供应商没有关系，只是为了有和我一样需求的小伙伴们好少起弯路有个参考。



我的站点使用 `Joomla!` ，备份打包使用 `Akeeba` 。

> `Akeeba` 官网：https://www.akeeba.com/

`Akeeba` 是 `Joomla!` 的一个备份插件，非常好用，具体可以参考网上的文章。

这里我重点说下如何恢复打包好的备份，也就是怎样将备份恢复到新站中。

`Akeeba` 提供了很多恢复方法，其中有一种比较简单实用，就是 `kickstart` 。



官网有下载，一共就两个文件（一个 `php` 文件，一个语言配置文件），用法也是十分地简单。

首先，将备份包和 `kickstart` 的两个文件上传到主机上的根目录。

图1



其次，用浏览器直接打开 `kickstart.php` 。

```
http://主机域名或IP/kickstart.php
```

出现向导界面，点击 `Start` 开始恢复。

图2



然后，程序自动解压所有文件。

图3



稍待片刻后，点击 `Run the Installer` 开始正式的安装部分。

图4



出现环境参数等确认画面，点击右上角的 `Next` 进入下一步。

图5



接下来是数据库的配置，我就是在这儿遇到了坑。

通常虚拟主机需要事先建立数据库以及有相应访问数据库权限的用户，我已经设定好了。

所以按照虚拟主机上新建的数据库名称及用户名密码填入相应栏位。

当我点击右上角 `Next` 想进入下一步时，出现了警告提示。

图6



当然这个提示并不是坑之所在，它只是警告密码中含有特殊字符，不过一般来说这并不会影响数据库的访问使用。

于是我点下确定继续，然后坑就来了！

图7



它居然说我无法创建数据库，我可是已经给用户赋予所有权限的啊！

后来和客服人员沟通后才发现，虚拟主机只支持一个数据库和一个用户，而数据库只能在控制面板上手动创建，并不支持 `SQL` 导入。

图8



这就很搞笑了！

当然我并不是说服务不好，相反他们的反馈还是很及时的，感谢他们的协助！

我是想说，我无法从已经打包的备份中找到并提取SQL导入语句，它是一个整体。

另外，我又不能通过恢复备份操作来执行创建数据库的动作。

这时我已经陷入了两难境地了。



怎么办呢？

我折腾了好几个小时，尝试将备份恢复到本地测试环境中，看看能不能有其他办法。

我的思路还是回到了寻找那个神秘的SQL语句文件上。

很遗憾的是，我并没有找到那个带有 `Create Database` 语句的文件，但却离奇地想到了另一个办法。

那就是同步数据库名称以及用户名。



有点懵是不是，其实就是想办法将旧站点的数据库名和用户名改成与新站相同，然后再打包恢复到新站。

听上去好像很费劲的样子是吧，不过被我找到了一个简便方法。

我发现报错时的那个地址路径是 `Installation` 下的文件，于是我就去根目录找到了这个目录。

这个应该是安装文件的所在，里面或许有导入的SQL文件。

果不出所料，我惊喜地发现其中有个 `sql` 目录，进去看看。

原来这里有很多很多的 SQL 文件，但是我告诉你，我找遍了所有这里的文件，都没有创建数据库的语句。

难道就这样完了？



当然我打开第一个名叫 `databases.json` 的文件时，我发现里面是原来旧站的数据库配置信息。

图9



哎，我改一改这里的配置，让它变成新站的配置可不可行呢？

死马当活马医呗，于是将数据库名及用户密码都改成新站的。

好，重头再开始恢复进程，我犹豫颤抖着右手点下了继续......

图10



哈哈，奇迹出现了！居然通过了！

我猜想可能是程序不完善，理想状态不应该是跳过已经创建的数据库再进行恢复吗。

现在在数据库名称及用户密码相同的情况下，程序可能认为是原来的站点，连接导入都会正常继续下去。

图11



当然，这仅仅是我的猜想。

不过作为一种变相思路，当你穷途末路之时我想可以参考尝试一下也未尝不可。

现如今的站点，使用众多的通常还有 `WordPress` 、`Drupal` 和 `Discuz` 等等，而使用的数据库也多半是 `Mysql` 或 `PostgreSQL` 等，我想如果遇到这样尴尬的坑应该也可供参考。



最后顺利完成恢复，但进入站点后发现 `PHP` 版本为 `7.2` 。

图12



这是虚拟主机默认的版本，而我明明记得我已经设定为 `7.4` ，有些莫名其妙，难道主机还是有缺陷？

随后回到控制面板将 `PHP` 版本修改回 `7.4` ，网站警告消失。

图13



这里顺带提醒一下小伙伴们，`PHP` 版本最好使用 `7.3` 以上，而 `7.3` 也将于今年（2021年）底结束支持，注意及时更新哦！



好了，以上就是我遇坑的分享，欢迎小伙伴们留言区评论、点赞、在看，我们下期再会！







WeChat@网管小贾 | www.sysadm.cc





















根目录下的 installation\sql

databases.json

将原有的帐号、密码以及数据库名修改为现有的内容。

