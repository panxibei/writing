从 2012R2 到 2016 共享文件夹的迁移过程

副标题：



文件服务器需要迁移。

虽然平时精于管理，但是共享文件夹仍然存在结构层次复杂，人员权限交错叠加的问题。

如果原本复制照搬到新服务器上，势必要重新配置权限、设定配额及过滤器等，费心费力。

毛主席教导我们，世上最怕认真二字，于是我又去翻阅了大量资料，找到了传说中的神奇工具 `Windows Server 迁移工具` 。

恕我孤陋寡闻了，这件神器最在 `Windows 2008` 时代就已经存在了，它基于 `PowerShell` 平台，再具体的说明我也说不太清楚，总之它可以帮我们迁移服务器各种功能，其中就包括共享文件服务。



网上可查到的资料基本都是碎片化的，参考任何一篇都很可能掉进不知何时会出现的坑中。

现在我将详细说明整个共享文件的迁移过程，其中当然也包括那些坑，最后我也会来个总结，帮助小伙伴们最终理清思路。



> 旧服务器：Windows Server 2012 R2
>
> 新服务器：Windows Server 2016
>
> 共享文件夹：D:\sysadm.cc



### 一、安装 `Windows Server` 迁移工具

安装非常简单，在 `服务器管理器` 中 `添加角色和功能` ，然后选中 `Windows Server 迁移工具` 安装即可。

图1



我在新旧两台服务器上都按这个方法安装了迁移工具，不过请小伙伴们注意，这里其实有个坑，具体后面会说。



### 二、打开防火墙端口

迁移工具在两台服务器之间传输通讯肯定要通过某些端口连接，根据官网的介绍，是需要分别打开源服务器与目的服务器的 `7000` 端口。

不过经过我测试，似乎目标服务器需要开通 `7000` 和 `7001` 两个端口，也可能是不需要 `7001` ，总之保险一点我开通了两个。

你手动添加或通过命令添加都可以，参考命令如下：

```
netsh advfirewall firewall add rule name= "Windows Server 迁移工具" dir=in action=allow protocol=TCP localport=7000
```



### 三、迁移服务器本地用户和组

如果共享文件夹中含有服务器本地用户或组的权限，那么应该先在目标服务器上完成这些用户和组的迁移。

换句话说，如果共享文件夹涉及到本地的（非域用户和组）用户或组的权限，就应该保证目标服务器上已经迁移或创建完成了这些用户和组。

因为在后面的迁移过程中，文件夹的权限列表是一起迁移的，所以要事先保证服务器上都能正常读取到这些用户和组的信息。



### 四、迁移命令

我们现在用到的迁移命令就两个，一个是 `Send-SmigServerData` ，用来发送数据，另一个是 `Receive-SmigServerData` ，用来接收数据。

两条命令就像两个兄弟，发送端在源服务器，接收端在目标服务器。

两个兄弟之间要拉上手建立连接才能传输数据，而拉上手之前的等待时间是 300 秒，也就是 5 分钟。

也就是说，不管兄弟俩谁等谁，他们俩都事先商量好的，5 分钟后就过时不侯了。

虽然一般情况下等人 5 分钟抽根烟这时间也差不多够用了，不过嘛总有一些特殊情况，所以这个等待时间还是可以修改的。

按以下内容修改注册表即可修改等待时间（连接超时）。

```
注册表项: \HKLM\Software\Microsoft\ServerMigration 
注册表键: MaxConnectionTime (REG_DWORD)
键值: 1 至 3600 间取值 (连接超时时间，单位秒，大于 3600 则按 3600 取值)
```



简单介绍一下两条命令怎么用。

##### 1、接收端命令

```
Receive-SmigServerData -Password <SecureString> [<CommonParameters>]
```

为什么先说接收端，因为它真的超级简单，别看命令语法那么吓人，直接输入命令本身就可以用了。

在目标服务器上输入 `Receive-SmigServerData` 回车，然后输入通讯密码后等待发送端动作就可以了。



##### 2、发送端命令

```
Send-SmigServerData [-Force] [-Recurse] -ComputerName <string> -DestinationPath <string> -Include <All | Data | Share> -Password <SecureString> -SourcePath <string> [-confirm] [<CommonParameters>]
```

发送端语法这么复杂，是不是也很吓人呢？

其实也不难，举个例子就明白了。

```
# 将文件夹 D:\sysadm.cc 打包发送到服务器 ServerX 相同位置上
Send-SmigServerData -ComputerName ServerX -SourcePath D:\sysadm.cc -DestinationPath D:\sysadm.cc -Recurse -Include All
```

* `-ComputerName`    目标服务器
* `-SourcePath`    源服务器上的文件夹
* `-DestinationPath`    目标服务器上的文件夹（最好和源服务器上一致）
* `-Include`    包含文件夹的哪些属性，数据还是共享
* `-Recurse`    拷贝所有子文件夹，如果没有这个参数，那么只有拷贝根文件夹



输入命令后和接收端一样需要提供通讯密码，密码通常为6位以上。

好了，基本上了解这些就够我们用了，下面开始才是重中之重哦！



### 五、迁移过程及填坑

首先，我在目标服务器上打开 `Windows Server 迁移工具` 。

`服务器管理器` > `工具` > `Windows Server Migration Tools` > `Windows Server 迁移工具`

图2



