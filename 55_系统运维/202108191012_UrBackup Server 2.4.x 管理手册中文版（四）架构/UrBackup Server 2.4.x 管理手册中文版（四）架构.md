UrBackup Server 2.4.x 管理手册中文版（四）架构

副标题：架构~

英文：administration-manual-for-urbackup-server-4

关键字：administration,manual,urbackup,backup,server,client



本篇比较简单，描述 `UrBackup` 的架构。



### `UrBackup` 的架构



`UrBackup` 分为服务端和客户端两大部分（C/S架构）。

服务端负责发现和备份客户端，在存储空间耗尽或存在太多备份时删除备份，同时还可以生成统计信息和管理客户端设置。

客户端则侦听服务端指令，比如告诉它应该构建一个文件列表，或者服务端想要下载哪个文件。

此外服务端还会开启一个通道，客户端可以在该通道上请求服务端开始备份，或者更新客户端的特定设置。



##### 3.1 服务端架构

服务端分为**核心**和**接口界面**两个部分。



目前服务端接口界面只支持 Web 界面的管理方式。

Web 界面可通过 `FastCGI`（端口 `55413`）和 `HTTP`（端口 `55414`）访问。

你可以利用 `FastCGI` 端口使 Web 界面通过 `SSL` 来访问（例如使用 `apache` ）。

有关详细信息，请参阅第 4.2 节。



服务端核心部分由多个不同任务的线程组成。

一个线程发现新客户端，另一个则检查客户端是否需要备份，而其他线程向客户端发送 ping 包以检查它们是否在线，或者向它们发送当前的备份状态。

还有一个线程则用于更新文件统计信息或删除旧备份。

正是因为 `UrBackup` 服务端由多线程任务组成，所以使用现代多核 CPU 会更高效（核数越多越好！）。



##### 3.2 客户端架构

客户端分为**核心进程**和**接口界面进程**。



接口界面进程用于显示托盘图标和对话窗口，同时向核心进程发送设置和命令。

客户端核心进程在 `UDP` 端口 `35622` 上侦听来自服务端的广播消息，并在收到消息后将带有其名称的消息返回给服务端。

使用 Windows 计算机名称作为名称。它在端口 35623 TCP 上侦听来自客户端接口进程和服务器的命令，并在端口 35621 TCP 上侦听来自服务器的文件请求。服务器在其命令端口上与每个客户端建立永久连接，客户端可以使用该连接请求备份或更改其设置。核心客户端进程负责构建要备份的目录中所有文件的列表。此列表在 UrBackup 客户端目录中创建为“urbackup/data/filelist.ub”。为了加快目录列表的创建，要备份的目录会通过 Windows 更改日志不断监视。Windows 更改日志只能用于整个分区。因此，第一次添加卷上的目录时，UrBackup 核心客户端进程会将新卷上的所有目录条目读取到“urbackup/backup_client.db”中的客户端数据库文件中。成功索引卷后，数据库会不断更新以与文件系统同步。因此，如果卷发生大的变化，数据库会更频繁地更新。这不会有很大的性能损失，因为只有目录保存在数据库中。更新每 10 秒或在请求文件列表时进行。服务器从客户端下载文件列表，并通过从内置客户端文件服务器下载更改的或新的文件来启动备份。映像备份仅使用命令端口完成。





### 小结

本节向小伙伴们介绍分享了 `UrBackup` 客户端的安装方法，虽然相对服务端的安装来说比较简单，但在实际的安装实践中也可以有多种灵活的方法，大家可以按实际情况定制安装。

由于开源多平台的特质，所以具体的客户端安装方法可以参考官方下载页面，每个不同的平台有相应不同的具体安装方法。

今天分享就到这里，之后会继续介绍 `UrBackup` 的其他特性，敬请期待！



**扫码关注@网管小贾，阅读更多**

网管小贾的博客 / www.sysadm.cc
