简单而快速地搞定 SQL Server 高可用

副标题：

英文：

关键字：



开场白



### 准备工作



##### 1、各系统命名、IP地址及功能备注

这里啰嗦几句，为了保证系统的可靠性（域名解析、故障转移和身份验证等），我们直接采用域环境的方式来搭建 `SQL Server` 高可用系统。

至于网络上还有使用证书验证的方式，反正我没有测试成功过，而且设定非常麻烦复杂又容易出错，所以我还是建议小伙伴们通过AD域环境来实现高可用。



* A89230	192.168.89.230	SQL Server 节点一（主）

* A89231	192.168.89.231	SQL Server 节点二（辅）
* A89219	192.168.89.219	文件共享服务器（共享见证）
* A89220	192.168.89.220	AD 服务器（域名服务器）域名：`sysadm.local`

* MSSql_Cluster	192.168.89.232	群集名称，虚拟 IP 地址

* MSSql_Listener	192.168.89.233	SQL Server Always On 可用性组侦听器，虚拟 IP 地址



##### 2、安装 `Net Framework 3.5` 

操作对象：主辅两台服务器



##### 3、安装 `故障转移群集管理器` 

操作对象：主辅两台服务器





##### 4、系统服务

操作对象：主辅两台服务器

确保系统服务是否正常启用并处于运行中

* 网络共享服务器 server

* 远程注册表服务 `Remote Registry`

* WMI 服务 `Windows Management Instrumentation`



##### 5、组策略

操作对象：主辅两台服务器

使用命令 `gpedit.msc` 打开组策略编辑器。

在窗口左侧依次找到 `计算机配置` > `Windows 设置` > `安全设置` > `本地策略` > `安全选项` 。

在窗口右侧找到 `网络访问：本地帐户的共享和安全模型` ，确保设定为 `经典 - 对本地用户进行身份验证，不改变其本来身份` 。



##### 6、防火墙

操作对象：主辅两台服务器

开启 `Windows Management Instrumentation (WMI)` 应用访问。

图？



1433和5022端口



##### 7、DNS解析

操作对象：主辅两台服务器

务必要保证各个系统之间都能正常通讯，那么 `DNS` 的正常解析就显得十分重要了。

本次实践我们是在域环境中实施的，所以 `DNS` 解析一般不会有问题。

但有一种情况，即非完全域名的解析，有可能会出现问题。

所以可以的话，建议小伙伴们在 `C:\Windows\System32\Drivers\etc\hosts` 文件中追加相应系统的域名解析记录。

```
# hosts 域名解析记录示例
192.168.8.88 yourhost
192.168.8.88 yourhost.sysadm.local
```



##### 8、群集见证共享

其实就是普通的共享文件夹，但为了保证其可靠性和稳定性，建议将这个共享建立在第三方。

这样即便某一台群集节点服务器故障也不会影响到共享的访问。

本例中将 `A89219` 设定为共享服务器，并建立一个共享文件夹 `\\A89219\ClusterSharing` 。

为保证各节点都能正常访问它，应该将这个共享文件夹的权限放开。

具体可以灵活自主实现，比如开放 `everyone` 的修改权限等等。

但为了保障系统安全，最好通过创建专用的共享帐号来实现访问。



### 建立群集及故障转移

群集是我们实现高可用的基础，因为要保障高可用，肯定是要用到两台甚至是更多台服务器的。

将这些服务器整合在一起就叫建立群集，而这些服务器在群集中就叫作节点。



故障转移则是在某台服务器发生故障后，可以顺利切换到其他正常服务器的功能。

而要实现故障转移，必须将某项服务设定为群集的角色来实现。

比如 `SQL Server` 的故障转移功能，就是通过做为群集的一个角色来实现的。



实现故障转移功能的角色设定我们需要在后面 `SQL Server` 中详细说明。

我们先说一说群集的建立，具体怎么做呢？



##### 1、建立群集

操作对象：主服务器（A89230）

打开 `服务器管理器` ，打开 `工具` > `故障转移群集管理器` 。

图2_01



在 `故障转移群集管理器` 界面中，左侧项的右键菜单中选择 `验证配置` 。

图2_02



根据你需要添加多少个节点服务器，依次输入服务器的名称，然后再点击 `添加` 。

图2_03



添加完毕，运行所有测试。

图2_04

图2_05

图2_06



如果测试中存在错误，请参照前面的准备工作所涉内容，务必保证通讯及权限的设定正确。

测试成功完成后，即可直接创建群集，只要在测试结果界面下方勾选 `立即使用经过验证的节点创建群集...` 并点击完成按钮。

图2_07



在创建群集向导界面中，输入你喜欢的群集名称，比如 `MSSql_Cluster` 。

然后在下方表格中填写群集 IP 地址，这个 IP 地址是空闲的、虚拟的，但须保证与各节点在同一网段，比如 `192.168.89.232` 。

图2_08



点击下一步开始创建群集。

图2_09



稍等一会儿，创建群集初步完成。

图2_10



哎，怎么叫初步完成呢？

小伙伴们也应该能注意到，在最后的完成画面中有一项警告，系统无法为见证磁盘找到合适的磁盘。

这是什么意思呢？

其实简单的说，就是当故障发生后故障转移时，系统需要一个判断，这个就叫作仲裁。

如果没有这个判断，那系统也就无法完成故障转移等一系列动作。

好，我们接下来就来搞定仲裁配置。



##### 2、仲裁配置

右击刚才创建的群集名称，依次选择 `更多操作(M)` > `配置群集仲裁设置(Q)...` 。

图2_11



仲裁配置选项中，选择 `选择仲裁见证` 。

图2_12



选择仲裁见证中，选择 `配置文件共享见证` 。

图2_13



输入文件共享路径（准备工作中已建立的共享文件夹），比如 `\\A89219\ClusterSharing` 。

图2_14



点击下一步，完成仲裁设置。

图2_15

图2_16



系统会在共享文件夹中创建一些随机文件，用于分析和测试等动作。

最终完成后应该是这个样子。

图2_17



两个节点服务器状态正常。

图2_18



而此时，角色一栏内仍然是空的，因为涉及到具体的某个服务，就我们需要到某个服务中来添加实现。

所以接下来我们就要转战 `SQL Server` ，来聊一下具体如何实现高可用功能。











### 安装 SQL Server 2019 企业版

需要事先啰嗦几句话哈，如果你使用的是 `SQL Server 2016` 也是可以的，但一定要保证是企业版。

这一点很重要，因为标准版之类的并没有诸如可读副本等功能，实际使用起来并不能达到我们预期的效果。



将镜像加载到虚拟光驱，或是直接解压缩到磁盘根目录下，都可以执行安装。

需要注意的是，解压缩后必须保证文件夹路径尽可能简单并不包含中文，否则安装时容易出错。



操作对象：主辅服务器

执行安装程序，在 `SQL Server 安装中心` 左侧点击 `安装` ，然后点击右侧 `全新 SQL Server 独立安装或向现有安装添加功能` 。

图3_01



经过检测及跳过更新。

图3_02

图3_03





作为演示我们仅安装 `SQL Server 复制` 一项。

图3_04



直接使用默认实例，下一步。

图3_05



服务帐户选择默认，下一步。

图3_06



设定 `sa` 密码，并添加本地管理员 `Administrator` 为 `SQL Server` 管理员。

图3_07



开始安装。

图3_08

图3_09



### 安装 SQL Server 客户端 SSMS

`SQL Server Management Studio` 简称 `SSMS` ，是微软自家出口的 `SQL Server` 客户端管理工具。

从 SQL Server 2017 开始，服务端与客户端的安装程序就被分开了，所以客户端需要单独安装。





当前最新版 18.9.1

下载链接：



图3_10





SSMS 客户端安装需要 `Net Framework 4.7.2` ，想要速度快些，可以先安装 `.Net` 后再安装 `SSMS` 。

`Net Framework 4.7.2`

下载链接：



图3_11



完成安装，就是这么简单。

记得重新启动服务器才能生效。

图3_12







### 设定 SQL Server 服务的专用管理员帐户

通常有些小伙伴喜欢使用默认的管理员帐户 `Administrator` 来管理系统的日常操作。

然而 `SQL Server` 的高可用（`Alwasys On`）是由多台服务器组成的，所以它们之间必须要共用一个相同密码的管理员帐户。

这就导致了一个问题，除了要保证几个节点服务器上的管理员帐户密码要一致外，还不能将这个管理员帐户挪作他用。

比如你使用了 `Administrator` 这个帐号，如果你想修改密码，那么就得每个节点服务器都要改上一遍，想想也是心累啊！

所以，我个人建议还是新建一个帐户专门用于 `Always On` 功能。

当然了，如果你就是想使用 `Domain\Administrator` 或节点本地的 `Administrator` 也都是没问题的。

好，按我个人建议，我们就来新建一个专属管理员帐户吧。



使用 `AD 用户和计算机` 管理器新建一个域用户 `admin_mssql` 。

图3_13

图3_14



将新建的用户加入到域管理员组内。

图3_15







点击开始菜单，找到并打开 `SSMS` 。

图3_16



输入服务器名称、并填写好登录名及密码，连接 SQL Server 服务。

图3_17



左侧展开 `安全性` ，右击 `登录名` 后选择 `新建登录名(N)...` 。

图3_18



在 `常规` 选项的登录名中，输入前面新建的域用户 ``admin_mssql` 。

图3_19



在 `服务器角色` 选项中，勾选 `sysadm` 。

图3_20



在 `用户映射` 选项中，将各个数据库勾选的后，同时数据库角色成员身份也勾选 `db_owner` 。

图3_21



按确定按钮完成用户的新建。



### 设定并调整 SQL Server 服务

默认安装好的 SQL Server 服务虽然已经正常运行着，但直接拿来用会有问题，需要我们给它调教一下。



点击开始菜单，打开并打开 `SQL Server 2019 配置管理器` 。

图3_22



在左侧展开 `SQL Server 网络配置` ，点击 `MSSQLSERVER 的协议` 。

右键点击右侧的 `TCP/IP` 。

图3_23



在 `TCP/IP 属性` 窗口中选择 `IP 地址` ，并将其中实际指向本机 IP 地址的一项启用。

图3_24



点击左侧 `SQL Server 服务` ，右击右侧 `SQL Sever (MSSQLSERVER)` ，选择 `属性` 。

图3_25



将服务运行帐户修改为前面新建的域帐户。

图3_26



切换到 `启用 Always On 可用性组` 选项卡，勾选 `启用 Always On 可用性组(E)` 。

图3_27



好了，SQL Server 服务设定完毕，记得一定要重启服务，否则不生效。



进入 `SSMS` ，右键点击服务器名称后选择属性，可以看到 `是否启用 HADR` 一项为 `True` 。

图3_28







### 创建 SQL Server 的 Always On 可用性组



在正式开始之前，我们需要备份一下数据库，因为在创建可用性组时，备份数据库是先决条件之一。

备份数据库很简单，你以前怎么备份的就怎么备份，没有什么特殊的。



图4_01

图4_02



左侧导航栏内展开 `Always On 高可用性` ，右击 `可用性组` ，选择 `新建可用性组向导(N)...` 。

图4_03



填入你喜欢的可用性组名称，并将下方两项打上勾。

图4_04



选择你需要赋予高可用功能的数据库，并确保其状态满足先决条件（比如已备份）。

图4_05



在 `副本` 选项卡中，点击 `添加副本(A)...` ，添加其他服务器实例副本。

之后勾选上 `自动故障转移` 一栏，并确保 `可用性模式` 为同步提交，同时 `可读辅助副本` 选择 `是` 。

图4_06



在 `备份首选项` 选项卡中，选择 `任意副本` 。

图4_07



在 `侦听器` 选项卡中，选择 `创建可用性组侦听器(C)` ，并填写侦听器 DNS 名称及端口，同时设定为静态IP地址。

比如本例中，侦听器名称为 `MSSql_Listener` ，端口 `1433` ，IP地址 `192.168.89.233` 。

图4_08



数据同步首选项，选择 `完整的数据库和日志备份` ，并指定之前的共享文件夹路径。

图4_09



完成一系列校验、连接和创建。

图4_10

图4_11

图4_12







### 效果测试











### 踩到的坑，含着泪也要自己填上



##### 坑一：正在检查托管次要副本 XXX 的服务器实例上是否已存在所选数据库

填上：删除副本服务器上的相应数据库。

图5_01



##### 坑二：可用性组侦听器 XXX 的创建失败。

填坑：手动在 etc/hosts 文件中追加侦听器的域名解析，或通过追加主机域名后缀来解决。

比如：

```
192.168.89.233 MSSql_Listener
192.168.89.233 MSSql_Listener.sysadm.local
```

图5_02



##### 坑三：最后一步一直停留在“正在将 XXX 联接到 XXX 上的可用性组 XXX ” 。

图5_03



填坑：通常是因为非域环境下无法成功进行 DNS 解析，故节点之间无法正常通讯，建议追加使用 DNS 后缀，比如 `host.domain.local` 。

在 `计算机名/域更改` 中点击 `其他(M)...` ，然后在 `此计算机的主DNS后缀(P)` 中填入相应域名。

图5_04



在 `高级 TCP/IP 设置` 中设定 `此连接的 DNS 后缀(S)` 为自己刚才设定的域名后缀，比如：`sysadm.local` 。

图5_05



最后别忘记最好在 `etc\hosts` 文件中追加域名解析记录。

```
192.168.89.233 MSSql_Listener.sysadm.local
```



##### 坑四：操作系统找不到已输入的环境选项，提示错误代码 0x800700cb 。
导致这个问题的原因还是 DNS 解析不正常。

通常在非域环境下，只有一个主机名就会导致这个问题的发生，即使主动做了 IP 地址指向也无济于事，所以可以参考前面的坑给加个域名后缀即可。





##### 坑五：消息 41105：无法创建名称和类型为“SQL Server 可用性组”的 Windows Server 故障转移群集 (WSFC) 资源

这个问题挺让人无语的，原因是系统认为你没有设定好 Windows 故障转移群集，所以就不能开启 Always On 可用性组。

这就是在开玩笑了，我明明已经创建好群集了对吧。

好吧，处理方法也很简单，只要打开 `SQL Server 配置管理器` ，在 SQL 服务属性的 `启用 Always On 可用性组` 选项卡中，将那个勾去掉、确定，然后重新给勾上、确定，最后重启服务即可。

图5_06





























