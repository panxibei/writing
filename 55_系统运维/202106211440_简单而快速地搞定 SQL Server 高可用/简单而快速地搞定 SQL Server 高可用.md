简单而快速地搞定 SQL Server 高可用

副标题：

英文：

关键字：



开场白



### 准备工作



##### 1、各系统命名、IP地址及功能备注

这里啰嗦几句，为了保证系统的可靠性（域名解析、故障转移和身份验证等），我们直接采用域环境的方式来搭建 `SQL Server` 高可用系统。

至于网络上还有使用证书验证的方式，反正我没有测试成功过，而且设定非常麻烦复杂又容易出错，所以我还是建议小伙伴们通过AD域环境来实现高可用。



* A89230	192.168.89.230	SQL Server 节点一（主）

* A89231	192.168.89.231	SQL Server 节点二（辅）
* A89219	192.168.89.219	文件共享服务器（共享见证）
* A89220	192.168.89.220	AD 服务器（域名服务器）域名：`sysadm.local`

* MSSql_Cluster	192.168.89.232	群集名称，虚拟 IP 地址

* MSSql_Listener	192.168.89.233	SQL Server Always On 可用性组侦听器，虚拟 IP 地址



##### 2、安装 `Net Framework 3.5` 

操作对象：主辅两台服务器



##### 3、安装 `故障转移群集管理器` 

操作对象：主辅两台服务器





##### 4、系统服务

操作对象：主辅两台服务器

确保系统服务是否正常启用并处于运行中

* 网络共享服务器 server

* 远程注册表服务 `Remote Registry`

* WMI 服务 `Windows Management Instrumentation`



##### 5、组策略

操作对象：主辅两台服务器

使用命令 `gpedit.msc` 打开组策略编辑器。

在窗口左侧依次找到 `计算机配置` > `Windows 设置` > `安全设置` > `本地策略` > `安全选项` 。

在窗口右侧找到 `网络访问：本地帐户的共享和安全模型` ，确保设定为 `经典 - 对本地用户进行身份验证，不改变其本来身份` 。



##### 6、防火墙

操作对象：主辅两台服务器

开启 `Windows Management Instrumentation (WMI)` 应用访问。

图？



1433和5022端口



##### 7、DNS解析

操作对象：主辅两台服务器

务必要保证各个系统之间都能正常通讯，那么 `DNS` 的正常解析就显得十分重要了。

本次实践我们是在域环境中实施的，所以 `DNS` 解析一般不会有问题。

但有一种情况，即非完全域名的解析，有可能会出现问题。

所以可以的话，建议小伙伴们在 `C:\Windows\System32\Drivers\etc\hosts` 文件中追加相应系统的域名解析记录。

```
# hosts 域名解析记录示例
192.168.8.88 yourhost
192.168.8.88 yourhost.sysadm.local
```



##### 8、群集见证共享

其实就是普通的共享文件夹，但为了保证其可靠性和稳定性，建议将这个共享建立在第三方。

这样即便某一台群集节点服务器故障也不会影响到共享的访问。

本例中将 `A89219` 设定为共享服务器，并建立一个共享文件夹 `\\A89219\ClusterSharing` 。

为保证各节点都能正常访问它，应该将这个共享文件夹的权限放开。

具体可以灵活自主实现，比如开放 `everyone` 的修改权限等等。

但为了保障系统安全，最好通过创建专用的共享帐号来实现访问。



### 建立群集及故障转移

群集是我们实现高可用的基础，因为要保障高可用，肯定是要用到两台甚至是更多台服务器的。

将这些服务器整合在一起就叫建立群集，而这些服务器在群集中就叫作节点。



故障转移则是在某台服务器发生故障后，可以顺利切换到其他正常服务器的功能。

而要实现故障转移，必须将某项服务设定为群集的角色来实现。

比如 `SQL Server` 的故障转移功能，就是通过做为群集的一个角色来实现的。



实现故障转移功能的角色设定我们需要在后面 `SQL Server` 中详细说明。

我们先说一说群集的建立，具体怎么做呢？



##### 1、建立群集

操作对象：主服务器（A89230）

打开 `服务器管理器` ，打开 `工具` > `故障转移群集管理器` 。

图2_01



在 `故障转移群集管理器` 界面中，左侧项的右键菜单中选择 `验证配置` 。

图2_02



根据你需要添加多少个节点服务器，依次输入服务器的名称，然后再点击 `添加` 。

图2_03



添加完毕，运行所有测试。

图2_04

图2_05

图2_06



如果测试中存在错误，请参照前面的准备工作所涉内容，务必保证通讯及权限的设定正确。

测试成功完成后，即可直接创建群集，只要在测试结果界面下方勾选 `立即使用经过验证的节点创建群集...` 并点击完成按钮。

图2_07



在创建群集向导界面中，输入你喜欢的群集名称，比如 `MSSql_Cluster` 。

然后在下方表格中填写群集 IP 地址，这个 IP 地址是空闲的、虚拟的，但须保证与各节点在同一网段，比如 `192.168.89.232` 。

图2_08



点击下一步开始创建群集。

图2_09



稍等一会儿，创建群集初步完成。

图2_10



哎，怎么叫初步完成呢？

小伙伴们也应该能注意到，在最后的完成画面中有一项警告，系统无法为见证磁盘找到合适的磁盘。

这是什么意思呢？

其实简单的说，就是当故障发生后故障转移时，系统需要一个判断，这个就叫作仲裁。

如果没有这个判断，那系统也就无法完成故障转移等一系列动作。

好，我们接下来就来搞定仲裁配置。



##### 2、仲裁配置

右击刚才创建的群集名称，依次选择 `更多操作(M)` > `配置群集仲裁设置(Q)...` 。

图2_11



仲裁配置选项中，选择 `选择仲裁见证` 。

图2_12



选择仲裁见证中，选择 `配置文件共享见证` 。

图2_13



输入文件共享路径（准备工作中已建立的共享文件夹），比如 `\\A89219\ClusterSharing` 。

图2_14



点击下一步，完成仲裁设置。

图2_15

图2_16



系统会在共享文件夹中创建一些随机文件，用于分析和测试等动作。

最终完成后应该是这个样子。

图2_17



两个节点服务器状态正常。

图2_18



而此时，角色一栏内仍然是空的，因为涉及到具体的某个服务，就我们需要到某个服务中来添加实现。

所以接下来我们就要转战 `SQL Server` ，来聊一下具体如何实现高可用功能。











安装 SQL Server 2019 企业版

需要事先啰嗦几句话哈，如果你使用的是 `SQL Server 2016` 也是可以的，但一定要保证是企业版。

这一点很重要，因为标准版之类的并没有诸如可读副本等功能，实际使用起来并不能达到我们预期的效果。



将镜像加载到虚拟光驱，或是直接解压缩到磁盘根目录下，都可以执行安装。

需要注意的是，解压缩后必须保证文件夹路径尽可能简单并不包含中文，否则安装时容易出错。



执行安装程序，在 `SQL Server 安装中心` 左侧点击 `安装` ，然后点击右侧 `全新 SQL Server 独立安装或向现有安装添加功能` 。

图3_01













