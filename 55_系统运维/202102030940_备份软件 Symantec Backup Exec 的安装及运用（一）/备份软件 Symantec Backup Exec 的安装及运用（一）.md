如何使用 Symantec Backup Exec 将数据备份到磁带库中（一）

副标题：SBE连接磁带库的驱动是个问题~



现代不仅仅是计算机时代，更是互联网时代，我们的方方面面的信息基本上都保存在大大小小的计算机中。

不知不觉地计算机早已成为了现代人的“生死簿”，自然而然地信息数据也就成了现代人的“命根子”，数据备份的重要性也就不言而喻了。

正巧最后到货一台服务器和一台磁带库，准备安装 `Symantec Backup Exec` 备份软件（以下简称 `SBE` ），正好把安装、调试以及如何使用的过程整理记录了下来，分享给小伙伴们。



测试环境：

> 操作系统：Windows 2016
>
> 备份软件：Symantec Backup Exec 21
>
> 备份介质：Dell ML3 磁带库



### 备份软件简介

网上的介绍有很多也很详细，简单来说 `SBE` 是一款 Windows 下使用的服务器备份软件。

别看它工作在 Windows 下，其实它功能很强大，可以通过网络备份多个不同的系统，包括 Windows 和 Linux ，甚至还包括 VMware 等虚拟系统。

基于它部署方便、易于上手等优点，很多企业都有它的身影。



### 磁带库驱动安装

想要让 `SBE` 开始干活我们需要先做些准备工作。

为什么要做准备工作呢，因为我们只知道要备份哪些数据，但是我们还不知道要备份到哪里去。

所以首先，我们得要让它能正常连接或识别备份目的地，通常我们把这个目的地叫作备份存储介质。



说到备份存储介质，我们常见的有硬盘、U盘、光盘等等。

那么一般情况下，我们要备份的数据量可能会很大，所以U盘、光盘之类的小朋友并不能满足容量需求，因此硬盘就成了我们最常用的存储介质了。

`SBE` 添加硬盘作为存储介质问题不大，因为你只要是正常安装好了操作系统它就能正常识别了，但在这里我们需要添加另外一种说是古老而现在却又仍然经常使用的存储介质--磁带。



在添加磁带介质前，我们需要先收集好磁带库信息。

手头上的货就是 `Dell ML3` ，打开驱动器一看，其实还是 `IBM` 的。

图1



到 `Veritas` 官网找到 `SBE` 的相关说明书，上面也写着是 `IBM` 的驱动器，型号为 `LTO Ultrium 7-H` 。

官方软硬件兼容列表（HCL）链接：https://www.veritas.com/content/support/en_US/article.100040087

我使用的 `SBE` 版本是 `21` ，对应查找其硬件兼容列表，的确是支持这一款磁带库的。

图2



接下来就是如何将 `SBE` 正常连接到磁带库的问题了。

我们打开备份服务器上的设备管理器，可以看到有两个**未知的媒体更换器设备**。

这里有两个未知设备是因为连接了两根SAS线。

图3



注意了，前方高能预警，接下来会有个大坑！



按照通常的思维方式，我们应该先解决未知设备的驱动问题。

于是我便到 Dell 的官网上找来了 ML3 的驱动程序。

驱动程序是一个自解压可执行文件，我将它运行解压后得到了几个文件夹。

`SBE` 备份服务器跑的是 Windows 2016 系统，所以我打开了其中名为 WS2016 的文件夹。

图4



哎？怎么没有 install 或是 setup 之类的安装文件呢？

这叫我怎么安装呢，再到刚才下载驱动的页面上看看有没有什么说明，于是找到了安装说明。

图5



安装说明里说得很清楚，程序安装是通过 `CLI` 安装脚本来执行，但需要事先确认程序版本是否为专属。

那么什么是专属（exclusive）和非专属（nonexclusive）驱动，此外我们又应该安装专属还是非专属的驱动呢？



我找到了 IBM 知识中心的参考内容。

链接：https://www.ibm.com/support/knowledgecenter/STAKKZ/dd_iug_kc/con_a88u9_win_svr_install.html

> * install_exclusive.exe The driver issues automatic reserves on open. It also prevents multiple open handles from the host to a drive from existing at the same time, as is required by applications such as Tivoli® Storage Manager. This driver is also required for the failover feature to work as it uses persistent reservation (by default).
>
>   install_exclusive.exe 驱动程序在打开时发出自动保留。它还可以防止从主机到驱动器的多个打开句柄同时存在，这是诸如Tivoli®Storage Manager之类的应用程序所要求的。 故障转移功能也需要此驱动程序，因为它使用持久保留（默认情况下）。
>
> * install_nonexclusive.exe The driver permits open handles from the host to a drive to exist at the same time, as is required by applications such as Microsoft Data Protection Manager (DPM).
>
>   install_nonexclusive.exe 驱动程序允许从主机到驱动器的打开句柄同时存在，这是Microsoft Data Protection Manager（DPM）之类的应用程序所要求的。



写了这么一堆，我很自信地说每个字我都认识，可放在一块儿我就懵逼了，就像王宝强似地脱口而出：这都写的是啥？！

我耐着性子又是一番大海捞针式的搜索，还好和我一样的小白遍布天下，我幸运地翻到了另一个有同样问题的帖子，就在 `veeam` 论坛里。

版主回复得简单明了，说是建议安装非专属的驱动程序。

图6



OK，那就照做走起！

打开命令提示符窗口，切换到 `WS2016` 目录，然后运行 `install_nonexclusive.exe` 。

```
# 安装驱动
C:\Dell\Drivers\T10N5\WS2016\install_exclusive.exe

# 卸载驱动
C:\Dell\Drivers\T10N5\WS2016\uninst.exe
```

安装很顺利地完成了。

图7

图8



注意啊同学们，前面我们已经预警过了，这其实就是个坑啊！

你以为这样安装了驱动程序就是对的吗？

看似设备识别、驱动OK，其实我可以告诉你，这完全就是错误的！

如果你接着后续的连接磁带库等操作，可能会遭遇惨败！



什么？你说了这么一大堆最后告诉我这些都是错误的？！

我只想说，同学们我十分抱歉，如果我不这么说的话，很可能你印象不深刻，无法从中吸取我的经验教训，否则我的文章也可能就沦落成和其他复制粘贴一样的呆板教程了。

好了，说了这么多，归根结底还是自身经验不足，我们回过头来再整理一下你就会发现问题所在了。



首先，我们忽略了安装说明中的重要信息。

图9



其次，在 `SBE` 的软件兼容列表（SCL）中也提到了关于 Windows 系统版本与磁带库驱动的关系。

图10



备份服务器使用的是 Windows 2016 系统，版本比 2012 高一头，手头的磁带库也在 `SBE` 硬件兼容列表之中，所以 `SBE` 它自己就能识别并驱动磁带库。

也就是说，我们可以得出这样的结论，**我们根本就不用特意安装驱动程序**！

那么真正正确的做法是**直接安装 `SBE` ，直接使用 `Unknown Medium Changer` 的未知设备**。

这事儿整得，就好比自己从6楼的家里出发去楼下拿快递，也不知道中了什么邪，非要到处找降落伞跳窗，快是挺快，可惜东西没到手人也废了。

希望小伙伴们不要走我的老路，吸取这惨痛的教训啊！





### 备份软件安装

`SBE` 的安装并不难，只需挂载安装镜像，按照每一步提示操作即可。

其中， `SBE` 需要 `MsSQL` 数据库支持，可以选择它自带的 `Express` 版 `MsSQL` ，也可以自己另外安装。

不管通过哪种方式都可以正常工作，如果你有自己的数据库服务，最好是与现有服务统一安装在一起。



关于需要安装哪些功能项，除试用版是具有完全功能外，基本是按照购入的 License 来限定选择的。

图11



从图中也可以看出，不同的 License 提供不同的功能支持。

一般基本功能会包含 Windows 和 Linux 的远程备份，而对虚拟机的备份就要另外付费了，当然其价格肯定令人精神振奋。



初次安装完成后，`SBE` 会提示你数据库加密密钥还没有导出备份。

图12



这个加密密钥是用于迁移或恢复 `SBE` 服务器用的，毕竟备份时的通讯都是加密的，自然保存的数据也是加密的，那么这个密钥也就是唯一的。

加密密钥很重要，我们需要第一时间将它导出并放到一个安全的地方。

方法很简单，单击左上角那个圆形图标按钮，然后点选 `Backup Exec 设置` > `数据库维护和安全` > `导出` 。

图13



导出路径随便你指定，导出 `dek` 文件即密钥文件，并将它及时移动到其他保险的地方即可。

接下来让我们进入配置磁带库的步骤。



### 磁带介质标签

我们在使用硬盘的时候，操作系统都会读取硬盘的设备号，然后再给它分区，有了分区我们就能存放数据了。

那么我们怎么来识别磁带呢？

最简单的办法就是给磁带贴上标签，标签上有条形码，通过读取条码来识别不同的磁带。



可是，我买的磁带里怎么没找到带条形码的标签啊，难道我遇到了奸商？

非也非也，其实这个条码标签它是要钱的，好吧，谈到钱就伤感情了不是，那我就自己手写呗。

什么？手写？

呵呵，小伙伴们莫不是误会了吧。

我又不是美术专业的，怎么可能手写条形码呢！

其实吧，只是手写编号，比如 `T1234567` 这样的字母数字组合的字符串罢了，这个叫作逻辑标签。

通常带库默认是允许装载未贴条码的磁带的，所以如何有效合理地使用磁带就必须由应用程序统一设定逻辑标签，以方便调用和读写。

你可以找贴纸写好标签，也可以直接写在磁带上。

当然讲究一点最好还是用标签打印机，毕竟磁带库身价高贵，万一磁带移动时标签掉落机器给搞坏了人生可就不美好了。



默认的磁带编号为8位（可调整），举个例子，比如有6盘磁带，那么逻辑标签可以这样设计。

前三位是服务器编号，后五位是磁带序号，服务器S01有6盘磁带：

* S0100001
* S0100002
* S0100003
* S0100004
* S0100005
* S0100006

在实际的使用中，可以根据实际情况精心设计好编号的扩展性，以免因目标备份对象及磁带数量增多后产生逻辑混乱。

逻辑标签我们了解了，磁带上我也贴好标签了，那么接下来在程序软件中怎么为它设定对应编号呢？



##### 1、登录磁带库，先确认带库是否允许非正常标签的磁带。

进入 `Settings` > `Library` > `Advanced` 查看，没问题可以支持未标签的磁带。 

图14



##### 2、查看磁带槽位状态

进入 `Cartridges` > `Cartridges and Slots` 查看，除最后一盘清洁带是自带条码标签外，其他都显示为未标签。

**其中 `Logical Library` 一列表示逻辑序列。**

图15



点击左上角下拉按钮菜单，`Actions` > `Graphical View` ，以图形模式再来查看。

其最底下一层的槽位为占位栏，不允许放置磁带，所以只有上面四格是有磁带的。

而磁带放置的顺序，是从左至右、从下到上的。

图16



我们按槽位的逻辑顺序放置磁带，在接下来的步骤中就可以按这个顺序在程序中设定标签了。



##### 3、给磁带写入介质标签

打开 `SBE` ，找到 `存储` 一项，可以看到不用特意安装驱动 `SBE` 已经连接到磁带库了。

点选 `插槽` 一项，然后点击右侧的 `自动化介质库 001 插槽 详细信息` 。

图17



之后可以看到很多项，都是写着 `插槽 X` ，但后边的介质标签一列都显示为 `<Unknown media>` 。

我们想要给 `插槽 1` 的磁带打上标签，那么我们就可以右键点击一下它，从菜单中选择 `标签` 。

图18



弹出警告，它告诉你不要胡乱给磁带打标签，因为是逻辑编号，除非更换磁带，所以最好不要随意更改已经设定好的标签。

我们这是第一次打标签，没问题继续。

图19



点击确定后，跳出一个框框，正是我们想要的更改标签的窗口。

别犹豫，输入之前设计好的逻辑编号，确定即可。

图20



按照这个方法，逐一给每一个槽位的磁带设定好逻辑标签。

因为之前磁带即按槽位顺序放置，所以我们就按顺序设定标签即可做到应用程序编号与磁带实际编号一一对应。

图21

图22



有了介质标签，就像有了北京暂住证一样有了底气，那是身份地位的象征，自然程序也就识别出磁带了，容量啥的信息也就都出来了。

系统处理需要一点儿时间，此时你可以放松一下自己，程序最后会自动完成所有的标签设定。



### 还有下一篇

到这儿挺不容易，但至少踩过坑就会成长一点儿。

一切准备就绪，由于篇幅较长，我只好将接下来的内容放到了下一篇中。

下一篇中我将继续给小伙伴们介绍如何通过 `SBE` 将目标服务器数据备份到磁带上。

资料整理以及上机搭环境测试需要大量的时间，还请小伙伴们耐心等待。

要是真着急的话，请立马关注@网管小贾，或在留言评论区三连走起，感谢哈~



WeChat@网管小贾 | www.sysadm.cc