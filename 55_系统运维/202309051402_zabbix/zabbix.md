zabbix

副标题：

英文：

关键字：







任意设备ping + 邮件报警



主要步骤：

1、fping

2、postfix

3、数据采集 > 主机

4、告警媒介

5、告警 > 媒介

6、告警 > 动作

7、消息模板

8、用户群组权限



### 安装在线检测程序 `fping`

一般的 `Linux` 发行版都已经预安装了，因此我们什么都不用做就可以直接使用了。

当然也可能有例外情况，那么我们就需要手动去安装 `fping` 。

方便也很简单，比如 `RedHat` 系的直接这么干就行了。

```
dnf install fping
```

图f01



有了 `fping` 就可以来测试对象目标是否在线了，存活在线就是 `alive` ，不在线就是 `unreachable` 。

用法如下：

```
fping 主机名/IP
```

图f02



### 安装邮件发送引擎 `Postfix`

`Postfix` 是非常著名的邮件引擎，多了我就不介绍了，总之你可以理解为它是用来发送邮件的邮件服务器程序。

如果你有现成的邮件发送程序，比如公司内部邮箱，或是 `163` 、 `QQ` 啥的，那么可以跳过这一步直接使用现成的。

之所以安装 `Postfix` ，自然是因为可能我们没有现成的邮件服务器，或是其他各种不方便因素，那么好极了，我们就自己再搭建一个 `Postfix` 吧！



本着尽量简洁、能让初学者也能看懂的原则，我们就直接在 `Zabbix` 所在的系统上直接搭建 `Postfix` ，这样做可以减少一些关于安全等方面诸多繁琐的配置。

首先，安装之，一条命令：

```
dnf install postfix
```

图f03



其次，来点简单的配置。

编辑 `/etc/postfix/main.cf` 文件，将以下参数修改为你自己的。

```
myhostname = mail.sysadm.local
mydomain = sysadm.local

myorigin = $myhostname
myorigin = $mydomain

inet_interfaces = all

mydestination = $myhostname, $mydomain

mynetworks = 127.0.0.0/8
```



OK，就这些！

简单不？

这样配置的话，我们只能通过本机服务器来发送邮件，其他外边的电脑是没办法连上来发邮件的。

不过这样不是挺好的吗，省去了配置加密和认证啥的麻烦。

当然如果想要更加细化的配置，建议小伙伴们参考其他教程文章。



好了，`Postfix` 就此搞定！





### 添加用来测试 `ping` 的主机

用 `ping` 来测试目标对象是最简单最经济的方法之一。

不管是服务器、网络设备还是其他联网的装置，都可以通过 `ping` 来诊断是否在线、工作正常。



网上有不少文章只介绍了服务器 `ping` 的测试方法，是通过操作系统模板来做的。

但是如果是某些工业设备，或是某些盒子，它们没有可以直接操作的系统，那么此类方法就不太适合了。

因此我们设定时，应该以通用性为准，即使不是诸如 `Windows` 之类的特定操作系统也应该能实现这样的诊断操作。

接下来我们一起看一下具体怎么做。



我们先添加一个主机，当然这个主机是什么样的设备都是可以的。

点击左侧导航菜单 `数据采集` > `主机` ，再点击右上角的 `创建主机` 。

图b01



填写一些主机所需要的参数，比如 `主机名称` 和 `可见的名称` 。

`主机名称` 必须是唯一的，是给 `Zabbix` 系统看的，比如 `HOST01` 。

`可见的名称` 则是给人看的，方便我们判断当前主机是干啥的，比如 `机房测试机01` 。

图b02



接下来是重点，选择模板，找到 `ICMP Ping` ，默认它在模板群组 `Templates/Network devices` 中。

这个正是通用的 `Ping` 模板，具体的后面还会有介绍。

图b03



然后给主机分配一个主机群组，方便管理。

最后在接口处添加一个代理 `Agent` ，可以用 `IP` 的形式，也可以用 `DNS` 域名的形式。

不管你用哪种形式，别忘记点选一下后面的 `连接到` 。

端口不用动，保持默认。

好了，主机添加完成！



不过话还没有说完，还需要向小伙伴们介绍一下刚才添加了半天都添加了啥。

主机添加完成后，我们可以看到系统给我们主机增加了3个监控项和3个触发器。

这些是哪来的呢？

没错，正是前面我们选择的 `ICMP Ping` 模板里的。

图c01



好，我们点开监控项瞅瞅。

一、二、三，不多不少就三个，不过它们都是啥意思呢？

* `ICMP loss` - 丢包诊断
* `ICMP ping` - 是否在线存活
* `ICMP response time` - `Ping` 包响应时间

图c02



接着我们再点开触发器看看。

也是三条，名字和监控项一样，只是多了些表达式啥的。

图c03



触发器是用来触发行为动作的，当表达式满足条件时，就可以用来触发动作，比如我们希望的发送告警邮件。

我们再仔细看看这三条触发器，实际上可以利用的应该是第三条 `ICMP unavaliable by ICMP ping` ，也就是判断主机是否掉线。

懂了！后面就这么用！











### 告警媒介







我做了个简单的思维导图，小伙伴们凑合看哈！

```
故障发生/恢复
|
 \_ 用户群组权限（是/否？没有权限则无法触发动作）
    |
     \_ 告警>触发器动作（重点：将[触发器]和[告警媒介]关联了起来）
             |
             |\_ 数据采集>主机>监控项>触发器
             |
              \_ 告警>媒介（邮箱）>消息模板
```











邮件设置。



1. 名称

这个随便起，喜欢就行，不过也不要太随便，喜欢也得是自己记得它是什么意思才行哈！

比如我这儿起个名，`Email zabbix@xxx.local` 。



2. 类型

电子邮件，这个不多说了。



3. 邮箱提供商

没有特殊情况就选择默认的 `Generic SMTP` ，就是通常的 `SMTP` 。



4. `SMTP` 服务器

你的邮箱是哪个供应商的，一般都可以问到。

比如 `163` 的，它的 `SMTP` 服务器就是 `smtp.163.com` ，`QQ` 的就是 `smtp.qq.com` 。

我这儿用的是自己搭建的邮件服务器，就在 `zabbix` 主机上面，因此直接写上 `127.0.0.1` 。



5. `SMTP` 服务器端口

和上面说的一样，要看供应商提供的，端口号通常有 `25` 、`465` 等等，看你的邮箱是不是走的加密认证之类的连接。



6. 电子邮件

就是你的邮箱地址了，比如：`zabbix@xxx.local` 。



7. `SMTP HELO`

这个是连接邮件服务器时最初的打招呼信息，即 `HELO` 信息。

有的服务器要求不怎么严格，可以随便乱写，而有的就比较严格了，所以说最好写成和你的邮箱地址一样比较好。

比如：`zabbix@xxx.local` 。



8. 安全连接

询问邮件提供商，通常其页面中的 `SMTP` 设置中会有写。

我这儿只开放了本机发送邮件，因此不用什么安全连接。



9. 认证

`SMTP` 本身没有啥认证不认证的，根本不用输入用户名密码，这是早期协议就这么设定的。

不过为了防止垃圾，有的服务器都加了一道认证的坎，这种情况下是要输入用户名和密码才能成功连接的。

我这儿只开放了本机发送邮件，因此不用什么认证。



10. 消息格式

即邮件内容的格式，一般用的是文本，如果你有特殊要求，那么可以选择 `HTML` 格式。



最后别忘记勾选 `已启用` ，否则这个邮箱不起作用啊！



图c06









消息模板



发生故障时：

主题：

```
[发生故障] {EVENT.NAME}
```



消息：

```
XXXX故障通知

主机名：{HOST.NAME}
主机IP：{HOST.IP}
严重程度：{TRIGGER.SEVERITY}
告警时间：{EVENT.DATE} {EVENT.TIME}
故障内容：{ITEM.NAME}: {ITEM.VALUE}
现在状态：{TRIGGER.STATUS}
事件ID：{EVENT.ID}

Zabbix https://192.168.1.123/
————————————————————————
XXXX 系统部
```



恢复故障时：

主题：

```
[故障恢复] {EVENT.DURATION}: {EVENT.NAME}
```



消息：

```
XXXX故障恢复通知

主机名：{HOST.NAME}
主机IP：{HOST.IP}
严重程度：{TRIGGER.SEVERITY}
告警时间：{EVENT.DATE} {EVENT.TIME}
恢复时间：{EVENT.RECOVERY.DATE} {EVENT.RECOVERY.TIME}
持续时间：{EVENT.DURATION}
故障内容：{ITEM.NAME}: {ITEM.VALUE}
现在状态：{TRIGGER.STATUS}
事件ID：{EVENT.ID}

Zabbix https://192.168.1.123/
————————————————————————
XXXX 系统部
```





想要了解参数信息，可以参考 `zabbix` 自带的 `Email` 等媒介模板（就是前面克隆我们自己的邮件媒介）。

图e05

图e06



