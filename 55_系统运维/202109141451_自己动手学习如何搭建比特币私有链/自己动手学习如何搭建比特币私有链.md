自己动手学习如何搭建比特币私有链

副标题：一起获取虚拟货币的感性认识~

英文：practicing-how-to-build-bitcoin-private-blockchain-by-myself

关键字：bitcoin,utxo,tx,blockchain,比特,比特币,区块链



一提到区块链我们自然而然地就能想到比特币，那么比特币到底怎么玩的呢？

作为一个对比特币一无所知的纯小白，这几天我查阅了很多资料和文章，可以说把我给看吐了！

晕头转向是我的最大收获，还好没彻底倒下，要说这关于区块链和比特币的相关知识还真是浩如烟海，我就像是一片孤叶随波逐流飘荡在这一片大海之中。

在这藏经阁似的文档中，充斥着一堆堆纷繁复杂一套又一套的术语和概念，我用尽了洪荒之力才了解到了个皮毛，再结合操作广为使用的 `Bitcoin Core` ，算是初步爬进了这所遥不可及、令人生畏的院墙大门。

如果你也和我一样，对比特币是个啥不甚了解，而又好奇心作怪想要一探究竟，那么恭喜你，找到组织了！

下面我就通过我自己的实践操作，来帮助小伙伴们入个门，以期望能一窥比特币的全貌。



### 下载比特币核心程序 `Bitcoin Core`

要学习一样东西，总归要和实物打交道，否则概念也就建立不起来，没有概念再想精进更是无从谈起。

所以我们一上来就先拿出实物：`Bitcoin Core` 。

这个东东叫作比特币核心程序，每个 `Bitcoin Core` 可以做服务端，也可以做客户端，我们所有的相关操作都是用它来做的。

当然了，还有很多其他的程序也可以实现同样的功能，但用的最多的就属它了。



> 下载地址有两个，都是一样的，你心情好就选一，心情不好就选二。
>
> https://bitcoincore.org/en/download/
>
> https://bitcoin.org/zh_CN/download



`Bitcoin Core` 是支持多平台的，接下来我会先在 `Windows` 上演示，毕竟用得人多一些，然后再说一说 `Linux` 上怎么安装操作。



下载好了吗？

呃，先别着急安装哈，我们先来了解一些概念和原理，要不就算你装上了也不知道怎么用对吧。



### 相关的概念还是要说一说的

在这儿我只简单地说一说我对比特币需要怎样操作的一些个人理解。



OK，我们先来搞清楚什么是区块链。

区块链肯定是由多个区块构成，这些区块里包含着交易信息等非常丰富的内容。

当这些区块串在一起，它就可以被叫作节点，也就是一个区块就是一个节点。

我的理解是，区块链接由很多节点组成（前面说到的 `Bitcoin Core` 就可以做节点程序），并且每个节点的地位都是平等的，没有谁是老大谁是小弟，所以说没有谁一定是服务端，谁一定是客户端。

所有的节点都包含了交易信息等内容，不会因为某个节点故障而导致整个网络出现问题，也就是所谓的去中心化。

而节点与节点之间是以区块形式首尾相连，子区块头上记录着父区块的哈希值，这所有的节点最终就组成为了我们看到的区块链。



然后这里还要重点介绍一下，目前就比特币而言，存在多个网络。

可以简单地理解为一个主网络 `mainnet` + 多个测试网络。

而测试网络又可以简单分为 `testnet` ，`signet` 和 `regtest` 。



`testnet` 是和主网络基本一样的但仅仅用于测试的网络，目前和主网络一样，它只存在这么一个，由于各种原因当前已经迭代到第三代了，你可以理解为它已经系统重装了三次。

`signet` 则是用于开发等用途，好像已经不怎么用了。

最后的 `regtest` 才是本文重点，它的意思是组成局域网式的封闭式的**本地区块链**，也叫私有链。

我们之后的测试就可以用这种方式，这样我们就可以自说自划，想怎么玩就怎么玩了，也不会有什么损失或坏处，大不了重新来过也没啥大不了的。

虽然你也可以加入到 `testnet` 中，但我们毕竟是学习，先在自己的局域网中熟悉了，然后再到外面转转才是上策吧。



好了，比特币中还有很多概念术语，比如比特币交易中使用 `UTXO` 等等，说实话我到现在还晕着呢，所以抱歉，只好抱着能用够用就行的想法，言尽于此。

接下来我们实际操作一下，相信会对大家关于这些概念的了解有所帮助。



### 安装比特币核心程序 `Bitcoin Core`

我们先看看 `Windows` 下怎么安装使用，安装基本上是一路下一步，我就不啰嗦了，看图。

图01

图02

图03

图04

图05



最后一步在完成安装前，务必去掉运行 `Bitcoin Core` 的那个勾。

原因很简单，当它初次启动时会使用默认配置去连接比特币主网络 `mainnet` ，这有悖于我们的初衷，所以先将它按下，待我们修整一番再打开它不迟。



安装好的 `Bitcoin Core` 可以随时运行，当我们需要连接不同的网络时可以在程序的后面加上相应的参数。

比如，我们想要连接 `testnet` ，也就是比特币测试网络，那么就可以在程序后面加上 `-testnet` 。

图06



而我们的最终目的很简单，就是想要连接到我们自己的 `regtest` （回归测试），也就是封闭的私有链。

刚才说了，初步运行程序是缺少定制的配置，那么怎样定制配置才能实现我们想要的呢？



### 给它一个配置，让它按我们的意思行事

官方提供了一个原始的模板文件，我们可以按照它的样子给它装扮装扮。

> https://github.com/bitcoin/bitcoin/blob/master/share/examples/bitcoin.conf



`Windows` 下配置文件应该在如下位置，第一行中使用了环境变量与第二行是等价的。

```
%APPDATA%\bitcoin\bitcoin.conf
C:\Users\sysadm\AppData\Roaming\bitcoin\bitcoin.conf
```



诚然，你可以将这个文件整个拿过来用，不过你完全可以按我说的这样做，直接在空白文件中放上想要的参数即可，这样你就不会因为注释满天飞而眼花缭乱了。

需要特别注意的是，不同分类的参数应该放在相应分类名称的子区段中，比如本例有些参数应该放在 `[regtest]` 区段中。

```
# 告知 Bitcoin-QT 接受 JSON-RPC 命令
server=1

# 开启回归测试模式
regtest=1


[regtest]

# 开启交易记录索引
txindex=1

# 开启挖矿
gen=1
```



设定好配置文件后，当你双击 `bitcoin-qt.exe` 时，它会启动并读取这个配置。

图07



界面左下角显示它正在连接其他节点，这说明它已经开始工作了。

同时在 `%APPDATA%\bitcoin` 目录下自动生成了一个 `regtest` 的文件夹。

另外使用 `netstat` 命令也可以看到 `18443` 和 `18444` 两个端口已经开启。

（不同网络模式端口不同：`default: 8333` ,  `testnet: 18333` ,  `signet: 38333` ,  `regtest: 18444` ）

图08



这个时候，如果你还有一台安装了 `Bitcoin Core` 的电脑，那么你就可以拿来连接这个节点了。

只要输入带有以下参数的命令，或是直接在配置文件中添加相应的参数即可连接。

```
# 连接IP地址 x.x.x.x 的节点
bitcoin-cli -regtest -connect=x.x.x.x
```

配置文件则可以这样写。

```
# 开启回归测试模式
regtest=1


[regtest]

# 连接IP地址 x.x.x.x 的节点
connect=x.x.x.x
```



不过此时即便连接好了，也是正在同步的状态，看样子接下来还要做点什么......



### 创建钱包

用以下命令创建一个名为 `xjWallet` 的钱包。

```
bitcoin-cli -regtest createwallet xjWallet
```

也可以用图形界面来操作，点击菜单 `文件` > `创建钱包...` ，也很方便。

图09



### 生成区块

生成 100 个区块。

```
bitcoin-cli -regtest -generate 100
```

图10



这个命令一执行不要紧，界面立马出现了变化。

总额变成了 3650 BTC ，哇哈哈，我已经这么富有了吗？

再仔细一瞧，好么，未成熟也是 3650 BTC。

啥意思？意思就是钱再多，也用不了。

这是比特币系统默认的设定，就是这样设计的，不服找中本聪去，反正到现在他的真实身份都没人知道！

哈，话说回来，系统设定为最前面的100个区块的钱是不给花的，要从第101个区块开始钱才有的拿。

好吧，反正是我们自己的测试节点，再生成一个区块不就得了，走起！

```
bitcoin-cli -regtest -generate 1
```

嘿嘿，终于有了真正属于我们的、可以消费的 50 个 BTC 了！

图11



### 介绍几个命令程序

在 `Bitcoin` 安装目录下的 `daemon` 子目录中会有四个用于终端执行的命令行程序文件。

```
// 命令行客户端（也可做 rpc 客户端）
bitcoin-cli.exe

// 服务节点守护进程
bitcoind.exe

// 比特币交易处理程序
bitcoin-tx.exe

// 钱包入口
bitcoin-wallet.exe
```



实际上第一个 `bitcoin-cli` 程序也可以用图形程序 `bitcoin-qt`  来代替，所以说，`bitcoin-qt` 也可以在命令行中通过在其后面追加参数来使用，效果是一样的。



当你要以后台服务形式运行 `bitcoin` 时，可以像下面这样，这时你就不必纠结于图形界面了。

```
bitcoind --daemon
```



### `RPC` 服务的连接方法

这个我一开始也没搞懂，后来才慢慢了解到，这个 `RPC` 服务其实可以理解为远程服务端。

什么意思呢？

就是说，当有一个远程的 `bitcoin-core` 在运行，而我不在远程那台机器上，所以我就想用自己手头的电脑去连接那个远程的机器，进而管理远程的 `bitcoin-core` 。

远程的 `bitcoin-core` 可以是正在运行的 `bitcoin-cli` ，也可以是 `bitcoin-qt` 的图形界面，也可以是以后台守护进程运行的 `bitcoind` 。

说白了就是当我连接到远端的时候，我在本地电脑上操作的 `bitcoin-core` 和在远程操作 `bitcoin-core` 是同一个东西，只是为了管理方便把操作终端放到了本地上。

就好像你用 `VNC` 远程到服务器上操作，和你直接到服务器上操作效果一样是一个道理，本质上这个 `bitcoin-core` 并没有多出来，还是那一个节点而已。



比如我现在手上的笔记本电脑，因为是公司的电脑不能乱安装东西，所以只放了一个客户端。

而在远程电脑上我安装并跑着一个 `bitcoin-core` ，那么我应该如何用笔记本上的客户端去连接并管理远程电脑上的 `bitcoin-core` 呢？



分两步走，第一步先在远程端的配置文件中加入如下的参数描述。

```
...
[regtest]
# 绑定并侦听在所有IP上
rpcbind=0.0.0.0

# 用户名
rpcuser=rpcuser

# 密码
rpcpassword=12345678

# 允许连接的IP范围
rpcallowip=0.0.0.0/0

# RPC侦听端口
rpcport=18443
```



第二步在本地笔记本电脑上修改配置参数，对应远程端的参数。

```
# 远程端 RPC 服务地址
rpcconnect=192.168.1.1
rpcuser=rpcuser
rpcpassword=12345678
rpcport=18443
```



就这样就可以了，当你启动 `bitcoin-qt` 后，它通过读取配置其实两端获取的信息是一模一样，等于你可以在本地操作远端的 `bitcoin-core` 了。

如果你要用 `bitcoin-cli` ，那么只要把前面说的参数一一加到命令的后面就可以了。

不过需要小心的是，远程端的 `RPC` 端口可以不用特意指定，但务必要确认访问的网络类型，因为不同的网络类型其默认端口号是不同的，本例是在 `regtest` 网络中，具体可以查看前面介绍的内容。



### `Linux` 下的安装使用

实际上比 `Windows`  下安装稍微麻烦一点点，但也不是什么大问题。

官方安装参考链接：https://github.com/bitcoin/bitcoin/blob/master/doc/build-unix.md



先安装一些依赖组件。

**`Fedora/CentOS/Rocky` 参考如下。**

```shell
sudo dnf install gcc-c++ libtool make autoconf automake python3
sudo dnf install libevent-devel boost-devel
###sudo dnf install libdb4-devel libdb4-cxx-devel
sudo dnf install sqlite-devel
###sudo dnf install miniupnpc-devel libnatpmp-devel
###sudo dnf install zeromq-devel
sudo dnf install systemtap
```



**`Debian/Ubuntu` 参考如下。**

```shell
sudo apt-get install build-essential libtool autotools-dev automake pkg-config bsdmainutils python3
sudo apt-get install libevent-dev libboost-dev libboost-system-dev libboost-filesystem-dev libboost-test-dev
sudo apt install libsqlite3-dev
sudo apt-get install libzmq3-dev
sudo apt install systemtap-sdt-dev
```



需要图形图面吗？那就安装 `Qt5` 所需要的组件吧。

**`Fedora/CentOS/Rocky` 参考如下。**

```shell
sudo dnf install qt5-qttools-devel qt5-qtbase-devel
sudo dnf install qt5-qtwayland
```



**`Debian/Ubuntu` 参考如下。**

```shell
sudo apt-get install libqt5gui5 libqt5core5a libqt5dbus5 qttools5-dev qttools5-dev-tools
sudo apt install qtwayland5
sudo apt-get install libqrencode-dev
```



下载源码包。

```shell
wget https://github.com/bitcoin/bitcoin/archive/refs/tags/v22.0.tar.gz
```



解压缩源码包，并切换进入安装目录。

```shell
tar zxvf v22.0.tar.gz
cd bitcoin-22.0
```

`bitcoin-core` 使用到了 `Berkeley DB` ，官方建议 `4.8` 版本，所以按官网来操作，进入解压目录执行以下命令。

```shell
./contrib/install_db4.sh `pwd`
```

参数 `pwd` 会将 `Berkeley DB` 安装到当前目录下（`/sysadm/bitcoin-22.0/db4`），所以你也可以将它换成你想要的目标目录。

安装完成之后，会像如下那样提示用户牢记 `db4` 的安装路径，在实际执行编译命令时要指定数据库组件参数的路径，后面还会再次提到。

```
db4 build complete.

When compiling bitcoind, run `./configure` in the following way:

  export BDB_PREFIX='/sysadm/bitcoin-22.0/db4'
  ./configure BDB_LIBS="-L${BDB_PREFIX}/lib -ldb_cxx-4.8" BDB_CFLAGS="-I${BDB_PREFIX}/include" ...
```



另外，此命令执行时可能会报错，原因是没有安装 `patch` 命令。

```shell
dnf install patch
```



后面就简单了，先自动生成编译文件。

```shell
./autogen.sh
```



然后就像前面说的，再指定 `db4` 的路径来进行配置。

```shell
export BDB_PREFIX='/sysadm/bitcoin-22.0/db4'
./configure BDB_LIBS="-L${BDB_PREFIX}/lib -ldb_cxx-4.8" BDB_CFLAGS="-I${BDB_PREFIX}/include"
```



最后编译并安装。

```
make
make install
```



安装完成后，执行文件均放在了下面的目录中。

```
/usrlocal/bin/bitcoin-cli
/usrlocal/bin/bitcoin-qt
...
/usrlocal/bin/bitcoind
```



配置文件 `bitcoin.conf` 的路径，在用户目录下的 `.bitcoin` 目录中。

```
/home/user/.bitcoin/bitcoin.conf
~/.bitcoin/bitcoin.conf
```

