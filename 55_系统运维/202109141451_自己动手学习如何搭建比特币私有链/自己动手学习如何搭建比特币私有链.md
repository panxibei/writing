自己动手学习如何搭建比特币私有链

副标题：一起获取虚拟货币的感性认识~

英文：practicing-how-to-build-bitcoin-private-blockchain-by-myself

关键字：bitcoin,utxo,tx,blockchain,比特,比特币,区块链



一提到区块链我们自然而然地就能想到比特币，那么比特币到底怎么玩的呢？

作为一个对比特币一无所知的纯小白，这几天我查阅了很多资料和文章，可以说把我给看吐了！

晕头转向是我的最大收获，还好没彻底倒下，要说这关于区块链和比特币的相关知识还真是浩如烟海，我就像是一片孤叶随波逐流飘荡在这一片大海之中。

在这藏经阁式中，充斥着一堆堆纷繁复杂一套又一套的术语和概念，我用尽了洪荒之力才了解到了个皮毛，再结合操作广为使用的 `Bitcoin Core` ，算是初步进了这所深宅大院的大门。

如果你也和我一样，对比特币是个啥不甚了解，而又好奇心作怪想要一探究竟，那么恭喜你，找到组织了！

下面我就通过我自己的实践操作，来帮助小伙伴们入个门，以期望能一窥比特币的全貌。



### 下载比特币核心程序 `Bitcoin Core`

要学习一样东西，总归要和实物打交道，否则概念也就建立不起来，没有概念再想精进也就无从谈起。

所以我们一上来就先拿出实物：`Bitcoin Core` 。

这个东东叫作比特币核心程序，每个 `Bitcoin Core` 可以做服务端，也可以做客户端，我们所有的相关操作都是用它来做的。

当然了，还有很多其他的程序也可以实现同样的功能，但用的最多的就属它了。



> 下载地址有两个，都是一样的，看你心情选吧。
>
> https://bitcoincore.org/en/download/
>
> https://bitcoin.org/zh_CN/download



`Bitcoin Core` 是支持多平台的，接下来我会先在 `Windows` 上演示，毕竟用得人多一些，然后再说一说 `Linux` 上怎么安装操作。



下载好了吗？

呃，先别着急安装哈，我们先要了解一些概念和原理，要不就算你装上了也不知道怎么用对吧。



### 相关的概念还是要说一说的

在这儿我只简单地说一说我对比特币需要怎么操作的一些个人理解。



OK，我们先来搞清楚什么是区块链。

我的理解是，它是由很多节点组成（前面说到的 `Bitcoin Core` 就可以做节点程序），并且每个节点的地位都是平等的，没有谁是老大谁是小弟。

所有的节点都包含了交易信息等内容，不会因为某个节点故障而导致整个网络出现问题，也就是所谓的去中心化。

而节点与节点之间是以区块形式首尾相连，子区块头上记录着父区块的哈希值，这所有的节点最终就组成为了我们看到的区块链。



然后这里还要重点介绍一下，目前就比特币而言，存在多个网络。

可以简单地理解为一个主网络 `mainnet` + 多个测试网络。

而测试网络还分为 `testnet` ，`signet` 和 `regtest` 。

`testnet` 是和主网络基本一样的用于测试的网络，只有一个，由于各种原因当前已经迭代到第三代了。

`signet` 则是用于开发等用途，好像已经不怎么用了。

最后的 `regtest` 是本文重点，它的意思是组成局域网式的封闭式的**本地区块链**。

我们之后的测试就可以用这种方式，这样我们就可以自说自划，想怎么玩就怎么玩了，也不会有什么损失或坏处，大不了重新来过也没啥大不了的。



好了，比特币中还有很多概念术语，比如比特币交易中使用 `UTXO` 等等，说实话我到现在还晕着呢，所以抱歉，只好抱着能用够用就行的想法，言尽于此。

接下来我们实际操作一下，相信会对大家对概念的了解有所帮助。



### 安装比特币核心程序 `Bitcoin Core`

我们先看看 `Windows` 下怎么安装使用，安装基本上是一路下一步，我就不啰嗦了，看图。

图w01

图w02

图w03

图w04

图w05



最后一步在完成安装前，务必去掉运行 `Bitcoin Core` 的那个勾。

原因很简单，当它初次启动时会使用默认配置而去连接比特币主网络，这有悖于我们的初衷，所以先将它按下，待我们修整一番再打开它不迟。



安装好的 `Bitcoin Core` 可以随时运行，当我们需要连接不同的网络时可以在程序的后面加上相应的参数。

比如，我们想要连接 `testnet` ，也就是比特币测试网络，那么就在程序后面加上 `-testnet` 。

图w06



而我们的最终目的很简单，就是想要连接到我们自己的 `regtest` （回归测试），也就是封闭的私有链。

刚才说了，初步运行程序是缺少定制的配置，那么怎样定制配置才能实现我们想要的呢？



### 给它一个配置，让它按我们的意思行事

官方提供了一个原始的模板文件，我们可以按照它的样子给它装扮装扮。

> https://github.com/bitcoin/bitcoin/blob/master/share/examples/bitcoin.conf



`Windows` 下配置文件应该在如下位置，使用环境变量是等价的。

```
%APPDATA%\bitcoin\bitcoin.conf
C:\Users\sysadm\AppData\Roaming\bitcoin\bitcoin.conf
```





诚然，你可以将这个文件整个拿过来用，不过你完全可以按我说的这样做，直接在空白文件中放上想要的参数即可。

需要特别注意的是，不同分类的参数应该放在相应分类名称的子区段中，比如本例有些参数应该放在 `[regtest]` 区段中。

```
# 告知 Bitcoin-QT 接受 JSON-RPC 命令
server=1

# 开启回归测试模式
regtest=1


[regtest]

# 开启交易记录索引
txindex=1

# 开启挖矿
gen=1
```



设定好配置文件后，当你双击 `bitcoin-qt.exe` 时，它会启动并读取这个配置。

图w12



界面左下角显示它正在连接其他节点，这说明它已经开始工作了。

同时在 `%APPDATA%\bitcoin` 目录下自动生成了一个 `regtest` 的文件夹。

另外使用 `netstat` 命令也可以看到 `18443` 和 `18444` 两个端口已经开启。

（不同网络模式端口不同：`default: 8333` ,  `testnet: 18333` ,  `signet: 38333` ,  `regtest: 18444` ）

图w13



这个时候，如果你还有一台安装了 `Bitcoin Core` 的电脑，那么你就可以拿来连接这个节点了。

只要输入以下命令，或是在配置文件中添加相应的参数即可连接。

```
# 连接IP地址 x.x.x.x 的节点
bitcoin-cli -regtest -connect=x.x.x.x
```

配置文件可以这样写。

```
# 开启回归测试模式
regtest=1


[regtest]

# 连接IP地址 x.x.x.x 的节点
connect=x.x.x.x
```



不过此时即便连接好了，也是正在同步的状态，看样子接下来还要做点什么。



##### 创建钱包

用以下命令创建一个名为 `xjWallet` 的钱包。

```
bitcoin-cli -regtest createwallet xjWallet
```

也可以用图形界面来操作，点击菜单 `文件` > `创建钱包...` ，也很方便。

图w14



##### 生成区块

生成 100 个区块。

```
bitcoin-cli -regtest -generate 100
```

图w15



这个命令一执行不要紧，界面立马出现了变化。

总额变成了 3650 BTC ，我已经这么富有了吗？

再仔细一看，好么，未成熟也是 3650 BTC。

啥意思？意思就是钱再多，也用不了。

这是系统设定成这样的，最前面的100个区块的钱是不给花的，要从第101个区块开始钱才有的拿。

好吧，反正是我们自己的测试节点，再生成一个区块不就得了，走起！

```
bitcoin-cli -regtest -generate 1
```

嘿嘿，终于有了真正属于我们的、可以消费的 50 个 BTC 了！

图w16























在 `Bitcoin` 安装目录下的 `daemon` 子目录中会有四个用于终端执行的命令行文件。

```
// 命令行客户端（也可做 rpc 客户端）
bitcoin-cli.exe

// 服务节点守护进程
bitcoind.exe

// 比特币交易处理程序
bitcoin-tx.exe

// 钱包入口
bitcoin-wallet.exe
```



```
bitcoind --daemon
```











```
...
[regtest]
rpcbind=0.0.0.0
rpcuser=rpcuser
rpcpassword=12345678
rpcallowip=0.0.0.0/0
txindex=1
gen=1
```





```
rpcconnect=10.66.88.231
rpcuser=rpcuser
rpcpassword=12345678
rpcport=18443
```

