私人笔记：如何在 Windows 上搭建 SSH 服务

副标题：

英文：

关键字：





`freeSSHd` 的安装非常简单，通常按下一步选择默认选项即可。

不过有几个地方可能需要说明一下，大家看下面的图示操作。



双击 `freeSSHd` 安装程序。

图a01



选择安装路径，保持默认吧。

图a02



选择 `Full installation` 完全安装，省得一会儿用的时候缺这缺那。

图a03



给它起个在开始菜单中的名字，保持默认，要不你能叫它啥呢，二哈吗？

图a04



创建桌面图标，就是启动时找起来方便。

图a05



准备安装清单列表，按下按钮即开始安装。

图a06



呃...突然出现，这是啥？

原来这是官方推销的同样 `SSH` 功能的软件，包括服务端和 `ActiveX` 。

建议先别着急看，因为它们是付费软件，我们先看 `freeSSHd` 吧！

图a07



终于安装好了，不过弹出个提示来。

头一个叫作：私钥将被创建，干不干？

```
Private keys should be created. Should I do it now?
```

图a08



那当然干了，点 `是(Y)` 。

哎，又来一个，问要不要将 `FreeSSHd` 作为系统服务跑起来？

```
Do you want to run FreeSSHd as a system service?
```

图a09



有开机即启动 `freeSSHd` 需求的小伙伴就请点 `是(Y)` 吧！

最后安装就完美结束啦！

图a10



桌面有个新建的 `FreeSSHd` 图标，点开它我们开始使用 `freeSSHd` ！

图b01



注意，涉及到权限问题，最好是使用管理员权限打开它。

图c05



呐呢？！刚开始就出师不利，这是什么鬼？

```
Error connecting to freeSSHd.com
```

图b02



看字面意思，似乎是 `freeSSHd` 升级连接失败。

点击 `确定` 继续，应该不会有什么影响。

果然，任务栏内多了一个新图标。

图b03



我们可以双击任务栏图标，也可以在右键菜单中选择 `Settings...` 来打开设置。

图c04



那么 `SSHd` 服务真的启动了吗？

应该是没有吧，因为我们还没有给它设置呢，怎么会自动跑呢！

打开设置，你看，`Telnet` 和 `SSH` 两个服务都没有真正开始运行。

图c01



这个我们可以双击任务栏图标，然后在 `Server status` 服务状态选项卡中查看。

那接下来我们就开始尝试设置一下 `SSH` 吧。



我们先找到 `SSH` 选项卡。

图c02



有几个地方需要改一改，就像图中所示的。

* `Listen address` - 侦听地址
* `Port` - 端口
* `RSA key` - `RSA` 密钥
* `DSA key` - `DSA` 密钥

图c03



侦听地址和端口通常保持默认，这个好办，只不过 `RSA` 密钥和 `DSA` 密钥这两个怎么搞呢？

其实不难，看到那个写着 `New...` 的按钮没，点它，然后选择密钥位数即可。

通常 `1024 bits` 就够了，选择 `2048 bits` 嘛密钥更强一些，都可以。

图c03



如法炮制，两个都这么干就是了。

图c06



`SSH` 服务设定OK了，然后我们来添加几个用户，访问 `SSH` 总要有登录用户的嘛！

找到 `User` 用户选项卡，点击 `Add...` 添加。

图c07



其中 `Login` 是登录用户名，这个好理解。

但是下面的 `Authorization` 认证，应该选哪一个呢？

* `NT autheritication` - `Windows` 用户认证
* `Password stored as SHA1 hash` - 以 `SHA1` 哈希形式保存
* `Public key (SSH only)` - 公钥（仅 `SSH` ）



如果你想直接用 `Windows` 上现有的用户，那么就选 `NT autheritication` 即可，当然要写对用户名称。

你看，密码一栏是不需要填写的。

图c08



通常我们选择 `Password stored as SHA1 hash` ，这样我们就可以自定义密码了。

图c09



至于 `Public key` 则可能需要公钥文件比较复杂，就不赘述了。

最后用户属性窗口中的下方有三个选项，就看你的实际需要了。

* `Shell` - 这台电脑的命令终端
* `SFTP` - 就是我们想要登录的 `SSH` 的服务端
* `Tunneling` - 建立通讯隧道

图c10



一旦有用户连上来，我们可以在 `Online users` 选项卡中查看在线用户。

图c16a



好，接下来还有几项需要设定，不复杂，接着来哈，很快就好了！

一个设置是 `Authentication` 认证方式。

通常我们设定了用户密码就需要将 `Password authentication` 设定为 `Requied` 必须。

图c11



这里简单说明一下三个选项。

`Disabled` 当然是禁用的意思，至于 `Allowed` 和 `Required` ，前者是允许后者是必须，前者可以有也可以没有，而后者则是强制要有的意思。



还有一个设置 `Encryption` 加密，默认 `Any` 任意即可。

图c12



`Tunneling` 隧道这个不用改什么，暂时没有启用它。

图c13



`SFTP` 选项卡中有一项是用来设定 `SFTP` 家目录，默认就是当前登录用户的家目录。

比如张三登录，那么出现的根目录就是张三自己的家目录。

通常用这里用 `$HOME\` 表示，不用改动它。

图c14



为了安全起见，`Host restrictions` 主机限制中可以填写一些不希望被访问的客户主机 `IP` 地址（支持通配符）。

图c15



再严格一些，我们可以开启日志记录，方便以后出现故障可以有迹可循。

图c16



最后还有一个 `Automatic updates` 自动升级的选项卡。

不说也知道啥意思，要是你觉得每次启动嫌那个提示麻烦，就在这里关掉它。

图c17









设置完毕，别歇着了，赶快启动它看看吧！

切换到 `Server status` 选项卡，看准 `Click here to start it.` 那几个字用力点下去！



哎我……启动 `SSH` 服务，有时就会出现启动失败的情况。

```
The specified address is already in use.
```

图d01



我赶紧用翻译软件这么一翻译，它喵的说是指定的地址已经在用着呢！

这是怎么回事，明明是头一次启动它呀！

使用以下命令查看是哪个程序占用了 `22` 端口。

```
netstat -ano
```

图d02



还真有一个程序占用了 `22` 端口，嗯，记下它的 `PID` ，也就是程序 `ID` 。

然后再打开任务管理器看看，呐呢，搞了半天乌龙了，原来就是 `FreeSSHd` 的服务进程占用了端口 `22` 。

图d03



`FreeSSHd` 啥时候自己启动起来了？

哦，想明白了，原来前面我们把它当作系统服务了，那时它就自动启动了。

你可以看一下截图中，`FreeSSHd` 是以 `SYSTEM` 用户运行的就明白了。



好了，说白了，我们不需要手动去启动服务了。

那我们直接登录就行了呗？

好像还有问题，可能会导致用户无法正常登录，会提示密码错误。

图d04



这又是怎么回事呢？

干脆我们来重新启动一下 `FreeSSHd` 服务，说不定是前面的配置并没有生效。

图d05



重启服务OK，应该是这个样子的。

图d06



使用中有几个小问题。



在登录 `FreeSSHd` 时，可能会出现乱码情况。

这时我们以 `WinSCP` 为例，点击 `高级(A)...` ，将文件名 `UTF-8` 编码设置为开启状态。

图d07

图d08



另外，有可能在实际访问远程目录时，会出现无法写入的情况。

图d10



那么我们可以先将远程目录的权限修改为 `Everyone` 可写（但不可删除自己）。

图d09



然后再试下，应该就可以成功上传文件了。

图d11

















**将技术融入生活，打造有趣之故事**

网管小贾 / sysadm.cc

