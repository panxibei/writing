Windows 运用 UrBackup 备份服务的最佳实践

副标题：

英文：

关键字：





### 防火墙开放端口

`UrBackup` 使用到两个端口，分别是 `55413` 和 `55414` 。

前者用来与客户端通讯，后者则是用于提供管理页面的访问。

图g02



`Windows` 下确保防火墙中已开放 `55413` 和 `55414` 端口。

可以将 `UrBackup` 服务端主程序放入允许通过 `Windows` 防火墙的列表中。

```
C:\Program Files\UrBackupServer\urbackup_srv.exe
```

图g01



也可以手动新建防火墙规则，将协议端口开放为允许连接。

图g03











### 创建管理员

默认情况下初次访问 `UrBackup` 设置页面是不需要任何用户登录的，这意味着任何人都可以访问并查看到 `UrBackup` 的设置以及备份信息。

因此，在开始一些重要设定之前，我们必须先为 `UrBackup` 添加管理员帐户。

顶部菜单切换到 `设置` ，并点选 `用户` 选项卡，再点击 `创建用户` 按钮。

我们也能看到，此时并没有任何用户帐户存在。

图e01



然后我们填写用户名和密码，并点击 `创建` 按钮。

默认权限是管理员的帐户就被成功创建了，在下次访问 `UrBackup` 管理页面进就会被要求使用管理员登录了。

图e02

图e03



注意，管理员的用户名并不一定是 `admin` ，为了安全起见，你也可以自定义它的名称并务必牢记。

在后续的管理工作中，我们也可以按实际情况创建更多的用户。



### 语言设定

通常 `UrBackup` 会自动切换并显示当前系统所在地区的语言。

如果有必要，可以在 `UrBackup` 页面的左下角可以选择你想要的其他语言。

图d09







### 动态磁盘的概念

`Windows` 在我们平时使用时磁盘都是以基本磁盘的形态为主而存在。

基本磁盘就是传统的磁盘使用方式，有两种分区方式，一种是 `MBR` ，另一种是 `GPT` 。

`MBR` 最多四个主分区，也可以是三个主分区加一个扩展分区，然后扩展分区里再划分更多个逻辑分区。

`GPT` 最多可创建128个主分区，现在这些分区也可以被称为卷，现在的电脑基本都使用 `GPT` 了，分区数量也够用。

虽然 `GPT` 比 `MBR` 先进，也挺好用，但是它解决不了一个问题。

什么问题？

磁盘组队问题。



不管是分区也好，还是整个磁盘也好，无论 `MBR` 还是 `GPT` 都无法解决前两者的组队问题。

比如，我想把第一块磁盘的一个分区与第二块磁盘的一个分区组成一个大分区用于存放更多的数据。

又比如，我想把第二块磁盘和第三块磁盘组成冗余热备盘。

解决不了这些问题怎么办？

动态磁盘这时候就可以粉墨登场了！



动态磁盘对应并有别于基本磁盘，专门用来解决前面提到的一些更高级的硬盘使用问题。

动态磁盘划分的分区都被称为动态卷，而这些动态卷就可以用来灵活地应对磁盘组队问题。

动态卷有这么几种：简单卷、跨区卷、带区卷和镜像卷。

它们的区别大概如下所述。



* 简单卷：类似于基本磁盘的普通分区，简单卷是动态磁盘下的称呼。动态卷通常是用来组队的，而动态磁盘只有一块而暂时无法组队的时候，那么划分分区时唯一只能是简单卷。



* 跨区卷：用于将多个动态磁盘的不同卷组队在一起，最终形成随时可扩展容量的一个大的逻辑卷。



* 带区卷：两块或两块以上动态磁盘组成，读写数据时分散于各动态磁盘之间，为提高文件访问效率及降低CPU负荷，可以简单地理解为类似于 `RAID0` 。



* 镜像卷：两块动态磁盘组成互为镜像，用于数据容错冗余，可以简单地理解为类似于 `RAID1` 。



`UrBackup` 建议我们使用硬件 `RAID` 或是 `Windows` 动态卷来作为备份文件夹的理想存放目标。

硬件 `RAID` 好处和用法在此不必多说，我们就以前面刚刚解释过的动态卷来作为演示向大家说明其具体做法。



我们在原有 `Windows` 系统基础上添加两块相同容量的磁盘，并将这两个磁盘做成镜像卷。

首先，在初始化之后，磁盘是以基本磁盘形态存在的，我们想要将这两块磁盘做成镜像卷可以有两种方法。

一种是先将它们转换成动态磁盘，然后再组成镜像卷。

另一种是直接做成镜像卷，系统会自动帮我们将它们处理成动态磁盘。



我们就直接点，右键任意一块未分配磁盘，在右键菜单中选择 `新建镜像卷(R)...` 。

图b01



出现新建镜像卷向导，点击下一步。

图b02



将两块未分配磁盘都添加到已选框内，点击下一步。

图b03

图b04



分配驱动器号，点击下一步。

图b05



格式化镜像卷，可以在此设定卷标，标识备份盘。

注意，文件系统必须为 `NTFS` 。

图b06



向导收集信息，确认无误后点击 `完成` 开始生成镜像卷。

图b07



最终动态镜像卷新建成功。

可以看到两块磁盘上都标识为相同的 `D` 盘，它们互为镜像，实现冗余镜像的作用。

图b08

图b09



镜像卷可以粗暴地理解为 `Windows` 中的软 `RAID1` ，那么一旦出现磁盘损坏，我们怎么恢复它呢？

在这里顺带简单地说一说吧。

比如镜像卷中的第二块磁盘损坏需要更换一块新的，那么我们将新磁盘（注意容量一致）接入并启动系统后，可以在磁盘管理器中看到如下的样子。

图c01



这时镜像卷的第一块磁盘是完好的，因此我们右键点击它，并选择菜单中的 `添加镜像(A)...` 。

图c02



点选新接入的新磁盘，然后点击 `添加镜像(A)` 按钮。

图c03



在出现的警告提示窗口中点击 `是(Y)` 继续。

图c04



稍等一会儿，系统会识别新磁盘并重新同步镜像卷。

图c05



等到同步完成后，镜像卷就又重新恢复到良好状态了。





### 禁用 `8.3` 名称生成



```
fsutil behavior set disable8dot3 1
```







### 专用备份分区（盘）



格式化备份分区（盘）。

```
# 格式化命令语法
# /V:Label 分区卷标
# /Q 快速格式化
# /FS:NTFS 文件系统NTFS
# /L:enable 强制使用较大的文件记录，可简写为 /L
Format <Drive:> /V:Label /Q /FS:NTFS /L:enable
```



以当前为例，格式化 `D` 盘。

```
Format D: /V:UrBackup /Q /FS:NTFS /L
```





### 创建并设定备份文件夹

在备份分区（盘）中新建一个用于存放备份数据的文件夹。

比如最简单的，在本例中我们在动态镜像卷 `D` 盘上新建一个名为 `Backup` 的文件夹。

```
MKDIR D:\Backup
```

图d02



打开浏览器，输入以下网址访问 `UrBackup` 服务管理页面。

```
http://localhost:55414
```

初次进入系统，页面会提示我们无法访问 `UrBackup` 用于保存备份的文件夹。

图d01



我们可以修改设置，将刚才新建的 `Backup` 文件夹指定为 `UrBackup` 备份文件夹。

图d03



`UrBackup` 会自动在备份文件夹中再创建两个子文件夹，分别用来存放客户端和临时文件。

图d10



当我们保存备份文件夹设置后，可能会引起杀毒软件报警，这是由于 `UrBackup` 试图在备份文件夹中测试或创建一些必要的子文件夹或临时文件夹。

从图中我们也看到了一些奇怪的现象，`UrBackup` 创建了临时文件 `urbackup_tmp_files\1` ，被示为有安全风险。

但是查出来的结果报告却是 `EICAR_Test_File` ，这是用于测试杀毒软件的测试文件，并不是真正的病毒文件！

图d04



看到如下页面提示，我们才知道刚才实际上就是 `UrBackup` 在测试杀毒软件对备份产生的影响。

`UrBackup` 检测到有杀毒软件正在活动，如果杀毒软件将备份文件视为病毒，那么最终会导致备份失败。

并且，杀毒软件多次扫描备份文件也可能导致性能问题。

基于以上两点，`UrBackup` 建议我们禁用杀毒软件，或至少将 `UrBackup` 临时路径排除扫描监视之外。

答案很明显了，最简单的我们将备份文件夹添加到杀毒软件的排除项中。



各种杀毒软件添加排除项的方法都大同小异，这里用 `Windows Defender` 做为示例。

打开 `Windows Defender` 的设置界面，找到 `添加排除项` 。

图d07



然后点击 `排除文件夹` ，选择备份文件夹即可。

图d08



刷新页面，警告消失。



### 客户端正确访问备份

我们都知道，备份是放在服务端的，或者也是服务端指向的某个地方，总之一般是不会在客户端存放的。

因此，客户端要想正确访问备份，必定要有正确的方式方法，这个方式方法就是**服务器地址 `URL`** 。



在 `UrBackup` 管理页面顶部菜单的 `设置` 一项中，依次点击 `常规` > `服务器` 。

我们在 `服务器地址` 一栏中务必填入正确的服务器地址。

比如：

```
http://backups.company.com:55414/
```

需要十分注意的是，客户端应该确保能正常解析这个域名。

如果是内部网络，那么应该解析为内部私有IP地址，如果是外部网络，那么应该解析为外部地址。

基于此，**我们在填写这个 `URL` 时应该确保内外网络都能正常解析访问**。





### 邮件服务器





### `Internet/广域网`





### 让 `UrBackup` 支持 `SSL`





### 备份日志







