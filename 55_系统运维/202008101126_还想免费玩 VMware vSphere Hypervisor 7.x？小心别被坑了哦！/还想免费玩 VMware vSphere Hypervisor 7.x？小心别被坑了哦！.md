还想免费玩 VMware vSphere Hypervisor 7.x？小心别被坑了哦！

副标题：为了不让你浪费青春，让我告诉你我是如何被坑的~



如今虚拟机技术已经不是什么新鲜玩意了，并且像 `VMware` 这样的业界杰出代表官方也提供免费试用版本给用户下载尝鲜测试。

这不正好手上有一台闲置的联想台式机，于是就想安装个免费版的 `VMware vSphere Hypervisor` 玩玩。

谁承想居然历程坎坷、着实被坑了一把~

事情是这个样子滴......



记得上一次，我使用的还是 `6.0` 版本的程序，现在最新版是7.0，先找到它下载吧。

我以前就注册过帐号，经过登录、搜索很顺利地就找到了7.0下载的地方。

图1



看得出有两个可以下载的链接，第一个是ISO镜像文件，第二个是离线打包文件，那么选择哪一个呢？

记得以前是用ISO文件刻录成光盘，然后再使用光盘安装的，就选第一个链接来下载吧。

镜像文件有300多M，村里网速再慢也很快就下载完成了，刻光盘什么的都没问题，然后拿去安装，才发现卡住走不下去了。

图2



把上面的鸟语一翻译成人话，我就想骂人。

说是它没有找到物理网卡，反正没有网卡就是不能继续安装。

你说气不气人，这年头哪台电脑会没有网卡呢，WHAT FU*C......！

哎？你等等......好吧，我知道了，之前也曾经在其他台式机上安装过 `6.0` 版本的 `ESXi` ，也发生过这样的问题。

究其原因很简单，我们这位 `ESXi` 公主比较傲骄，只识别服务器设备上的网卡，普通台式机的网卡它压根就瞧不上。

我这么一查，我去果然这台式机的网卡是块螃蟹卡，型号正是烂大街的 `RTL8111/RTL8168/8411`。

OK！OK！Easy！Easy！

您瞧瞧，我这儿气得直说鸟语！

那怎样才能让我们的公主瞧得上呢？

我依稀记得可以通过某种工具软件把螃蟹卡的驱动导入到光盘镜像中，然后就可以顺利安装。

于是我就开始翻找以前的旧资料......



终于我找到了解决以前的解决方法。

方法很简单，只需把网卡的驱动导入到安装盘中即可。

要入得了傲骄公主的法眼，需要以下三位骑士出马（文末有下载）。

1.  `VMware vSphere Hypervisor` 的 `Offline Bundle` 程序包
2. 螃蟹卡的 `VIB` 驱动程序
3. 用于导入驱动程序的脚本工具



##### 1、第一个获取 `Offline Bundle` 程序包很简单，直接下载它就是了。

图3



##### 2、第二个和第三个需要到一个名叫 `v-front.de` 的神奇网站上获取。

网址：https://vibsdepot.v-front.de/wiki/index.php/List_of_currently_available_ESXi_packages

在这个网站中可以找到一个脚本工具以及螃蟹卡的最新 `ESXi` 驱动。

图4

图5



别客气，公主有令，请他们下来。

图6

图7



下载完成后，把它们移动到一个新文件夹中，然后以管理员身份打开 `PowerShell` ，尝试运行 `ESXi-Customizer-PS-v2.6.0.ps1` 。

结果提示错误，好像是缺少 `VMware` 的某些组件。

图8



怎么好像和以前的不太一样啊，其实这个时候我已经有一丝不详的预感了。

到网上找大神求助，众大神给出了方法，需要安装名为 `VMware.PowerCLI` 的依赖。

```shell
Install-Module -Name VMware.PowerCLI
```



老实巴交的我照做了，可是换来的是无尽的确认提示和漫长的等待。

图9

图10

图11

图12



我差点晕倒，还好默念了几句平安经最后被我发现，其实官网早就有完整程序包可供下载。

链接：https://code.vmware.com/web/tool/12.0.0/vmware-powercli

图13



下载好后，得到了文件 `VMware-PowerCLI-12.0.0-15947286.zip` 。

 把压缩包中的所有文件夹解压到 `PowerShell` 的 `Modules` 目录中，比如 `C:\Program Files\WindowsPowerShell\Modules` 。

图14



配置远程执行策略为允许

```
Set-ExecutionPolicy RemoteSigned
```

图15



配置忽略证书验证

```
Set-PowerCLIConfiguration -Scope AllUsers -ParticipateInCeip $false -InvalidCertificateAction Ignore
```

图16



再次尝试运行 `ESXi-Customizer-PS-v2.6.0.ps1` ，这下没有错误提示了。

图17



##### 3、导入螃蟹卡的VIB驱动

不加任何参数地执行脚本将会生成一个不导入任何第三方驱动的标准镜像文件，等于是从官网直接下载镜像文件，对我们来说没有用，所以要加些参数。

在脚本当前目录下新建一个空文件夹，比如 `pkgDir` 。

然后把前面下载的 `VIB` 驱动程序放在这个空文件夹中。

执行导入命令：

```shell
.\ESXi-Customizer-PS-v2.6.0.ps1 -izip .\VMware-ESXi-7.0.0-16324942-depot.zip -pkgDir .\pkgDir
```



命令完成后，虽然生成了新的镜像文件，但似乎有警告提示。

图18



实际上这个镜像是无法成功加载 `Realtek` 网卡的，原因当然是驱动导入没有成功了。

如果用以下命令导入呢？

```
.\ESXi-Customizer-PS-v2.6.0.ps1 -v70 -load net-r8168,net-r8169,net-sky2
.\ESXi-Customizer-PS-v2.6.0.ps1 -v70 -vft -load net-r8168,net-r8169,net-sky2
```

告诉你吧，这些都没有用，不管是不是直接连接 `v-front` 官网导入生成镜像，结果都和前面的一样。



那么问题出在哪儿呢？

查看命令执行时给出的警告信息，会发现 `VIB` 驱动需要两个依赖库，分别是 `vmkapi_2_2_0_0` 和 `com.vmware.driverAPI-9.2.2.0` 。

官方也给出了提示。

图19



任凭我如何艰苦卓绝地搜索，仍然是找不到安装这两个依赖的方法。

最后在一个论坛里找到了让人绝望而无奈的回复。

图20



文字大意：

> 很不幸，这个错误无法纠正。
>
> 出现这个问题是由于`VSphere 7.0` 中已经不推荐使用 `VMKlux` 驱动程序栈了。
>
> 这意味着从 `Linux` 驱动程序（如 `Realtek NIC` 的驱动程序）构建的任何驱动程序都将无法与 `VSphere 7` 兼容而正常工作。
>
> 唯一能让这些网卡与 `7.x` 版本兼容运行的方法只能是等待官方发布的驱动程序了。



多么痛心的领悟啊！

怪不得 `v-front` 官网上只看到有 `6.7` 版本的字样呢，原来 `7.0` 的还没有搞定啊！

好吧，我投降了，我的青春已不在！

我决定放弃 `7.0` 转而使用 `6.7` 了！

还是上面熟悉的套路，很容易我就完成了 `6.7` 的驱动导入！

还是 `6.7` 来得香啊！

早知如此，何必当初，小伙伴们，可不要走我的老路啊！

青春易逝，及时行乐！

切记！勿忘！





###### 最后的最后，分享给小伙伴们本文涉及到的下载链接，可直接下载使用，免去你到处查找的麻烦。

**1、已经导入螃蟹网卡驱动的镜像，可直接用于安装。**

[ESXi-6.7.0-Within-R8111G.iso](https://pan.baidu.com/s/1vNYLFlxenjq8TdUgGV2hGg) 提取码：whvl



**2、`VMware-ESXi-6.7.0` 的离线打包程序，可用于导入制作各种定制版安装镜像。**

[VMware-ESXi-6.7.0-8169922-depot.zip](https://pan.baidu.com/s/1x3BGcoXzx6DZ8WtWqh5qLQ) 提取码：148b



**3、文章中用到的神奇网站 `v-front` 的各种脚本工具和驱动。**

[ESXi-Customizer-PS-v2.6.0.ps1.7z](https://o8.cn/MYqc6E) 密码：vx52

[VMware-PowerCLI-12.0.0-15947286.zip](https://o8.cn/Ziicsj) 密码：y6av

[net55-r8168-8.045a-napi.x86_64.vib.7z](https://o8.cn/gRBlx7) 密码：2fq9



> WeChat @网管小贾 | www.sysadm.cc

