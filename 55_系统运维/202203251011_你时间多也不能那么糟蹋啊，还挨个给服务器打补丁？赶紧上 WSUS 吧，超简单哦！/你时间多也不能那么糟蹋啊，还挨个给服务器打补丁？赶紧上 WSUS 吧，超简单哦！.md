你时间多也不能那么糟蹋啊，还挨个给服务器打补丁？赶紧上 WSUS 吧，超简单哦！

副标题：批量给服务器上更新，你必须用用看 WSUS ！

英文：you-cant-waste-so-much-time-and-still-patching-servers-one-by-one-hurry-up-to-try-wsus-its-very-simple

关键字：windows,wsus,update,upgrade,更新,补丁,patch,服务器



连续好几个周末，说好的哥几个都一块儿去钓鱼散心，却每次都被小M放了鸽子。

这咋回事，这小M背着哥几个玩什么猫腻，就想知道小M最近搞啥飞机呢？

终于大伙儿一块儿商量着，决定一起开个“视频会议”，来“揭秘”小M不为人知的秘密！



话说这天到了周末，好不容易等到了小M上线，原本哥几个还期待着小M是不是在哪个风色场所出现，让人意想不到的是他居然人在机房。

屏幕中的小M一副苦瓜脸，刚一上来就向大家伙哭诉着最近被迫996的痛苦经历，每到周末还要给服务器打补丁。

原先没几台服务器，小M寻思着也就挨个手动安装操作了。

如今不知不觉有了数十台服务器，安装更新所花费时间也就越来越久，最终导致周末无休，放假无望。



听完小M的哭诉，我长叹了一声，语重心长地安慰他说：“你特么上个 `WSUS` 能si啊？！”

很明显，小M被我的话感动到了，被我这么一说，他激动地结巴起来：“那...那什么...怎么搞啊？”

看他挺可怜的，于是我就告诉他，`WSUS` 是 `Windows Server Update Services` 的简称，翻译过来就是 `Windows` 服务器更新服务，专门用来分发更新补丁的。

这 `WSUS` 是 `Windows` 服务器版本系统就有的，它的好处可多了，大概有以下几个。

* 可自动批量分发更新补丁到服务器和客户端计算机
* 可批量处理不同系统版本的更新
* 可审批或拒绝特定的更新，避免某些更新造成系统不稳定甚至崩溃
* 及时、有效、全面地应用更新，不用自己到处找更新程序
* 不需要域环境支持，直接上就行



看到这么多好处，小M立马流下了悔恨的口水。

没想到还能这么干啊，他求我赶紧教他具体的方法。

大家都知道，我是一位心地善良、乐于助人的好心人，这点小事对我来说是举手之劳。

我安慰他，说别着急，你先擦干口水振作一点，我先出去买米，等我做了饭请你来咱们一边吃饭一边好好聊聊！

我刚说完，小M立马转我一个大红包，示意我见外了，让我现在赶紧救急。

我还在一边安慰他，一边点开大红包，然后咧嘴笑说：“啥也甭说了！走着！”



### 如何添加 `Windows Server 更新服务`

`服务器管理器` 中点击 `管理` 菜单，选择 `添加角色和功能` 。

图01



一些说明，没啥可看的，直接下一步吧。

图02



默认直接下一步。

图03



默认是在当前服务器上添加角色和功能，下一步。

图04



找到 `Windows Server 更新服务` ，打上勾。

图05



安装 `Windows Server 更新服务` 是需要 `Web 服务器(IIS)` 支持的，所以它也会一并被安装。

我们点击 `添加功能` ，它会自动勾选。

图06

图07



不需要选择任何功能，直接下一步。

图08



还是一些说明，直接下一步没得说。

图09



保留默认的角色服务选择，下一步。

第三项需要 `SQL Server` 支持，简单运用我们无需选择它。

图10



更新服务器需要下载大量的更新补丁，因此我们必须为它指定一个可保存更新补丁的文件夹，名字可随意，尽量预留大一些的容量空间。

图11



确认默认安装的 `Web 服务器角色(IIS)` 信息，不用刻意调整，直接下一步即可。

图12

图13



最后安装准备，点击 `安装` 开始更新服务的安装进程。

图14

图15

图16



### 初始化 `Windows Server 更新服务` 

安装完成后，我们点击 `服务器管理器` 界面上的通知信息（小旗子），然后再点击 `启动安装后任务` 。

图17

图18

图19



待安装任务完成后，我们点击 `工具` 菜单中的 `Windows Server 更新服务` ，开始初始化部署。

图20



配置向导开启，点击下一步。

图21



将下方提交给官方报告的提示选项去除。

图22



选择上游服务器，有两种方式，一是直接通过官方服务器更新，这是默认选项。

另一种是指向已有服务器，只要指定这个服务器的名称或IP地址即可。

图23



选择代理服务器，如果内部是通过代理服务器连接更新服务的，那么就在此指定代理。

图24



作为服务的初始化，接下来我们需要点击 `开始连接(S)` 来连接上一级更新服务。

注意注意，这是必须步骤，如果你在此不小心点击取消，那么在之后的更新列表中有可能找不到 `Windows 10` 等比较新的更新版本了。

图25



这一步骤需要花费较多的时间，需要耐心等待，我这儿就干等了小半个钟头。

图26



耐心等待完成连接后，我们就可以点击下一步了。

图27



选择更新所属语言，通常我们选择 `中文(简体)` ，或是根据你实际需要再选择其他语言。

图28



接下来选择更新产品，也就是我们实际需要哪些补丁，比如针对 `Windows 10` 的，还是针对 `Windows Server` 的，又比如驱动程序或产品更新等等。

当然如果是什么 `XP` 啥的，就没有选择的必要了，那我们可以将不需要的去掉，以便减少下载负荷。

图29



再来我们还要选择更新分类，一般情况下我们选择 `安全更新程序` 和 `关键更新程序` 就足够了。

图30



然后我们定个同步时间，可以理解为检测和下载更新的时间。

这个时间你可以随意设置，但建议选在夜深人静的时候，可能速度会快一些。

另外每天同步次数最好不要太多，如果因为频繁地更新而导致系统卡死可就不开心了。

图31



是否开始初始同步？

我建议最好不要，因为在这儿就开始第一次同步需要等待非常长的时间。

我们完全可以等待设置完毕后再同步也不迟。

图32



一切准备OK，点击 `完成` 按钮完成设置。

图33



最后我们就可以看到更新服务的界面，在这个界面中我们就可以开始更新服务的进一步调整设置了。

图34



就像前面说的，如果你不小心取消了初始化向导设置，那么也不用担心，我们可以在更新服务界面中的选项，找到 `WSUS服务器配置向导` ，就可以再次激活初始化配置向导。

图35



### 开始使用 `Windows Server 更新服务` 



##### 同步

确认初始化设置没有问题后，我们可以点击更新服务界面中的 `立即同步` 。

图36



经过一段时间后，我们可以看到有更新被同步过来了。

当然这些更新还没有被审批，只有等待我们审批通过后，这些更新才会被应用到指定的计算机中。

图37



等到更新同步完成后，我们点击 `所有更新` ，然后将过滤条件的状态选择为 `任何` ，再点击 `刷新` ，就可以看到同步好后的更新列表了。

图38



##### 审批

右键点击我们需要安装的更新（可以批量选择），然后点击 `审批(A)...` 。

图x08



在 `审批更新` 界面中点选相应的计算机组，然后点击 `已审批进行安装(I)` 即可将更新审批应用到指定的计算机中。

图x09



##### 计算机组

计算机组可以用来划分需要安装不同更新补丁的计算机，将这些计算机放在一个组里方便应用相同的更新。

右键点击 `所有计算机` ，然后点击 `添加计算机组(A)...` 。

图x10



给这个计算机组起个容易区分的名称，以后审批更新就可以直接应用到这些计算机组上了。

图x11



##### 拒绝

更新有审批通过的，就有我们不需要的，然而不需要的却是大多数，因此我个人建议可以先将大部分我们不需要的更新给予拒绝，方便我们理清之后的更新。

比如较旧版本的更新，再比如 `ARM64` 甚至部分 `x86` 平台之类用不上的更新等等都可以排除。

右键点击需要拒绝的更新，然后点击 `拒绝(D)` 。

图x06



确认无误后，点击 `是(Y)` 将当前更新拒绝。

图x07



### 客户端

指向更新服务器的客户端配置有几种方法可以做到，但基本原理都是一样的。

我们可以通过组策略、注册表，甚至写个批处理文件导入设置可实现。



##### 组策略

不管是域组策略还是单机组策略都大同小异。

执行 `gpedit.msc` 打开组策略编辑器，依次找到 `计算机配置` > `管理模板` > `Windows 组件` > `Windows 更新` 。

在右侧设置窗口中找到两项，一项是 `配置自动更新` ，还有一项是 `指定 Intranet Microsoft 更新服务位置` 。

图y01



我们先来看看 `配置自动更新` ，打开后选择 `已启用` ，然后在下方选项中设置自动更新方法、计划安装日期和时间即可。

自动更新方法默认为 `3` ，在此建议选择 `4` ，也就是自动下载并同时安装。

因为只有我们审批过更新才会被安装，所以不用担心自动安装会带来麻烦。

图y02



接着我们再来看看 `指定 Intranet Microsoft 更新服务位置` 。

在选择 `已启用` 后，在下方选项中只要填写服务器信息即可，比如 `http://WSUSServer:8530` ，当然也可以用IP地址， `8530` 是默认更新端口也可省略。

另外，需要注意是 `http` 而不是 `https` 。

图y03



##### 注册表

组策略设置挺简单的吧？

除了组策略，注册表其实也可以设置客户端指向服务器更新。

实际上通过组策略设置，同时注册表也会生成类似如下的注册表信息。

大体你可以参考如下，将 `x.x.x.x` 修改成你的 `WSUS` 服务器的域名或IP地址即可。

```
Windows Registry Editor Version 5.00

[HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate]
"ElevateNonAdmins"=dword:00000001
"DoNotConnectToWindowsUpdateInternetLocations"=dword:00000001
"WUServer"="http://x.x.x.x:8530"
"WUStatusServer"="http://x.x.x.x:8530"
"UpdateServiceUrlAlternate"=""

[HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate\AU]
"NoAutoRebootWithLoggedOnUsers"=dword:00000001
"DetectionFrequencyEnabled"=dword:00000001
"DetectionFrequency"=dword:00000001
"NoAutoUpdate"=dword:00000000
"AUOptions"=dword:00000004
"ScheduledInstallDay"=dword:00000000
"ScheduledInstallTime"=dword:0000000a
"UseWUServer"=dword:00000001
```



其中有几项挑出来说明一下，方便各位小伙伴们理解。

* `WUServer` 和 `WUStatusServer` ，这个不用多说，就是更新服务器。
* `NoAutoRebootWithLoggedOnUsers` ，为 `1` 时当有用户登录时更新不自动重启计算机。
* `NoAutoUpdate` ，`0` 启用自动更新，`1` 禁用自动更新。
* `AUOptions` 指的是自动更新的方法（可参考组策略），默认是 `3` ，建议 `4` 。
* `ScheduledInstallDay` 就是计划安装日期，默认是 `0` 每天都更新，`1` 到 `7` 对应周日到周六。
* `ScheduledInstallTime` 是计划安装时间，数字直接对应从一天的 `0` 点到 `23` 点。
* `UseWUServer` 设置为 `1` 表示使用更新服务器而不是官方的更新服务。



##### 批处理

有了注册表项，我们还可以编写批处理程序来给客户端批量设置更新服务器。

此处仅举个例子，其他项目可自行补充。

```
: 添加 WUServer
reg add HKLM\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate /v WUServer /t REG_SZ /d http://x.x.x.x:8530 /f

: 添加 WUStatusServer
reg add HKLM\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate /v WUStatusServer /t REG_SZ /d http://x.x.x.x:8530 /f

: 设置使用自建的更新服务器
reg add HKLM\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate\AU /v UseWUServer /t REG_DWORD /d 1 /f
```



##### 确认客户端是否连接到更新服务器

在确认客户端是否成功连接之前，我们必须先确保服务器的更新服务是否可以通过防火墙正常访问。

那么我们至少需要开放更新服务所用到的 `TCP` 协议的 `8530` 和 `8531` 两个端口。

图y06

图y04

图y05



我们如何让客户端连接更新服务器呢？

很简单，打开客户端的 `Windows` 更新设置界面，点击 `检查更新` 。

图y07



之后过了一会儿，检查更新完成，似乎没有什么大的变化，也没有新的更新出现。

图y08



其实不用着急，我们回到更新服务器那边再看看，OK的话我们就可以在所有计算机中找到刚才的客户端计算机。

当然，查询状态你可能需要改成 `任何` ，然后再点刷新。

图y09



我们注意到，刚刚添加进来的客户端计算机前面有个感叹号，这表示客户端还没有完成更新，状态暂时异常。

这个状态异常并不是十分要紧，它只是在检查客户端计算机有没有正确安装了应该安装的更新。

经过一段时间的检查，最后它会在下方的信息栏内显示已安装和未安装更新的详细信息。

一旦出现需要的更新，那么客户端就会在计划内安装这些更新。

图y10



既然客户端已经连接过来了，那接下来是不是客户端就直接可以更新了呢？

并不是，我们还需要再做些工作，分三步走！



**第一步，将客户端移动到指定的计算机组中。**

这样有利于我们分门别类地管理不同更新需求的客户端计算机。

图y11

图y12



**第二步，审批更新。**

右键点击需要安装到客户端的更新（可多选），然后点击 `审批(A)...` 。

图y13



在审批更新界面中，点选相应的计算机组，然后点击 `已审批进行安装(I)` ，最后确定退出。

图y14

图y15



我们回到客户端所在的计算机组再次查看，就可以看到有我们刚刚审批通过的更新。

图y16



**第三步，客户端更新。**

我们可以直接去客户端手动点击那个检查更新，也可以暂时不管等它自动启动检查更新。

作为测试，我们在这里就手动更新以方便演示。

如果有适合的更新，那么客户端就会从更新服务器上直接下载并安装了。

图y17



### 安装信息查看组件

当我们想要查看客户端具体需要安装哪些更新时，可以点击下方状态信息栏中的项目。

不过如果是第一次这样操作，系统会提示我们还需要安装报表查看组件。

图z01



这个被称为 `Microsoft Report Viewer 2012` 的组件需要有两个安装程序。

* `ReportViewer`
* `SQLSysClrTypes(64/32)`



我给小伙伴们找好了，都放在这儿，大家就近下载吧，省得再到处找了。



**ReportViewer.msi.7z(5.88M)**

下载链接：https://pan.baidu.com/s/16kmZT2buQfhCV8RE3h2P7g

提取码：oy06



**SQLSysClrTypes64.msi.7z(1.18M)**

下载链接：https://pan.baidu.com/s/1PH01zoekHlImhVv2ZrcDnQ

提取码：86qm



**SQLSysClrTypes32.msi.7z(1.04M)**

下载链接：https://pan.baidu.com/s/1Ohp7JOfmunui1N7Y6d4cQg

提取码：f2zl



以上程序注意是有安装顺序的，应该先安装 `SQLSysClrTypes` 再安装 `ReportViewer` 。

否则会警告缺少组件而无法安装（我就是来帮忙的，没想到还要有人来帮我一把啊！）

图z02



具体的安装过程很简单，就是N个下一步，我就不在这儿啰嗦了。

组件安装完毕后，需要重启更新服务器的控制台来加载组件。

通过报告我们可以很清楚地了解到客户端计算机需要安装哪些具体的更新，以便我们可以针对性选择审批适合的更新补丁。

图z03

图z04



### 其他设置

由于可能需要审批的更新数量众多，因此我们可以使用 `选项` 中的 `自动审批` 来实现自动化。

另外我们还可以设置 `电子邮件通知` ，在经过同步后如果有新的更新需要我们发布就可以第一时间通知到我们。

还有其他一些辅助性的设置，都比较简单，就不在此赘述了。



### 写在最后





**扫码关注@网管小贾，阅读更多**

网管小贾的博客 / www.sysadm.cc





















