如何安全而又不失优雅地与多人共享大文件（三）

副标题：TempShare 的权限与限期



天色有些阴沉，似乎又有些小雨。

孔大力早早地来到公司，进入办公室，坐到了自己的工位上。

他机械而习惯性地打开背包、掏出电脑，摆放在桌子上，回想起昨天还有没完全的工作。

他望着窗外，不知怎么发起了呆，这时手机响了一下，来了条短信......

"尊敬的XXX，您的还款日为XX日，请您按期足额还款......"

短信一把将孔大力游离在外的小心思抓回了现实，他哆嗦了一下，不禁感叹还是有人记得他的，活着真好！



“老板不讲武德，我可不能不耗子尾汁啊！开始工作工作......”，孔大力调侃自己，显然带了点苦涩。

他快速回忆整理了昨天所做的一切，剩下的还有两个问题：权限和期限。

好了，趁着一早还没有人打扰，干就是了！



#### 首先，是权限问题。

为了保证相关的用户可以访问到同一文件夹，同时又为了保证不同用户之间避免不必要的干扰而实施隔离，这就不得不涉及到权限问题了。



首先，要保证通过申请的用户才可以访问 `TempShare` 。

右击 `TempShare` 文件夹，选择属性，找到安全选项卡。

禁用继承 > 删除 `Users`  组 > 添加 `Domain Users` 组只读 > 添加 `TempShare` 组可写。

图1

图2

图3



这样一来，所有的域用户都可以查看 `TempShare` ，但只有 `TempShare` 组的用户才可以往里面写文件。

孔大力仔细想了想，发现有个漏洞，那不是所有用户都可以看其他用户的文件了，这算什么隔离呢？

嗯，还是要再更新一下设计方案。

孔大力想到了让用户自行指定可以访问的用户，通过 `VBS` 代码命令参数来实现。

比如让 `user1` 和 `user2` 两个用户都能访问自己的文件，可以这样做。

```
C:\> Cscript TempShare.vbs user1 user2
```



那么，VBS代码哪些实现呢？

套路还是一样的，新建的 `TempShare` 子文件夹也要执行禁用继承等操作，然后赋予指定用户访问权限。

```
' Modify Folder Permissions Function
Function ModifyFolderPermissions(ByVal strFolder)
   Dim strCmd
   
   strCmd = "cmd /c ""ICACLS " & strFolder & " /inheritance:d"""
   CreateObject("WScript.Shell").Run strCmd, 0
   
   strCmd = "cmd /c ""ICACLS " & strFolder & " /remove ""TempShare"""
   CreateObject("WScript.Shell").Run strCmd, 0

   strCmd = "cmd /c ""ICACLS " & strFolder & " /remove ""Domain Users"""
   CreateObject("WScript.Shell").Run strCmd, 0

   
	' Paramete of Argument, Users who would be added to access
	If intArgNum > 0 Then
	   For Each strArgUser in ArgArray

		  ' 指定用户可写权限
		  strCmd = "cmd /c ""ICACLS " & strFolder & " /grant:r " & strArgUser & ":(OI)(CI)(RC,S,RD,WD,AD,DC,REA,WEA,X,RA,WA)"""
		  CreateObject("WScript.Shell").Run strCmd, 0
	   
	      If Err.Number <> 0 Then
			Msgbox "Permissions setup error!" & vbCrLf & "ErrNo: " & Err.Number
		  End If

	   Next
	End If
   
End Function
```



#### 其次，是期限问题。

权限问题暂时搞定了，可期限怎么设定呢？

昨天，在草稿上的代码中临时设定了期限变量为3天，当然这是可以修改的。

变量为3天这个设定很容易，但实际上如何操作来具体达到限制的目的呢？

孔大力在网上搜索，发现还真有一个 `forfiles` 的命令可以实现定期删除文件的功能。



```
forfiles /S /D -3 /P "C:\TempShare" /M "*" /C "cmd /C if @isdir==TRUE rd @path 2> nul"
```

简单解释一下：

`/S` ：递归子目录

`/D -3` ：文件夹修改日期超过3天以上

`/P "C:\TempShare"` ：搜索路径

`/M "*"` ：搜索掩码，因为要删除的是文件夹，所以不能用 `*.*` 的形式

`/C "cmd /C if @isdir==TRUE rd @path 2> nul"` ：实际执行的命令，判断是否为文件夹并删除之









关注微信公众号，下载完整源码：





夜已深，窗外不断传来虫儿们的鸣叫声。

孔大力眯缝着眼看了看时间，已是凌晨1点多了。

他眼中噙着泪，口中打着哈，站起身来伸了个懒腰。

“哈啊...看样子今天的班儿就加到这儿吧~”

“咳咳...**还有共享文件夹的权限问题和时间限定问题**，算了算了，明天再搞吧~年轻人也要耗子尾汁啊！”

一阵阵困意袭来，孔大力不禁自言自语起来。

这位苦逼的打工人强打精神，简单地收拾下自己的电脑和背包，很快就甩门离去，背影渐渐消失在茫茫夜色中......



> WeChat@网管小贾 | www.sysadm.cc





