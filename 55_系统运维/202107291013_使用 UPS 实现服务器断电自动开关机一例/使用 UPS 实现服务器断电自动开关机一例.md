使用 UPS 实现服务器断电自动开关机一例

副标题：从此不再操心服务器启动一事啦~

英文：

关键字：





前言



### `UPS` 监控软件的安装

选用 `Rocky Linux` ，个人认为它是未来 `CentOS` 的最佳接任者，使用起来和 `CentOS` 基本没有什么差别。

而 `Windows` 平台下安装基本也与 `Linux` 差不多，可以互相参考，在这儿我以实际我做过的为准。



新建一个目录（比如 `/pcbeagent` ），然后将 `pcbeagent` 程序包上传并解压缩。

```shell
tar zxvf pcbeagent-10.0.2-301-EN.x86_64.tar.gz
```



解压缩后得到很多文件，其中有两个我们会用到，一个是安装脚本，另一个是 `pbeagent` 主安装程序。

图a1



紧接着执行安装脚本。

```shell
./install_pbeagent_linux.sh
```



安装程序启动，选择语言。

为了避免乱码，我们还是老老实实用英文，这样也能多了解安装使用期间各种单词的含义。

图a2



阅读协议内容，按空格或回车翻页到最后，输入 `yes` 回车表示同意。

图a3

图a4



接下来询问你将 `PowerChute` 安装在哪儿，通常我选择默认位置，因为这样将来好处理问题。

输入 `yes` 回车，开始安装。

图a5



在安装的过程中可能会遇到一些奇怪的坑，比如像这样，直接提示失败。

图a6



通过提示，需查看 `rpm.log` 日志文件，内容如下。

> warning: pbeagent-10.0.2-301-EN.x86_64.rpm: Header V4 RSA/SHA1 Signature, key ID 7cf6d1fd: NOKEY
> error: %prein(pbeagent-10.0.2-301.x86_64) scriptlet failed, exit status 3
> error: pbeagent-10.0.2-301.x86_64: install failed



说明在安装 `rpm` 文件时出错，于是直接手动安装这个 `rpm` 包试试。

```
rpm -ivh pbeagent-10.0.2-301-EN.x86_64.rpm
```

结果也报错了，不过可以看出来是没有安装 `unzip` 的原因。

图a7



它要啥我们就给啥呗，满足它，安装 `unzip` 。

```
yum install -y unzip
```



再来执行一下安装脚本。

```
./install_pbeagent_linux.sh
```

OK，没问题了，安装进程进入了配置阶段。

`rpm` 包安装完成后会生成配置文件 `config.sh` ，此时等同于手动执行了这个 `config.sh` 文件。

图a8



提示输入用户名和密码，这个用户名和密码是之后用于管理的 `Web` 界面的登录用户和密码，切记务必设定后保管好。

如果不幸忘记了密码怎么办？

文末给你总结了重置用户名和密码的方法，着急的话你可以直接到文末查找。



用户名和密码要求：

* 用户名的长度必须介于 6 到 128 个字符之间。
* 密码要求：
  * 长度至少 8 个字符，最多 128 个字符。
  * 1 个大写字母和 1 个小写字母。
  * 1 个数字或特殊字符。
* 用户名不能是密码的一部分。



OK，接下来就是针对具体 `UPS` 设备的型号来设置了。

说实话，这玩意很容易搞错，所以你需要根据说明书上或设备上的实际型号来选择。

图a9



然后就是选择线缆的连接方式，通常有串口或 `USB` 方式。

图a10



配置程序会检测 `UPS` 设备是否在线，我这儿做测试没有真的连接，所以会提示是否连接正常。

图a11



一切OK，最后程序询问你是否启动 `PowerChute` 代理服务程序。

图a12



毫无悬念地代理服务正常启动了，这个时候我们就可以来管理它了。

图a13



今后完全可以手动启动或停止这个代理服务。

```
# 启动服务
systemctl start PBEAgent

# 停止服务
systemctl stop PBEAgent

# 重启服务
systemctl restart PBEAgent

# 查看服务状态
systemctl status PBEAgent
```



安装程序已经将 `PBEAgent` 服务加载到启用项了，以后系统开机会自动启动服务。

图14





### `UPS` 监控软件的设定

在正式开始设定前，我们需要确保防火墙开放 TCP `6547` 端口，因为 `PBEAgent` 用到了这个端口。

```
firewall-cmd --zone=public --add-port=6547/tcp --permanent
```





端口开放后我们就可以这样来访问管理界面。

```
https://x.x.x.x:6547
```

注意是 `https` 而不是 `http` ，端口号用冒号连接在域名或IP之后。









### 最终效果确认

从前面介绍的安装和配置中也能看到使用的效果。

基本上当市电切断后，`UPS`  自动转为电池供电，与此同时发送给代理程序一个关机信号。

服务器接收到关机信号后，在一定的时间内完成关机动作。

然后在此之后 `UPS` 自动停止供电，相当于自己关机休眠了。



等于到市电恢复，`UPS` 再次开启，同时插座面板供电。

服务器检测到插座供电就自动启动，系统恢复正常。





### 如果忘了登录的用户名和密码怎么办？

这种情况只能重置用户名和密码了。

到 `PBEAgent` 安装路径（默认 `/opt/APC/PowerChuteBusinessEdition/Agent` ）中找到 `pcbeconfig.ini` 文件，用文本编辑器打开它。

然后在文件最下面添加以下内容。

同时直接在等号后面输入新用户名和密码，切记用户名和密码要符合之前的规范和约束。

```
[Credentials]
username=新的用户名
password=新的密码
```



编辑好后保存 `pcbeconfig.ini` 文件，然后重启 `PBEAgent` 服务。

服务重启后，如果用户名和密码符合规范要求，那么 `[Credentials]` 区段内容将自动被删除，同时新的用户名和密码将生效。

假如用户名和密码不符合要求呢，系统会在 `pcbeconfig.ini` 文件中写入错误信息，根据这个信息再来调整即可。



### 写在最后

关于服务器自动开关机的简单的单机解决方案大体就如以上所述，在实际使用场景中用得也比较多一些。

不过还有更复杂的场景，比如有多台服务器的情况，那么可能需要用到网络管理卡。

如果你想通过网络的方式来给远程多台服务器发送开关机信号，那么应该会要用到网络管理卡的方式。

我没有实际使用网络管理卡的经验，所以也无法向小伙伴们介绍了，大家可以到官网上查找相关的说明书。

好了，以后还有什么有趣的研究我会抽空总结后分享给大家，记得三连，这是我的最低要求啦！



**扫码关注@网管小贾，阅读更多**

网管小贾的博客 / www.sysadm.cc
