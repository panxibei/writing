思科交换机VTP无法同步一例

副标题：事有蹊跷，必定有鬼~



背景介绍

有两台交换机，一个命名为21，另一个命名为22。

交换机 `21` 连接到主交换机上，而 `22` 则连接到了 `21` 上，也就是说，它们相当于是串联关系。

图1



设定好交换机后，发现VLAN11无法通讯。





### 一、检查 `vtp` 配置信息

会不会是vlan配置有问题，遂查看 `vtp` 同步信息。

```shell
show vtp status
```



主交换机上

图2



交换机 `21` 上是这样。

图3



交换机 `22` 上是这样。

图4



很显示可以看出，交换机 `22` 没有成功同步到 `vtp` 信息。

你看哈，首先配置信息最后修改记录和时间没有统一。

```
Configuration last modified by x.x.x.x at xx-xx-xx xx:xx:xx
```

其次是修订版本，前两者都是4，而有问题的后者则是2，显示也没有统一。

```
Configuration Revision：xx
```



那是不是配置有问题呢？

于是逐一确认。



1、VTP域名

```
vtp domain XXXX
```

结果：统一设定，已经区分了大小写，名称OK没问题。



2、VTP密码

```
show vtp password #查看密码
vtp password xxxxxx #设定密码
```

通过查看密码命令，确认密码也没有问题。



3、VTP模式

VTP模式一共有三种 `Server/Client/Transparent` 。

通过命令 `show vtp status` 也确认了除主交换机设定为 `Server` 外，其余交换机均设定为 `Client` ，同时也确认没有设定为 `Transparent` 。



配置一切OK，而且修订版本也算正确（`Server` 版本高于 `Client` ）。

我抓了抓脑袋上仅有的几根秀发，心想究竟是哪里出了问题呢？





### 二、检查 `Trunk` 链路是否正常允许通过 `VLAN`

既然 `vtp` 设定一切正常，那么会不会是 `vlan11` 没有被允许通过 `trunk` 呢？

我们都知道 `vlan1` 作为默认 `vlan` ，是允许通过任何链路的，而除了它自行建立的 `vlan` 就可能会有被限制通行的可能。

想到这儿，我赶紧开始了检查。

登录到交换机 `22` 上，输入查看命令。

```
#show interfaces trunk
```

图5



没问题啊！

`port-channel` 端口可以通过 `vlan` 的 `1` 和 `11` 。

通过输入相同的命令来对照其他交换机的输出查看，结果完全一样，并没有什么特殊的。



为什么？为什么？为什么？

我的头上出现了，那不是我的头发，而是三个大问号！

难道说 `trunk` 链路设定有问题？



通过一番命令检查，虽说原始设定是使用双线做成两个冗余端口，但配置并无任何不妥之处。

我再次地迷茫了！



### 三、揭晓谜底

迷茫解决不了问题！

我重新冷静下来，再一次反复推演排除，最后判断应该是上一级交换机 `21` 之所以没有把VTP信息正确传递/同步到下一级交换机 `22` 上，就是因为两者之间的连接出了问题。

嗯，死马当活马医吧，试试看就知道了！

于是我在这两台交换机上打了一条查看邻居设备命令。

```
#show cdp neighbors
```



交换机 `22` ，也就是有问题的这台交换机上。

图6



交换机 `21`，就是上一级交换机。

图7



看到结果当时我就惊呆了！

为啥？

因为交换机的线根本就是接错了嘛！

从图中可以看到，`22` 交换机连接到了上一级 `21` 交换机的12端口，而不是23和24端口！



难怪 `vtp` 信息无法同步，原因就是没有正确连接到 `trunk` 链路的端口上，而连接非 `trunk` 端口是无法转发除 `vlan` 以外的 `vlan` 信息的，自然也就无法同步 `vtp` 配置信息了。

至此真相大白！



