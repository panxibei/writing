SimpleRunBlocker

副标题：

英文：

关键字：



就在某天深夜，屋外风雨交加，我正准备洗漱就寝，忽然传来一阵急促的敲门声。

我打了个哈欠，伸着懒腰埋怨了一声，心想谁这么晚了还来打扰。

我走近门口想看个究竟，同时大声嚷道：“搞什么...鬼啊！”

刚才还理直气壮的，可就是这“鬼啊”二字却略带了点颤音。

原来，当我从猫眼向外观瞧时，突然一道闪电划过，我分明看到了一个满身泥水、灰头土脸、狼狈不堪的小男孩，手里还捧着一个包，正惊慌失措地瞪着两只大眼睛看向我。



“妈耶，这谁啊？”，我先是一惊，后又大大的不解。

这时手机音乐又突然响了起来，我心肝一颤跟着一蹦三尺高。

我自己差点也乐出来，心想我啥时候跳高成绩这么好了！

遂低头一看手机，原来是同一小区的某位孩子家长打来的电话。

接了电话我才彻底明白，原来门外的小男孩是这位住户的孩子，是来找我帮忙看电脑的。



原来就在前数天前，这位家长出差在外，如今被疫情阻隔无法回家，现在孩子又开学无望，明天急需使用电脑上网课，却发现无法正常打开浏览器等程序。

究其原因，是这位家长在离家之前怕孩子乱玩游戏，就用一个叫作 `Simple Run Blocker` 的程序将电脑上的程序给锁定了。

结果现在大人回不来，孩子又要用电脑，赶时间实在没办法了这才找到我。

我立马将孩子让进屋里，一番安顿后我打开了他的电脑。



呃，这绕来绕去说了这么多，那到底怎么就不能打开程序了呢？

我这一研究，才发现问题的确没那么简单......





### 程序被锁定的现象

我拍着胸脯向小男孩保证很快就能搞定，于是屁颠儿地随便打开了一个程序，发现跳出了错误提示。

```
本次操作由于这台计算机的限制而被取消。请与你的系统管理员联系。
```

图a07



什么情况？

这以前倒没见过，怎么有点像病毒木马干的呢？

经过我一番确认，电脑里的确没有什么病毒和木马，看来需要研究一下这位家长提到的 `Simple Run Blocker` 了。

可是我怎么找都找不到这个程序，难道是被删除了？



后来我在 `www.sordum.org` 中找到了这款软件。



### `Simple Run Blocker` 介绍

`Simple Run Blocker` 简称 `SRB` 一款便携式免费软件，用于阻止应用程序启动。

通常这款程序主要是用来防止熊孩子乱用某些程序，或是其他一些需要防止应用程序误启动的特殊情况。



`SRB` 的界面很简单，操作也很方便。

如图，只需将目标应用程序拖放到窗口中即可将应用程序加入到列表中。

或者按下加号 `+` 或 减号 `-` 来添加或删除应用程序，最后按下对勾保存使设置生效。

图a03



按下齿轮图标，弹出设置菜单。

其中我们可以在最初打开 `SRB` 时选择 `Languages` ，并选择 `简体中文` 。

图a05



在后面的下拉菜单中，我们可以有三种拦截选项。

分别是：

1 - 拦截不在列表中的所有程序

2 - 拦截列表中的程序

3 - 不拦截

图a04



`SRB` 大致具有两大功能，一是隐藏或锁定驱动器，就是 `C` 盘、 `D` 盘的不让用，还有一个就是锁定应用程序。

下面我们分别分析分析。



### 隐藏或锁定驱动器

点击齿轮图标，在下拉菜单中选定 `隐藏或锁定驱动器` 。



首先，我们看一下 `隐藏驱动器` 功能。

如图，我们只要勾选相应的驱动器盘符，然后再点击应用即可。

图b01



同样，对于 `锁定驱动器` 功能，也是勾选相应的驱动器盘符，然后再点击应用即可。

图b02



这些操作是挺简单的，那它是怎么实现的呢？

随后我找到了注册表中相应的注册表项，揭开了这些秘密。

```
HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\Explorer
```

图b03



其中有两个非常重要的注册表键：

* `NoDrives` - 隐藏磁盘
* `NoViewOnDrive` - 禁止访问磁盘



这两个好哥们，一个管隐藏，一个管禁止，虽然各司其职名字不完全一样，但用法是一样的。

他们都是 `REG_DWORD` 类型的键值，是**用二进制的数字位数是 `1` 还是 `0` 来表示磁盘驱动器的排序位置**。

具体地说，就是磁盘驱动器的盘符从高到低，也就是从 `A` 到 `Z` ，分别用二进制来表示。

相应盘符排序位置的数字是`0` 表示启用，数字是 `1` 则表示禁用。



举例，只保留开启 `C` 、 `D` 盘，则可以这样表示：

```
Z Y X W V U T S R Q P O N M L K J I H G F E D C B A
1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 0 0 1 1
```

因此将二进制转换成十六进制就是 `0x3FFFFF3` 。



另外，还有一个注册表键 `NoDriveTypeAutoRun` 是用来指定某些类型的设备是否禁止自动播放功能。

设备分为很多不同的类型，分别用不同的数字指代，通常如下。

* `1` - `DRIVE_UNKNOWN` 不能识别的类型
* `4` - `DRIVE_REMOVABLE` 可移动磁盘
* `8` - `DRIVE_FIXED` 硬盘
* `10` - `DRIVE_REMOTE` 网络驱动器
* `20` - `DRIVE_CDROM` 光驱
* `40` - `DRIVE_RAMDISK` `RAM` 驱动器
* `80` - 未知类型
* `FF` - 所有类型



如果我们要禁止某一类型设备自动播放，那么直接使用对应的值即可。

如果要禁止多个类型的设备，则将指代它们的数值相加即可。

比如：

* `95 = 1+4+10+80` 是指 `不能识别的类型` + `可移动磁盘` + `网络驱动器` + `未知类型`
* `91=1+10+80` 是指 `不能识别的类型`  + `网络驱动器` + `未知类型`
* `b5=1+4+10+20+80` 是指 `不能识别的类型` + `可移动磁盘` + `网络驱动器` + `光驱` + `未知类型`



当然，自动播放并不是重点，重点是前面那两个。



### 拦截应用程序

`SRB` 拦截的方式有两种（不拦截不算），一个是拦截列表中的程序，还一个是相反的，拦截不是列表中的程序。

通常我们是要将需要拦截的程序放到列表中，因此拦截方式我们会选择 `2 - 拦截列表中的程序` 。

图e01



那么这种操作也是非常简单，但它是什么原理呢？

同样，还是前面说到的注册表项，我们往里边找找。

```
HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\Explorer
```



当我们设定 `SRB` 拦截应用程序时，`Explorer` 项的下面就多出了几个没见过的键。

出现了三个新的注册表键：

* `BlockRunList`
* `DisallowRun`
* `RestrictRun`

图a08



这三个注册表键是谁派来的？他们啥来头？



##### 先看看 `DisabllowRun` （拦截列表中的程序）

这个注册表键 `DisallowRun` ，看字面意思就是不让执行，只要它的值是 `1` 就会起作用。

图e02



一旦 `DisallowRun` 起作用，以下注册表路径（也就是 `Explorer` 下一级的 `DisallowRun` 项）中的所列出的项目就会被拦截禁止。

```
HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\Explorer\DisallowRun
```

注意，其中被拦截应用程序的注册表键名可以是任意的，但键值才是关键不能写错哦！

图e03



##### 再看看 `RestrictRun` （拦截不在列表中的所有程序）

这个的意思正好和前面的相反，用来禁止绝大部分程序，这种反向操作要特别小心了，有可能会错误拦截了系统程序而导致系统崩溃。

图e04



相应的注册表键就是 `RestrictRun` ，只要它的值是 `1` 就起作用。

图e05



一旦 `RestrictRun` 起作用，以下注册表路径中的所列出的项目就会被拦截禁止。

```
HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\Explorer\RestrictRun
```

注意，其中跳过应用程序的注册表键名是任意的，但键值才是关键不能写错哦！

图e06



##### 小结

前面也说明得挺清楚了吧，即使没有这个 `SRB` 程序，我们也完全可以通过手动修改注册表来达到拦截应用程序的效果。

最后，至于 `Explorer` 项下还有一个名叫 `BlockRunList` 的注册表键，似乎应该是 `SRB` 这个程序自己创建的，用来自己保存程序列表。



### 绕过限制的方法

既然原理已经被我们掌握，同时也明白我们是可以通过手动修改注册表来实现与 `SRB` 同样的效果，那么接下来如何绕过限制也就变得易如反掌了。

很简单，我们还是通过手动修改注册表将策略关闭。



方法一，直接关闭限制开关，将 `DisallowRun` 和 `RestrictRun` 分别设置为 `0` 。

```
Windows Registry Editor Version 5.00

[HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\Explorer]
"RestrictRun"=dword:00000000
"DisallowRun"=dword:00000000
```



方法二，将限制列表中的相应程序名称重命名。

比如 `DisallowRun` 项中的程序列表，将其中你想要运行程序项的键值修改为其他名称。

图e07



又比如 `RestrictRun` 项中的程序列表，在其中添加你想要运行程序的名称。

注意，键名可以随意不一定是程序名称，但键值一定要是程序的完全文件名。

图e08



好了，手动修改注册表后，有可能不会立刻生效，那么我们可以用以下命令强制刷新策略就能快速生效而无须重启电脑。

```
gpupdate /force
```



方法三，文件重命名。

以上方法通过手动修改注册表可能略显麻烦，实际上还有一个极其简单而又变通的方法，那就是直接去重命名你想要执行的程序文件名。

哈哈，这么简单啊，我可真是个机灵鬼，因为 `Simple Run Blocker` 压根就管不了你重命名文件啊！



### 写在最后

经过前面的说明以及反复测试，可以说我们完全掌握了 `Simple Run Blocker` 的使用原理，那么我们完全也可以自己开发出这样一套简单实用的小程序。

我也正考虑能不能自己也搞一个差不多的程序，以便将这些功能整合到其他程序中。

可是好景不长，没过几天，他又再次找到我，说他这次遇到了更为棘手的麻烦！

是的，他的程序被再次锁定，而且就算是重命名文件也不好使了！



我将电脑拿过来这么一瞧，还真是，不管怎么折腾都不好使了！

哎？这是怎么回事？

难道我碰上了更难缠的对手了？

我稍作调整，准备开始新一轮的战斗。

后来究竟如何，请看下回分解！



**扫码关注@网管小贾，阅读更多**

网管小贾的博客 / www.sysadm.cc