如何实现 NAS + UPS 断电自动关机以及来电自动开机功能

副标题：

英文：

关键字：



一般情况下，我们只要在电脑系统中安装相应的 `UPS` 驱动应用程序，就可以正常与 `UPS` 交互，从而达到控制电脑系统自动开关机的功能。

想必有不少小伙伴应该有所尝试过了吧，不过这次有点不一样了，因为系统平台从 `Windows` 和 `Linux` 换到了其他系统平台，比如 `NAS` 系统。

我手头上正好有一台 `XigmaNAS` 系统，它是 `NAS4Free` 的后来者，与 `FreeNAS` 之类的都差不多，其系统本质都是 `FreeBSD` 。

然而像某些 `UPS` 的应用程序却并不支持这样的系统平台，比如 `APC` 的 `PowerChute` ，只支持 `Windows` 和 `Linux` 。

要想实现断电来电的自动开关机功能，这可怎么办呢？

经过我一番试验，最后还真的成功了，于是赶紧将这些零零碎碎的经验做了一个总结，分享给有需要的小伙伴们！



### 准备工作

* `NAS` 网盘：`XigmaNAS`
* `UPS` 电源：`APC Smart-UPS 1500`
* 通讯电缆线：方口 `USB` 打印线缆（一头 `A` 型，一头 `B` 型）



`UPS` 电源应选择可管理可与主机通讯的型号，这里我选择了常见的 `Smart-UPS 1500` 这个型号。

注意，`APC` 这一款 `UPS` 有很多子型号，但是一定要带有管理通讯功能的。

图01



`USB` 通讯电缆最好是买 `UPS` 自带的，这样可以避免兼容问题。

图02



除了 `USB` 线缆连接之外，我们还需要使用电源线将 `UPS` 与 `NAS` 主机连接起来。

使用的电源线应该是配套的一头母口一头公口的电源线。

此外务必要注意的是，尽量将电源母口接到标有 `GROUP 1` 字样的插座组上。

图03



`UPS` 的插座组分为主插座组 `Main Group` 和插座组一 `Group 1` 。

之所以这么分，目的是为了控制区分可断电和不可断电两类设备。

比如，有的设备需要切断电源减小负载，那么就接到 `Group 1` 上，而有的设备则需要较长时间的供电待机，那么就接到 `Main Group` 上。



不论什么情况，这两者都可以设定自动切断供电，只是先后顺序的问题。

`UPS` 在开机时 `Main Group` 会优先接通电源，随后 `Group 1` 接通电源；

在关机时，`Group 1` 优先切断电源，随后 `Main Group` 再切断电源。

这样可以保证先后有不同设备切断电源。

而 `Group 1` 有更加灵活的设定功能，具体在后面会讲到。



### `UPS` 设定

首先，我们在 `LCD` 面板上切换到主菜单配置 `Main Menu: Configuration` ，按回车确认进入。

图04



其次，我们找到主菜单类型 `Menu Type: Normal` ，按回车后将其调整为高级 `Advanced` 。

这样做的目的，是将隐藏设置项调出，方便我们设定自动开关机。

图05



然后，我们接着在配置中按上下键切换，找到配置插座组一配置 `Config Group 1 Outlets` 一项，并按下回车进入。

图06



在里面，我们找到一项 `LoadShed Time On Battery: Disable` 。

这个选项是指，当 `UPS` 切换为电池供电后是否开启关闭插座组的功能。

这是一个开关项，如果开启了，那么具体的设定在后面设置。

图07



我们将这一选项开启，之后就可以看到另一项 `LoadShed Time On Battery: XXs` 。

这个选项是指，当 `UPS` 切换为电池供电后在多少秒之后关闭插座组供电。

建议这个时间不要设定得太小，至少要等待主机正常关机后再切断插座组供电，比如 `60s` 。

如果你的服务器关机特别慢，那么建议再增加一些时间，比如 `90s` 或 `120s` 。

图08



这里插进来一个选项的说明。

除了刚才我们介绍的 `LoadShed Time On Battery` 之外，其实还有一项叫作 `LoadShed Runtime Remain` 。

这个选项则指，当电池供电剩余运行时间小于多少秒后 `UPS` 会切断插座组供电。

当然了这个选项也和前面一样，先要开启，再设定具体的时间。

图09

图10



关于 `LoadShed Runtime Remain` 这个选项需要再多说几句。

在实际使用场景下，我们应该根据实际具体的负载情况来设定这个时间，否则可能达不到预期效果。

在这里我就没有开启这个功能，而是只使用了 `LoadShed Time On Battery` 的延迟关闭插座组功能。

请小伙伴们根据你自己的实际情况选择吧！





### `NAS` 主机设定

开机进入 `BIOS` 设置，找到电源管理选项。

将其中一项 `After Power Loss` 修改为 `Power On` 。

这一项的意思是，当设备掉电然后再来电后采取的动作，`Power On` 就是来电后自动开机。

图11



然后转到 `XigmaNAS` 的设定界面，依次找到 `服务` > `UPS` ，将几个主要的选项设定好。

* 模式：主要
* 驱动程式：`usbhid-ups`
* 端口：`auto`
* 关闭模式：`UPS` 转用电池
* 关机定时器：`10`



图12



其中驱动程序应该选择 `USB` 线缆连接的类型，具体名称可从驱动列表中获取。

图13



关机采取的方式是当 `UPS` 切换为电池供电，通常这意味着市电已经断开，在电池供电有限的时间内设备应该尽快关机。

那么关机的时间可以设定为当 `UPS` 切换为电池供电后的 `N` 秒之后采取关机动作。

通常没有什么特殊的情况的话，可以将这个时间设定在 `10` 秒之内。

如果这个时间设定太短，那么在 `UPS` 又恢复市电供电之后可能会来不及反应而直接关机，这样会导致误关机操作。

所以，请小伙伴自行考虑，既要保证短时间内不要立刻关机，又要保证在不太长的时间内正常关机，比如 `5` 到 `10` 之间。



前面这些设定完成后，点击 `保存并重启服务` ，如果没什么意外的话设定就完成了，`UPS` 就可以正常工作了。

当然如果你想要及时得到相关的报告，那么还可以在 `到Email地址` 一栏中填写上你的电子邮件地址，以便接受 `UPS` 的相关信息。



设定完成后我们还可以回到首页查看 `UPS` 设备的当前具体详细的信息，方便我们实时掌握判断 `UPS` 的状况。

图14

图15



### 最终测试

最后测试一下，当我们关闭 `UPS` 的市电供电时，`UPS` 自动切换为电池模式并发出警报声。

在设定的数秒（ `10` 秒）之后，`NAS` 主机自动获得关机信号开始关机。

图16



`NAS` 设备正常完成关机，自切换成电池模式的数秒（ `60` 秒）之后，插座组一 `Group 1` 自动切断电源供电。

图17



当我们恢复市电供电，`UPS` 从电池模式恢复为正常供电，此时插座组一 `Group 1` 也同时恢复供电。

`NAS` 主机设备获得电源供电信号后自动开机，最终完成系统启动。



### 写在最后

以上就是 `UPS` 确保 `NAS` 设备可以自动开关机的整个方法步骤。

总结下来，主要就两点。

一是由主机设备提供的驱动程序来控制自己关机。

二是由 `UPS` 插座组面板的供电来控制主机设备自动开机。



基于这些原理，实际上我们可以将 `UPS` 方案应用到其他一些场景中，完全可以用来管理和控制服务器等我们常用设备断电来电的自动开关机。

此文旨在抛砖引玉，以我自己的一些浅薄经验，为小伙伴带来一些帮助和启示，希望有用，谢谢！



**扫码关注@网管小贾，个人微信：sysadmcc**

网管小贾 / sysadm.cc

























